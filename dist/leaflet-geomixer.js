/*
 Leaflet-GeoMixer, Leaflet plugin for visualization data from GeoMixer server
 (c) 2013-2016, RDC ScanEx
*/
!function(){"use strict";function e(e,t){this.layer=e,this.tile=t.el;var r=t.coords,n=r.z,o=Math.pow(2,n),s=r.x%o,a=r.y%o,l=i;0>s&&(s+=o),0>a&&(a+=o),this.ntp={z:n,x:s,y:a},this.tilePoint=r,this.zoom=n,this.gmx=e._gmx,this.zKey=this.layer._tileCoordsToKey(r,n),this.worldWidthMerc=l.worldWidthMerc;var u=l.getTileNumFromLeaflet(r,n);this.tpx=256*u.x,this.tpy=256*(1+u.y);var h=l.tileSizes[r.z];this.tbounds=l.getBoundsByTilePoint(this.ntp),this.topLeft={pix:{px:256*r.x,py:256*r.y},wm:{x:h*r.x-this.worldWidthMerc,y:this.worldWidthMerc-h*r.y},bounds:l.getBoundsByTilePoint(r)},this.gmxTilePoint=u,this.showRaster=n>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||n>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this.itemsView=[],this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}var t;"undefined"!=typeof module&&module.exports?(t=require("leaflet"),t.gmx={},module.exports=t.gmx):t=window.L,function(){var e=/\[(.+?)\]/g,r=/(floor\()/g,i={functionFromExpression:function(t){return new Function("props","indexes","return "+t.replace(e,'props[indexes["$1"]]').replace(r,"Math.$1")+";")}},n=function(e,t){return{head:e,tail:t}},o=function(e,t){return n(e,t)},s=function(e,t){return n(e,t)},a=new s(-1,null),l=function(e){return-1===e.head},u=function(e,t){return new s(e.head+t,e.tail)},h=function(e){var t=e.length;return function(r,i){return r.substr(i.head,t)===e?u(i,t):a}},c=function(e){var t=e.length;return e=e.toLowerCase(),function(r,i){return r.substr(i.head,t).toLowerCase()===e?u(i,t):a}},d=function(e,t){var r=e.charCodeAt(0),i=t.charCodeAt(0);return function(e,t){var n=e.charCodeAt(t.head);return n>=r&&i>=n?u(t,1):a}},m=function(e){return function(t,r){return t.length>r.head&&l(e(t,r))?u(r,1):a}},f=function(e){return function(t,r){for(var i=0;i<e.length;i++)if(r=e[i](t,r),l(r))return a;return r}},p=function(e){return function(t,r){for(var i=0;i<e.length;i++){var n=e[i](t,r);if(!l(n))return n}return a}},g=function(e,t){return t},v=function(e){return p([e,g])},y=function(e,t){return function(r,i){for(var n=0;;){var o=t(r,i);if(l(o))return n>=e?i:a;n+=1,i=o}}},x=function(e,t,r){var i=f([t,y(e-1,f([r,t]))]);return e>0?i:p([i,g])},_=y(0,p([h(" "),h("	"),h("\n")])),b=function(e,t,r){return x(e,t,f([_,r,_]))},S=function(e){for(var t=[],r=0;r<e.length;r++)t.length>0&&t.push(_),t.push(e[r]);return f(t)},P=function(e){return function(t,r){var i=e(t,r);return l(i)?a:new s(i.head,new o(t.substr(r.head,i.head-r.head),i.tail))}},T=function(e,t){return function(r,i){var n=i,u=e(r,new s(n.head,null));return l(u)?a:new s(u.head,new o(t(u.tail),n.tail))}},I=P(y(1,p([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_")]))),L=P(y(1,p([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_"),h(" ")]))),M=p([I,f([h('"'),L,h('"')]),f([h("`"),L,h("`")])]),k=f([h("'"),P(y(0,m(h("'")))),h("'")]),C=y(1,d("0","9")),O=P(f([v(h("-")),C,v(f([h("."),C]))])),w=p([O,k]),D=function(e,t){return t(e,new s(0,null))},F=T(S([M,P(p([h("=="),h("!="),h("<>"),h("<="),h(">="),h("="),h("<"),h(">"),c("LIKE")])),p([w,M])]),function(e){var r=e.tail.tail.head,i=e.tail.head,n=e.head,o=null;return"LIKE"===i.toUpperCase()&&(o=function(e){var t=null;return t=function(r,i){var o=n.charAt(r),s=e.charAt(i);return""===o?""===s:"%"===o?t(r+1,i)||""!==s&&t(r,i+1):o===s&&t(r+1,i+1)},t(0,0)}),function(e,s,a){var l=e[s[r]],u=n;if(n in s&&(u=e[s[u]]),"date"!==a[r]&&"datetime"!==a[r]||"string"!=typeof u||(u=t.gmxUtil.getUnixTimeFromStr(u)),"boolean"==typeof l&&"string"==typeof u&&(l=l?"True":"False"),null===l)return!1;if(null!==o)return o(l);if("="===i||"=="===i)return l==u;if("!="===i||"<>"===i)return l!=u;var h,c;return n in s||"string"!=typeof u||D(u,O).head!==u.length?(h=l,c=u,"<"===i?c>h:">"===i?h>c:"<="===i?c>=h:">="===i?h>=c:!1):(h=parseFloat(l),c=parseFloat(u),"<"===i?c>h:">"===i?h>c:"<="===i?c>=h:">="===i?h>=c:!1)}}),R=T(S([M,c("IN"),h("("),b(0,w,h(",")),h(")")]),function(e){for(var t=e;null!=t.tail;)t=t.tail;var r=t.head;return function(t,i){var n=t[i[r]];if(null==n)return!1;for(var o=e;null!==o.tail;){if(o.head===n)return!0;o=o.tail}return!1}}),E=function(e,t){return E(e,t)},N=function(e,t){return N(e,t)},A=T(S([c("NOT"),E]),function(e){var t=e.head;return function(e,r,i){return!t(e,r,i)}});E=p([A,F,R,S([h("("),N,h(")")])]);var G=T(b(2,E,c("AND")),function(e){return function(t,r,i){for(var n=!0,o=e;null!=o;)n=n&&o.head(t,r,i),o=o.tail;return n}}),U=T(b(2,E,c("OR")),function(e){return function(t,r,i){for(var n=!1,o=e;null!=o;)n=n||o.head(t,r,i),o=o.tail;return n}});N=p([G,U,E]);var z=f([_,N,_]);i.parseSQL=function(e){var t=D(e,z);return t.head===e.length?t.tail.head:D(e,_).head===e.length?function(){return!0}:null};var B=function(e,t){return B(e,t)},H=function(e,t){return H(e,t)};B=T(b(1,H,P(p([h("+"),h("-")]))),function(e){return function(t,r,i){for(var n=e,o=0;null!==n;){if(o+=n.head(t,r,i),null===n.tail)return o;"-"===n.tail.head&&(o=-o),n=n.tail.tail}return o}});var V=p([T(O,function(e){return function(){return parseFloat(e.head)}}),T(f([h("floor("),B,h(")")]),function(e){return function(t,r,i){var n=e.head(t,r,i);return Math.floor(n)}}),T(f([h("["),I,h("]")]),function(e){return function(t,r){return parseFloat(t[r[e.head]])}}),S([h("("),B,h(")")])]);V=p([V,T(S([h("-"),V]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]),H=T(b(1,V,P(p([h("*"),h("/")]))),function(e){return function(t,r,i){for(var n=e,o=1;null!==n;){if(o*=n.head(t,r,i),null===n.tail)return o;"/"===n.tail.head&&(o=1/o),n=n.tail.tail}return o}}),V=p([V,T(S([h("-"),V]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]);var q=f([_,B,_]);i.parseExpression=function(e){var t=D(e,q);return t.head===e.length?t.tail.head:null};var Z=T(y(0,p([O,h(","),h("M"),h("C"),y(1,p([h(" "),h("	"),h("\r"),h("\n")]))])),function(e){for(var t=[];null!==e;)t.push(parseFloat(e.head)),e=e.tail;return t.reverse(),t});i.parseSVGPath=function(e){var t=D(e,Z);return t.head===e.length?t.tail.head:[]},t.gmx=t.gmx||{},t.gmx.Parsers=i}();var r=function(e){var t,i=[],n=[],o=!1,s=!1,a=!1,l=!1,u=this._fulfill=function(e){if(!o){var r=e?i:n;t=[].slice.call(arguments,1),o=!0,s=e,r.forEach(function(e){e.apply(null,t)}),i=n=[]}};this.resolve=function(){l||u.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||u.apply(null,[!1].concat([].slice.call(arguments)))};var h=this.cancel=function(){l||o||(l=!0,e&&e())},c=this.then=function(e,a){if(l)return null;var u=null,c=new r(function(){h(),u&&u.cancel()}),d=function(e,t){return function(){if(e){var i=e.apply(null,arguments);i instanceof r?(u=i,i.then(c.resolve,c.reject)):c.resolve(i)}else c._fulfill.apply(null,[t].concat([].slice.call(arguments)))}};return o?d(s?e:a,s).apply(null,t):(i.push(d(e,!0)),n.push(d(a,!1))),c};this.once=function(e){a||(a=!0,c(e))},this.always=function(e){c(e,e)},this.getFulfilledData=function(){return t}};r.all=function(){var e=[].slice.apply(arguments),t=new r,i=e.length,n=new Array(e.length);return i?e.forEach(function(e,r){e.then(function(e){n[r]=e,i--,0===i&&t.resolve.apply(t,n)},function(){t.reject()})}):t.resolve(),t},t.gmx=t.gmx||{},t.gmx.Deferred=r,function(){var e=function(e,r,i){this._id=e,this.remove=t.gmx.imageLoader._removeRequestFromCache.bind(t.gmx.imageLoader,this),this.url=r,this.options=i||{},this.promise=this.def=new Promise(function(e,r){this.resolve=e,this.reject=function(){r(this.url),t.gmx.imageLoader._cancelRequest(this)}}.bind(this)).catch(function(e){console.warn("Warning: skip url ",e)})},r=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_checkIE11bugFix:function(e,t){if(!this.divIE11bugFix){var r=document.createElement("div");this.divIE11bugFix=r,r.style.visibility="hidden",r.style.position="absolute",document.body.insertBefore(r,document.body.childNodes[0])}var i=function(){e.resolve(t)};this.divIE11bugFix.appendChild(t),setTimeout(i,0)},_resolveRequest:function(e,r,i){if(r){if(!i&&e.options.cache){var n=e.url,o=this.requestsCache[n],s=e._id;o||(o=this.requestsCache[n]={image:r,requests:{}}),o.requests[s]||(o.requests[s]=e)}t.gmxUtil.isIE11&&/\.svg/.test(e.url)?this._checkIE11bugFix(e,r):e.resolve(r)}else i||e.reject();this.fire("requestdone",{request:e})},_imageLoaded:function(e,r,i){if(e in this.inProgress){var n=function(e){this._resolveRequest(e,r,i)};this.inProgress[e].requests.forEach(n.bind(this)),--this.curCount,delete this.inProgress[e]}t.gmxUtil.loaderStatus(e,!0),this.fire("imageloaded",{url:e}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=r.MAX_COUNT)&&this.requests.length){var e=this.requests.shift(),i=e.url;if(i in this.inProgress)this.inProgress[i].requests.push(e);else{var n=[e];this.inProgress[i]={requests:n},++this.curCount;for(var o=this.requests.length-1;o>=0;o--)this.requests[o].url===i&&(n.push(this.requests[o]),this.requests.splice(o,1));var s=this._loadImage(e);s.width||t.gmxUtil.loaderStatus(i),this.inProgress[i]&&(this.inProgress[i].image=s)}}},_loadImage:function(e){var r=new Image,i=e.url,n=this;return e.options.crossOrigin&&(r.crossOrigin=e.options.crossOrigin),r.onload=this._imageLoaded.bind(this,i,r,!1),r.onerror=function(){n._imageLoaded(i)},t.gmxUtil.isIEOrEdge?setTimeout(function(){r.src=i},0):r.src=i,this.fire("imageloadstart",{url:i}),r},_cancelRequest:function(e){var r,i=e._id,n=e.url,o=0;if(n in this.inProgress){var s=this.inProgress[n],a=s.requests;if(r=a.length,1===r&&a[0]._id===i)s.image.onload=t.Util.falseFn,s.image.onerror=t.Util.falseFn,s.image.src=t.Util.emptyImageUrl,this._imageLoaded(n,null,!0);else for(o=0;r>o;o++)if(a[o]._id===i){a.splice(o,1);break}}else for(o=0,r=this.requests.length;r>o;o++)if(this.requests[o]._id===i){this.requests.splice(o,1);break}this.fire("requestdone",{request:e})},_removeRequestFromCache:function(e){this._cancelRequest(e),this._clearCacheItem(e.url,e._id)},_clearCacheItem:function(e,t){if(this.requestsCache[e]){var r=this.requestsCache[e];delete r.requests[t],0===Object.keys(r.requests).length&&delete this.requestsCache[e]}},_add:function(r,i,n){i=i.replace(/^http:/,t.gmxUtil.protocol);var o="id"+ ++this.uniqueID,s=new e(o,i,n);return i in this.inProgress?this.inProgress[i].requests.push(s):(r?this.requests.unshift(s):this.requests.push(s),this._nextLoad()),this.fire("request",{request:s}),s},push:function(e,t){return this._add(!1,e,t)},unshift:function(e,t){return this._add(!0,e,t)}});t.gmx.imageLoader=new r}();var i={lastMapId:0,fromWebMercY:function(e){return 90*(4*Math.atan(Math.exp(e/i.rMajor))/Math.PI-1)},newId:function(){return i.lastMapId+=1,"_"+i.lastMapId},uniqueGlobalName:function(e){var t=i.newId();return window[t]=e,t},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(e){var r=t.gmxUtil.parseUri(("http"!==e.substr(0,4)?t.gmxUtil.protocol+"//":"")+e);return e=r.host+r.directory,"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e},getLayerItemFromServer:function(e){var r=e.query?e.query:"["+e.field+"]="+e.value,n=t.gmxUtil.protocol+"//maps.kosmosnimki.ru/",o={WrapStyle:"func",geometry:!0,layer:e.layerID,query:r};return e.border&&(o.border=e.border),i.requestJSONP(e.url||(window.serverBase||n)+"VectorLayer/Search.ashx",o,e)},getCadastreFeatures:function(e){if(e.latlng){var t=e.latlng,r={WrapStyle:"func",text:(t.lat+" "+t.lng).replace(/\./g,","),tolerance:e.tolerance||0};return i.requestJSONP(e.url||"http://pkk5.rosreestr.ru/api/features/",r,e)}return null},getFormData:function(e){var t=[];for(var r in e){var i=e[r];t.push(r+"="+("object"==typeof i?JSON.stringify(i):i))}return t.join("&")},requestLink:function(e,r,i){return i=i||{},new Promise(function(n,o){var s=null;if(-1===e.indexOf(".css")){s=document.createElement("script"),s.setAttribute("charset","UTF-8");var a=t.extend({},r,t.gmx.gmxMapManager.syncParams),l=[];for(var u in a)l.push(u+"="+encodeURIComponent(a[u]));var h=e+(-1===e.indexOf("?")?"?":"&")+l.join("&"),c=function(a){t.gmxUtil.loaderStatus(h,!0),s.parentNode.removeChild(s),a?(o(e),console.warn("Not found script:",e)):n(e,r,i)};s.onerror=c,s.onload=function(){c()},t.gmxUtil.loaderStatus(h,null,"vector"),s.setAttribute("src",h)}else s=document.createElement("link"),s.rel="stylesheet",s.type="text/css",s.href=e,n(e,r,i);document.getElementsByTagName("head").item(0).appendChild(s)})},requestJSONP:function(e,r,n){n=n||{};var o=new t.gmx.Deferred,s=document.createElement("script");s.setAttribute("charset","UTF-8");var a="callbackParamName"in n?n.callbackParamName:"CallbackName",l=t.extend({},r,t.gmx.gmxMapManager.syncParams);if(a){var u=i.uniqueGlobalName(function(e){delete window[u],o.resolve(e,n)});l[a]=u}var h=[];for(var c in l)h.push(c+"="+encodeURIComponent(l[c]));var d=e+(-1===e.indexOf("?")?"?":"&")+h.join("&");return s.onerror=function(e){o.reject(e),t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},s.onload=function(){t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},t.gmxUtil.loaderStatus(d,null,"vector"),s.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(s),o},getXmlHttp:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){e=!1}}return e},request:function(e){var r=i.getXmlHttp();if(r){if(r.open(e.type?e.type:"GET",e.url,e.async||!1),e.headers)for(var n in e.headers)r.setRequestHeader(n,e.headers[n]);var o=t.gmxUtil.loaderStatus(e.url);e.async&&(e.withCredentials&&(r.withCredentials=!0),r.onreadystatechange=function(){4===r.readyState&&(t.gmxUtil.loaderStatus(o,!0),200===r.status?(e.callback(r.responseText),r=null):e.onError&&e.onError(r))});var s=null;if(e.params){s=e.params;var a=t.gmx.gmxMapManager.getSyncParams(!0);a&&(s+="&"+a)}return r.send(s),e.async||200!==r.status?!0:(e.callback(r.responseText),t.gmxUtil.loaderStatus(o,!0),r.status)}return e.onError&&e.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(e,t){"z"in e&&(t=e.z);var r=Math.pow(2,t),i=e.x%r+(e.x<0?r:0),n=e.y%r+(e.y<0?r:0);return{z:t,x:i%r-r/2,y:r/2-1-n%r}},getTilePosZoomDelta:function(e,t,r){var i=Math.pow(2,t-r),n=256/i,o=e.x%i,s=e.y%i;return{size:n,zDelta:i,x:n*(0>o?i+o:o),y:n*(0>s?-(1+e.y)%i:i-1-s)}},isItemIntersectBounds:function(e,t){var r=e.type,i=e.coordinates;("POLYGON"===r||"Polygon"===r)&&(i=[i]);for(var n=0,o=i.length;o>n;n++)for(var s=0,a=i[n].length;a>s;s++)if(t.clipPolygon(i[n][s]).length)return!0;return!1},geoItemBounds:function(e){if(!e)return{bounds:null,boundsArr:[]};var t=e.type,r=e.coordinates,n=null,o=0,s=0,a=null,l=[];if("MULTIPOLYGON"===t||"MultiPolygon"===t)for(a=i.bounds(),o=0,s=r.length;s>o;o++){for(var u=[],h=0,c=r[o].length;c>h;h++)n=i.bounds(r[o][h]),u.push(n),0===h&&a.extendBounds(n);l.push(u)}else if("POLYGON"===t||"Polygon"===t)for(a=i.bounds(),o=0,s=r.length;s>o;o++)n=i.bounds(r[o]),l.push(n),0===o&&a.extendBounds(n);else if("POINT"===t||"Point"===t)a=i.bounds([r]);else if("MULTIPOINT"===t||"MultiPoint"===t)for(a=i.bounds(),o=0,s=r.length;s>o;o++)n=i.bounds([r[o]]),a.extendBounds(n);else if("LINESTRING"===t||"LineString"===t)a=i.bounds(r);else if("MULTILINESTRING"===t||"MultiLineString"===t)for(a=i.bounds(),o=0,s=r.length;s>o;o++)n=i.bounds(r[o]),a.extendBounds(n);return{bounds:a,boundsArr:l}},getUnFlattenGeo:function(e){var t=e.type,r=-1!==t.indexOf("POLYGON")||-1!==t.indexOf("Polygon"),n=e.coordinates,o=n;if(r){o=[];var s="POLYGON"===t||"Polygon"===t;s&&(n=[n]);for(var a=0,l=n.length;l>a;a++){for(var u=[],h=0,c=n[a].length;c>h;h++)u[h]=i.unFlattenRing(n[a][h]);o.push(u)}s&&(o=o[0])}return{type:t,coordinates:o}},unFlattenRing:function(e){if("number"!=typeof e[0])return e;for(var t=e.length,r=0,i=new Array(t/2),n=0;t>n;n+=2)i[r++]=[e[n],e[n+1]];return i},geoFlatten:function(e){var t=e.type,r=-1!==t.indexOf("POLYGON")||-1!==t.indexOf("Polygon"),n="POLYGON"===t||"Polygon"===t,o=e.coordinates;if(r){n&&(o=[o]);for(var s=0,a=o.length;a>s;s++)for(var l=0,u=o[s].length;u>l;l++)o[s][l]=i.flattenRing(o[s][l])}},flattenRing:function(e){for(var t=e.length,r=0,i="function"==typeof Float64Array?Float64Array:Array,n=new i(2*t),o=0;t>o;o++)n[r++]=e[o][0],n[r++]=e[o][1];return n},isRectangle:function(e){return!(!e||!e[0]||5!==e[0].length&&4!==e[0].length||e[0][0][0]!==e[0][1][0]&&e[0][0][1]!==e[0][1][1]||e[0][1][0]!==e[0][2][0]&&e[0][1][1]!==e[0][2][1]||e[0][2][0]!==e[0][3][0]&&e[0][2][1]!==e[0][3][1]||e[0][3][0]!==e[0][0][0]&&e[0][3][1]!==e[0][0][1])},getGeometryBounds:function(e){var t=i.geoItemBounds(e);return t.bounds},getMarkerPolygon:function(e,t,r){var i=(e.min.x+e.max.x)/2,n=(e.min.y+e.max.y)/2;return[[i-t,n-r],[i-t,n+r],[i+t,n+r],[i+t,n-r],[i-t,n-r]]},getQuicklookPointsFromProperties:function(e,r){var n=r.tileAttributeIndexes,o={x1:i.getPropItem(r.quicklookX1||("x1"in n?"x1":"X1"),e,n)||0,y1:i.getPropItem(r.quicklookY1||("y1"in n?"y1":"Y1"),e,n)||0,x2:i.getPropItem(r.quicklookX2||("x2"in n?"x2":"X2"),e,n)||0,y2:i.getPropItem(r.quicklookY2||("y2"in n?"y2":"Y2"),e,n)||0,x3:i.getPropItem(r.quicklookX3||("x3"in n?"x3":"X3"),e,n)||0,y3:i.getPropItem(r.quicklookY3||("y3"in n?"y3":"Y3"),e,n)||0,x4:i.getPropItem(r.quicklookX4||("x4"in n?"x4":"X4"),e,n)||0,y4:i.getPropItem(r.quicklookY4||("y4"in n?"y4":"Y4"),e,n)||0},s=i.bounds([[o.x1,o.y1],[o.x2,o.y2],[o.x3,o.y3],[o.x4,o.y4]]);if(s.max.x===s.min.x||s.max.y===s.min.y)return null;if(!r.quicklookPlatform){var a=3857==r.srs?t.CRS.EPSG3857:t.Projection.Mercator,l=a.project(t.latLng(o.y1,o.x1));o.x1=l.x,o.y1=l.y,l=a.project(t.latLng(o.y2,o.x2)),o.x2=l.x,o.y2=l.y,l=a.project(t.latLng(o.y3,o.x3)),o.x3=l.x,o.y3=l.y,l=a.project(t.latLng(o.y4,o.x4)),o.x4=l.x,o.y4=l.y}return o},getPropertiesHash:function(e,t){var r={};for(var i in t)r[i]=e[t[i]];return r},getPropItem:function(e,t,r){return e in r?t[r[e]]:""},dec2rgba:function(e,t){var r=255&e>>16,i=255&e>>8,n=255&e;return"rgba("+r+", "+i+", "+n+", "+t+")"},dec2hex:function(e){return(e+16777216).toString(16).substr(-6)},dec2color:function(e,t){return 1>t?this.dec2rgba(e,t):"#"+this.dec2hex(e)},oneDay:86400,isTileKeysIntersects:function(e,t){if(e.z<t.z){var r=e;e=t,t=r}var i=e.z-t.z;return e.x>>i===t.x&&e.y>>i===t.y},rotatePoints:function(e,t,r,i){var n=[];t*=Math.PI/180;var o=Math.sin(t),s=Math.cos(t);r||(r=1);for(var a=0;a<e.length;a++){var l=r*e[a].x-i.x,u=r*e[a].y-i.y;n.push({x:s*l-o*u+i.x,y:o*l+s*u+i.y})}return n},getPatternIcon:function(e,t,r){if(!t.fillPattern)return null;var n=!0,o=t.fillPattern,s=e?e.properties:null,a=o.step>0?o.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};o.patternStepFunction&&null!==s&&(a=o.patternStepFunction(s,r),n=!1),a>l.maxStep?a=l.maxStep:a<l.minStep&&(a=l.minStep);var u=o.width>0?o.width:8;o.patternWidthFunction&&null!==s&&(u=o.patternWidthFunction(s,r),n=!1),u>l.maxWidth?u=l.maxWidth:u<l.minWidth&&(u=l.minWidth);var h=t.fillOpacity;t.opacityFunction&&null!==s&&(h=t.opacityFunction(s,r)/100,n=!1);var c=[16711680,65280,255],d=null!=o.colors?o.colors:c,m=d.length,f=[],p=0;for(p=0;m>p;p++){var g=d[p];o.patternColorsFunction&&null!==o.patternColorsFunction[p]&&(g=null!==s?o.patternColorsFunction[p](s,r):c[p%3],n=!1),f.push(g)}0===m&&(f=[0],h=0,m=1);var v=u+a,y=v*m,x=0,_=0,b=y,S=y,P=o.style||"horizontal",T=!1;if("diagonal1"===P||"diagonal2"===P||"cross"===P||"cross1"===P?T=!0:"circle"===P?(S=b=2*v,x=Math.floor(S/2),_=2*Math.PI/m):"vertical"===P?b=1:"horizontal"===P&&(S=1),S*b>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var I=document.createElement("canvas");I.width=S,I.height=b;var L=I.getContext("2d");for(L.clearRect(0,0,I.width,I.height),("diagonal2"===P||"vertical"===P)&&(L.translate(S,0),L.rotate(Math.PI/2)),p=0;m>p;p++){L.beginPath();var M=i.dec2color(f[p],h);if(L.fillStyle=M,T){var k=p*v,C=k+u;L.moveTo(k,0),L.lineTo(C,0),L.lineTo(0,C),L.lineTo(0,k),L.lineTo(k,0),k+=y,C=k+u,L.moveTo(k,0),L.lineTo(C,0),L.lineTo(0,C),L.lineTo(0,k),L.lineTo(k,0),("cross"===P||"cross1"===P)&&(k=p*v,C=k+u,L.moveTo(S,k),L.lineTo(S,C),L.lineTo(S-C,0),L.lineTo(S-k,0),L.lineTo(S,k),k+=y,C=k+u,L.moveTo(S,k),L.lineTo(S,C),L.lineTo(S-C,0),L.lineTo(S-k,0),L.lineTo(S,k))}else"circle"===P?(L.arc(x,x,u,p*_,(p+1)*_),L.lineTo(x,x)):L.fillRect(0,p*v,S,u);L.closePath(),L.fill()}var O=document.createElement("canvas");O.width=S,O.height=b;var w=O.getContext("2d");return w.drawImage(I,0,0,S,b),{notFunc:n,canvas:O}},getSVGIcon:function(e){var r='<svg xmlns="'+t.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',i=e.type,n=e.fillStyle||"rgba(255, 255, 255, 0.5)",o=e.strokeStyle||"#0000ff",s=e.lineWidth||2,a={className:"gmx-svg-icon"};e.className&&(a.className=e.className);var l=e.iconSize;if(a.iconSize=[l,l],r+=' height = "'+l+'px"  width = "'+l+'px">',"circle"===i){if(e.fillRadialGradient){r+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var u=e.fillRadialGradient.colorStop||e.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],h=0,c=u.length;c>h;h++){var d=u[h];r+='<stop offset="'+100*d[0]+'%"   stop-color="'+d[1]+'" stop-opacity="'+d[2]+'"/>'}r+="</radialGradient></defs>",n="url(#myRadialGradient4)",o=s=null}l/=2,r+='<g><circle cx="'+l+'" cy="'+l+'" r="'+l+'" style="',n&&(r+=" fill:"+n+";"),o&&(r+=' stroke:"'+o+";"),s&&(r+=' stroke-width:"'+s+";"),r+=';" />'}else"square"===i&&(r+='<g><rect width="'+l+'" height="'+l+'" style="',n&&(r+=" fill:"+n+";"),o&&(r+=" stroke:"+o+";"),s&&(r+=" stroke-width:"+2*s+";"),r+='" />');if(e.text){var m=e.text;r+='<text x="50%" y="50%" dy="0.4em"';for(var f in m)"count"!==f&&(r+=" "+f+'="'+m[f]+'"');r+=">"+m.count+"</text>"}return r+="</g></svg>",a.html=r,new t.DivIcon(a)},toPixels:function(e,t,r,i){var n=e[0]*i;n=.5+n<<0;var o=e[1]*i;return o=.5+o<<0,[n-t,r-o].concat(e.slice(2))},getPixelPoint:function(e,t){var r=e.gmx,n=r.mInPixel,o=e.item,s=o.currentStyle||o.parsedStyleKeys||{},a=e.style||{},l=s.iconScale||1,u=s.iconCenter||!1,h=s.sx||a.sx||4,c=s.sy||a.sy||4,d=s.weight||a.weight||0,m=s.iconAnchor||a.iconAnchor||null,f=e.tpx,p=e.tpy;!u&&m&&(v-=m[0],g-=m[1]),h*=l,c*=l,h+=d,c+=d;var g=p-t[1]*n,v=t[0]*n-f;return v-h>256?v=(t[0]-2*i.worldWidthMerc)*n-f:-h>v&&(v=(t[0]+2*i.worldWidthMerc)*n-f),g-c>256||v-h>256||0>v+h||0>g+c?null:{sx:h,sy:c,px1:.5+v<<0,py1:.5+g<<0}},getImageData:function(e){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return null;var r=document.createElement("canvas"),i=e.width,n=e.height;r.width=i,r.height=n;var o=r.getContext("2d");return o.drawImage(e,0,0),o.getImageData(0,0,i,n).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(e){return e===i.getIEversion()},gtIE:function(e){return e<i.getIEversion()},getIEversion:function(){var e=navigator.userAgent||"",t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var r=e.indexOf("Trident/");if(r>0){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}var n=e.indexOf("Edge/");return n>0?parseInt(e.substring(n+5,e.indexOf(".",n)),10):-1},replaceColor:function(e,r,i){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return e;var n=document.createElement("canvas"),o=e.width,s=e.height;n.width=o,n.height=s;var a,l=!1,u=n.getContext("2d");if("string"==typeof r&&(r=parseInt("0x"+r.replace(/#/,""))),r!==this.DEFAULT_REPLACEMENT_COLOR){var h=255&r>>16,c=255&r>>8,d=255&r;i?a=u.createImageData(o,s):(u.drawImage(e,0,0),a=u.getImageData(0,0,o,s),i=a.data);for(var m=a.data,f=0,p=i.length;p>f;f+=4)255!==i[f]&&238!==i[f]||0!==i[f+1]||255!==i[f+2]||(m[f]=h,m[f+1]=c,m[f+2]=d,m[f+3]=i[f+3],l=!0)}return l?u.putImageData(a,0,0):u.drawImage(e,0,0),n},drawIconPath:function(e,r){if(t.Util.isArray(e)&&!(e.length<3)&&r.ctx){var n=!1,o=r.ctx,s=r.radian;(r.px||r.py)&&(o.translate(r.px||0,r.py||0),n=!0),!s&&r.rotateRes&&(s=Math.PI+i.degRad(r.rotateRes)),s&&(o.rotate(s),n=!0),o.moveTo(e[0],e[1]);for(var a=2,l=e.length;l>a;a+=2)o.lineTo(e[a],e[a+1]);n&&o.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(e){var r=e.gmx,n=e.pointAttr,o=e.style||{},s=e.item,a=s.currentStyle||s.parsedStyleKeys,l=a.iconScale||1,u=a.image,h=n.sx,c=n.sy,d=n.px1,m=n.py1,f=d,p=m,g=e.ctx;if("image"===a.type&&(h=o.sx,c=o.sy,u=o.image),a.iconCenter?(f-=h/2,p-=c/2):"circle"===o.type&&(d+=h/2,m+=c/2),a.iconPath&&(e.px=d,e.py=m,e.rotateRes=a.rotate||0),u)"iconColor"in a&&!t.gmxUtil.isIE11&&(u=this.replaceColor(u,a.iconColor,e.imageData)),o.rotateRes=a.rotate||0,"opacity"in o&&(g.globalAlpha=a.opacity||o.opacity),r.transformFlag?(g.setTransform(r.mInPixel,0,0,r.mInPixel,-e.tpx,e.tpy),g.drawImage(u,d,-m,h,c),g.setTransform(r.mInPixel,0,0,-r.mInPixel,-e.tpx,e.tpy)):(1!==l&&(h*=l,c*=l,d=n.px1,m=n.py1,f=d,p=m,a.iconCenter&&(f-=h/2,p-=c/2)),o.rotateRes?(g.translate(d,m),g.rotate(i.degRad(o.rotateRes)),g.translate(-d,-m),g.drawImage(u,f,p,h,c),g.setTransform(1,0,0,1,0,0)):g.drawImage(u,f,p,h,c)),"opacity"in o&&(g.globalAlpha=1);else if(o.fillColor||a.fillRadialGradient){if(g.beginPath(),a.iconPath)i.drawIconPath(a.iconPath,e);else if("circle"===o.type||a.fillRadialGradient){var v=o.iconSize/2;if(a.fillRadialGradient){var y=a.fillRadialGradient;v=y.r2*l;for(var x=g.createRadialGradient(d+y.x1,m+y.y1,y.r1*l,d+y.x2,m+y.y2,v),_=0,b=y.addColorStop.length;b>_;_++){var S=y.addColorStop[_];x.addColorStop(S[0],S[1])}g.fillStyle=x}g.arc(d,m,v,0,2*Math.PI)}else g.fillRect(f,p,h,c);g.fill()}a.strokeStyle&&(g.beginPath(),a.iconPath?i.drawIconPath(a.iconPath,e):"circle"===o.type?g.arc(d,m,o.iconSize/2,0,2*Math.PI):g.strokeRect(f,p,h,c),g.stroke())},lineToCanvasAsIcon:function(e,t){var r=e.length,n=t.ctx,o=t.item,s=o.currentStyle||o.parsedStyleKeys,a=s.iconPath;if(r>0){"getLineDash"in n&&n.getLineDash().length>0&&n.setLineDash([]),n.beginPath();for(var l,u=0;r>u;u++)l=e[u],i.drawIconPath(a,{ctx:n,px:l.x,py:l.y,radian:l.radian});s.strokeStyle&&n.stroke(),s.fillStyle&&n.fill()}},lineToCanvas:function(e){var t=e.gmx,r=e.coords,n=e.ctx,o=e.item,s=o.currentStyle||o.parsedStyleKeys,a=s.iconPath?[]:null,l=null,u=null;n.beginPath();for(var h=0,c=r.length;c>h;h++){var d=i.toPixels(r[h],e.tpx,e.tpy,t.mInPixel,e.topLeft),m=d[0],f=d[1];(l!==m||u!==f)&&(a&&a.push({x:m,y:f,radian:d[2]}),0===h?n.moveTo(m,f):n.lineTo(m,f),l=m,u=f)}return n.stroke(),a},getCoordsPixels:function(e){for(var t=e.gmx,r=e.coords,n=e.hiddenLines||[],o=[],s=[],a=!1,l={gmx:t,topLeft:e.topLeft,tpx:e.tpx,tpy:e.tpy,coords:null,hiddenLines:null},u=0,h=r.length;h>u;u++){for(var c=r[u],d=n[u]||[],m=[],f=[],p=0,g=c.length;g>p;p++){l.coords=c[p],l.hiddenLines=d[p]||[];var v=i.getRingPixels(l);m.push(v.coords),f.push(v.hidden),v.hidden&&(a=!0)}o.push(m),s.push(f)}return{coords:o,hidden:a?s:null,z:t.currentZoom}},getRingPixels:function(e){if(0===e.coords.length)return null;for(var t=e.gmx,r=t.mInPixel,i=e.coords,n=e.hiddenLines||null,o=e.tpx,s=e.tpy,a=0,l=0,u=null,h=null,c="number"==typeof i[0]?2:1,d=[],m=[],f=0,p=i.length;p>f;f+=c){var g=!1;n&&f===n[l]&&(g=!0,l++);var v=1===c?i[f]:[i[f],i[f+1]],y=Math.round(v[0]*r),x=Math.round(v[1]*r),_=Math.round(y-o),b=Math.round(s-x);(u!==_||h!==b)&&(u=_,h=b,g&&m.push(a),d[a++]=y,d[a++]=x)}return{coords:d,hidden:m.length?m:null}},polygonToCanvas:function(e){if(0===e.coords.length)return null;var t=e.hiddenLines||null,r=e.coords,i=e.ctx,n=e.tpx,o=e.tpy,s=0,a=0,l="number"==typeof r[0]?2:1,u=null,h=null;i.beginPath();for(var c=0,d=r.length;d>c;c+=l){var m=1===l?r[c]:[r[c],r[c+1]],f=Math.round(m[0]-n),p=Math.round(o-m[1]),g=!1,v="round";t&&c===t[a]&&(g=!0,v="butt",a++),i.lineCap!==v&&(i.lineCap=v),(u!==f||h!==p)&&(i[g?"moveTo":"lineTo"](f,p),u=f,h=p,s++)}1===s&&i.lineTo(u+1,h),i.stroke()},polygonToCanvasFill:function(e){if(!(e.coords.length<3)){var t=e.coords,r=e.tpx,i=e.tpy,n=1,o=e.ctx;o.lineWidth=0,"number"==typeof t[0]?(n=2,o.moveTo(Math.round(t[0]-r),Math.round(i-t[1]))):o.moveTo(Math.round(t[0][0]-r),Math.round(i-t[0][1]));for(var s=n,a=t.length;a>s;s+=n){var l=1===n?t[s]:[t[s],t[s+1]];o.lineTo(Math.round(l[0]-r),Math.round(i-l[1]))}}},isPatternNode:function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(e,t){if(t){if(!i.labelCanvasContext){var r=document.createElement("canvas");r.width=r.height=512,i.labelCanvasContext=r.getContext("2d")}var n=i.labelCanvasContext;n.clearRect(0,0,512,512),n.font!==t.font&&(n.font=t.font),n.fillStyle!==t.fillStyle&&(n.fillStyle=t.fillStyle);var o=e.split("\n");return o.map(function(e){return n.fillText(e,0,0),[e,n.measureText(e).width]})}return 0},setLabel:function(e,r,i,n){var o=i[0],s=i[1];e.shadowColor!==n.strokeStyle&&(e.shadowColor=n.strokeStyle),e.shadowBlur!==n.shadowBlur&&(e.shadowBlur=n.shadowBlur),e.font!==n.font&&(e.font=n.font),t.Browser.gecko?e.strokeStyle!==n.fillStyle&&(e.strokeStyle=n.fillStyle):(e.strokeStyle!==n.strokeStyle&&(e.strokeStyle=n.strokeStyle),e.fillStyle!==n.fillStyle&&(e.fillStyle=n.fillStyle)),e.strokeText(r,o,s),t.Browser.gecko||e.fillText(r,o,s)},worldWidthFull:40075016.685578495,rMajor:6378137,degRad:function(e){return e*(Math.PI/180)},distVincenty:function(e,t,r,n){for(var o={lon:i.degRad(e),lat:i.degRad(t)},s={lon:i.degRad(r),lat:i.degRad(n)},a=i.rMajor,l=6356752.3142,u=1/298.257223563,h=s.lon-o.lon,c=Math.atan((1-u)*Math.tan(o.lat)),d=Math.atan((1-u)*Math.tan(s.lat)),m=Math.sin(c),f=Math.cos(c),p=Math.sin(d),g=Math.cos(d),v=h,y=2*Math.PI,x=20;Math.abs(v-y)>1e-12&&--x>0;){var _=Math.sin(v),b=Math.cos(v),S=Math.sqrt(g*_*g*_+(f*p-m*g*b)*(f*p-m*g*b));if(0===S)return 0;var P=m*p+f*g*b,T=Math.atan2(S,P),I=f*g*_/S,L=1-I*I,M=P-2*m*p/L;isNaN(M)&&(M=0);var k=u/16*L*(4+u*(4-3*L));y=v,v=h+(1-k)*u*I*(T+k*S*(M+k*P*(-1+2*M*M)))}if(0===x)return 0/0;var C=L*(a*a/(l*l)-1),O=1+C/16384*(4096+C*(-768+C*(320-175*C))),w=C/1024*(256+C*(-128+C*(74-47*C))),D=w*S*(M+w/4*(P*(-1+2*M*M)-w/6*M*(-3+4*S*S)*(-3+4*M*M))),F=l*O*(T-D);return F},_vfi:function(e,t,r){return[-Math.cos(e)*Math.sin(t)+Math.sin(e)*Math.sin(r)*Math.cos(t),Math.cos(e)*Math.cos(t)+Math.sin(e)*Math.sin(r)*Math.sin(t),-Math.sin(e)*Math.cos(r)]},getCircleLatLngs:function(e,r){var n=0,o=0;if(e instanceof t.LatLng)n=e.lng,o=e.lat;else{if(!t.Util.isArray(e))return null;n=e[1],o=e[0]}for(var s=Math.PI/180,a=n*s,l=o*s,u=i.rMajor,h=u*Math.sin(r/u),c=u*Math.cos(r/u),d=[c*Math.cos(l)*Math.cos(a),c*Math.cos(l)*Math.sin(a),c*Math.sin(l)],m=[],f=0,p=2*Math.PI+1e-6;p>f;f+=s){for(var g=i._vfi(f,a,l),v=[],y=0;3>y;y++)v[y]=d[y]+h*g[y];var x=Math.acos(v[0]/Math.sqrt(v[0]*v[0]+v[1]*v[1]))/s;v[1]<0&&(x=-x),n-180>x?x+=360:x>n+180&&(x-=360),m.push([Math.asin(v[2]/u)/s,x])}return m},parseCoordinates:function(e){var r=null,n=/\(EPSG:(\d+)\)/g,o=n.exec(e);if(o&&(r=o[1],e=e.replace(n,"")),e.match(/[йцукенгшщзхъфывапролджэячсмитьбюЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮqrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(-1===e.indexOf(" ")&&-1===e.indexOf(","))return null;-1!==e.indexOf(" ")&&(e=e.replace(/,/g,"."));var s=[];for(n=/(-?\d+(\.\d+)?)([^\d\-]*)/g,o=n.exec(e);o;)s.push(o[1]),o=n.exec(e);if(s.length<2)return null;var a,l=Math.floor(s.length/2),u=0,h=1;for(a=0;l>a;a++)u+=parseFloat(s[a])*h,h/=60;var c=0;for(h=1,a=l;a<s.length;a++)c+=parseFloat(s[a])*h,h/=60;Math.max(e.indexOf("N"),e.indexOf("S"))>Math.max(e.indexOf("E"),e.indexOf("W"))&&(o=c,c=u,u=o);var d;return 3857==r&&(d=t.Projection.SphericalMercator.unproject(new t.Point(u,c)._divideBy(i.rMajor)),c=d.lng,u=d.lat),(Math.abs(c)>180||Math.abs(u)>180)&&(d=t.Projection.Mercator.unproject(new t.Point(u,c)),c=d.lng,u=d.lat),-1!==e.indexOf("W")&&(c=-c),-1!==e.indexOf("S")&&(u=-u),[u,c]},pad2:function(e){return e>=0&&10>e?"0"+e:""+e},trunc:function(e){return(""+(Math.round(1e7*e)/1e7+1e-8)).substring(0,9)},formatDegrees:function(e,t){e=Math.round(1e7*e)/1e7+1e-8;var r=Math.floor(e),n=Math.floor(60*(e-r)),o=i.toPrecision(3600*(e-r-n/60),2),s=i.pad2(r)+"°";return void 0===t&&(t=2),t>0&&(s+=i.pad2(n)+"'"),t>1&&(s+=i.pad2(o)+'"'),s},latLonFormatCoordinates:function(e,t){return e%=360,e>180?e-=360:-180>e&&(e+=360),i.formatDegrees(Math.abs(t))+(t>0?" N, ":" S, ")+i.formatDegrees(Math.abs(e))+(e>0?" E":" W")
},latLonToString:function(e,t,r){return e%=360,e>180?e-=360:-180>e&&(e+=360),r&&(e=i.toPrecision(e,r),t=i.toPrecision(t,r)),t+(t>0?" N, ":" S, ")+e+(e>0?" E":" W")},formatCoordinates:function(e,t){return i.latLonFormatCoordinates(e,t)},latLonFormatCoordinates2:function(e,t){return i.trunc(Math.abs(t))+(t>0?" N, ":" S, ")+i.trunc(Math.abs(e))+(e>0?" E":" W")},formatCoordinates2:function(e,t){return i.latLonFormatCoordinates2(e,t)},getPixelScale:function(e){return 256/i.tileSizes[e]},forEachPoint:function(e,t){if(!e||0===e.length)return[];var r,n,o=[];if(e[0].length)for(r=0,n=e.length;n>r;r++)"string"!=typeof e[r]&&o.push(i.forEachPoint(e[r],t));else{if(2===e.length)return t(e);for(r=0,n=e.length/2;n>r;r++)o.push(t([e[2*r],e[2*r+1]]))}return o},getItemCenter:function(e,t){var r=e.bounds,n=r.min,o=r.max,s=e.type,a="POINT"===s||"MULTIPOINT"===s,l=a?[n.x,n.y]:[(n.x+o.x)/2,(n.y+o.y)/2];if("MULTIPOLYGON"===s)return l;if("POLYGON"===s)for(var u=0,h=t.length;h>u;u++){var c=t[u],d=c.geo,m=d.coordinates,f=c.dataOption,p=f.bounds;if(p.contains(l)){"POLYGON"===d.type&&(m=[m]);for(var g=0,v=m.length;v>g;g++)for(var y=0,x=m[g],_=x.length;_>y;y++){var b=i.getHSegmentsInPolygon(l[1],x[y]);if(b)return b.max.center}}}else{if("POINT"===s||"MULTIPOINT"===s)return l;if("LINESTRING"===s||"MULTILINESTRING"===s)return l}return null},getHSegmentsInPolygon:function(e,t){var r,i,n,o=[],s=1,a=t[0];"number"==typeof t[0]&&(s=2,a=[t[0],t[1]]);var l=e>a[1];for(r=s,i=t.length;i>r;r+=s){var u=1===s?t[r]:[t[r],t[r+1]],h=e>u[1];l!==h&&o.push(a[0]-(a[0]-u[0])*(a[1]-e)/(a[1]-u[1])),a=u,l=h}if(i=o.length){o=o.sort();var c=0,d=-1;for(r=1;i>r;r+=2){var m=r-1,f=Math.abs(o[r]-o[m]);f>c&&(c=f,d=m)}n={y:e,segArr:o,max:{width:c,center:[(o[d]+o[d+1])/2,e]}}}return n},isPointInPolygonArr:function(e,t){var r=!1,i=e[0],n=e[1],o=1,s=t[0];"number"==typeof t[0]&&(o=2,s=[t[0],t[1]]);for(var a=o,l=t.length;l>a;a+=o){var u=1===o?t[a]:[t[a],t[a+1]],h=Math.min(s[0],u[0]),c=Math.max(s[0],u[0]),d=Math.max(s[1],u[1]);if(i>h&&c>=i&&d>=n&&s[0]!==u[0]){var m=(i-s[0])*(u[1]-s[1])/(u[0]-s[0])+s[1];(s[1]===u[1]||m>=n)&&(r=!r)}s=u}return r},isPointInPolygonWithHoles:function(e,t){if(!i.isPointInPolygonArr(e,t[0]))return!1;for(var r=1,n=t.length;n>r;r++)if(i.isPointInPolygonArr(e,t[r]))return!1;return!0},isClockwise:function(e){for(var t,r=0,i=0,n=e.length;n>i;i++)t=(i+1)%n,r+=e[i][0]*e[t][1],r-=e[t][0]*e[i][1];return 0>r},isPointInPolyLine:function(e,r,i,n){var o=e[0],s=e[1],a={x:o,y:s},l=o-r,u=o+r,h=s-r,c=s+r,d=0;r*=r;for(var m=1,f=i.length;f>m;m++)if(n&&m===n[d])d++;else{var p=i[m-1],g=i[m],v=p[0],y=p[1],x=g[0],_=g[1];if(!(Math.max(v,x)<l||Math.min(v,x)>u||Math.max(y,_)<h||Math.min(y,_)>c)){var b=t.LineUtil._sqClosestPointOnSegment(a,{x:v,y:y},{x:x,y:_},!0);if(r>b)return!0}}return!1},isPointInLines:function(e){for(var t=e.coords,r=e.point,n=e.delta,o=e.boundsArr,s=e.hidden,a=0,l=t.length,u=!1;l>a;a++)if(u=o[a]?o[a].contains(r):!0,u&&i.isPointInPolyLine(r,n,t[a],s?s[a]:null))return!0;return!1},getLength:function(e,r){var n=0;if(e&&e.length){var o=!1,s=!1;r=void 0===r||r,e.forEach(function(e){if(t.Util.isArray(e)){if(t.Util.isArray(e[0]))return n+=i.getLength(e,r);r&&(e=t.Projection.Mercator.unproject({x:e[0],y:e[1]}))}o!==!1&&s!==!1&&(n+=parseFloat(i.distVincenty(o,s,e.lng,e.lat))),o=e.lng,s=e.lat})}return n},prettifyDistance:function(e,r){var i=" "+t.gmxLocale.getText("units.km");return"nm"===r?Math.round(.539956803*e)/1e3+" "+t.gmxLocale.getText("units.nm"):"km"===r?Math.round(e)/1e3+i:2e3>e||"m"===r?Math.round(e)+" "+t.gmxLocale.getText("units.m"):2e5>e?Math.round(e/10)/100+i:Math.round(e/1e3)+i},geoJSONGetLength:function(e){var t,r,n,o,s,a=0;if("GeometryCollection"===e.type?a+=e.geometries.forEach(i.geoJSONGetLength):"Feature"===e.type?a+=i.geoJSONGetLength(e.geometry):"FeatureCollection"===e.type&&(a+=e.features.forEach(i.geoJSONGetLength)),"LineString"===e.type||"MultiLineString"===e.type)for(s=e.coordinates,"LineString"===e.type&&(s=[s]),t=0,n=s.length;n>t;t++)a+=i.getRingLength(s[t]);if("Polygon"===e.type||"MultiPolygon"===e.type)for(s=e.coordinates,"Polygon"===e.type&&(s=[s]),t=0,n=s.length;n>t;t++)for(r=0,o=s[t].length;o>r;r++)a+=i.getRingLength(s[t][r]);return a},getRingLength:function(e){var r=0;if(e&&e.length){var n=!1,o=!1;e.forEach(function(e){return t.Util.isArray(e)&&e.length>2?r+=i.getRingLength(e):(n!==!1&&o!==!1&&(r+=parseFloat(i.distVincenty(n,o,e[0],e[1]))),n=e[0],o=e[1],void 0)})}return r},geoJSONGetArea:function(e){var t=0;if("GeometryCollection"===e.type?t+=e.geometries.forEach(i.geoJSONGetArea):"Feature"===e.type?t+=i.geoJSONGetArea(e.geometry):"FeatureCollection"===e.type&&(t+=e.features.forEach(i.geoJSONGetArea)),"Polygon"===e.type||"MultiPolygon"===e.type){var r=e.coordinates;"Polygon"===e.type&&(r=[r]);for(var n=0,o=r.length;o>n;n++){t+=i.getRingArea(r[n][0]);for(var s=1,a=r[n].length;a>s;s++)t-=i.getRingArea(r[n][s])}}return t},geoJSONGetLatLng:function(e){if("Feature"===e.type)return i.geoJSONGetLatLng(e.geometry);if("Point"===e.type)return t.latLng(e.coordinates[1],e.coordinates[0]);throw new Error("cannot get "+e.type+" latLng")},getRingArea:function(e){for(var t=0,r=0,n=e.length;n>r;r++){var o=r===n-1?0:r+1,s=e[r],a=e[o];t+=s[0]*Math.sin(i.degRad(a[1]))-a[0]*Math.sin(i.degRad(s[1]))}var l=Math.abs(t*i.lambertCoefX*i.lambertCoefY/2);return l},getArea:function(e){for(var t=0,r=0,n=e.length;n>r;r++){var o=r===n-1?0:r+1,s=e[r],a=e[o];t+=s.lng*Math.sin(i.degRad(a.lat))-a.lng*Math.sin(i.degRad(s.lat))}return Math.abs(t*i.lambertCoefX*i.lambertCoefY/2)},prettifyArea:function(e,r){var i=" "+t.gmxLocale.getText("units.km2");return"km2"===r?""+Math.round(e/100)/1e4+i:"ha"===r?""+Math.round(e/100)/100+" "+t.gmxLocale.getText("units.ha"):1e5>e||"m2"===r?Math.round(e)+" "+t.gmxLocale.getText("units.m2"):3e6>e?(""+Math.round(e/1e3)/1e3).replace(".",",")+i:3e7>e?(""+Math.round(e/1e4)/100).replace(".",",")+i:3e8>e?(""+Math.round(e/1e5)/10).replace(".",",")+i:Math.round(e/1e6)+i},geoLength:function(e){var t=0,r=e.type;if("MULTILINESTRING"===r||"MultiLineString"===r){for(var n=0,o=e.coordinates.length;o>n;n++)t+=i.geoLength({type:"LINESTRING",coordinates:e.coordinates[n]});return t}return("LINESTRING"===r||"LineString"===r)&&(t=i.getLength(e.coordinates)),t},geometryToGeoJSON:function(e,t,r){if(!e)return null;var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return t&&(o=i.coordsFromMercator(n,o,r)),{type:n,coordinates:o}},convertGeometry:function(e,t,r){var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return o=t?i.coordsFromMercator(n,o,r):i.coordsToMercator(n,o,r),{type:e.type,coordinates:o}},geoJSONtoGeometry:function(e,t){if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);if("Feature"===e.type)return i.geoJSONtoGeometry(e.geometry,t);if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);var r="MultiPolygon"===e.type?"MULTIPOLYGON":"Polygon"===e.type?"POLYGON":"MultiLineString"===e.type?"MULTILINESTRING":"LineString"===e.type?"LINESTRING":"MultiPoint"===e.type?"MULTIPOINT":"Point"===e.type?"POINT":e.type,n=e.coordinates;return t&&(n=i.coordsToMercator(e.type,n)),{type:r,coordinates:n}},_coordsConvert:function(e,r,n,o){var s,a,l,u=[];if("Point"===e)n?(l=(o?t.CRS.EPSG3857:t.Projection.Mercator).project({lat:r[1],lng:r[0]}),u=[l.x,l.y]):(l=t.Projection.Mercator.unproject({y:r[1],x:r[0]}),u=[l.lng,l.lat],o&&(u[1]=i.fromWebMercY(r[1])));else if("LineString"===e||"MultiPoint"===e)for(s=0,a=r.length;a>s;s++)u.push(i._coordsConvert("Point",r[s],n,o));else if("Polygon"===e||"MultiLineString"===e)for(s=0,a=r.length;a>s;s++)u.push(i._coordsConvert("MultiPoint",r[s],n,o));else if("MultiPolygon"===e)for(s=0,a=r.length;a>s;s++)u.push(i._coordsConvert("Polygon",r[s],n,o));return u},coordsFromMercator:function(e,t,r){return i._coordsConvert(e,t,!1,r)},coordsToMercator:function(e,t,r){return i._coordsConvert(e,t,!0,r)},transformGeometry:function(e,t){return e?{type:e.type,coordinates:i.forEachPoint(e.coordinates,function(e){return t(e)})}:e},geoArea:function(e,r){var n,o,s=0,a=e.type||"";if(r=void 0===r||r,"MULTIPOLYGON"===a||"MultiPolygon"===a){for(n=0,o=e.coordinates.length;o>n;n++)s+=i.geoArea({type:"POLYGON",coordinates:e.coordinates[n]},r);return s}if("POLYGON"===a||"Polygon"===a){for(s=i.geoArea(e.coordinates[0],r),n=1,o=e.coordinates.length;o>n;n++)s-=i.geoArea(e.coordinates[n],r);return s}if(e.length){var l=[],u="number"==typeof e[0]?2:1;for(n=0,o=e.length;o>n;n+=u){var h=1===u?e[n]:[e[n],e[n+1]];l.push(r?t.Projection.Mercator.unproject({y:h[1],x:h[0]}):{lat:h[1],lng:h[0]})}return i.getArea(l)}return 0},getGeoJSONSummary:function(e,t){var r,n,o,s=e.type,a=t||{},l=0;if("Point"===s)o=e.coordinates,l=i.formatCoordinates(o[0],o[1]);else if("Polygon"===s)l=i.prettifyArea(i.geoArea(e,!1),a.squareUnit);else if("MultiPolygon"===s){for(o=e.coordinates,r=0,n=o.length;n>r;r++)l+=i.geoArea({type:"Polygon",coordinates:o[r]},!1);l=i.prettifyArea(l,a.squareUnit)}else if("LineString"===s)l=i.prettifyDistance(i.geoJSONGetLength(e),a.distanceUnit);else if("MultiLineString"===s){for(o=e.coordinates,r=0,n=o.length;n>r;r++)l+=i.geoJSONGetLength({type:"LineString",coordinates:o[r]});l=i.prettifyDistance(l,a.distanceUnit)}return l},getCoordinatesString:function(e,r){var n,o=e.lng,s=e.lat,a=["",""," (EPSG:3395)"," (EPSG:3857)"],l=a.length,u="";return r=r||0,o>180&&(o-=360),-180>o&&(o+=360),0===r%l?u=i.formatCoordinates2(o,s):1===r%l?u=i.formatCoordinates(o,s):2===r%l?(n=t.Projection.Mercator.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[2]):(n=t.CRS.EPSG3857.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[3]),u},getGeometriesSummary:function(e,r){var n="",o="",s=0;return r||(r={}),e&&e.forEach(function(e){if(e){o=e.type.toUpperCase();var a=t.gmxUtil.geometryToGeoJSON(e,!0,3857==r.srs);if(-1!==o.indexOf("POINT")){var l=t.latLng(a.coordinates.reverse());n="<b>"+t.gmxLocale.getText("Coordinates")+"</b>: "+i.getCoordinatesString(l,r.coordinatesFormat)}else-1!==o.indexOf("LINESTRING")?s+=i.geoJSONGetLength(a):-1!==o.indexOf("POLYGON")&&(s+=i.geoJSONGetArea(a))}}),n||(-1!==o.indexOf("LINESTRING")?n="<b>"+t.gmxLocale.getText("Length")+"</b>: "+i.prettifyDistance(s,r.distanceUnit):-1!==o.indexOf("POLYGON")&&(n="<b>"+t.gmxLocale.getText("Area")+"</b>: "+i.prettifyArea(s,r.squareUnit))),n},getGeometrySummary:function(e,t){return i.getGeometriesSummary([e],t||{})},chkOnEdge:function(e,t,r){return e[0]<r.min.x&&t[0]<r.min.x||e[0]>r.max.x&&t[0]>r.max.x?!0:e[1]<r.min.y&&t[1]<r.min.y||e[1]>r.max.y&&t[1]>r.max.y?!0:!1},getHidden:function(e,t){for(var r=[],n="number"==typeof e[0]?2:1,o=null,s=0,a=e.length;a>s;s+=n){var l=1===n?e[s]:[e[s],e[s+1]];o&&i.chkOnEdge(l,o,t)&&r.push(s),o=l}return r},getNormalizeBounds:function(e,r){var n=e.getNorthWest(),o=e.getSouthEast(),s=n.lng,a=o.lng,l=(a-s)/2,u=null,h=null,c=[];if(l>=180)s=-180,a=180;else if(a>180||-180>s){var d=(a+s)/2%360;d>180?d-=360:-180>d&&(d+=360),s=d-l,a=d+l,-180>s?(u=s+360,h=180,s=-180):a>180&&(u=-180,h=a-360,a=180)}var m={x:s,y:o.lat},f={x:a,y:n.lat};if(void 0!==r&&(m=t.Projection.Mercator.project(new t.LatLng([o.lat,s])),f=t.Projection.Mercator.project(new t.LatLng([n.lat,a])),m.y-=r,f.y-=r),c.push(i.bounds([[m.x,m.y],[f.x,f.y]])),u){var p={x:u,y:o.lat},g={x:h,y:n.lat};void 0!==r&&(p=t.Projection.Mercator.project(new t.LatLng([o.lat,u])),g=t.Projection.Mercator.project(new t.LatLng([n.lat,h])),p.y-=r,g.y-=r),c.push(i.bounds([[p.x,p.y],[g.x,g.y]]))}return c},toPrecision:function(e,t){var r=Math.pow(10,t?t:4);return Math.round(r*e)/r},getBoundsByTilePoint:function(e){var t=i.tileSizes[e.z],r=e.x*t-i.worldWidthMerc,n=i.worldWidthMerc-e.y*t;return i.bounds([[r,n-t],[r+t,n]])},getTileBounds:function(e,t,r){var n=i.tileSizes[r],o=e*n,s=t*n;return i.bounds([[o,s],[o+n,s+n]])},parseTemplate:function(e,t){var r=e.match(/\[([^\]]+)\]/gi);if(r)for(var i=0,n=r.length;n>i;i++){var o=r[i],s=o.substr(1,o.length-2),a=s in t?t[s]:"";e=e.replace(o,a)}return e},getDefaultBalloonTemplate:function(e,t){var r="";for(var i in e)(!t||i in t)&&(r+="<b>"+i+":</b> ["+i+"]<br />");return r+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(e,r){var n=r.properties;e||(e=i.getDefaultBalloonTemplate(n,r.tileAttributeTypes));var o=e.match(/\[([^\]]+)\]/gi);if(o)for(var s=r.tileAttributeTypes,a=r.unitOptions,l=r.geometries,u=0,h=o.length;h>u;u++){var c=o[u],d=c.substr(1,c.length-2),m="";d in n?m=t.gmxUtil.attrToString(s[d],n[d]):"SUMMARY"===d&&(m=r.summary||t.gmxUtil.getGeometriesSummary(l,a)),e=e.replace(c,m)}return e},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(e){var r=i.defaultStyles,n=t.extend({},r);return n.RenderStyle=r.RenderStyle[e],n},toServerStyle:function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,s=n.client.length;s>o;o++){var a=n.client[o];if(a in e){t[r]||(t[r]={});var l=e[a];("opacity"===a||"fillOpacity"===a)&&(l*=100),t[r][n.server[o]]=l}}return"iconAnchor"in e&&(t.marker||(t.marker={}),t.marker.dx=-e.iconAnchor[0],t.marker.dy=-e.iconAnchor[1]),t},fromServerStyle:function(e){var r,n,o,s,a,l={type:""};for(s in i.styleKeys){var u=i.styleKeys[s];for(n=0,o=u.client.length;o>n;n++)a=u.client[n],a in e&&(l[a]=e[a]);if(r=e[s],r&&"object"==typeof r)for(n=0,o=u.server.length;o>n;n++)if(a=u.server[n],a in r){var h=u.client[n],c=r[a];if("string"==typeof c){if(i.styleFuncKeys[h])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=t.gmx.Parsers.parseExpression(c);null===d?c=i.styleFuncError[h]():l[i.styleFuncKeys[h]]=d}}else"opacity"===a&&(c/=100);l[h]=c}}if(e.marker&&(r=e.marker,"dx"in r||"dy"in r)){var m=r.dx||0,f=r.dy||0;l.iconAnchor=[-m,-f]}for(s in e)i.styleKeys[s]||(l[s]=e[s]);return l},getUnixTimeFromStr:function(e){var r=t.Util.trim(e).split(" "),i=r[0].split("."),n=r[1]?r[1].split(":"):[0,0,0];return 4===i[2].length&&(i=i.reverse()),Date.UTC(i[0],i[1]-1,i[2],n[0]||0,n[1]||0,n[2]||0)/1e3},getDateFromStr:function(e){var r=t.Util.trim(e).split(" ");r=r[0].split("."),4===r[2].length&&(r=r.reverse());var i=new Date(r[0],r[1]-1,r[2]);return i},getUTCdate:function(e){var t=new Date(1e3*e);return[t.getUTCFullYear(),i.pad2(t.getUTCMonth()+1),i.pad2(t.getUTCDate())].join(".")},getUTCtime:function(e){var t=Math.floor(e/3600),r=Math.floor((e-3600*t)/60),n=Math.floor(e-3600*t-60*r);return[i.pad2(t),i.pad2(r),i.pad2(n)].join(":")},getUTCdateTime:function(e){var t=e%86400;return t?[i.getUTCdate(e),i.getUTCtime(e%86400)].join(" "):i.getUTCdate(e)},attrToString:function(e,r){return"date"===e?r?t.gmxUtil.getUTCdate(r):r:"time"===e?r?t.gmxUtil.getUTCtime(r):r:"datetime"===e?r?t.gmxUtil.getUTCdateTime(r):r:r},getTileAttributes:function(e){var t={},r={};if(e.attributes){var i=e.attributes,n=e.attrTypes||null;e.identityField&&(t[e.identityField]=0);for(var o=0;o<i.length;o++){var s=i[o];t[s]=o+1,r[s]=n?n[o]:"string"}}return{tileAttributeTypes:r,tileAttributeIndexes:t}}};i.lambertCoefX=100*i.distVincenty(0,0,.01,0),i.lambertCoefY=180*100*i.distVincenty(0,0,0,.01)/Math.PI,function(){for(var e=0;30>e;e++)i.tileSizes[e]=i.worldWidthFull/Math.pow(2,e)}(),i.worldWidthMerc=i.worldWidthFull/2,i.Bounds=function(e){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(e)},i.Bounds.prototype={extend:function(e,t){return e<this.min.x&&(this.min.x=e),e>this.max.x&&(this.max.x=e),t<this.min.y&&(this.min.y=t),t>this.max.y&&(this.max.y=t),this},extendBounds:function(e){return this.extendArray([[e.min.x,e.min.y],[e.max.x,e.max.y]])},extendArray:function(e){if(!e||!e.length)return this;var t,r;if("number"==typeof e[0])for(t=0,r=e.length;r>t;t+=2)this.extend(e[t],e[t+1]);else for(t=0,r=e.length;r>t;t++)this.extend(e[t][0],e[t][1]);return this},addBuffer:function(e,t,r,i){return this.min.x-=e,this.min.y-=t||e,this.max.x+=r||e,this.max.y+=i||t||e,this},contains:function(e){var t=this.min,r=this.max,i=e[0],n=e[1];return i>=t.x&&i<=r.x&&n>=t.y&&n<=r.y},getCenter:function(){var e=this.min,t=this.max;return[(e.x+t.x)/2,(e.y+t.y)/2]},addOffset:function(e){return this.min.x+=e[0],this.max.x+=e[0],this.min.y+=e[1],this.max.y+=e[1],this},intersects:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x>t.x&&i.x<r.x&&n.y>t.y&&i.y<r.y},intersectsWithDelta:function(e,t,r){var i=this.min,n=this.max,o=t||0,s=r||0,a=e.min,l=e.max;return l.x+o>i.x&&a.x-o<n.x&&l.y+s>i.y&&a.y-s<n.y},isEqual:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x===r.x&&i.x===t.x&&n.y===r.y&&i.y===t.y},isNodeIntersect:function(e){for(var t=0,r=e.length;r>t;t++)if(this.contains(e[t]))return{num:t,point:e[t]};return null},clipPolygon:function(e,r){if(e.length){var i,n,o,s,a,l,u,h,c,d=[1,4,2,8];if(t.LineUtil.isFlat(e)){var m=e;e=m.map(function(e){return new t.Point(e[0],e[1],r)})}for(n=0,u=e.length;u>n;n++)e[n]._code=this._getBitCode(e[n]);for(s=0;4>s;s++){for(h=d[s],i=[],n=0,u=e.length,o=u-1;u>n;o=n++)a=e[n],l=e[o],a._code&h?l._code&h||(c=this._getEdgeIntersection(l,a,h,r),c._code=this._getBitCode(c),i.push(c)):(l._code&h&&(c=this._getEdgeIntersection(l,a,h,r),c._code=this._getBitCode(c),i.push(c)),i.push(a));e=i}}return e.map(function(e){return[e.x,e.y]})},_getBitCode:function(e){var t=0;return e.x<this.min.x?t|=1:e.x>this.max.x&&(t|=2),e.y<this.min.y?t|=4:e.y>this.max.y&&(t|=8),t},_getEdgeIntersection:function(e,r,i,n){var o,s,a=r.x-e.x,l=r.y-e.y,u=this.min,h=this.max;return 8&i?(o=e.x+a*(h.y-e.y)/l,s=h.y):4&i?(o=e.x+a*(u.y-e.y)/l,s=u.y):2&i?(o=h.x,s=e.y+l*(h.x-e.x)/a):1&i&&(o=u.x,s=e.y+l*(u.x-e.x)/a),new t.Point(o,s,n)},clipPolyLine:function(e,t,r){r=r||0;var i,n,o,s,a,l,u=this.min,h=this.max,c=[u.x-r,u.y-r,h.x+r,h.y+r],d=function(e){var t=0;return e[0]<c[0]?t|=1:e[0]>c[2]&&(t|=2),e[1]<c[1]?t|=4:e[1]>c[3]&&(t|=8),t},m=function(e,t){return Math.PI/2+Math.atan2(t[1]-e[1],e[0]-t[0])},f=function(e,t,r){return 8&r?[e[0]+(t[0]-e[0])*(c[3]-e[1])/(t[1]-e[1]),c[3]]:4&r?[e[0]+(t[0]-e[0])*(c[1]-e[1])/(t[1]-e[1]),c[1]]:2&r?[c[2],e[1]+(t[1]-e[1])*(c[2]-e[0])/(t[0]-e[0])]:1&r?[c[0],e[1]+(t[1]-e[1])*(c[0]-e[0])/(t[0]-e[0])]:null},p=[],g=e.length,v=d(e[0],c),y=[];for(i=1;g>i;i++)if(n=e[i-1],o=e[i],n[0]!==o[0]||n[1]!==o[1]){for(a=l=d(o,c);;){if(!(v|a)){t&&(n[2]=m(n,o),s=e[i+1],o[2]=s?m(o,s):n[2]),y.push(n),a!==l?(y.push(o),g-1>i&&(p.push(y),y=[])):i===g-1&&y.push(o);break}if(v&a)break;v?(n=f(n,o,v,c),v=d(n,c)):(o=f(n,o,a,c),a=d(o,c))}v=l}return y.length&&p.push(y),p},toLatLngBounds:function(e){var r=t.Projection.Mercator,n=r.unproject(this.min),o=r.unproject(this.max),s=[[n.lat,n.lng],[o.lat,o.lng]];return e&&(s[0][0]=i.fromWebMercY(this.min.y),s[1][0]=i.fromWebMercY(this.max.y)),t.latLngBounds(s)}},i.bounds=function(e){return new i.Bounds(e)},i.parseUri=function(e){for(var t=i.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n.hostOnly=n.host,n.host=n.authority,n},i.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},t.gmxUtil||(t.gmxUtil={}),t.extend(t.gmxUtil,{newId:i.newId,isPageHidden:i.isPageHidden,protocol:"https:"!==location.protocol?"http:":location.protocol,loaderStatus:function(){},isIE9:i.isIE(9),isIE10:i.isIE(10),isIE11:i.isIE(11),gtIE11:i.gtIE(11),getFormData:i.getFormData,requestJSONP:i.requestJSONP,requestLink:i.requestLink,getCadastreFeatures:i.getCadastreFeatures,request:i.request,getLayerItemFromServer:i.getLayerItemFromServer,fromServerStyle:i.fromServerStyle,toServerStyle:i.toServerStyle,getDefaultStyle:i.getDefaultStyle,bounds:i.bounds,getNormalizeBounds:i.getNormalizeBounds,getGeometryBounds:i.getGeometryBounds,tileSizes:i.tileSizes,getDateFromStr:i.getDateFromStr,getUnixTimeFromStr:i.getUnixTimeFromStr,getUTCdate:i.getUTCdate,getUTCtime:i.getUTCtime,getUTCdateTime:i.getUTCdateTime,attrToString:i.attrToString,getTileAttributes:i.getTileAttributes,formatCoordinates:function(e,t){return i["formatCoordinates"+(t?"2":"")](e.lng,e.lat)},formatDegrees:i.formatDegrees,pad2:i.pad2,dec2hex:i.dec2hex,dec2rgba:i.dec2rgba,trunc:i.trunc,latLonFormatCoordinates:i.latLonFormatCoordinates,latLonFormatCoordinates2:i.latLonFormatCoordinates2,latLonToString:i.latLonToString,toPrecision:i.toPrecision,getLength:i.getLength,geoLength:i.geoLength,prettifyDistance:i.prettifyDistance,getArea:i.getArea,prettifyArea:i.prettifyArea,geoArea:i.geoArea,parseBalloonTemplate:i.parseBalloonTemplate,getSVGIcon:i.getSVGIcon,getCoordinatesString:i.getCoordinatesString,getGeometriesSummary:i.getGeometriesSummary,getGeometrySummary:i.getGeometrySummary,getGeoJSONSummary:i.getGeoJSONSummary,getPropertiesHash:i.getPropertiesHash,distVincenty:i.distVincenty,parseCoordinates:i.parseCoordinates,geometryToGeoJSON:i.geometryToGeoJSON,coordsFromMercator:i.coordsFromMercator,convertGeometry:i.convertGeometry,transformGeometry:i.transformGeometry,geoJSONtoGeometry:i.geoJSONtoGeometry,geoJSONGetArea:i.geoJSONGetArea,geoJSONGetLength:i.geoJSONGetLength,geoJSONGetLatLng:i.geoJSONGetLatLng,fromWebMercY:i.fromWebMercY,parseUri:i.parseUri,isRectangle:i.isRectangle,isClockwise:i.isClockwise,isPointInPolygonWithHoles:i.isPointInPolygonWithHoles,getPatternIcon:i.getPatternIcon,getCircleLatLngs:i.getCircleLatLngs,normalizeHostname:i.normalizeHostname,getTileBounds:i.getTileBounds,getBoundsByTilePoint:i.getBoundsByTilePoint,parseTemplate:i.parseTemplate}),t.gmxUtil.isIEOrEdge=t.gmxUtil.gtIE11||t.gmxUtil.isIE11||t.gmxUtil.isIE10||t.gmxUtil.isIE9,function(){function e(e,o,s){var a="gmxAPIutils_id"+n++,l=t.DomUtil.create("iframe");l.style.display="none",l.setAttribute("id",e),l.setAttribute("name",e),l.src="javascript:true",l.callbackName=a;var u=i.parseUri(s),h=(u.protocol?u.protocol+":":t.gmxUtil.protocol)+"//"+(u.host||window.location.host);return r[h]=r[h]||{},r[h][a]={callback:o,iframe:l},l}var r={},n=0,o=function(e){if(e.origin in r){var t=decodeURIComponent(e.data.replace(/\n/g,"\n\\"));try{var i=JSON.parse(t)}catch(n){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:t}})}var o=r[e.origin][i.CallbackName];o&&(delete r[e.origin][i.CallbackName],delete i.CallbackName,o.iframe.parentNode&&o.iframe.parentNode.removeChild(o.iframe),"callback"in o&&o.callback(i))}};t.DomEvent.on(window,"message",o),i.createPostIframe2=e}(),function(){function e(e,r,n,o){var s,a,l="$$iframe_"+i.newId(),u=i.createPostIframe2(l,n,e);if(o)s=o,a=s.getAttribute("action"),s.setAttribute("action",e),s.target=l;else if(t.Browser.ielt9){var h="<form id="+l+'" enctype="multipart/form-data" style="display:none" target="'+l+'" action="'+e+'" method="post"></form>';s=document.createElement(h)}else s=document.createElement("form"),s.style.display="none",s.setAttribute("enctype","multipart/form-data"),s.target=l,s.setAttribute("method","POST"),s.setAttribute("action",e),s.id=l;var c=document.createElement("div");c.style.display="none","window"===r.WrapStyle&&(r.WrapStyle="message"),"message"===r.WrapStyle&&(r.CallbackName=u.callbackName);for(var d in r){var m=document.createElement("input"),f="undefined"!=typeof r[d]?r[d]:"";m.setAttribute("type","hidden"),m.setAttribute("name",d),m.setAttribute("value",f),c.appendChild(m)}s.appendChild(c),o||document.body.appendChild(s),document.body.appendChild(u),s.submit(),o?(s.removeChild(c),null!==a?s.setAttribute("action",a):s.removeAttribute("action")):s.parentNode.removeChild(s)}t.gmxUtil.sendCrossDomainPostRequest=i.sendCrossDomainPostRequest=e}();var n=["strokeStyle","fillStyle","lineWidth"],o=n.length,s=i,a=function(e,t,r,i){for(var a=0;o>a;a++){var l=n[a],u=i[l];u!==r[l]&&(r[l]=u)}if(i.dashArray){var h=i.dashArray,c=i.dashOffset||0;"setLineDash"in r&&(r.setLineDash(h),r.lineDashOffset!==c&&(r.lineDashOffset=c))}else"getLineDash"in r&&r.getLineDash().length>0&&r.setLineDash([]);if("round"!==r.lineCap&&(r.lineCap="round"),"round"!==r.lineJoin&&(r.lineJoin="round"),i.canvasPattern)r.fillStyle=r.createPattern(i.canvasPattern.canvas,"repeat");else if(i.fillLinearGradient){for(var d=i.fillLinearGradient,m=d.x1Function?d.x1Function(e,t):d.x1,f=d.y1Function?d.y1Function(e,t):d.y1,p=d.x2Function?d.x2Function(e,t):d.x2,g=d.y2Function?d.y2Function(e,t):d.y2,v=r.createLinearGradient(m,f,p,g),y=0,x=d.addColorStop.length;x>y;y++){var _=d.addColorStop[y],b=d.addColorStopFunctions[y],S=b[0]?b[0](e,t):_[0],P=_.length<3?100:b[2]?b[2](e,t):_[2],T=s.dec2color(b[1]?b[1](e,t):_[1],P>1?P/100:P);v.addColorStop(S,T)}r.fillStyle=i.fillStyle=v}};t.gmxUtil.drawGeoItem=function(e,r,n,o,l){var u,h,c,d,m=e.properties,f=m[0],p=n.gmx,g=n.ctx,v=m[m.length-1],y=null,x=e.dataOption,_=n.rasters||{},b=n.tbounds;if(r.currentStyle=t.extend({},o),l){if(p.styleHook){if(e.styleExtend||(e.styleExtend=p.styleHook(r,p.lastHover&&f===p.lastHover.id)),!e.styleExtend)return!1;"number"==typeof e.styleExtend.strokeStyle&&(e.styleExtend.strokeStyle=i.dec2color(e.styleExtend.strokeStyle,1)),"number"==typeof e.styleExtend.fillStyle&&(e.styleExtend.fillStyle=i.dec2color(e.styleExtend.fillStyle,1)),r.currentStyle=t.extend(r.currentStyle,e.styleExtend)}a(m,p.tileAttributeIndexes,g,r.currentStyle)}else l={};var S=v.type.toUpperCase(),P={gmx:p,item:r,style:l,styleExtend:e.styleExtend||{},ctx:g,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy};if("POINT"===S&&(P.pointAttr=s.getPixelPoint(P,v.coordinates),!P.pointAttr))return!1;if("POINT"===S||"MULTIPOINT"===S)if(y=v.coordinates,"iconColor"in l&&l.image&&!t.gmxUtil.isIE11&&(l.lastImage!==l.image&&(l.lastImage=l.image,l.lastImageData=s.getImageData(l.image)),P.imageData=l.lastImageData),"MULTIPOINT"===S)for(u=0,h=y.length;h>u;u++)P.coords=y[u],s.pointToCanvas(P);else P.coords=y,s.pointToCanvas(P);else if("POLYGON"===S||"MULTIPOLYGON"===S)if(l.image)P.coords=[(x.bounds.min.x+x.bounds.max.x)/2,(x.bounds.min.y+x.bounds.max.y)/2],P.pointAttr=s.getPixelPoint(P,P.coords),P.pointAttr&&s.pointToCanvas(P);else{y=v.coordinates,"POLYGON"===S&&(y=[y]);var T=x.hiddenLines||[],I=x.pixels,L=!0;I&&I.z===p.currentZoom||(I=x.pixels=s.getCoordsPixels({gmx:p,coords:y,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy,hiddenLines:T}));var M=function(e,t){for(y=I.coords,T=I.hidden||[],P.flagPixels=L,u=0,h=y.length;h>u;u++){var r=y[u],i=T[u]||[];for(g.beginPath(),c=0,d=r.length;d>c;c++)P.coords=r[c],P.hiddenLines=i[c]||[],e(P);g.closePath(),t&&g.fill()}},k=r.currentStyle.strokeStyle||l.strokeStyle,C=r.currentStyle.lineWidth||l.lineWidth;k&&C&&M(s.polygonToCanvas),n.bgImage?P.bgImage=n.bgImage:_[f]&&(P.bgImage=_[f]),(P.styleExtend.skipRasters||r.skipRasters)&&delete P.bgImage,l.imagePattern?r.currentStyle.fillStyle=g.createPattern(l.imagePattern,"repeat"):P.bgImage&&b.intersectsWithDelta(x.bounds,-1,-1)&&(s.isPatternNode(P.bgImage)&&("rasterOpacity"in p&&(g.globalAlpha=p.rasterOpacity),g.fillStyle=g.createPattern(P.bgImage,"no-repeat"),l.bgImage=!0),M(s.polygonToCanvasFill,!0),g.globalAlpha=1),(r.currentStyle.fillStyle||r.currentStyle.canvasPattern)&&(g.fillStyle=r.currentStyle.canvasPattern||r.currentStyle.fillStyle,M(s.polygonToCanvasFill,!0))}else if("LINESTRING"===S||"MULTILINESTRING"===S){y=v.coordinates,"LINESTRING"===S&&(y=[y]);var O=r.currentStyle||r.parsedStyleKeys,w=O.iconPath||O.iconPath,D=(r.currentStyle.maxSize||r.currentStyle.lineWidth)/p.mInPixel;for(u=0,h=y.length;h>u;u++)if(w){var F=b.clipPolyLine(y[u],!0,D);for(c=0,d=F.length;d>c;c++){P.coords=F[c];var R=s.lineToCanvas(P);R&&(g.save(),s.lineToCanvasAsIcon(R,P),g.restore())}}else P.coords=y[u],s.lineToCanvas(P)}return!0};var l={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var e=this;if(this._scriptSearched)return this._scriptAPIKey;for(var t=document.getElementsByTagName("script"),r=0;r<t.length;r++){for(var i=t[r].getAttribute("src"),n=this.SCRIPT_REGEXP,o=0,s=n.length;s>o;o++)if(n[o].exec(i)){var a=i.split("?")[1];if(a)for(var l=a.split("&"),u=0;u<l.length;u++){var h=l[u].split("=");if(h[0]===e.APIKEY_PARAM){e._scriptAPIKey=h[1];break}}break}if(e._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(e,r){var n=this._sessionKeys;return e in n||(r="undefined"==typeof r?this._searchScriptAPIKey():r,n[e]=new Promise(function(n,o){r?i.requestJSONP(t.gmxUtil.protocol+"//"+e+"/ApiKey.ashx",{WrapStyle:"func",Key:r}).then(function(e){e&&"ok"===e.Status?n(e.Result.Key):o()},o):n("")})),n[e]},getSessionKey:function(e){return this._sessionKeys[e]},_sessionKeys:{}};t.gmx=t.gmx||{},t.gmx.gmxSessionManager=l;var u={getMap:function(e,t,r,i,n){return u.loadMapProperties({srs:n,hostName:e,apiKey:t,mapName:r,skipTiles:i})},loadMapProperties:function(e){var r=this._maps,n=e.hostName||e.serverHost,o=e.mapName;if(!r[n]||!r[n][o]){var s={WrapStyle:"func",skipTiles:e.skipTiles||"None",MapName:o,srs:e.srs||3857,ftc:e.ftc||"osm",ModeKey:"map"},a=new Promise(function(r,a){l.requestSessionKey(n,e.apiKey).then(function(e){s.key=e,i.requestJSONP(t.gmxUtil.protocol+"//"+n+"/TileSender.ashx",s).then(function(i){i&&"ok"===i.Status&&i.Result?(i.Result.properties.hostName=n,i.Result.properties.sessionKey=e,t.gmx._maps[n]=t.gmx._maps[n]||{},t.gmx._maps[n][o]={_rawTree:i.Result,_nodes:{}},r(i.Result)):a(i)},a)},a)});r[n]=r[n]||{},r[n][o]={promise:a}}return r[n][o].promise},syncParams:{},setSyncParams:function(e){this.syncParams=e},getSyncParams:function(e){var t=this.syncParams;if(e){var r=[];for(var i in t)r.push(i+"="+t[i]);t=r.join("&")}return t},findLayerInfo:function(e,r,i){var n=t.gmx._maps[e],o=null;if(n&&n[r]){var s=n[r];s._nodes[i]||u.iterateNode(s._rawTree,function(e){s._nodes[e.content.properties.name]=e}),o=s._nodes[i]}return o?o.content:null},iterateLayers:function(e,t){var r=function(e){for(var i=0,n=e.length;n>i;i++){var o=e[i];"group"===o.type?r(o.content.children):"layer"===o.type&&t(o.content)}};
e&&r(e.children)},iterateNode:function(e,t){var r=function(e){for(var i=e.children,n=0,o=i.length;o>n;n++){var s=i[n];t(s),"group"===s.type&&r(s.content)}};e&&r(e)},_maps:{}};t.gmx=t.gmx||{},t.gmx._maps={},t.gmx._clientLayers={},/\bsw=1\b/.test(location.search)&&(t.gmx._sw=1,"serviceWorker"in navigator?navigator.serviceWorker.register("./gmx-sw1.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}).catch(function(e){console.log("ServiceWorker registration failed: ",e)}):console.error("Your browser does not support Service Workers.")),t.gmx.gmxMapManager=u;var h=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e,r){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={};var i=this;this.properties=t.extend({},e.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=e;var n=r.skipTiles||"All",o=r.ftc||"osm",s=r.srs||3857,a=this.properties.name;this.layersCreated=new Promise(function(l){var h={},c={};u.iterateLayers(e,function(n){var o=n.properties,s={mapID:a,sessionKey:e.properties.sessionKey,layerID:o.name};o.hostName=e.properties.hostName,e.srs&&(o.srs=e.srs);var l=o.ContentID||o.type,u=o.MetaProperties||{},d=t.extend(s,r);o.dataSource||"parentLayer"in u?(d.parentLayer=o.dataSource||"","parentLayer"in u&&(d.parentLayer=u.parentLayer.Value||""),c[s.layerID]={info:n,options:d}):l in t.gmx._layerClasses?i.addLayer(t.gmx.createLayer(n,d)):(h[l]=h[l]||[],h[l].push({info:n,options:d}))});var d=[];for(var m in h)d.push(t.gmx._loadLayerClass(m).then(function(e){for(var r=h[e],n=0,o=r.length;o>n;n++)i.addLayer(t.gmx.createLayer(r[n].info,r[n].options))}.bind(null,m)));var f,p,v,y={};for(p in c){v=c[p];var x=v.options,_=x.parentLayer,b=this.layersByID[_];b?(v.options.parentOptions=b.getGmxProperties(),v.options.dataManager=this.dataManagers[_]||new g(v.options.parentOptions,!0),this.dataManagers[_]=v.options.dataManager,this.addLayer(t.gmx.createLayer(v.info,v.options))):(f=x.hostName,y[f]||(y[f]={}),y[f][_]||(y[f][_]=[]),y[f][_].push(p))}for(f in y){var S=[],P=t.gmxUtil.protocol+"//"+f;for(p in y[f])S.push({Layer:p});d.push(t.gmxUtil.requestJSONP(P+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",skipTiles:n,srs:s,ftc:o,Layers:JSON.stringify(S)},{ids:y[f]}).then(function(e,r){if(e&&"ok"===e.Status&&e.Result)e.Result.forEach(function(e){var n=e.properties,a=n.name;n.tiles=[],n.srs=s,n.ftc=o;var l=i.addDataManager(e);r&&r.ids&&r.ids[a]&&r.ids[a].forEach(function(r){var n=c[r];n.options.parentOptions=e.properties,n.options.dataManager=l,n.info.properties.tiles=[],n.info.properties.srs=s,n.info.properties.ftc=o,i.addLayer(t.gmx.createLayer(n.info,n.options))})});else if(console.info("Error: loading ",P+"/Layer/GetLayerJson.ashx",e.ErrorInfo),r&&r.ids)for(var n in r.ids)r.ids[n].forEach(function(e){i.addLayer(new t.gmx.DummyLayer(c[e].info.properties))})}))}Promise.all(d).then(l)}.bind(this))},addDataManager:function(e){var t=e.properties.name;return this.dataManagers[t]||(this.dataManagers[t]=new g(e.properties)),this.dataManagers[t]},getDataManager:function(e){return this.dataManagers[e]},addLayer:function(e){var t=e.getGmxProperties();return this.layers.push(e),this.layersByTitle[t.title]=e,this.layersByID[t.name]=e,this.fire("layeradd",{layer:e}),this},removeLayer:function(e){for(var t=e.getGmxProperties(),r=0;r<this.layers.length;r++)if(this.layers[r].getGmxProperties().name===t.name){this.layers.splice(r,1);break}return delete this.layersByTitle[t.title],delete this.layersByID[t.name],this.fire("layerremove",{layer:e}),this},addLayersToMap:function(e){for(var t=this.layers.length-1;t>=0;t--){var r=this.layers[t];r.getGmxProperties().visible&&e.addLayer(r)}return this}});t.gmx=t.gmx||{},t.gmx.gmxMap=h;var c=t.Handler.extend({options:{},initialize:function(e){this._map=e,this._layers={},this._lastLayer=null,this._lastId=null;var r=this;this._drawstart=null,this._lastCursor="";var i=function(){if(r._drawstart)return!0;if(null===r._drawstart){if(e.gmxControlsManager){var t=e.gmxControlsManager.get("drawing");t&&t.on("activechange",function(t){r._drawstart=t.activeIcon,e._container.style.cursor=r._drawstart?"pointer":""})}r._drawstart=!1}return!1},n=function(e){var t=e._container;if(t)for(var r=t.parentNode.childNodes,i=0,n=r.length;n>i;i++)if(t===r[i])return i;return 0},o=function(){r._lastLayer&&(r._lastLayer.gmxEventCheck({type:"mousemove"},!0),r._lastLayer=null)},s=function(e){var n=e.type,s=r._map;if(e.originalEvent&&(s.gmxMouseDown=t.Browser.webkit&&!t.gmxUtil.isIEOrEdge?e.originalEvent.which:e.originalEvent.buttons),s._animatingZoom||i()||!e.latlng||"click"===n&&s._skipClick||"mousemove"===n&&s.gmxMouseDown)return o(),s._skipClick=!1,void 0;e.layerPoint&&(s._gmxMouseLatLng=e.latlng,s.gmxMousePos=s.getPixelOrigin().add(e.layerPoint));for(var a,l=Object.keys(r._layers).sort(function(e,t){var i=s._layers[e],n=s._layers[t];if(i&&n){var o=i.options,a=n.options,l=(o.zIndexOffset||0)+(o.zIndex||0),u=(a.zIndexOffset||0)+(a.zIndex||0),h=u-l;return h?h:r._layers[t]-r._layers[e]}return 0}),u=null,h="",c=0,d=l.length;d>c;c++){var m=l[c];if(a=s._layers[m],a&&a._map&&!a._animating&&a.options.clickable&&a.gmxEventCheck(e)){a.hasEventListeners("mouseover")&&(h="pointer"),u=a;break}}r._lastCursor===h||i()||(s._container.style.cursor=h),r._lastCursor=h,"zoomend"!==n&&(u?(r._lastLayer!==u&&o(),r._lastLayer=u):o())};e.on({zoomend:function(){e._gmxMouseLatLng&&setTimeout(function(){s({type:"mousemove",latlng:e._gmxMouseLatLng})},0)},click:s,dblclick:s,mousedown:s,mouseup:s,mousemove:s,contextmenu:s,layeradd:function(e){var t=e.layer;"gmxEventCheck"in t&&t.options.clickable&&(r._layers[t._leaflet_id]=n(t))},layerremove:function(e){var t=e.layer._leaflet_id;delete r._layers[t],r._lastLayer&&r._lastLayer._leaflet_id===t&&(r._lastLayer=null,r._lastId=0)}},this)}});t.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new c(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart},this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()}))}),function(){var e="rus",r=function(e,t,r,i){i[e]||(i[e]={}),i[e][t]=r};t.gmxLocale={setLanguage:function(e){this._language=e},getLanguage:function(){return window.language||this._language||e}},t.gmxLocaleMixin={addText:function(){var e=arguments[0],t=arguments[1];1===arguments.length&&(t=e,e=null);for(var i in t)if(null===e)for(var n in t[i])r(i,n,t[i][n],this);else r(e,i,t[i],this);return this},getText:function(e){for(var r=t.gmxLocale.getLanguage(),i=this[r]||{},n=e?e.split(/\./):[],o=0,s=n.length;s>o&&i;o++)i=i[n[o]];return i}},t.extend(t.gmxLocale,t.gmxLocaleMixin)}(),t.extend(t.gmxLocale,{rus:{Coordinates:"Координаты",Length:"Длина",nodeLength:"Длина от начала",edgeLength:"Длина сегмента",Area:"Площадь",Perimeter:"Периметр",units:{m:"м",nm:"м.мили",km:"км",m2:"кв. м",km2:"кв. км",ha:"га",m2html:"м<sup>2",km2html:"км<sup>2"}}}),t.extend(t.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}});var d={_loadedTiles:{},_getKey:function(e){return[e.layerID,e.x,e.y,e.z,"undefined"==typeof e.d?-1:e.d,"undefined"==typeof e.s?-1:e.s,e.v].join(":")},load:function(e,r){var i=d._getKey(r);if(!this._loadedTiles[i]){var n={ModeKey:"tile",ftc:"osm",r:"j",LayerName:r.layerID,z:r.z,x:r.x,y:r.y,v:r.v};r.srs&&(n.srs=r.srs),-1!==r.d&&(n.Level=r.d,n.Span=r.s),t.gmx._sw&&(n.sw=t.gmx._sw);var o=new Promise(function(t,r){var i=e+"&"+Object.keys(n).map(function(e){return e+"="+n[e]}).join("&");fetch(i,{mode:"cors",credentials:"include"}).then(function(e){return e.text()}).then(function(e){var i="gmxAPI._vectorTileReceiver(";if(e.substr(0,i.length)===i){e=e.replace(i,"");var n=JSON.parse(e.substr(0,e.length-1));t(n)}else r()})});this._loadedTiles[i]=o}return this._loadedTiles[i]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(e){var t=d._getKey({layerID:e.LayerName,x:e.x,y:e.y,z:e.z,d:e.level,s:e.span,v:e.v});d._loadedTiles[t]&&d._loadedTiles[t].resolve({bbox:e.bbox,srs:e.srs,isGeneralized:e.isGeneralized,values:e.values})};var m=function(e,t){this.dataProvider=e,this.x=t.x,this.y=t.y,this.z=t.z,this.v=t.v,this.s=t.s||-1,this.d=t.d||-1,this.attributes=t.attributes,this.isGeneralized=t.isGeneralized,this.isFlatten=t.isFlatten,this.bounds=i.getBoundsByTilePoint(this.z?t:{z:0,x:0,y:0}),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=m.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&t.dateZero&&(this.beginDate=new Date(t.dateZero.valueOf()+1e3*this.s*this.d*i.oneDay),this.endDate=new Date(t.dateZero.valueOf()+1e3*(this.s+1)*this.d*i.oneDay)),this.clear()};m.prototype={addData:function(e,t){t&&this.removeData(t,!0);for(var r=e.length,n=new Array(r),o=i.bounds(),s=0;r>s;s++){var a=this._parseItem(e[s]);n[s]=a,o.extendBounds(a.bounds)}return this.data?(this.data=this.data.concat(e),this.dataOptions=this.dataOptions.concat(n)):(this.data=e,this.dataOptions=n),this.loaded(e),o},removeData:function(e){for(var t=this.data||[],r=t.length-1;r>=0;r--)e[t[r][0]]&&(t.splice(r,1),this.dataOptions&&this.dataOptions.splice(r,1))},loaded:function(e){this.state="loaded",this._resolve(e)},load:function(){if("notLoaded"===this.state){this.state="loading";var e=this;this.dataProvider.load(e.x,e.y,e.z,e.v,e.s,e.d,function(t){e.bbox=t.bbox,e.srs=t.srs,e.isGeneralized=t.isGeneralized,e.addData(t.values)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this))},_parseItem:function(e){var t,r=e.length-1;for(t=1;r>t;t++)null===e[t]&&(e[t]="");var n=e[r],o=this.isFlatten,s=n.type,a=-1!==s.indexOf("POLYGON")||-1!==s.indexOf("Polygon"),l="POLYGON"===s||"Polygon"===s,u=n.coordinates,h=[],c=null,d=[];if(a){l&&(u=[u]),c=i.bounds();var m=i.bounds().extendBounds(this.bounds).addBuffer(-.05),f=!1;for(t=0,r=u.length;r>t;t++){for(var p=[],g=[],v=0,y=u[t].length;y>v;v++){o&&"number"!=typeof u[t][v][0]&&(u[t][v]=i.flattenRing(u[t][v]));var x=i.bounds(u[t][v]);p.push(x),0===v&&c.extendBounds(x);var _=i.getHidden(u[t][v],m);g.push(_),_.length&&(f=!0)}d.push(p),h.push(g)}f||(h=null),l&&(d=d[0])}else if("POINT"===s||"Point"===s)c=i.bounds([u]);else if("MULTIPOINT"===s||"MultiPoint"===s)for(c=i.bounds(),t=0,r=u.length;r>t;t++)c.extendBounds(i.bounds([u[t]]));else if("LINESTRING"===s||"LineString"===s)c=i.bounds(u);else if("MULTILINESTRING"===s||"MultiLineString"===s)for(c=i.bounds(),t=0,r=u.length;r>t;t++)c.extendBounds(i.bounds(u[t]));var b={bounds:c,boundsArr:d};return h&&(b.hiddenLines=h),b}},m.makeTileKey=function(e,t,r,i,n,o){return r+"_"+e+"_"+t+"_"+i+"_"+n+"_"+o},m.createTileKey=function(e){return[e.z,e.x,e.y,e.v,e.s,e.d].join("_")},m.parseTileKey=function(e){var t=e.split("_").map(function(e){return Number(e)});return{z:t[0],x:t[1],y:t[2],v:t[3],s:t[4],d:t[5]}},m.boundsFromTileKey=function(e){var t=m.parseTileKey(e);return i.getTileBounds(t.x,t.y,t.z)};var f=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this.type=e.type||"update",this._callback=e.callback,this.layerID=e.layerID,this.target=e.target,this.itemHook=e.itemHook,this._items=null,this.bbox=e.bbox,this.needBbox=e.needBbox,this.filters=e.filters||[],this.targetZoom=e.targetZoom||null,this.active="active"in e?e.active:!0,this.srs=e.srs||3857,e.bounds&&this.setBounds(e.bounds);var t,r=i.worldWidthMerc;this.bbox?this.bbox.max.x>r?(t=this.bbox.max.x-r,this.bbox1=i.bounds([[t-r,this.bbox.max.y],[-(t+r),this.bbox.min.y]])):this.bbox.min.x<-r&&(t=this.bbox.min.x+r,this.bbox1=i.bounds([[t+r,this.bbox.max.y],[r-t,this.bbox.min.y]])):(this.bbox=i.bounds([[-r,-r],[r,r]]),this.world=!0),e.dateInterval&&this._setDateInterval(e.dateInterval[0],e.dateInterval[1])},hasFilter:function(e){for(var t=0,r=this.filters.length;r>t;t++)if(this.filters[t]===e)return!0;return!1},activate:function(){return this.active||(this.active=!0,this.fire("activate")),this},deactivate:function(){return this.active&&(this.active=!1,this.fire("activate")),this},toggleActive:function(e){return e?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(e){var t=e.length,r={count:t};if("update"===this.type){this._items||(this._items={});for(var i,n=this._items,o={},s=[],a=[],l=0;t>l;l++){var u=e[l];i=u.id+"_"+u.tileKey,o[i]=u,n[i]||s.push(u)}for(i in n)o[i]||a.push(n[i]);s.length&&(r.added=s),a.length&&(r.removed=a),this._items=o}else r.added=e;return this.fire("data",{data:this._callback(r)}),r=null,e=null,this},removeData:function(e){if("update"!==this.type||!this._items)return this;var t=this._items,r=[];for(var i in e)t[i]&&(r.push(t[i]),delete t[i]);return r.length&&this._callback({removed:r}),this},setBounds:function(e,r){var n;if(!e)return this.world||(n=i.worldWidthMerc,this.bbox=i.bounds([[-n,-n],[n,n]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var o=e.min,s=e.max;if(!o||!s){var a=t.latLngBounds(e),l=a.getSouthWest(),u=a.getNorthEast();o={x:l.lng,y:l.lat},s={x:u.lng,y:u.lat}}var h=o.x,c=s.x,d=o.y,m=s.y,f=null,p=null;if(this.world=!1,n=(c-h)/2,n>=180)h=-180,c=180,this.world=!0;else if(c>180||-180>h){var g=(c+h)/2%360;g>180?g-=360:-180>g&&(g+=360),h=g-n,c=g+n,-180>h?(f=h+360,p=180,h=-180):c>180&&(f=-180,p=c-360,c=180)}var v=3857==this.srs?t.CRS.EPSG3857:t.Projection.Mercator,y=v.project(t.latLng(d,h)),x=v.project(t.latLng(m,c));return this.bbox=i.bounds([[y.x,y.y],[x.x,x.y]]),r&&this.bbox.addBuffer(r),this.bbox1=null,f&&(y=v.project(t.latLng(d,f)),x=v.project(t.latLng(m,p)),this.bbox1=i.bounds([[y.x,y.y],[x.x,x.y]]),r&&this.bbox1.addBuffer(r)),this.fire("update"),this},intersects:function(e){return this.world||this.bbox.intersects(e)||!(!this.bbox1||!this.bbox1.intersects(e))},intersectsWithTile:function(e){if(this.targetZoom&&!this.needBbox){var t=this.targetZoom+(this.targetZoom%2?1:0);if(e.isGeneralized&&e.z!==t||e.z>t)return!1}var r=this.dateInterval;return this.intersects(e.bounds)&&(!e.beginDate||r&&r.endDate>=e.beginDate&&r.beginDate<=e.endDate)},intersectsWithGeometry:function(e){var t=e.type.toUpperCase(),r=e.coordinates;if("POINT"===t)return this.world||this.bbox.contains(r)||!(!this.bbox1||!this.bbox1.contains(r));"POLYGON"===t?r=[r[0]]:"MULTIPOLYGON"===t?r=r.map(function(e){return e[0]}):"LINESTRING"===t&&(r=[r]);for(var i=0,n=r.length;n>i;i++)if(this.bbox.clipPolygon(r[i]).length||this.bbox1&&this.bbox1.clipPolygon(r[i]).length)return!0;return!1},_setDateInterval:function(e,t){this.dateInterval=e&&t?{beginDate:e,endDate:t}:null},setDateInterval:function(e,t){var r=e&&t;return(!this.dateInterval!=!r||r&&(this.dateInterval.beginDate.valueOf()!==e.valueOf()||this.dateInterval.endDate.valueOf()!==t.valueOf()))&&(this._setDateInterval(e,t),this.fire("update",{temporalFilter:!0})),this}});t.gmx.observer=function(e){return new f(e)},function(){var e=function(e){var t=[],r=e.TemporalTiles||[],n=e.TemporalVers||[],o=e.TemporalPeriods||[],s=o[o.length-1],a=Number.MAX_VALUE,l=e.ZeroDate.split("."),u=new Date(l.length>2?l[2]:2008,l.length>1?l[1]-1:0,l.length>0?l[0]:1),h=new Date(u.getTime()-6e4*u.getTimezoneOffset()),c=h.getTime()/1e3;this.dateZero=h;var d,f,p=function(e,t,r){var n=e.d;if(t.d===o[n])return e.count++,e.tiles.push(r),void 0;var s=o[n-1],a=o[n]/s;"children"in e||(e.children=new Array(a));var l=Math.floor(t.s*t.d/s),u=l-e.s*a;if(!e.children[u]){var h=s*i.oneDay,d=l*h+c;e.children[u]={d:n-1,s:l,t1:d,t2:d+h,count:0,children:[],tiles:[]}}p(e.children[u],t,r)},g=o.length-1,v=o[g]*i.oneDay;for(d=0,f=r.length;f>d;d++){l=r[d];var y=Number(l[1]),x=Number(l[0]);x===s&&(a=Math.min(a,y))}for(d=0,f=r.length;f>d;d++){l=r[d];var _={x:Number(l[2]),y:Number(l[3]),z:Number(l[4]),v:Number(n[d]),s:Number(l[1]),d:Number(l[0])};if(!(_.d<0)){var b=Math.floor(_.s*_.d/o[g])-a,S=b+a;t[b]=t[b]||{d:g,s:S,t1:S*v+c,t2:(S+1)*v+c,count:0,tiles:[]};var P=m.createTileKey(_);p(t[b],_,P)}}r=n=null,this.selectTiles=function(e,r,i){i=i||{};for(var n=e.valueOf()/1e3,s=r.valueOf()/1e3,a=0,l=(s-n)/3600/24,u=0;u<o.length;u++)if(o[u]>l){a=Math.max(0,u-1);break}o[o.length-1]<=l&&(a=o.length-1);for(var h=Math.min(o.length-1,a+Number(l>o[a])),c=function(e,t){for(var r=0,i=0;i<e.length;i++)e[i].intersects(t)&&r++;return r},d=function(e,t,r){if(t>=e.t2||r<=e.t1)return{count:0,tiles:[],nodes:[]};if(i.bounds&&!e.tileBounds&&(e.tileBounds=e.tiles.map(function(e){return m.boundsFromTileKey(e)})),e.d===a){var n=i.bounds?c(e.tileBounds,i.bounds):e.count;return{tiles:e.tiles,count:n,nodes:[e]}}var o,s=0,l=[],u=e.children?e.children.length:0;for(o=0;u>o;o++)l[o]=e.children[o]?d(e.children[o],Math.max(t,e.t1),Math.min(r,e.t2)):{count:0,tiles:[],nodes:[]},s+=l[o].count;var f=i.bounds?c(e.tileBounds,i.bounds):e.count;if(e.d>h||f>s){var p=[],g=[];for(o=0;o<l.length;o++)g.push(l[o].nodes),p.push(l[o].tiles);return{tiles:[].concat.apply([],p),count:s,nodes:[].concat.apply([],g)}}return{tiles:e.tiles,count:f,nodes:[e]}},f=[],p=0;p<t.length;p++)if(t[p]){var g=d(t[p],n,s);g.tiles.length&&(f=f.concat(g.tiles))}for(var v={},y=0;y<f.length;y++)v[f[y]]=!0;return{tiles:v}},this.getNode=function(e,r){if(0>e||0>r)return null;for(var i=function(e,t,r){if(!e)return null;if(o[e.d]===t)return e.s===r?e:null;var n=o[e.d]/o[e.d-1],s=Math.floor(r*t/o[e.d-1]),a=s-e.s*n;return e.children[a]?i(e.children[a],t,r):null},n=0;n<t.length;n++){var s=i(t[n],e,r);if(s)return s}return null}};t.gmx.tilesTree=function(t){return new e(t)}}();var p=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this._dataManager=e,this._observerData={},this._tileData={}},addObserver:function(e){return this._observerData[e.id]={observer:e,tiles:{},leftToLoad:0,loadingState:!1},e.on("update",this._updateObserver.bind(this,e)),this._updateObserver(e),this},removeObserver:function(e){var t=this._observerData[e].tiles;for(var r in t)delete this._tileData[r].observers[e];return delete this._observerData[e],this},addTile:function(e){var t="loaded"===e.state?0:1;e.loadDef.then(this._tileLoadedCallback.bind(this,e));var r={};for(var i in this._observerData){var n=this._observerData[i];n.observer.intersectsWithTile(e)&&(n.tiles[e.vectorTileKey]=!0,n.leftToLoad+=t,r[i]=!0)}return this._tileData[e.vectorTileKey]={observers:r,tile:e},this},removeTile:function(e){var t=this._tileData[e],r="loaded"===t.tile.state?0:1;for(var i in t.observers){var n=this._observerData[i];n.leftToLoad-=r,delete n.tiles[e]}return delete this._tileData[e],this},startLoadTiles:function(e){this._dataManager._getActiveTileKeys();var t=this._observerData[e.id];if(t.leftToLoad<1)return this.fire("observertileload",{observer:e}),this;t.loadingState||(t.loadingState=!0,e.fire("startLoadingTiles"));for(var r in t.tiles)this._tileData[r].tile.load();return this},getTileObservers:function(e){return this._tileData[e].observers},getObserverLoadingState:function(e){return this._observerData[e.id].loadingState},getObserverLeftToLoad:function(e){return this._observerData[e.id].leftToLoad},_updateObserver:function(e){if(this._observerData[e.id]){var t,r=this._observerData[e.id],i={},n=0;for(t in this._tileData){var o=this._tileData[t].tile;e.intersectsWithTile(o)&&(i[t]=!0,"loaded"!==o.state&&n++,this._tileData[t].observers[e.id]=!0)}for(t in r.tiles)t in i||delete this._tileData[t].observers[e.id];r.tiles=i,r.leftToLoad=n}},_tileLoadedCallback:function(e){if(this.fire("tileload",{tile:e}),e.vectorTileKey in this._tileData){var t=this._tileData[e.vectorTileKey].observers;for(var r in t){var i=this._observerData[r];i.leftToLoad--,i.leftToLoad<1&&(i.loadingState&&(i.loadingState=!1,i.observer.fire("stopLoadingTiles")),this.fire("observertileload",{observer:i.observer}))}}}}),g=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,options:{name:null,srs:"",identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:-1,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,needBbox:!1,isFlatten:!1},setOptions:function(e){this._clearProcessing(),e.GeoProcessing&&(this.processingTile=this.addData([]),this._chkProcessing(e.GeoProcessing)),t.setOptions(this,e),this.optionsLink=e,this._isTemporalLayer=this.options.Temporal;var r=t.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=r.tileAttributeIndexes,this.temporalColumnType=r.tileAttributeTypes[this.options.TemporalColumnName];var i=this.options.hostName,n=this.options.sessionKey;this.tileSenderPrefix=t.gmxUtil.protocol+"//"+i+"/"+"TileSender.ashx?WrapStyle=None"+"&key="+encodeURIComponent(n),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(e,t,r,i,n,o,s){var a=this;d.load(a.tileSenderPrefix,{x:e,y:t,z:r,v:i,s:n,d:o,srs:this.options.srs,layerID:a.options.name}).then(s,function(){console.log("Error loading vector tile"),s({values:[]}),a.fire("chkLayerUpdate",{dataProvider:a})})},initialize:function(e,t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._filtersView={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var r=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new p(this),this._observerTileLoader.on("tileload",function(e){var t=e.tile;if(r._updateItemsFromTile(t),r._tilesTree){var i=r._tilesTree.getNode(t.d,t.s);i&&i.count--}}),this._observerTileLoader.on("observertileload",function(e){var t=e.observer;t.isActive()&&(t.needRefresh=!1,t.updateData(r.getItems(t.id)))}),this.setOptions(e),t&&(this.options.LayerVersion=-1),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(e,t,r){var i=e.options.unixTimeStamp,n=r.dateInterval;return n&&i>=n.beginDate.valueOf()&&i<n.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),this.options.needBbox||!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var e={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),e=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(e)}else this.initTilesList();return this._activeTileKeys},getViewFilters:function(e,t){var r=[];e=e||"screen";for(var i in this._filtersView[t])0===i.indexOf(e)&&r.push(i);return r},_getObserversByFilterName:function(e,t){var r={};for(var i in this._observers){var n=this._observers[i];n.hasFilter(e)?r[i]=!0:t&&t===n.target&&(n.filters.push(e),r[i]=!0)}return r},addLayerFilter:function(e,t){if(t&&t.layerID){var r=t.layerID,i=t.target||"screen",n=i;this._filtersView[r]||(this._filtersView[r]={}),t.id&&(n+="_"+t.id),this._filtersView[r][n]=e,this._triggerObservers(this._getObserversByFilterName(n,i))}return this},removeLayerFilter:function(e){if(this._filtersView[e.layerID]){var t=e.layerID,r=e.target||"screen",i=r;if(e.id&&(i+="_"+e.id),this._filtersView[t][i]){var n=this._getObserversByFilterName(i,r);delete this._filtersView[t][i],this._triggerObservers(n)}}return this},addFilter:function(e,t){return this._filters[e]=t,this._triggerObservers(this._getObserversByFilterName(e)),this},removeFilter:function(e){if(this._filters[e]){var t=this._getObserversByFilterName(e);delete this._filters[e],this._triggerObservers(t)}return this},getItems:function(e){var t=[],r=this._observers[e];if(!r)return[];var i=r.layerID,n=this._filtersView[i]||{},o=r.filters.concat("processingFilter");this._isTemporalLayer&&o.push("TemporalFilter"),o=o.filter(function(e){return e in this._filters||e in n}.bind(this));var s=this,a=function(e){var i=e.data,a=t.length,l=i.length;t.length=a+l;for(var u=0;l>u;u++){var h=e.dataOptions[u];if(r.intersects(h.bounds)){for(var c=i[u],d=c[0],m=s.getItem(d),f=c[c.length-1],p=!1,g=0;g<o.length;g++){var v=o[g],y=s._filters[v]||n[v];if(y&&!y(m,e,r,f,h)){p=!0;break}}if(!p){var x={id:d,properties:c,item:m,dataOption:h,v:e.v,tileKey:e.vectorTileKey};r.itemHook?r.itemHook(x):t[a++]=x}}}t.length=a},l=this._getActiveTileKeys();for(var u in l){var h=s._tiles[u].tile;h.data&&h.data.length>0&&(0===h.z||r.intersectsWithTile(h))&&a(h)}return t},_updateItemsFromTile:function(e){for(var t=e.vectorTileKey,r=e.data||[],i=r.length,n=r[0]&&r[0].length-1,o=0;i>o;o++){var s=r[o],a=s[n],l=s[0],u=this._items[l];if(u?(u.processing?e.data[o]=u.properties:(u.properties=s,-1===u.type.indexOf("MULTI")&&(u.type="MULTI"+u.type)),delete u.bounds,u.currentFilter=null):(u={id:l,type:a.type,properties:s,options:{fromTiles:{}}},this._items[l]=u),u.options.fromTiles[t]=o,e.isGeneralized&&(u.options.isGeneralized=!0),this.options.TemporalColumnName){var h=s[this.tileAttributeIndexes[this.options.TemporalColumnName]];u.options.unixTimeStamp=1e3*h}}return i},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var e=this._observers,t=null,r=null;for(var i in e){var n=e[i],o=n.dateInterval;o&&((!t||o.beginDate<t)&&(t=o.beginDate),(!r||o.endDate>r)&&(r=o.endDate))}t&&r&&(this._beginDate!==t||this._endDate!==r)&&(this._beginDate=t,this._endDate=r,this._needCheckActiveTiles=!0)}},addObserver:function(e,r){r=r||"s"+ ++this._freeSubscrID;var i=this,n=new f(e);return n.id=r,n.needRefresh=!0,this._observerTileLoader.addObserver(n),n.on("update",function(e){n.needRefresh=!0,e.temporalFilter&&(i._needCheckDateInterval=!0),t.gmx.layersVersion.now(),i._waitCheckObservers()}).on("activate",function(){i.fire("observeractivate"),i.checkObserver(n)}),i._needCheckDateInterval=!0,this._observers[r]=n,this._waitCheckObservers(),n.isActive()&&this.fire("observeractivate"),n},getActiveObserversCount:function(){var e=0;for(var t in this._observers)this._observers[t].isActive()&&e++;return e},getObserver:function(e){return this._observers[e]},removeObserver:function(e){if(this._observers[e]){this._observerTileLoader.removeObserver(e);var t=this._observers[e].isActive();delete this._observers[e],t&&this.fire("observeractivate")}},getObserverLoadingState:function(e){return this._observerTileLoader.getObserverLoadingState(e)},getObserverLeftToLoad:function(e){return this._observerTileLoader.getObserverLeftToLoad(e)},getTileKeysToLoad:function(e,t){var r=this._tilesTree.selectTiles(e,t).tiles;return r},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=i.bounds();for(var e in this._items){var t=this.getItem(e);this._itemsBounds.extendBounds(t.bounds)}}return this._itemsBounds},getItem:function(e){var t=this._items[e];if(t&&!t.bounds){var r=t.options.fromTiles,n=[];for(var o in r)if(this._tiles[o]){var s=r[o],a=this._tiles[o].tile;"loaded"===a.state&&a.dataOptions[s]?n.push(a.dataOptions[s].bounds):delete r[o]}if(1===n.length)t.bounds=n[0];else{t.bounds=i.bounds();for(var l=i.worldWidthMerc,u=0,h=n.length;h>u;u++){var c=n[u];t.bounds.max.x-c.min.x>l&&(c=i.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),t.bounds.extendBounds(c)}}}return t},getItemMembers:function(e){var t=this._items[e].options.fromTiles,r=[];for(var i in t)if(this._tiles[i]){var n=this._tiles[i].tile;if(n.data){var o=t[i],s=n.data[o],a=n.dataOptions[o],l=a.bounds;r.push({geo:s[s.length-1],width:l.max.x-l.min.x,dataOption:a})}}return r.sort(function(e,t){return t.width-e.width})},getItemGeometries:function(e){var t=this._items[e]?this._items[e].options.fromTiles:{},r=[];for(var n in t)if(this._tiles[n]&&this._tiles[n].tile.data){var o=this._tiles[n].tile.data,s=o[t[n]];r.push(i.getUnFlattenGeo(s[s.length-1]))}return r},addTile:function(e){this._tiles[e.vectorTileKey]={tile:e},this._getActiveTileKeys()[e.vectorTileKey]=!0,this._observerTileLoader.addTile(e),this.checkObservers()},checkObserver:function(e){e.needRefresh&&e.isActive()&&this._observerTileLoader.startLoadTiles(e)},checkObservers:function(){var e=this._observers;for(var t in this._observers)this.checkObserver(e[t])},_waitCheckObservers:function(){this._checkObserversTimer&&clearTimeout(this._checkObserversTimer),this._checkObserversTimer=setTimeout(t.bind(this.checkObservers,this),0)},_triggerObservers:function(e){var t=e||this._observers;for(var r in t)this._observers[r]&&(this._observers[r].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(e){var t=this._observers;for(var r in t)this._observers[r].removeData(e);this._waitCheckObservers()},preloadTiles:function(e,t,i){var n={};this._isTemporalLayer?(this._tilesTree||this.initTilesTree(),n=this._tilesTree.selectTiles(e,t).tiles):(this._needCheckActiveTiles=!0,n=this._getActiveTileKeys());var o=[];for(var s in n){var a=this._getVectorTile(s,!0).tile;if("notLoaded"===a.state&&(!i||i.intersects(a.bounds))){var l=a.load();o.push(l)}}return r.all.apply(null,o)},_updateActiveTilesList:function(e){if(this._tileFilteringHook){var t={};for(var r in e)this._tileFilteringHook(this._getVectorTile(r,!0).tile)&&(t[r]=!0);e=t}var i,n=this._activeTileKeys||{},o={},s=this;this.processingTile&&(e[this.processingTile.vectorTileKey]=!0),this._rasterVectorTile&&(i=this._rasterVectorTile.vectorTileKey,e[i]=!0,this._tiles[i]={tile:this._rasterVectorTile});var a=function(e){var t=s._observerTileLoader.getTileObservers(e);for(var r in t)o[r]=!0};for(i in e)n[i]||(this._observerTileLoader.addTile(this._getVectorTile(i,!0).tile),a(i));for(i in n)e[i]||(a(i),this._observerTileLoader.removeTile(i));this._activeTileKeys=e,this._triggerObservers(o)},_propertiesToArray:function(e){var t=e.properties,r=this.tileAttributeIndexes,i=[];for(var n in r)i[r[n]]=t[n];return i[i.length]=e.geometry,i[0]=e.id,i},_clearProcessing:function(){if(this.processingTile){for(var e=this._items,t=this.processingTile,r=t.vectorTileKey,i=t.data||[],n=0,o=i.length;o>n;n++){var s=i[n][0];if(e[s]){var a=e[s];a.processing=null,a.currentFilter=null,delete a.options.fromTiles[r],delete a.fromServerProps,delete a.geometry}}t.clear()}},_chkProcessing:function(e){var t,r,i,n,o,s=this._items,a=!1,l={};if(e){if(e.Deleted)for(r=0,i=e.Deleted.length;i>r;r++)t=e.Deleted[r],l[t]=!0,s[t]&&(s[t].processing=!0,s[t].currentFilter=null),i>0&&(a=!0);var u={};if(e.Inserted)for(r=0,i=e.Inserted.length;i>r;r++)n=e.Inserted[r],l[n[0]]||(u[n[0]]=n);if(e.Updated){for(r=0,i=e.Updated.length;i>r;r++)n=e.Updated[r],l[n[0]]||(u[n[0]]=n);!a&&i>0&&(a=!0)}o=[];for(t in u)this._items[t]&&(this._items[t].properties=u[t],this._items[t].processing=!0,this._items[t].currentFilter=null),o.push(u[t]);o.length>0&&(this.processingTile=this.addData(o))}a?this.addFilter("processingFilter",function(e,t){return 0===t.z||!e.processing}):this.removeFilter("processingFilter")},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())},_resetTilesTree:function(){this._tilesTree=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},updateVersion:function(e,r){if(!t.gmx.skipLoadTiles)if(e&&this.setOptions(e),r){this._needCheckActiveTiles=!1;for(var i,n={},o={},s=0,a=0,l=r.length;l>s;s+=6,a++)i=m.createTileKey({z:Number(r[s]),x:Number(r[s+1]),y:Number(r[s+2]),v:Number(r[s+3]),d:Number(r[s+4]),s:Number(r[s+5])}),n[i]=this._getVectorTile(i,!0),o[i]=!0;this._tiles=n,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile}),this._updateActiveTilesList(o)}else this._resetTilesTree()},getNotLoadedVectorTiles:function(e){var t=0;if(e.tiles)for(var r=e.tiles||[],i=0,n=0,o=r.length;o>i;i+=6,n++)this._tiles[m.createTileKey({z:Number(r[i]),x:Number(r[i+1]),y:Number(r[i+2]),v:Number(r[i+3]),d:Number(r[i+4]),s:Number(r[i+5])})]||t++;
return t},_getDataKeys:function(e){for(var t={},r=0,i=e.length;i>r;r++)t[e[r][0]]=!0;return t},_getProcessingTile:function(){if(!this.processingTile){var e=-.5,t=-.5,r=0,i=0,n=-1,o=-1,s=this.options.isFlatten;this.processingTile=new m({load:function(e,t,r,i,n,o,s){s({values:[]})}},{x:e,y:t,z:r,v:i,s:n,d:o,isFlatten:s}),this.addTile(this.processingTile)}return this.processingTile},addData:function(e){e||(e=[]);var t=this._getProcessingTile(),r=this._getDataKeys(e),i=t.addData(e,r);return this._itemsBounds&&this._itemsBounds.extendBounds(i),this._updateItemsFromTile(t),this._triggerObservers(),t},removeData:function(e){this._itemsBounds=null;var t=this.processingTile;if(t){var r=(e||t.data).reduce(function(e,t){var r=t[0];return e[r]=!0,delete this._items[r],e}.bind(this),{});this._removeDataFromObservers(r),t.removeData(r,!0),this._updateItemsFromTile(t),this._triggerObservers()}return t},initTilesTree:function(){this._tilesTree=t.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(e,t){if(!this._tiles[e]&&t){var r=m.parseTileKey(e);r.dateZero=this.dateZero,this._addVectorTile(r)}return this._tiles[e]},_addVectorTile:function(e){e.isFlatten=this.options.isFlatten,e.needBbox=this.options.needBbox,e.attributes=this.options.attributes;var t=new m(this._vectorTileDataProvider,e),r=t.vectorTileKey;return this._tiles[r]={tile:t},r},_getGeneralizedTileKeys:function(e){for(var r=e.z%2?1:2,i=Math.pow(2,r),n=e.z-r,o=Math.floor(e.x/i),s=Math.floor(e.y/i),a={v:e.v,s:-1,d:-1,isGeneralized:!0},l={};n>1;){var u=[n,o,s].join("_");l[u]=t.extend({},a,{x:o,y:s,z:n}),n-=2,o=Math.floor(o/4),s=Math.floor(s/4)}return l},initTilesList:function(){var e={};if(this.options.tiles){for(var t,r,i,n,o=this.options.tiles||[],s=this.options.tilesVers,a=this.options.isGeneralized?{}:null,l={},u=0,h=0,c=o.length;c>u;u+=3,h++)if(i={x:Number(o[u]),y:Number(o[u+1]),z:Number(o[u+2]),v:Number(s[h]),s:-1,d:-1},n=this._getVectorTile(m.createTileKey(i),!0),r=n.tile.vectorTileKey,l[r]=n,e[r]=!0,a){var d=this._getGeneralizedTileKeys(i);for(t in d){var f=d[t];a[t]?a[t].v=Math.max(f.v,a[t].v):a[t]=f}}if(a)for(t in a)i=a[t],r=m.createTileKey(i),l[r]||(this._tiles[r]||this._addVectorTile(i),l[r]=this._tiles[r],e[r]=!0);this._tiles=l,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(e)},setTileFilteringHook:function(e){this._tileFilteringHook=e,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});t.gmx=t.gmx||{},t.gmx.DataManager=g,t.gmx.VectorLayer=t.GridLayer.extend({options:{tilesCRS:t.CRS.EPSG3395,openPopups:[],minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,skipTiles:"All",iconsUrlReplace:[],showScreenTiles:!1,clickable:!0},initialize:function(r){r=t.setOptions(this,r),this._initPromise=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this)),this.repaintObservers={},this._gmx={hostName:i.normalizeHostname(r.hostName||"maps.kosmosnimki.ru"),mapName:r.mapID,sessionKey:this.options.sessionKey,iconsUrlReplace:this.options.iconsUrlReplace,showScreenTiles:this.options.showScreenTiles,skipTiles:r.skipTiles,needBbox:"All"===r.skipTiles,useWebGL:r.useWebGL,srs:r.srs||"",layerID:r.layerID,beginDate:r.beginDate,endDate:r.endDate,sortItems:r.sortItems||null,styles:r.styles||[],tileSubscriptions:{},shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},r.crossOrigin&&(this._gmx.crossOrigin=r.crossOrigin),this.on("load",function(e){console.log("load ",this._tileZoom,e),this._clearOtherZoomLevels()},this).on("loading",function(e){console.log("loading ",this._tileZoom,e),this._updateShiftY()},this).on("tileunload",function(e){this._gmx.dataManager&&this._gmx.dataManager.removeObserver(this._tileCoordsToKey(e.coords))},this).on("tileloadstart",function(r){var i=this._tileCoordsToKey(r.coords),n=this._tiles[i];n.loaded=0,n.screenTile=new e(this,n),setTimeout(t.bind(this.__drawTile,this,r),250)},this)},onAdd:function(e){if(e=e||this._map,e.options.crs!==t.CRS.EPSG3857&&e.options.crs!==t.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";var r=this._gmx;this.options.tilesCRS=3857==r.srs?t.CRS.EPSG3857:t.CRS.EPSG3395,r.shiftY=0,r.applyShift=e.options.crs===t.CRS.EPSG3857&&3857!=r.srs,r.currentZoom=e.getZoom(),this._levels={},this._tiles={},r.styleManager.promise.then(function(){this._heatmap||this._clusters||t.GridLayer.prototype.onAdd.call(this),e.on("zoomstart",this._zoomStart,this),e.on("zoomend",this._zoomEnd,this),"Vector"===r.properties.type&&e.on("moveend",this._moveEnd,this),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),r.balloonEnable&&!this._popup&&this.bindPopup(""),this.on("stylechange",this._onStyleChange,this),this.on("versionchange",this._onVersionChange,this),t.gmx.layersVersion.add(this),this.fire("add")}.bind(this)),r.styleManager.initStyles()},onRemove:function(e){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),e.off({viewreset:this._reset,moveend:this._update},this),this._animated&&e.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||e.off("move",this._limitedUpdate,this);var r=this._gmx;r.labelsLayer&&e._labelsLayer.remove(this),this._container=null,this._map=null,e.off("zoomstart",this._zoomStart,this),e.off("zoomend",this._zoomEnd,this),this.off("stylechange",this._onStyleChange,this),delete r.map,"Vector"===r.properties.type&&e.off("moveend",this._moveEnd,this),r.dataManager&&!r.dataManager.getActiveObserversCount()&&t.gmx.layersVersion.remove(this),this.fire("remove")},beforeAdd:function(e){t.GridLayer.prototype.beforeAdd.call(this,e),this._map=e},_updateZIndex:function(){if(this._container){var e=this.options,t=e.zIndex||0,r=e.zIndexOffset||0;this._container.style.zIndex=r+t}},createTile:function(e,r){var i=t.DomUtil.create("canvas","leaflet-tile"),n=this.getTileSize();return i.width=n.x,i.height=n.y,i},initFromDescription:function(e){var r=this._gmx;if(r.properties=e.properties,r.geometry=e.geometry,r.properties._initDone&&delete r.properties[r.properties.Temporal?"TemporalTiles":"tiles"],r.properties._initDone=!0,!r.geometry){var n=i.tileSizes[1];r.geometry={type:"POLYGON",coordinates:[[[-n,-n],[-n,n],[n,n],[n,-n],[-n,-n]]]}}if(r.rawProperties=e.rawProperties||e.properties,this._updateProperties(e.properties),"Vector"===r.rawProperties.type&&(e.properties.srs=r.srs=3857,r.RasterSRS=Number(r.rawProperties.RasterSRS)||3857),e.properties.needBbox=r.needBbox,e.properties.isGeneralized=this.options.isGeneralized,e.properties.isFlatten=this.options.isFlatten,r.dataManager=this.options.dataManager||new g(e.properties),this.options.parentOptions&&(e.properties.styles||(e.properties.styles=this.options.parentOptions.styles),r.dataManager.on("versionchange",this._onVersionChange,this)),r.styleManager=new v(r),this.options.minZoom=r.styleManager.minZoom,this.options.maxZoom=r.styleManager.maxZoom,r.dataManager.on("observeractivate",function(){r.dataManager.getActiveObserversCount()?t.gmx.layersVersion.add(this):t.gmx.layersVersion.remove(this)},this),"Vector"!==r.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==r.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),r.clusters&&this.bindClusters(JSON.parse(r.clusters)),r.filter){var o=t.gmx.Parsers.parseSQL(r.filter.replace(/[\[\]]/g,'"'));o&&r.dataManager.addFilter("userFilter_"+r.layerID,function(e){return r.layerID!==this._gmx.layerID||!o||o(e.properties,r.tileAttributeIndexes,r.tileAttributeTypes)?e.properties:null}.bind(this))}return r.dateBegin&&r.dateEnd&&this.setDateInterval(r.dateBegin,r.dateEnd),this._resolve(),this},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._gmx.dataManager.enableGeneralization(),this.redraw()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._gmx.dataManager.disableGeneralization(),this.redraw()))},setRasterOpacity:function(e){return this._gmx.rasterOpacity!==e&&(this._gmx.rasterOpacity=e,this._initPromise.then(this.repaint.bind(this))),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(e){return this._gmx.styleManager.getIcons(e),this},setStyles:function(e){return this._initPromise.then(function(){this._gmx.styleManager.clearStyles(),e?e.forEach(function(e,t){this.setStyle(e,t,!0)}.bind(this)):this.fire("stylechange")}.bind(this)),this},getStyle:function(e){return this.getStyles()[e]},setStyle:function(e,t,r){return this._initPromise.then(function(){this._gmx.styleManager.setStyle(e,t,r).then(function(){this.fire("stylechange",{num:t||0})}.bind(this))}.bind(this)),this},setStyleHook:function(e){return this._gmx.styleHook=e,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(e){return this._gmx.rasterProcessingHook=e,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(e){var t=this._gmx;return t.dataManager.addFilter("userFilter",function(r){return t.layerID!==this._gmx.layerID||!e||e(r)?r.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},addLayerFilter:function(e,t){var r=this._gmx;return t=t||{},t.layerID=r.layerID,r.dataManager.addLayerFilter(function(t){return!e||e(t)?t.properties:null}.bind(this),t),this},removeLayerFilter:function(e){return e=e||{},e.layerID=this._gmx.layerID,this._gmx.dataManager.removeLayerFilter(e),this},setDateInterval:function(e,r){var i=this._gmx;if(i.dateBegin&&i.dateEnd&&(e=i.dateBegin,r=i.dateEnd),!i.beginDate!=!e||!i.endDate!=!r||e&&i.beginDate.valueOf()!==e.valueOf()||r&&i.endDate.valueOf()!==r.valueOf()){if(i.rawProperties.maxShownPeriod&&e){var n=1e3*3600*24*i.rawProperties.maxShownPeriod;e=new Date(Math.max(e.valueOf(),r.valueOf()-n))}i.beginDate=e,i.endDate=r;var o=null,s=i.dataManager;for(var a in this._tiles)o=this._tiles[a].observer,o.setDateInterval(e,r);o=s.getObserver("_Labels"),o&&o.setDateInterval(e,r),("NotVisible"===i.skipTiles||i.needBbox||i.properties.UseTiles===!1)&&(i.needBbox||(i.properties.LayerVersion=-1,s.setOptions({LayerVersion:-1})),this._map&&t.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(e){return this._gmx.dataManager.addObserver(e)},removeObserver:function(e){return this._gmx.dataManager.removeObserver(e.id)},setPositionOffset:function(e,t){var r=this._gmx;return r.shiftXlayer=e,r.shiftYlayer=t,this._update(),this},getPositionOffset:function(){var e=this._gmx;return{shiftX:e.shiftXlayer,shiftY:e.shiftYlayer}},setZIndexOffset:function(e){return arguments.length&&(this.options.zIndexOffset=e),this._updateZIndex(),this},_clearLoaded:function(e){this._tiles[e]&&(this._tiles[e].loaded=0)},repaint:function(e){if(this._map){if(e){if(t.Util.isArray(e)){var r=e;e={},r.forEach(function(t){e[t]=!0,this._clearLoaded(t)}.bind(this))}else if("string"==typeof e){var i=e;this._clearLoaded(i),e={},e[i]=!0}}else{e={};for(var n in this._tiles)e[n]=!0,this._clearLoaded(n);t.extend(e,this.repaintObservers)}this._gmx.dataManager._triggerObservers(e)}},redrawItem:function(e){if(this._map){var t=this._gmx.dataManager.getItem(e),r=this._getTilesByBounds(t.bounds);this.repaint(r)}},gmxGetCanvasTile:function(e){var t=this._tileCoordsToKey(e);return this._tiles[t]},appendTileToContainer:function(e){if(this._tileZoom===e.coords.z){var r=this._getTilePos(e.coords),i=e.el,n=this._level?this._level.el:this._tileContainer;n.appendChild(i),t.DomUtil.setPosition(i,r,t.Browser.chrome||t.Browser.android23)}},addData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.addData(e,t),this.repaint()),this},removeData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.removeData(e,t),this.repaint()),this},getStylesByProperties:function(e,t){return this._gmx.styleManager.getCurrentFilters(e,t)},getItemStyle:function(e){var t=this._gmx,r=t.dataManager.getItem(e);return t.styleManager.getObjStyle(r)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(e){var r=this._gmx,i=r.dataManager.getItem(e),n=this.getStyles(),o="";if(i&&n[i.currentFilter]){var s=i.properties;o=t.gmxUtil.parseBalloonTemplate(n[i.currentFilter].Balloon,{properties:this.getItemProperties(s),geometries:[s[s.length-1]],tileAttributeTypes:r.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return o},getItemProperties:function(e){var t={},r=this._gmx.tileAttributeIndexes;for(var i in r)t[i]=e[r[i]];return t},addPreRenderHook:function(e){this._gmx.preRenderHooks.push(e),this.repaint()},removePreRenderHook:function(e){for(var t=this._gmx.preRenderHooks,r=0,i=t.length;i>r;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},addRenderHook:function(e){this._gmx.renderHooks.push(e),this.repaint()},removeRenderHook:function(e){for(var t=this._gmx.renderHooks,r=0,i=t.length;i>r;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var e=this._gmx.layerID?i.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return e?e.toLatLngBounds(3857==this._gmx.srs):new t.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=t.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0,3857==this._gmx.srs)),this._gmx.latLngGeometry},getPropItem:function(e,t){return i.getPropItem(e,t,this._gmx.tileAttributeIndexes)},_zoomStart:function(){this._gmx.zoomstart=!0,delete this._tileZoom},_zoomEnd:function(){this._gmx.zoomstart=!1,this._updateShiftY(this._map)},_moveEnd:function(){"dataManager"in this._gmx&&this._gmx.dataManager.fire("moveend")},_onStyleChange:function(){var e=this._gmx;!e.balloonEnable&&this._popup?this.unbindPopup():e.balloonEnable&&!this._popup&&this.bindPopup(""),this._map&&((this.options.minZoom!==e.styleManager.minZoom||this.options.maxZoom!==e.styleManager.maxZoom)&&(this.options.minZoom=e.styleManager.minZoom,this.options.maxZoom=e.styleManager.maxZoom,this._map._updateZoomLevels()),e.labelsLayer?this._map._labelsLayer.add(this):e.labelsLayer||this._map._labelsLayer.remove(this),this.redraw())},_getTilesByBounds:function(e){var t=this._gmx,r=this._map._zoom,i=t.shiftX||0,n=t.shiftY||0,o=e.toLatLngBounds(3857==t.srs),s=o.getSouthWest(),a=o.getNorthEast(),l=this._map.getBounds(),u=l.getSouthWest(),h=l.getNorthEast(),c=0;h.lng-u.lng<360&&(a.lng<u.lng?c=360*(1+Math.floor((u.lng-a.lng)/360)):s.lng>h.lng&&(c=360*Math.floor((h.lng-s.lng)/360))),s.lng+=c,a.lng+=c;var d,m,f,p,g=this._map.getPixelBounds(),v=this._map.project(s),y=this._map.project(a);g?(d=Math.floor((Math.max(y.y,g.min.y)+n)/256),m=Math.floor((Math.min(v.y,g.max.y)+n)/256),f=s.lng<=-180?g.min.x:Math.max(v.x,g.min.x),f=Math.floor((f+i)/256),p=a.lng>=180?g.max.x:Math.min(y.x,g.max.x),p=Math.floor((p+i)/256)):(d=Math.floor((y.y+n)/256),m=Math.floor((v.y+n)/256),f=Math.floor((v.x+i)/256),p=Math.floor((y.x+i)/256));for(var x={},_=f;p>=_;_++)for(var b=d;m>=b;b++){var S=this._tileCoordsToKey({x:_,y:b},r);x[S]=!0}return x},_updateProperties:function(e){var r=this._gmx;r.sessionKey=e.sessionKey=this.options.sessionKey||"",this.options.parentOptions&&(e=this.options.parentOptions),r.identityField=e.identityField,r.GeometryType=(e.GeometryType||"").toLowerCase(),r.minZoomRasters=e.RCMinZoomForRasters||1,r.minZoomQuicklooks=r.minZoomRasters;var i=e.type||"Vector";if(e.Temporal&&(i+="Temporal"),r.layerType=i,r.items={},t.extend(r,t.gmxUtil.getTileAttributes(e)),r.dataManager&&r.dataManager.setOptions(e),"ZIndexField"in e&&e.ZIndexField in r.tileAttributeIndexes&&(r.zIndexField=r.tileAttributeIndexes[e.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),r.filter=e.filter,r.dateBegin=e.dateBegin,r.dateEnd=e.dateEnd,r.dataSource=e.dataSource,"MetaProperties"in r.rawProperties){var n=r.rawProperties.MetaProperties;"srs"in n&&(r.srs=n.srs.Value||""),"parentLayer"in n&&(r.dataSource=n.parentLayer.Value||""),"filter"in n&&(r.filter=n.filter.Value||""),"dateBegin"in n&&(r.dateBegin=t.gmxUtil.getDateFromStr(n.dateBegin.Value||"01.01.1980")),"dateEnd"in n&&(r.dateEnd=t.gmxUtil.getDateFromStr(n.dateEnd.Value||"01.01.1980")),("shiftX"in n||"shiftY"in n)&&(r.shiftXlayer=n.shiftX?Number(n.shiftX.Value):0,r.shiftYlayer=n.shiftY?Number(n.shiftY.Value):0),("shiftXfield"in n||"shiftYfield"in n)&&(n.shiftXfield&&(r.shiftXfield=n.shiftXfield.Value),n.shiftYfield&&(r.shiftYfield=n.shiftYfield.Value)),"quicklookPlatform"in n&&(r.quicklookPlatform=n.quicklookPlatform.Value,"image"===r.quicklookPlatform&&delete r.quicklookPlatform),"quicklookX1"in n&&(r.quicklookX1=n.quicklookX1.Value),"quicklookY1"in n&&(r.quicklookY1=n.quicklookY1.Value),"quicklookX2"in n&&(r.quicklookX2=n.quicklookX2.Value),"quicklookY2"in n&&(r.quicklookY2=n.quicklookY2.Value),"quicklookX3"in n&&(r.quicklookX3=n.quicklookX3.Value),"quicklookY3"in n&&(r.quicklookY3=n.quicklookY3.Value),"quicklookX4"in n&&(r.quicklookX4=n.quicklookX4.Value),"quicklookY4"in n&&(r.quicklookY4=n.quicklookY4.Value),"multiFilters"in n&&(r.multiFilters="1"===n.multiFilters.Value?!0:!1),"isGeneralized"in n&&(this.options.isGeneralized="false"!==n.isGeneralized.Value),"isFlatten"in n&&(this.options.isFlatten="false"!==n.isFlatten.Value)}if(e.Temporal&&(this.options.isGeneralized=!1),e.IsRasterCatalog){r.IsRasterCatalog=e.IsRasterCatalog;var o=r.tileAttributeIndexes.GMX_RasterCatalogID;o&&(r.rasterBGfunc=function(e,i,n,s,a){var l=s.properties,u=t.gmxUtil.protocol+"//"+r.hostName+"/TileSender.ashx?ModeKey=tile&ftc=osm"+"&x="+e+"&y="+i+"&z="+n;return(a||r.srs)&&(u+="&srs="+(a||r.srs)),r.crossOrigin&&(u+="&cross="+r.crossOrigin),u+="&LayerName="+l[o],r.sessionKey&&(u+="&key="+encodeURIComponent(r.sessionKey)),t.gmx._sw&&s.v&&(u+="&sw="+t.gmx._sw+"&v="+s.v),u})}if(e.Quicklook){var s;s="{"===e.Quicklook[0]?JSON.parse(e.Quicklook):{minZoom:r.minZoomRasters,template:e.Quicklook},"X1"in s&&(r.quicklookX1=s.X1),"Y1"in s&&(r.quicklookY1=s.Y1),"X2"in s&&(r.quicklookX2=s.X2),"Y2"in s&&(r.quicklookY2=s.Y2),"X3"in s&&(r.quicklookX3=s.X3),"Y3"in s&&(r.quicklookY3=s.Y3),"X4"in s&&(r.quicklookX4=s.X4),"Y4"in s&&(r.quicklookY4=s.Y4);var a=r.Quicklook=s.template;"minZoom"in s&&(r.minZoomQuicklooks=s.minZoom),r.quicklookBGfunc=function(e){for(var t=a,i=/\[([^\]]+)\]/,n=i.exec(t);n&&n.length>1;)t=t.replace(n[0],e.properties[r.tileAttributeIndexes[n[1]]]),n=i.exec(t);return r.srs&&(t+=(-1===t.indexOf("?")?"?":"&")+"srs="+r.srs),t},r.imageQuicklookProcessingHook=t.gmx.gmxImageTransform}this.options.attribution=e.Copyright||""},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},_updateShiftY:function(){var e=this._gmx;e.currentZoom=this._tileZoom,e.tileSize=i.tileSizes[e.currentZoom],e.mInPixel=256/e.tileSize,e.rastersDeltaY=3857===e.RasterSRS?0:this._getShiftY(e.currentZoom,t.CRS.EPSG3395),e.applyShift&&this._map&&(e.deltaY=this._getShiftY(e.currentZoom),e.shiftX=Math.floor(e.mInPixel*(e.shiftXlayer||0)),e.shiftY=Math.floor(e.deltaY+e.mInPixel*(e.shiftYlayer||0)),e.shiftPoint=new t.Point(e.shiftX,-e.shiftY))},_getShiftY:function(e,r){var i=this._map,n=i.getCenter(),o=i.options.crs.project(n).y-(r||this.options.tilesCRS).project(n).y;return Math.floor(t.CRS.scale(e)*o/40075016.685578495)},_clearOtherZoomLevels:function(e){e=e||this._tileZoom;for(var r in this._levels)r!=e&&(t.DomUtil.remove(this._levels[r].el),this._onRemoveLevel(r),delete this._levels[r])},__drawTile:function(e){var t=e.coords,r=this._tileCoordsToKey(t),n=this._tiles[r],o=this._tileZoom||this._map._zoom,s=this._gmx,a=this,l=i.getTileNumFromLeaflet(t,o);n.promise?(n.observer.deactivate(),n.resolve()):(n.loaded=0,n.key=r,n.promise=new Promise(function(e,i){n.resolve=e,n.reject=i;var u=s.dataManager.getViewFilters("screen",s.layerID),h=function(){a._tileReady(t,null,n.el)};n.observer=s.dataManager.addObserver({type:"resend",layerID:s.layerID,needBbox:s.needBbox,srs:s.srs,target:"screen",targetZoom:a.options.isGeneralized?o:null,dateInterval:"VectorTemporal"===s.layerType?[s.beginDate,s.endDate]:null,active:!1,bbox:s.styleManager.getStyleBounds(l),filters:["clipFilter","userFilter_"+s.layerID,"styleFilter","userFilter"].concat(u),callback:function(e){a._tiles[r]?(a._tiles[r].loaded=0,n.screenTile.drawTile(e).then(function(){h()},function(e){h(e)})):(console.log("bad key",r),h())}},r).on("activate",function(){this.isActive()||(console.log("isActive",r),h())}).activate()}).catch(function(e){console.warn("catch:",e)}))}}),t.Map.addInitHook(function(){t.Mixin.ContextMenu&&t.gmx.VectorLayer.include(t.Mixin.ContextMenu),this.options.ftc=this.options.ftc||"osm",this.options.srs=this.options.srs||3857,this.options.skipTiles=this.options.skipTiles||"All"}),e.prototype={_getUrlFunction:function(e,t){return this.gmx.rasterBGfunc(e.x,e.y,e.z,t)},_loadTileRecursive:function(e,r){var i=this.gmx,n={z:e.z,x:this.ntp.x,y:this.ntp.y},o=this;return this.rasterRequests={},new Promise(function(e){var s=function(n,a){var l=o._getUrlFunction(n,r),u=function(t){t&&(i.badTiles[t]=!0),n.z>1?s({x:Math.floor(n.x/2),y:Math.floor(n.y/2),z:n.z-1},""):e({gtp:n})};if(i.badTiles[l]||i.maxNativeZoom&&i.maxNativeZoom<n.z)return u(),void 0;var h=o.rasterRequests[l];h?h.options.tileRastersId=o._uniqueID:(i.rasterProcessingHook&&(a="anonymous"),h=t.gmx.imageLoader.push(l,{tileRastersId:o._uniqueID,zoom:o.zoom,cache:!0,crossOrigin:i.crossOrigin||a||""}),o.rasterRequests[l]=h),h.promise.then(function(t){t?e({gtp:n,image:t}):u(l)},function(){u(l)})};s(n)})},_rasterHook:function(e){var t=e.sourceTilePoint||e.destinationTilePoint,r={geoItem:e.geoItem,destination:{z:e.destinationTilePoint.z,x:e.destinationTilePoint.x,y:e.destinationTilePoint.y},source:{z:t.z,x:t.x,y:t.y}};return e.url&&(r.quicklook=e.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(e.res,e.image,e.sx||0,e.sy||0,e.sw||256,e.sh||256,e.dx||0,e.dy||0,e.dw||256,e.dh||256,r)},_defaultRasterHook:function(e,t,r,i,n,o,s,a,l,u){var h=e.getContext("2d");h.drawImage(t,r,i,n,o,s,a,l,u)},_getShiftPixels:function(e){var t=e.dx+(e.dx<0?256:0),r=e.dy+(e.dy<0?256:0),i=0,n=256-t,o=t,s=n;if(e.tx>e.x&&(i=n,n=t,o=0,s=n),256===i||1>n)return null;var a=r,l=256-r,u=0,h=l;return e.ty>e.y&&(a=0,u=l,l=r,h=l),256===a||1>l?null:{sx:i,sy:a,sw:n,sh:l,dx:o,dy:u,dw:s,dh:h}},_getShiftTilesArray:function(e,t,r){var i=this.gmx.mInPixel,n=this.gmxTilePoint,o=t*i,s=r*i,a=Math.floor(.5+o%256),l=Math.floor(.5+s%256),u=256/i,h=n.x-t/u,c=n.y-r/u,d=Math.floor(h),m=d+(h===d?0:1),f=Math.floor(c),p=f+(c===f?0:1),g=Math.floor((e.min.x-t)/u),v=Math.floor((e.max.x-t)/u),y=Math.floor((e.min.y-r)/u),x=Math.floor((e.max.y-r)/u);g>d&&(d=g),m>v&&(m=v),y>f&&(f=y),p>x&&(p=x);for(var _=[],b=f;p>=b;b++)for(var S=d;m>=S;S++)_.push({z:n.z,x:S,y:b,dx:a,dy:l,tx:h,ty:c});return _},_chkRastersByItemIntersect:function(e,t){var r=t.properties[t.properties.length-1],n=[];return e.forEach(function(e){var t=i.getBoundsByTilePoint(e);i.isItemIntersectBounds(r,t)&&n.push(e)}),n},_getItemRasters:function(e){var r=e.properties,n=r[0],o=this,s=this.gmx,a=s.tileAttributeIndexes,l=this.rasters,u=Number(s.shiftXfield?i.getPropItem(s.shiftXfield,r,a):0)%this.worldWidthMerc,h=Number(s.shiftYfield?i.getPropItem(s.shiftYfield,r,a):0),c=u||h,d=i.getPropItem("urlBG",r,a),m="",f=null,p=!1,g=s.dataManager.getItem(n),v=this.gmxTilePoint,y=this.tilePoint,x=this.ntp,_=null;g.v=e.v;var b=new Promise(function(b){s.IsRasterCatalog&&("Raster"===s.rawProperties.type||i.getPropItem("GMX_RasterCatalogID",r,a))?p=!0:s.quicklookBGfunc?(m=s.quicklookBGfunc(g),f=s.imageQuicklookProcessingHook):d&&(m=d,f=s.imageQuicklookProcessingHook),new Promise(function(r){if(p){var n=e.dataOption||{},a=this._chkRastersByItemIntersect(c?this._getShiftTilesArray(n.bounds,u,h):[x],e),l=a.length,d=function(){1>l&&r()},b=function(){l--,d()},S=function(r,n,a){g.skipRasters=!1;var u=!0;f&&(a=f(a,{gmx:s,geoItem:e,item:g,gmxTilePoint:r}),u=!1);var h={geoItem:e,image:a,destinationTilePoint:y,sourceTilePoint:r,sx:0,sy:0,sw:256,sh:256,dx:0,dy:0,dw:256,dh:256};if(c){var m=o._getShiftPixels(n);if(null===m)return b(),void 0;t.extend(h,m),u=!1}if(r.z!==v.z){var p=i.getTilePosZoomDelta(v,v.z,r.z);if(p.size<1/256)return d(),void 0;if(u=!1,h.sx=Math.floor(p.x),h.sy=Math.floor(p.y),h.sw=h.sh=p.size,c){var x=Math.floor(h.dw/p.zDelta);h.sx=(0===h.dx?h.sw:256)-x,h.sw=x;var S=Math.floor(h.dh/p.zDelta);h.sy=(0===h.dy?h.sh:256)-S,h.sh=S}}if(u&&!s.rasterProcessingHook)l--,_=a,d();else{_||(_=document.createElement("canvas"),_.width=_.height=256),h.res=_;var P=o._rasterHook(h),T=function(){l--,n.resImage=_,d()};P?P.then&&P.then(T):null===P?(g.skipRasters=!0,b()):T()}};l?a.map(function(e){var t=o._loadTileRecursive(e,g);return t.then(function(t){S(t.gtp,e,t.image)},b),t}):(g.skipRasters=!0,b())}else{if(m){s.sessionKey&&(m+=(-1===m.indexOf("?")?"?":"&")+"key="+encodeURIComponent(s.sessionKey));var P=this.rasterRequests[m];P?P.options.tileRastersId=this._uniqueID:(P=t.gmx.imageLoader.push(m,{tileRastersId:o._uniqueID,crossOrigin:s.crossOrigin||"anonymous"}),this.rasterRequests[m]=P),P.promise.then(r,r)}else r();g.skipRasters=!1}}.bind(this)).then(function(t){if(p)l[n]=_,b();else{if(t){var r={gmx:s,geoItem:e,item:g,gmxTilePoint:v};_||(_=document.createElement("canvas"),_.width=_.height=256);var i=function(t){var i=o._rasterHook({geoItem:e,res:_,image:f?f(t,r):t,destinationTilePoint:v,url:m}),s=function(){l[n]=_,b()};i?i.then&&i.then(s):null===i?(g.skipRasters=!0,b()):s()};i(t)}else g.skipRasters=!0,b();delete o.rasterRequests[m]}}.bind(this))}.bind(this));return b},_getVisibleItems:function(e){if(e.length<2)return this.itemsView=e,e;i._tileCanvas||(i._tileCanvas=document.createElement("canvas"),i._tileCanvas.width=i._tileCanvas.height=256);var r,n,o=this.gmx,s=o.dataManager,a=i._tileCanvas,l=a.getContext("2d"),u={tbounds:this.tbounds,gmx:o,topLeft:this.topLeft,tpx:this.tpx,tpy:this.tpy,ctx:l};for(l.clearRect(0,0,256,256),l.imageSmoothingEnabled=!1,r=0,n=e.length;n>r;r++){l.fillStyle=i.dec2rgba(r+1,1);var h=e[r];t.gmxUtil.drawGeoItem(h,s.getItem(h.properties[0]),u,{fillStyle:l.fillStyle})}var c={},d=l.getImageData(0,0,256,256).data;for(r=0,n=d.length;n>r;r+=4)if(255===d[r+3]){var m=d[r+2];d[r+1]&&(m+=d[r+1]<<8),d[r]&&(m+=d[r]<<16),m&&(c[m]=!0)}var f=[];for(var p in c){var g=e[Number(p)-1];g&&f.push(g)}return this.itemsView=f,f},_getNeedRasterItems:function(e){for(var t=this.gmx,r=t.tileAttributeIndexes,n=this.tbounds,o=[],s=0,a=e.length;a>s;s++){var l=e[s],u=l.properties,h=u[0],c=l.dataOption||{},d=!1;if(t.quicklookBGfunc&&!i.getPropItem("GMX_RasterCatalogID",u,r)){if(t.minZoomQuicklooks&&this.zoom<t.minZoomQuicklooks)continue;var m=i.getPropItem(t.quicklookPlatform,u,r)||t.quicklookPlatform||"";if(!(m&&"imageMercator"!==m||i.getQuicklookPointsFromProperties(u,t)))continue}t.styleHook&&(l.styleExtend=t.styleHook(t.dataManager.getItem(h),t.lastHover&&h===t.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&n.intersectsWithDelta(c.bounds,-1,-1)&&o.push(l)}return this._getVisibleItems(o)},_getTileRasters:function(e){return new Promise(function(t){Promise.all(this._getNeedRasterItems(e).map(this._getItemRasters.bind(this))).then(t)}.bind(this))},_chkItems:function(e){var t=this.layer;if(!t._map)return null;var r=e&&e.added&&e.added.length?e.added:null;if(!r){var i=t._tiles[this.zKey];return i&&i.el&&i.el.getContext("2d").clearRect(0,0,256,256),null}return this.gmx.sortItems?t.getSortedItems(r):r},destructor:function(){this._preRenderPromise&&this._preRenderPromise.reject(),this._renderPromise&&this._renderPromise.reject(),this._cancelRastersPromise(),this._clearCache()},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.reject&&this.rastersPromise.reject(),this.rastersPromise=null)},_clearCache:function(){for(var e in this.rasterRequests)this.rasterRequests[e].remove();this.rasterRequests={}},drawTile:function(e){return this.destructor(),new Promise(function(r,i){var n=this._chkItems(e),o=function(){r({count:n.length})}.bind(this),s=this;if(this._uniqueID++,n){var a=this.tile,l=a.getContext("2d"),u=this.gmx,h={tbounds:this.tbounds,rasters:this.rasters,gmx:u,topLeft:this.topLeft,tpx:this.tpx,tpy:this.tpy,ctx:l};t.DomUtil.addClass(a,"__zKey:"+this.zKey);var c=function(){l.clearRect(0,0,256,256),u.showScreenTiles&&(l.strokeRect(0,0,255,255),l.strokeText(s.zKey,50,50));var e,r={zKey:s.zKey,topLeft:s.topLeft,tpx:s.tpx,tpy:s.tpy,x:s.tilePoint.x,y:s.tilePoint.y,z:s.zoom},c=[];u.preRenderHooks.forEach(function(t){e||(e=document.createElement("canvas"),e.width=e.height=256);var i=t(e,r);i&&i.then&&c.push(i)}),Promise.all(c).then(function(){e&&(h.bgImage=e);for(var l=0,c=n.length;c>l;l++){var d=n[l],m=d.id,f=u.dataManager.getItem(m);if(f){var p=u.styleManager.getObjStyle(f),g=u.lastHover&&u.lastHover.id===d.id&&p;if(u.multiFilters)for(var v=0,y=f.multiFilters.length;y>v;v++){var x=f.multiFilters[v];t.gmxUtil.drawGeoItem(d,f,h,g?x.parsedStyleHover:x.parsedStyle,x.style)}else t.gmxUtil.drawGeoItem(d,f,h,g?f.parsedStyleHover:f.parsedStyleKeys,p);m in u._needPopups&&!u._needPopups[m]&&(u._needPopups[m]=!0)}}s.rasters={},Promise.all(s._getHooksPromises(u.renderHooks,a,r)).then(o,i)},i)};this.showRaster?(this.rastersPromise=this._getTileRasters(n),this.rastersPromise.then(c,i)):c()}else r()}.bind(this)).catch(function(e){console.warn("catch1:",e)})},_getHooksPromises:function(e,t,r){var i=[];return e.forEach(function(e){var n=e(t,r);n&&n.then&&i.push(n)}),i},_drawDone:function(){for(var e in this.rasterRequests){var t=this.rasterRequests[e];this._uniqueID!==t.options.tileRastersId&&(t.remove(),delete this.rasterRequests[e])}}},function(){var e=1e6,r=function(e){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=e,e.on("add",this.onAdd,this),e.on("remove",this.onRemove,this)};r.prototype={addToReorder:function(e,t){++this.count,this.all[e]=t?-this.count:this.count},clickFunc:function(e){if(!this.disabled){var t=e.gmx.id;this.addToReorder(t,e.originalEvent.ctrlKey),this.layer.redrawItem(t)}},sortItems:function(t,r){var i=this._objectsReorder;if(i.count>0){var n=i.all[t.id],o=i.all[r.id];if(n||o)return n=n?n+(n>0?e:-e):0,o=o?o+(o>0?e:-e):0,n-o}return i.sortFunc?i.sortFunc.call(this,t,r):0},resetSortFunc:function(){var e=this.layer,t=e._gmx,r=t.zIndexField;t.sortItems=this.sortItems,this.sortFunc=r&&!this.userSetSortFunc?function(e,t){var i=Number(e.properties[r])-Number(t.properties[r]);return i?i:e.id-t.id}:function(e,t){return e.id-t.id}},initialize:function(){var e=this.layer._gmx;this.userSetSortFunc||"polygon"!==e.GeometryType&&"linestring"!==e.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},t.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new r(this))},getReorderArrays:function(){var e={top:[],bottom:[]};if(this._objectsReorder)for(var t=this._objectsReorder,r=Object.keys(t.all).sort(function(e,r){return t.all[e]-t.all[r]}),i=0,n=r.length;n>i;i++){var o=r[i];t.all[o]>0?e.top.push(o):e.bottom.push(o)}return e},bringToTopItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e),this.redrawItem(e),this
},bringToBottomItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e,!0),this.redrawItem(e),this},clearReorderArrays:function(){if(this._objectsReorder){var e=this._objectsReorder;e.all={},e.count=0,this.repaint()}return this},setReorderArrays:function(e,t){this._objectsReorderInit();var r=this._objectsReorder;return r.all={},r.count=0,t&&t.forEach(function(e){r.addToReorder(e,!0)}),e&&e.forEach(function(e){r.addToReorder(e)}),this.repaint(),this},getSortedItems:function(e){return this._objectsReorderInit(),e.sort(t.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))},setSortFunc:function(e){this._objectsReorderInit();var t=this._objectsReorder;return t.sortFunc=e,t.userSetSortFunc=e?!0:!1,this._gmx.sortItems=t.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}();var v=function(e){this.gmx=e,this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this)),this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var t=1/0,r=-1/0,i=e.properties.styles||[],n=0,o=i.length;o>n;n++){var s=i[n];t=Math.min(t,s.MinZoom),r=Math.max(r,s.MaxZoom)}this.minZoom=1/0===t?0:t,this.maxZoom=r===-1/0?18:r};v.prototype={_getMaxStyleSize:function(e){for(var t=0,r=0,i=this._styles.length;i>r;r++){var n=this._styles[r];if(!(e>n.MaxZoom||e<n.MinZoom)){var o=n.RenderStyle;if(this._needLoadIcons||!o||!("maxSize"in o)){t=v.MAX_STYLE_SIZE;break}var s=0;"iconAnchor"in o&&!o.iconCenter&&(s=Math.max(Math.abs(o.iconAnchor[0]),Math.abs(o.iconAnchor[1]))),t=Math.max(o.maxSize+s,t)}}return t},getStyleBounds:function(e){if(!e)return i.bounds();this._maxStyleSize=this._getMaxStyleSize(this.gmx.currentZoom);var t=2*this._maxStyleSize*i.tileSizes[e.z]/256;return i.getTileBounds(e.x,e.y,e.z).addBuffer(t)},isVisibleAtZoom:function(e){for(var t=0,r=this._styles.length;r>t;t++){var i=this._styles[t];if(e>=i.MinZoom&&e<=i.MaxZoom)return!0}return!1},getIcons:function(e){var t=this;this.promise.then(function(){for(var r=[],i=0,n=t._styles.length;n>i;i++){var o=t._styles[i],s={};o.RenderStyle&&(s.RenderStyle={image:o.RenderStyle.image}),o.HoverStyle&&(s.HoverStyle={image:o.HoverStyle.image}),r.push(s)}e&&e(r)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var e=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(t){return e._chkStyleFilter(t)}),this.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=0,t=this._deferredIcons.length;t>e;e++)this._getImageSize(this._deferredIcons[e]);return this._deferredIcons=[],this._chkReady(),this.promise},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=[],r=0,i=this._styles.length;i>r;r++){var n=t.extend({},this._styles[r]);n.RenderStyle=v.getStyleKeys(n.RenderStyle),n.HoverStyle&&(n.HoverStyle=v.getStyleKeys(n.HoverStyle)),delete n.filterFunction,delete n.version,delete n.common,delete n.type,e.push(n)}return e},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var e=this;this._styles.map(function(t){t.version=++e._maxVersion})},setStyle:function(e,r,i){if(r=r||0,r<this._styles.length||i){var n=this._styles[r];if(n||(n=this._prepareItem({}),this._styles[r]=n),n.version=++this._maxVersion,"Filter"in e){n.Filter=e.Filter;var o=typeof e.Filter;n.filterFunction="string"===o?t.gmx.Parsers.parseSQL(n.Filter.replace(/[\[\]]/g,'"')):"function"===o?n.Filter:null,this._changeStylesVersion()}for(var s=0,a=v.DEFAULT_KEYS.length;a>s;s++){var l=v.DEFAULT_KEYS[s];l in e&&(n[l]=e[l])}e.RenderStyle&&(n.RenderStyle=this._parseStyle(e.RenderStyle)),e.HoverStyle&&(n.HoverStyle=this._parseStyle(e.HoverStyle,n.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(e){var t=this.gmx.dataManager.getItem(e),r=t?t.currentFilter:0,i=this._styles[r];return i?{DisableBalloonOnMouseMove:i.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:i.DisableBalloonOnClick||!1,templateBalloon:i.Balloon||null,isSummary:/\[SUMMARY\]/.test(i.Balloon)}:null},getObjStyle:function(e){this._chkStyleFilter(e);var t,r=this._styles[e.currentFilter];return r?r.hoverDiff&&this.gmx.lastHover&&e.id===this.gmx.lastHover.id?r.HoverStyle?(t=r.HoverStyle.version||-1,t!==e.styleVersion&&(e.parsedStyleHover=this._itemStyleParser(e,r.HoverStyle)),r.HoverStyle):(delete e.parsedStyleHover,null):(t=r.version||-1,t!==e.styleVersion&&(e.parsedStyleKeys=this._itemStyleParser(e,r.RenderStyle)),r.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(e){var r=e.iconUrl||e.fillIconUrl||"",i={crossOrigin:"anonymous"},n=t.gmxUtil.isIE11&&/\.svg/.test(r),o=this;"file:"!==self.location.protocol&&(r=r.replace(/http(s*):/,"")),n&&(r+=(-1===r.indexOf("?")?"?":"&")+"crossOrigin="+i.crossOrigin),i.layerID=this.gmx.layerID,++this._needLoadIcons,t.gmx.imageLoader.unshift(r,i).def.then(function(t){if(e.version=++o._maxVersion,e.fillIconUrl)e.imagePattern=t;else{e.sx=t.width||t.offsetWidth,e.sy=t.height||t.offsetHeight,e.image=t;var r=e.iconAngle?Math.sqrt(e.sx*e.sx+e.sy*e.sy):Math.max(e.sx,e.sy);e.scaleFunction||e.rotateFunction||((e.iconScale||1===e.iconScale)&&(r*=e.iconScale),e.common=!0),e.maxSize=Number(r.toFixed())}o._needLoadIcons--,o._chkReady()},function(){e.version=++o._maxVersion,e.sx=1,e.sy=0,e.image=null,o._needLoadIcons--,o._chkReady(),console.log({url:r,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(e,t){var r=this.gmx,i=r.tileAttributeIndexes,n=r.tileAttributeTypes,o=t||1,s=[];this._serverStylesParsed||this._parseServerStyles();for(var a=0,l=this._styles.length;l>a;a++){var u=this._styles[a];if(!(o>u.MaxZoom||o<u.MinZoom||u.filterFunction&&!u.filterFunction(e,i,n)||(s.push(a),r.multiFilters)))break}return s},_chkStyleFilter:function(e){var t=this.gmx,r=t.currentZoom,i=t.multiFilters?-1:e.currentFilter,n=this._styles[i],o=!n||n.version!==e.styleVersion;if(o||e._lastZoom!==r){e.currentFilter=-1,e.multiFilters=[];for(var s=this.getCurrentFilters(e.properties,r),a=0,l=s.length;l>a;a++){var u=s[a],h=this._styles[u];if(e.hoverDiff=h.hoverDiff,e.currentFilter=u,o||i!==u){var c=h.common&&h.common.RenderStyle||this._itemStyleParser(e,h.RenderStyle),d=null;e.parsedStyleKeys=c,h.HoverStyle&&(d=h.common&&h.common.HoverStyle||this._itemStyleParser(e,h.HoverStyle),e.parsedStyleHover=d),t.multiFilters&&e.multiFilters.push({style:h.RenderStyle,styleHover:h.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(e.styleVersion=h.version,!t.multiFilters)break}e._lastZoom=r}return this._styles[e.currentFilter]?!0:(e.currentFilter=-1,!1)},_parseServerStyles:function(){for(var e=this.gmx,t=e.properties,r=t.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:v.DEFAULT_STYLE}],i=Math.max(r.length,e.styles.length),n=0;i>n;n++)if(!this._styles[n]){var o=e.styles[n]||r[n];if(o.RenderStyle||(o.RenderStyle=v.DEFAULT_STYLE),void 0===o.HoverStyle){var s=JSON.parse(JSON.stringify(o.RenderStyle));s.outline&&(s.outline.thickness+=1),o.HoverStyle=s}else null===o.HoverStyle&&delete o.HoverStyle;var a=this._prepareItem(o);this._styles.push(a),this._isLabel(a.RenderStyle)&&(e.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_iconsUrlReplace:function(e){var t=e||"";return e&&this.gmx.iconsUrlReplace&&this.gmx.iconsUrlReplace.forEach(function(e){t=t.replace(e.from,e.to)}),t},_checkStyles:function(){for(var e=1/0,t=-1/0,r=!1,i=!1,n=0,o=this._styles.length;o>n;n++){var s=this._styles[n];s.DisableBalloonOnMouseMove=s.DisableBalloonOnMouseMove===!1?!1:!0,s.DisableBalloonOnClick=s.DisableBalloonOnClick||!1,(s.DisableBalloonOnMouseMove===!1||s.DisableBalloonOnClick===!1)&&(r=!0,s.BalloonEnable=!0),s.hoverDiff=null,s.common={},s.RenderStyle&&(s.RenderStyle.iconUrl&&(s.RenderStyle.iconUrl=this._iconsUrlReplace(s.RenderStyle.iconUrl)),s.HoverStyle&&s.HoverStyle.iconUrl&&(s.HoverStyle.iconUrl=this._iconsUrlReplace(s.HoverStyle.iconUrl)),i||this._isLabel(s.RenderStyle)&&(i=!0),s.RenderStyle.common&&(s.common.RenderStyle=this._itemStyleParser({},s.RenderStyle)),s.HoverStyle&&(s.hoverDiff=v.checkDiff(s.RenderStyle,s.HoverStyle))),s.HoverStyle&&s.HoverStyle.common&&(s.common.HoverStyle=this._itemStyleParser({},s.HoverStyle)),e=Math.min(e,s.MinZoom),t=Math.max(t,s.MaxZoom)}1/0!==this.minZoom&&(this.minZoom=e),this.maxZoom!==-1/0&&(this.maxZoom=t),this.gmx.balloonEnable=r,this.gmx.labelsLayer=i},_parseStyle:function(e,r){if(e){e.common=!0;for(var n in e)if(i.styleFuncKeys[n]){var o=i.styleFuncKeys[n],s=e[n];"string"==typeof s?(e.common=!1,r&&r[n]===s?e[o]=r[o]:(this._parserFunctions[s]||(this._parserFunctions[s]=t.gmx.Parsers.parseExpression(s)),e[o]=this._parserFunctions[s])):"function"==typeof s&&(e.common=!1,e[o]=s)}var a="";if("iconUrl"in e)a="image",e.iconUrl&&(e.maxSize=256,this._deferredIcons.push(e));else if(e.fillIconUrl)a="square",this._deferredIcons.push(e);else if(e.fillPattern)a="square",e.common=v.parsePattern(e.fillPattern),e.canvasPattern=i.getPatternIcon(null,e);else if(e.iconCircle)a="circle","iconSize"in e||(e.iconSize=4);else if(e.iconPath){a="iconPath";var l=0,u=t.Util.isArray(e.iconPath)?e.iconPath:v.DEFAULT_ICONPATH;e.iconPath=v.DEFAULT_ICONPATH.map(function(e,t){var r=u[t]||e;return l=Math.max(l,r),r}),e.iconSize=2*l}else if(e.fillRadialGradient){a="circle","iconCenter"in e||(e.iconCenter=!0);var h=v.parseRadialGradient(e.fillRadialGradient);null===h?e.common=!1:e.iconSize=h}else e.fillLinearGradient?(a="square",e.common=v.parseLinearGradient(e.fillLinearGradient)):e.iconSize&&(a="square","iconCenter"in e||(e.iconCenter=!0));e.type=a,e.common&&!e.maxSize&&(e.maxSize=e.iconSize||0,e.maxSize+=e.weight?e.weight:0,"iconScale"in e&&(e.maxSize*=e.iconScale))}return e},_prepareItem:function(e){var r={MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18,Filter:e.Filter||null,Balloon:e.Balloon||"",RenderStyle:e.RenderStyle?this._parseStyle(t.gmxUtil.fromServerStyle(e.RenderStyle)):{},version:++this._maxVersion};if(r.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove===!1?!1:!0,r.DisableBalloonOnClick=e.DisableBalloonOnClick||!1,e.HoverStyle&&(r.HoverStyle=this._parseStyle(t.gmxUtil.fromServerStyle(e.HoverStyle),r.RenderStyle)),"Filter"in e){var i=t.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));i&&(r.filterFunction=i)}return r},_isLabel:function(e){var t=this.gmx.tileAttributeIndexes;return e&&(e.labelTemplate||e.labelField&&e.labelField in t)},_itemStyleParser:function(e,t){t=t||{};var r,n,o,s={},a=this.gmx.tileAttributeIndexes,l=e.properties||{},u=e.type,h=t.type,c="color"in t?t.color:255,d="opacity"in t?t.opacity:1;if(s.sx=t.sx,s.sy=t.sy,t.maxSize&&(s.maxSize=t.maxSize),t.iconAngle){var m=t.iconAngle||0;m&&"string"==typeof m&&(m=t.rotateFunction?t.rotateFunction(l,a):0),s.rotate=m||0}if("iconColor"in t&&(s.iconColor="iconColorFunction"in t?t.iconColorFunction(l,a):t.iconColor),"iconScale"in t&&(s.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,a):1:t.iconScale),"image"===h)s.type=h,t.iconUrl&&(s.iconUrl=t.iconUrl),t.image&&(s.image=t.image);else if(t.fillRadialGradient){var f=t.fillRadialGradient,p=f.r1Function?f.r1Function(l,a):f.r1,g=f.r2Function?f.r2Function(l,a):f.r2,v=f.x1Function?f.x1Function(l,a):f.x1,y=f.y1Function?f.y1Function(l,a):f.y1,x=f.x2Function?f.x2Function(l,a):f.x2,_=f.y2Function?f.y2Function(l,a):f.y2;f.r2max&&(g=Math.min(g,f.r2max));var b=[];for(o=f.addColorStop.length,f.addColorStopFunctions||(f.addColorStopFunctions=new Array(o)),n=0;o>n;n++){r=f.addColorStop[n];var S=f.addColorStopFunctions[n]||[],P=S[0]?S[0](l,a):r[0],T=r[3];if(r.length<4){var I=r.length<3?1:S[2]?S[2](l,a):r[2];T=i.dec2color(S[1]?S[1](l,a):r[1],I)}b.push([P,T])}s.maxSize=s.sx=s.sy=s.iconSize=g,s.fillRadialGradient={x1:v,y1:y,r1:p,x2:x,y2:_,r2:g,addColorStop:b},s._radialGradientParsed={create:[v,y,p,x,_,g],colorStop:b}}else if(t.fillLinearGradient)s.fillLinearGradient=t.fillLinearGradient;else{if(t.fillPattern&&(s.canvasPattern=t.canvasPattern?t.canvasPattern:i.getPatternIcon(e,t,a)),"iconPath"===h&&(s.type=h,s.iconPath=t.iconPath),("POLYGON"===u||"MULTIPOLYGON"===u||"polygon"===this.gmx.GeometryType)&&(h="polygon"),t.iconSize){var L="sizeFunction"in t?t.sizeFunction(l,a):t.iconSize;s.sx=s.sy=L,s.iconSize=L,"iconScale"in t&&(s.iconSize*=t.iconScale),s.maxSize=L}s.stroke=!0,("colorFunction"in t||"opacityFunction"in t)&&(c="colorFunction"in t?t.colorFunction(l,a):c,d="opacityFunction"in t?t.opacityFunction(l,a):d),s.strokeStyle=i.dec2color(c,d),s.lineWidth="weight"in t?t.weight:1}if("iconScale"in t&&(s.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,a):1:t.iconScale),"iconAnchor"in t&&(s.iconAnchor=t.iconAnchor),"iconCenter"in t&&(s.iconCenter=t.iconCenter),"square"===h||"polygon"===h||"circle"===h||"iconPath"===h){s.type=h;var M=t.fillOpacity,k=t.fillColor,C="string"==typeof k?parseInt(k.replace(/#/,""),16):k;"fillColor"in t&&(s.fillStyle=i.dec2color(C,1)),"fillColorFunction"in t||"fillOpacityFunction"in t?(c="fillColorFunction"in t?t.fillColorFunction(l,a):k||255,d="fillOpacityFunction"in t?t.fillOpacityFunction(l,a):M||1,s.fillStyle=i.dec2color(c,d)):"fillOpacity"in t&&"fillColor"in t&&(s.fillStyle=i.dec2color(C,M))}if("dashArray"in t&&(s.dashArray=t.dashArray),"dashOffset"in t&&(s.dashOffset=t.dashOffset),this.gmx.labelsLayer){for(r=i.styleKeys.label.client,n=0,o=r.length;o>n;n++){var O=r[n];if(O in t){if("labelField"===O){if(!a[t[O]])continue}else if("labelTemplate"===O){var w=i.getPropertiesHash(l,a);s.labelText=i.parseTemplate(t[O],w)}s[O]=t[O]}}"labelAnchor"in t&&(s.labelAnchor=t.labelAnchor)}return s}},v.MAX_STYLE_SIZE=256,v.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8}},v.DEFAULT_KEYS=["MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick"],v.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],v.parsePattern=function(e){var r=!0,i=t.gmx.Parsers;if("step"in e&&"string"==typeof e.step&&(e.patternStepFunction=i.parseExpression(e.step),r=!1),"width"in e&&"string"==typeof e.width&&(e.patternWidthFunction=i.parseExpression(e.width),r=!1),"colors"in e){for(var n=[],o=0,s=e.colors.length;s>o;o++){var a=e.colors[o];"string"==typeof a?(n.push(i.parseExpression(a)),r=!1):n.push(null)}e.patternColorsFunction=n}return r},v.getStyleKeys=function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,s=n.client.length;s>o;o++){var a=n.client[o];a in e&&(void 0!==e[a]&&(t[a]=JSON.parse(JSON.stringify(e[a]))),"fillPattern"===a?delete t[a].patternColorsFunction:"fillLinearGradient"===a&&delete t[a].addColorStopFunctions)}return"iconAnchor"in e&&(t.iconAnchor=e.iconAnchor),"labelAnchor"in e&&(t.labelAnchor=e.labelAnchor),t},v.checkDiff=function(e,t){for(var r in e)if(e[r]!==t[r])return r;return null},v.parseRadialGradient=function(e){var r=!0,n=t.gmx.Parsers,o=0,s=["r1","x1","y1","r2","x2","y2"],a=s.length;for(o=0;a>o;o++){var l=s[o];e[l]||(e[l]=0),"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),r=!1)}for(e.addColorStop=e.addColorStop||[[0,16711680,.5],[1,16777215,.5]],e.addColorStopFunctions=[],o=0,a=e.addColorStop.length;a>o;o++){s=e.addColorStop[o];var u=["string"==typeof s[0]?n.parseExpression(s[0]):null,"string"==typeof s[1]?n.parseExpression(s[1]):null,"string"==typeof s[2]?n.parseExpression(s[2]):null];e.addColorStopFunctions.push(u),null===u[1]&&null===u[2]?s[3]=i.dec2color(s[1],s[2]>1?s[2]/100:s[2]):r=!1}return"r2Function"in e&&(r=!1),r?Math.max(e.r1,e.r2):null},v.parseLinearGradient=function(e){var r=!0,i=0,n=t.gmx.Parsers,o=["x1","y1","x2","y2"],s=[0,0,0,256],a=o.length;for(i=0;a>i;i++){var l=o[i];l in e?"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),r=!1):e[l]=s[i]}for(e.addColorStop=e.addColorStop||[[0,16711680],[1,16777215]],e.addColorStopFunctions=[],i=0,a=e.addColorStop.length;a>i;i++)o=e.addColorStop[i],e.addColorStopFunctions.push(["string"==typeof o[0]?n.parseExpression(o[0]):null,"string"==typeof o[1]?n.parseExpression(o[1]):null,"string"==typeof o[2]?n.parseExpression(o[2]):null]);return r},t.gmx.VectorLayer.include({bindPopup:function(e,r){var i=t.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},r);return this._popup&&this.unbindPopup(),e instanceof t.Popup?this._popup=e:((!this._popup||r)&&(this._popup=new t.Popup(i)),this._popup.setContent(e)),this._popup._initContent=e,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),i&&i.popupopen&&(this._popupopen=i.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var e in this._gmx._needPopups)this._gmx._needPopups[e]&&(this.addPopup(e),delete this._gmx._needPopups[e])},disablePopup:function(){return this._popupDisabled=!0,this},enablePopup:function(){return this._popupDisabled=!1,this},openPopup:function(e,t){return this._popup&&(e=e||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],t=t||{},t.latlng=e,this._openPopup(t)),this},closePopup:function(e){return this._popup&&(this._popup._close(),"mouseout"!==e&&this.getPopups().forEach(this._clearPopup.bind(this)),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(e){if("mouseover"===this._popup._state){var t=this._popup.options._gmxID||-1;t!==e.gmx.id&&this._setPopupContent(e),this._popup.setLatLng(e.latlng)}},_overPopup:function(e){var t=this._popup;t._map?this.fire("popupopen",{popup:t,gmx:this._setPopupContent(e,t)}):this._openPopup(e),"mouseover"===t._state&&t.setLatLng(e.latlng)},_outPopup:function(e){"mouseover"!==this._popup._state||e.gmx.prevId||this.closePopup(e.type)},_callBalloonHook:function(e,t){var r,i,n,o=t.getElementsByTagName("span"),s={};for(r in this._balloonHook){var a=this._balloonHook[r].hookID;for(s[r]=0,i=0,n=o.length;n>i;i++)o[i].id===a&&s[r]++}for(r in this._balloonHook){var l=this._balloonHook[r],u=l.hookID,h=!0;for(i=0,n=o.length;n>i;i++){var c=o[i];c.id===u&&(h=!1,c.id+="_"+i,l.callback(e,t,c,s))}h&&l.callback(e,t,null,s)}},_setPopupContent:function(e,r){r||(r=this._popup);var n=e.gmx||{},o=n.balloonData||{},s=t.extend({},n.properties),a=n.target||{},l=a.geometry||{},u=a.offset,h=r._initContent||o.templateBalloon||"",c=e.type,d=this.options.isGeneralized&&("mouseover"===c||"mousemove"===c),m={id:n.id,type:c,nodePoint:n.nodePoint,latlng:e.latlng,properties:s,templateBalloon:h};if("POINT"===l.type){var f=t.gmxUtil.geometryToGeoJSON(l,!0,3857==n.srs);m.latlng=t.latLng(f.coordinates.reverse())}if(u){var p=t.Popup.prototype.options.offset;r.options.offset=[-p[0]-u[0],p[1]-u[1]]}else r.options.offset[1]="mouseover"===c?-7:7;if(this._popupopen)this._popupopen({popup:r,latlng:m.latlng,layerPoint:e.layerPoint,contentNode:r._contentNode,containerPoint:e.containerPoint,originalEvent:e.originalEvent,gmx:m});else if(!(h instanceof t.Popup)){if(!(h instanceof HTMLElement)){var g,v="",y=this._map?this._map.options:{};if(d||(g=a.geometry?[a.geometry]:n.geometries||this._gmx.dataManager.getItemGeometries(n.id)||[],m.summary=v=t.gmxUtil.getGeometriesSummary(g,y)),this._balloonHook){h||(h=i.getDefaultBalloonTemplate(s));for(var x in this._balloonHook)s[x]=i.parseTemplate(this._balloonHook[x].resStr,s)}h=t.gmxUtil.parseBalloonTemplate(h,{properties:s,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:y,summary:v,geometries:g})}var _=t.DomUtil.create("div","");_.innerHTML=h,r.setContent(_),this._balloonHook&&this._callBalloonHook(n.properties,r.getContent())}return r.options._gmxID=n.id,m},_openClickPopup:function(e){var r=e.originalEvent||{},n=!e.gmx||this._popupDisabled||r.ctrlKey||r.altKey||r.shiftKey;if(!n){var o=e.type,s=e.gmx,a=s.balloonData,l="click"===o&&a.isSummary&&!a.DisableBalloonOnClick,u=s.target;if(l&&u.options.isGeneralized&&!u.geometry){var h=s.layer.getGmxProperties();i.getLayerItemFromServer({options:e,layerID:h.name,value:u.id,field:h.identityField}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result){var r=e.Result.values[0];t.options.gmx.target.fromServerProps=r,t.options.gmx.target.geometry=r[r.length-1],this._openPopup(t.options)}}.bind(this))}else-1!==u.type.indexOf("POINT")&&(e.latlng=t.latLng(t.gmxUtil.geometryToGeoJSON(u.properties[u.properties.length-1],!0,3857==this._gmx.srs).coordinates.reverse())),this._openPopup(e)}},_openPopup:function(e,r){var i=this._map,n=e.originalEvent||{},o=r?!r:this._popupDisabled||n.ctrlKey||n.altKey||n.shiftKey;if(!o){var s=e.type,a=this._popup,l=e.gmx||{},u=l.balloonData||{};if("click"===s){if(!r&&u.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in i||(i._gmxPopups=[]),"maxPopupCount"in i.options||(i.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,i.on({layerremove:function(e){if(e.layer instanceof t.Popup)this._clearPopup(e.layer);else if(e.layer===this){if(i._gmxPopups){var r=this._gmx.layerID;i._gmxPopups=i._gmxPopups.reduce(function(e,t){return t._map&&(t.options.layerId===r?t._map.removeLayer(t):e.push(t)),e},[])}this.closePopup()}}},this)),this._clearPopup(l.id);var h=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};a=new t.Popup(t.extend({},h,{closeOnClick:1===i.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==s)return;if(u.DisableBalloonOnMouseMove)return a._state="",void 0;a.options.autoPan=!1}a.options.objectId=l.id,a._state=s;var c=this._setPopupContent(e,a);if(a.setLatLng(c.latlng),this.fire("popupopen",{popup:a,gmx:c}),"click"===s&&(i._gmxPopups.length>=i.options.maxPopupCount&&i.removeLayer(i._gmxPopups.shift()),i._gmxPopups.push(a)),a.addTo(i),a._closeButton){var d=a._closeButton.style;"mouseover"===s&&"hidden"!==d?(d.visibility="hidden",a._container.style.marginBottom="7px",a._container.style.pointerEvents="none"):"click"===s&&"inherit"!==d&&(d.visibility="inherit",a._container.style.marginBottom="",a._container.style.pointerEvents="")}}},_clearPopup:function(e){var r=this._map;if(r&&r._gmxPopups){var i=this._gmx.layerID,n=e instanceof t.Popup;r._gmxPopups=r._gmxPopups.reduce(function(t,r){return r._map&&(n&&r===e?r._map.removeLayer(r):r.options.layerId===i&&r.options.objectId===e?r._map.removeLayer(r):t.push(r)),t},[])}},getPopups:function(e){var t=this._map,r=[];if(t&&t._gmxPopups){var i=this._gmx.layerID;t._gmxPopups.reduce(function(t,r){return r.options.layerId===i&&t.push(e?r:r.options.objectId),t},r)}return r},addPopup:function(e){var r=this._gmx,i=r.dataManager.getItem(e);if(i&&this._map){var n=i.bounds.getCenter(),o=t.latLng(t.gmxUtil.coordsFromMercator("Point",n,3857==r.srs).reverse());this._openPopup({type:"click",latlng:o,gmx:this.getHoverOption(i)},!0),delete r._needPopups[e]}else r._needPopups[e]=!1;return this},addPopupHook:function(e,r){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[e]){var i="_"+t.stamp({});this._balloonHook[e]={key:e,hookID:i,resStr:'<span id="'+i+'"></span>',callback:r}}return this},removePopupHook:function(e){return this._balloonHook&&delete this._balloonHook[e],this}}),t.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(e,t,r){for(var n,o,s=this._gmx,a=s.mInPixel,l=e.length-1;l>=0;l--){var u=e[l].properties,h=u[0],c=e[l].dataOption||{},d=s.dataManager.getItem(h),m=d.currentStyle||d.parsedStyleKeys||{},f=m.iconScale||1,p=m.iconCenter,g=!p&&m.iconAnchor?m.iconAnchor:null,v=s.styleManager.getObjStyle(d),y=m.lineWidth||v.lineWidth||0,x=y+(v.sx||m.sx||0),_=y+(v.sy||m.sy||0),b=[f*x/2,f*_/2],S=t,P=u[u.length-1],T=P.type;"POINT"===T&&"circle"===v.type&&(b[0]*=2,b[1]*=2);var I=b[0],L=i.bounds().extendBounds(c.bounds).addBuffer(b[0]/a,b[1]/a);if(g&&(b=[g[0]-b[0],g[1]-b[1]],S=[t[0]+b[0]/a,t[1]-b[1]/a]),L.contains(S)){var M=m.fillStyle||m.canvasPattern||v.bgImage||v.fillColor,k=v&&v.image?v.image:null,C=T,O=c.hiddenLines||[],w=c.boundsArr,D=P.coordinates,F=null,R={point:t,bounds:r,coords:D,boundsArr:w};if(("MULTIPOLYGON"===T||"POLYGON"===T)&&(k?C="POINT":M||("POLYGON"===T?(C="MULTILINESTRING",O=O[0]):C="LIKEMULTILINESTRING",R.hidden=O)),"LINESTRING"===C){if(!i.isPointInPolyLine(t,y/a,D)&&(F=i.bounds([S]).addBuffer(b[0]/a,b[1]/a).isNodeIntersect(D),null===F))continue}else if("LIKEMULTILINESTRING"===C){R.delta=y/a;var E=!1;for(n=0,o=D.length;o>n;n++)if(R.coords=D[n],R.hidden=O?O[n]:null,R.boundsArr=w[n],i.isPointInLines(R)){E=!0;break}if(!E)continue}else if("MULTILINESTRING"===C){if(R.delta=y/a,R.hidden=O,!i.isPointInLines(R)){var N=i.bounds([S]).addBuffer(b[0]/a,b[1]/a);for(n=0,o=D.length;o>n;n++)if(F=N.isNodeIntersect(D[n]),null!==F){F.ring=n;break}if(null===F)continue}}else if("MULTIPOLYGON"===C||"POLYGON"===C){var A=t;for(E=!1,"POLYGON"===C&&(D=[P.coordinates],w=[c.boundsArr]),n=0,o=D.length;o>n;n++)for(var G=D[n],U=w[n],z=0,B=G.length;B>z;z++){var H=U[z];if(H.intersects(r)&&i.isPointInPolygonWithHoles(A,G)){E=0===z?!0:!1;break}}if(!E)continue}else if("POINT"===C&&"circle"===v.type){var V=(D[0]-S[0])*a,q=(D[1]-S[1])*a;if(V*V+q*q>I*I)continue}if(this.isPointInClipPolygons(t))return{id:h,properties:d.properties,geometry:P,bounds:d.bounds,nodePoint:F,offset:g?b:null,parsedStyle:v}}}return null},gmxEventCheck:function(e,r){if(!this._map)return 0;var n=this,o=n._gmx,s=e.type,a=o.lastHover,l=function(t){a&&"mousemove"===s&&(t&&n.hasEventListeners(t)&&(e.gmx=a,n.fire(t,e)),a.hoverDiff&&n.redrawItem(a.id))},u=this._map.getZoom();if((u>this.options.maxZoom||u<this.options.minZoom)&&(r=!0),r)a&&(a.prevId=null),l("mouseout"),o.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(s)||"mousemove"===s&&"Raster"!==o.properties.fromType){var h=e.latlng.lng%360,c=new t.LatLng(e.latlng.lat,h+(-180>h?360:h>180?-360:0)),d=3857==o.srs?t.CRS.EPSG3857:t.Projection.Mercator,m=d.project(c)._subtract({x:o.shiftXlayer||0,y:o.shiftYlayer||0}),f=Math.max(5,o.styleManager._getMaxStyleSize(u))/o.mInPixel,p=[m.x,m.y],g=o.dataManager.getViewFilters("screen",o.layerID),v={type:"resend",layerID:o.layerID,needBbox:o.needBbox,bbox:i.bounds([p]).addBuffer(f),dateInterval:"VectorTemporal"===o.layerType?[o.beginDate,o.endDate]:null,filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"].concat(g),active:!1};this.options.isGeneralized&&(v.targetZoom=u),o.dataManager.addObserver(v,"hover");var y=o.dataManager.getItems("hover");if(o.dataManager.removeObserver("hover"),y&&y.length){y.length>1&&o.sortItems&&(y=this.getSortedItems(y));var x=this._gmxFirstObjectsByPoint(y,p,v.bbox);if(x){var _=x.id,b=o.dataManager.getItem(_),S=a?a.id:null,P=!a||a.id!==_;if("mousemove"===s&&a){if(!P)return e.gmx=a,this.fire(s,e),_;e.gmx=a,this.fire("mouseout",e),l(b.currentFilter!==a.currentFilter?"mouseout":""),o.lastHover=null}return e.gmx=t.extend(this.getHoverOption(b),{targets:y,nodePoint:x.nodePoint,prevId:S,hoverDiff:b.hoverDiff}),this.hasEventListeners(s)&&this.fire(s,e),"mousemove"===s&&P&&(a=o.lastHover=e.gmx,l("mouseover"),o.lastMouseover=o.lastHover),this._map.doubleClickZoom.disable(),_}}}return this._map&&this._map.doubleClickZoom.enable(),0},getHoverOption:function(e){return{layer:this,target:e,balloonData:this._gmx.styleManager.getItemBalloon(e.id),properties:this.getItemProperties(e.properties),currentFilter:e.currentFilter||0,id:e.id}}}),function(){var e=2e4,r={},i={},n="/Layer/CheckVersion.ashx",o=null,s=null,a={},l=function(e){var t=e.Temporal?"TemporalTiles":"tiles";return t in e||e.currentTiles},u=function(e,t,r){var i={Name:e.name,Version:l(e)?e.LayerVersion:-1};if(t&&(e.UseTiles===!1||"NotVisible"===r.skipTiles||r.needBbox)){var n=t.getMaxDateInterval(),o=n.beginDate||r.beginDate,s=n.endDate||r.endDate;o&&(i.dateBegin=Math.floor(o.getTime()/1e3)),s&&(i.dateEnd=Math.floor(s.getTime()/1e3))}return i},h=function(e){var i,n,o,s,a={};if(e)e.target instanceof t.gmx.DataManager&&(e=e.target),e instanceof t.gmx.DataManager?(o=e,i=o.options):(i=e._gmx.properties,o=e._gmx.dataManager,s=e._gmx),n=i.hostName||e._gmx.hostName,a[n]=[u(i,o,s)];else{var l={};for(var h in r){var c=r[h],d=c instanceof t.gmx.DataManager;if(c.options.chkUpdate||d){o=d?c:c._gmx.dataManager,i=d?c.options:c._gmx.properties,s=d?c:c._gmx,n=i.hostName||c._gmx.hostName;var m=u(i,o,s),f=m.Name+m.Version;l[f]||(a[n]?a[n].push(m):a[n]=[m]),l[f]=!0}}}return a},c=function(e,i){var o=d._map,s=function(n){if(n&&"ok"===n.Status&&n.Result){var s,a,l,u,h,c=n.Result,m=c.length,f=0;if(d.needBbox){for(s=0;m>s;s++){if(h=c[s],u=h.name||h.properties.name,l=null,e&&e._gmx.properties.name===u)l=e;else for(a in r)if(l=r[a],!(e&&e===l&&"updateVersion"in e)){if(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l)break;if(l instanceof t.gmx.DataManager&&l.options.name===u)break}l&&(f+=(l.getDataManager?l.getDataManager():l).getNotLoadedVectorTiles(h))}if(o.fire("needLoadTiles",{count:f}),t.gmx.skipLoadTiles)return console.log("Skiped tiles: ",t.gmx.needLoadTiles),void 0}for(s=0;m>s;s++){h=c[s],u=h.name||h.properties.name,e&&e._gmx.properties.name===u&&"updateVersion"in e&&e.updateVersion(h);for(a in r)l=r[a],e&&e===l||(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l?l.updateVersion(h):l instanceof t.gmx.DataManager&&l.options.name===u&&l.updateVersion(h.properties,h.tiles))}}i&&i(n)};if(document.body&&!t.gmxUtil.isPageHidden()){var l=h(e),u=function(i){var u=t.gmxUtil.protocol+"//"+i+n,h=JSON.stringify(l[i]),c="WrapStyle=None&ftc=osm";if(d.needBbox){var m=t.Projection.Mercator;3857==o.options.srs&&(c+="&srs=3857",m=t.CRS.EPSG3857);var f=o.getZoom(),p=o.getBounds(),g=m.project(p.getSouthWest()),v=m.project(p.getNorthEast()),y=[g.x,g.y,v.x,v.y].join(",");c+="&zoom="+f,c+="&bbox=["+y+"]"}if(c+="&layers="+encodeURIComponent(h),e||!a[i]||a[i]!==c){"FormData"in window&&t.gmxUtil.request({url:u,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:c,withCredentials:!0,callback:function(e){a[i]=c,s(JSON.parse(e))},onError:function(e){console.log("Error: LayerVersion ",e)}});var x=Date.now();for(var _ in r){var b=r[_],S=b._gmx||b.options;S.hostName===i&&(S._stampVersionRequest=x)}}};for(var c in l)u(c)}},d={needBbox:!1,addDataManager:function(e){var t=e.options,i=t.name;i in r||(t.needBbox&&!d.needBbox&&(d.needBbox=t.needBbox),e.on("chkLayerUpdate",c.bind(e)),r[i]=e)},removeDataManager:function(e){var t=e.options.name;t in r&&(e.off("chkLayerUpdate",c.bind(e)),delete r[t])},remove:function(e){delete r[e._gmx.layerID];var t=e._gmx,n=e.options.parentOptions;if(n){var o=n.name;i[o]&&(delete i[o][t.properties.name],Object.keys(i[o]).length||(d.removeDataManager(t.dataManager),delete i[o]))}else t.dataManager.off("chkLayerUpdate",t._chkVersion)},add:function(e){var t=e._gmx.layerID;if(!(t in r)){var n=e._gmx,o=n.properties;if("LayerVersion"in o){r[t]=e,n._chkVersion=function(){c(e)},n.dataManager.on("chkLayerUpdate",n._chkVersion);var s=e.options.parentOptions;if(s){var a=s.name;d.addDataManager(n.dataManager),i[a]||(i[a]={}),i[a][o.name]=e}n.needBbox&&!d.needBbox&&(d.needBbox=n.needBbox),d.start(),d.now()}}},chkVersion:c,now:function(){s&&clearTimeout(s),s=setTimeout(c,0)},stop:function(){o&&clearInterval(o),o=null},start:function(t){t&&(e=t),d.stop(),o=setInterval(c,e)}};t.gmx||(t.gmx={}),t.gmx.layersVersion=d,t.gmx.VectorLayer.include({updateVersion:function(e){if(e){var r=this._gmx;e.geometry&&(r.geometry=e.geometry),e.properties&&(t.extend(r.properties,e.properties),r.properties.currentTiles=e.tiles,r.properties.GeoProcessing=e.properties.GeoProcessing,r.rawProperties=r.properties,this.fire("versionchange")),!r.dataSource&&r.dataManager&&r.dataManager.updateVersion(r.rawProperties,e.tiles)
}}}),t.Map.addInitHook(function(){d._map=this;var e=this,t={};this.on("moveend",function(){var r=e.getZoom(),i=e.getPixelBounds().getCenter();(r!==t.z||t.center.distanceTo(i)>128)&&(c(),t.z=r,t.center=i)})})}(),t.gmx.RasterLayer=t.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(e){var r=e.properties,n=r.styles[0]||{MinZoom:r.MinZoom||0,MaxZoom:r.MaxZoom||21},o={type:"Vector",fromType:r.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,RasterSRS:Number(r.RasterSRS)||3857,Copyright:r.Copyright||"",RCMinZoomForRasters:n.MinZoom,visible:r.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:n.MinZoom,MaxZoom:n.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},s=this._gmx,a=i.tileSizes[1];return r.MaxZoom&&(s.maxNativeZoom=r.MaxZoom),e.geometry?3857==s.srs&&s.srs!=o.RasterSRS&&(e.geometry=i.convertGeometry(i.convertGeometry(e.geometry,!0,!0),!1,!0)):e.geometry={type:"POLYGON",coordinates:[[[-a,-a],[-a,a],[a,a],[a,-a],[-a,-a]]]},t.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:e.geometry,properties:o,rawProperties:e.properties}),s.rasterBGfunc=function(e,r,i){var n=t.gmxUtil.protocol+"//"+s.hostName+"/"+"TileSender.ashx?ModeKey=tile&ftc=osm"+"&z="+i+"&x="+e+"&y="+r;return s.srs&&(n+="&srs="+s.srs),s.crossOrigin&&(n+="&cross="+s.crossOrigin),n+="&LayerName="+s.layerID,s.sessionKey&&(n+="&key="+encodeURIComponent(s.sessionKey)),n},s.dataManager._rasterVectorTile=new m({load:function(t,r,n,o,l,u,h){var c=[[777,e.geometry]],d=i.geoItemBounds(e.geometry),m=d.bounds;if(m.max.x>a){var f=2*a,p=777,g=e.geometry.coordinates,v=d.boundsArr;c=[],"POLYGON"===e.geometry.type&&(g=[g],v=[v]);for(var y=0,x=g.length;x>y;y++){var _=g[y],b=v[y][0],S=_;if(c.push([p++,{type:"POLYGON",coordinates:S}]),b.max.x>a){S=[];for(var P=0,T=_.length;T>P;P++){for(var I=_[P],L=0,M=[],k=I.length;k>L;L++){var C=I[L];M.push([C[0]-f,C[1]])}S.push(M)}c.push([p++,{type:"POLYGON",coordinates:S}])}}}h({bbox:[m.min.x,m.min.y,m.max.x,m.max.y],srs:s.srs,isGeneralized:!1,changeState:!0,values:c}),s.dataManager._updateItemsFromTile(s.dataManager._rasterVectorTile)}},{x:0,y:0,z:0,v:0,s:-2,d:-2}),s.dataManager.addTile(s.dataManager._rasterVectorTile),this},setZoomBounds:function(e,r){var i=this.getStyles().slice(0);i[0]=t.extend({},i[0]),i[0].MinZoom=e,i[0].MaxZoom=r,this.setStyles(i)}}),t.LabelsLayer=(t.Layer||t.Class).extend({options:{labels:"default",pane:"overlayPane"},initialize:function(e,r){t.setOptions(this,r),this._observers={},this._styleManagers={},this._labels={},this._labelsIndex={};var n=this;this.bbox=i.bounds();var o=function(r,o){if(r.added||r.removed){for(var s=o.options,a=e._zoom>=s.minZoom&&e._zoom<=s.maxZoom?r.added:[],l="_"+o._leaflet_id,u=o._gmx,h={},c=0,d=a.length;d>c;c++){var m=a[c].item,f="POINT"===m.type||"MULTIPOINT"===m.type,p=m.parsedStyleKeys||m.currentStyle||{};if(u.styleHook){var g=u.styleHook(m,u.lastHover&&m.id===u.lastHover.id);if(!g)continue;p=t.extend({},p,g)}if(m.multiFilters)for(var v=0,y=m.multiFilters.length;y>v;v++){var x=m.multiFilters[v].parsedStyle;if("labelField"in x||"labelText"in x){p=x;break}}var _=u.styleManager.getObjStyle(m)||{},b=p.labelText||_.labelText,S=p.labelField||_.labelField,P=u.tileAttributeTypes[S],T=String(b||t.gmxUtil.attrToString(P,o.getPropItem(S,m.properties)));if(_.labelTemplate){var I,L=/\[([^\]]*)\]/g;for(T=_.labelTemplate;I=L.exec(_.labelTemplate);)if(2===I.length){S=I[1],P=u.tileAttributeTypes[S];var M=t.gmxUtil.attrToString(P,o.getPropItem(S,m.properties));T=T.replace(I[0],M)}}if(T||0===T){var k,C=_.labelFontSize||p.labelFontSize||12,O="_"+m.id,w=!0,D=0,F=m.options,R={font:C+'px "Arial"',labelHaloColor:"labelHaloColor"in p?p.labelHaloColor:"labelHaloColor"in _?_.labelHaloColor:16777215,labelColor:p.labelColor||_.labelColor,labelAlign:p.labelAlign||_.labelAlign,labelAnchor:p.labelAnchor||_.labelAnchor,labelFontSize:C};if(F){if(!("center"in F)){var E=i.getItemCenter(m,u.dataManager.getItemMembers(m.id));if(!E)continue;F.center=E}if(F.label){D=F.label.width,k=F.label.arrTxtWidth;var N=F.label.style;w=F.label.txt!==T||N.labelHaloColor!==R.labelHaloColor||N.labelColor!==R.labelColor||N.labelAlign!==R.labelAlign||N.labelAnchor!==R.labelAnchor||N.labelFontSize!==R.labelFontSize}}if(w){if(D=0,k=i.getLabelWidth(T,R),k&&k.forEach(function(e){D=Math.max(D,e[1])}),!D){delete h[O];continue}D+=4,m.options.labelStyle=null}F.label={isPoint:f,width:D,sx:_.sx||0,txt:T,arrTxtWidth:k,style:R},h[O]=m}}n._labelsIndex[l]=o.options.zIndex,n._labels[l]=h}},s=function(e,t){var r=e._gmx,i=["styleFilter","userFilter"],s={type:"resend",bbox:n.bbox,filters:i,callback:function(t){o(t,e),n.redraw()}};return r.beginDate&&r.endDate&&(s.dateInterval=[r.beginDate,r.endDate]),r.dataManager.addObserver(s,"_Labels_"+t)};this.add=function(e){var t=e._leaflet_id,r=e._gmx;!n._observers[t]&&r&&r.labelsLayer&&t&&r.styleManager.promise.then(function(){var i=s(e,t),o=n._map._zoom;e.options.isGeneralized&&(i.targetZoom=o),i.dateInterval&&e.on("dateIntervalChanged",function(e){var t=e.target.getDateInterval();this.setDateInterval(t.beginDate,t.endDate)},i),r.styleManager.isVisibleAtZoom(o)||i.deactivate(),n._observers[t]=i,n._styleManagers[t]=r.styleManager,n._labels["_"+t]={},n._labelsIndex["_"+t]={},n._updateBbox()})},this.remove=function(e){var t=e._leaflet_id;if(n._observers[t]){var r=e._gmx,i=r.dataManager;i.removeObserver(n._observers[t].id),delete n._observers[t],delete n._styleManagers[t],delete n._labels["_"+t],delete n._labelsIndex["_"+t],n.redraw()}},this._layeradd=function(e){n.add(e.layer)},this._layerremove=function(e){n.remove(e.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=t.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var e=this._map.getPanes()[this.options.pane];e&&e.insertBefore(this._canvas,e.firstChild)},onAdd:function(e){this._map=e,this._canvas||this._initCanvas();var t=window.location.search.match("labels=([^&]+)");t&&(this.options.labels=t[1]),e.on("moveend",this._reset,this),e.on({layeradd:this._layeradd,layerremove:this._layerremove}),e.on("zoomstart",function(){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas)},this),this._reset()},onRemove:function(e){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("layeradd",this._layeradd),e.off("layerremove",this._layerremove)},addTo:function(e){return e.addLayer(this),this},_initCanvas:function(){var e=t.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer"),r=this._map.getSize();e.width=r.x,e.height=r.y,e.style.pointerEvents="none",this._canvas=e;var i=this._map.options.zoomAnimation&&t.Browser.any3d;t.DomUtil.addClass(e,"leaflet-zoom-"+(i?"animated":"hide"))},_updateBbox:function(){var e=this._map,r=e.getBounds(),n=r.getSouthWest(),o=r.getNorthEast(),s=3857==e.options.srs?t.CRS.EPSG3857:t.Projection.Mercator,a=s.project(n),l=s.project(o),u=e.getZoom();this.mInPixel=i.getPixelScale(u),this._ctxShift=[a.x*this.mInPixel,l.y*this.mInPixel];for(var h in this._observers){var c=this._observers[h];c.targetZoom&&(c.targetZoom=u),c.setBounds({min:{x:n.lng,y:n.lat},max:{x:o.lng,y:o.lat}})}},_reset:function(){this._updateBbox();for(var e in this._observers){var t=this._observers[e];!t.isActive()&&this._styleManagers[e].isVisibleAtZoom(this._map.getZoom())&&t.activate(),t.fire("update")}},_redraw:function(){var e=[],r=this._map,n=r.getSize(),o=this._canvas,s=this.options.labels,a=r.latLngToContainerPoint(r.getBounds().getNorthWest()),l=r.containerPointToLayerPoint(a);o.width=n.x,o.height=n.y,t.DomUtil.setPosition(o,l);var u,h,c,d=2*this.mInPixel*i.worldWidthMerc,m=d*Math.floor(r.getPixelBounds().min.x/d),f=o.getContext("2d"),p=Object.keys(this._labels).sort(function(e,t){return this._labelsIndex[t]-this._labelsIndex[e]}.bind(this));if(p.forEach(function(t){var r=this._labels[t];for(var o in r){c=r[o];var a=c.options,l=a.label,f=l.style,p=f.labelAlign||"center",g=l.arrTxtWidth,v=g.length||1,y=l.width,x=y/2,_=f.labelFontSize||12,b=_/2,S=a.center,P=[S[0]*this.mInPixel,S[1]*this.mInPixel],T=!1;if(l.isPoint){var I=l.sx;"left"===p?P[0]+=x+I:"right"===p&&(P[0]-=y+I)}P[0]-=x+this._ctxShift[0],P[1]=-b-P[1]+this._ctxShift[1],b*=v,f.labelAnchor&&(P[0]+=f.labelAnchor[0],P[1]+=f.labelAnchor[1]);for(var L=P[0]+m;L<n.x;L+=d){var M=[Math.floor(L),Math.floor(P[1])],k=i.bounds([[M[0],M[1]-b],[M[0]+y,M[1]+b]]);if("All"!==s){for(u=0,h=e.length;h>u;u++)if(k.intersects(e[u].bbox)){T=!0;break}if(T)continue}a.labelStyle||(a.labelStyle={font:_+'px "Arial"',fillStyle:i.dec2color(f.labelColor||0,1),shadowBlur:4},-1!==f.labelHaloColor&&(a.labelStyle.strokeStyle=a.labelStyle.shadowColor=i.dec2color(f.labelHaloColor,1))),e.push({arr:c.properties,bbox:k,arrTxtWidth:g,width2:"center"===p?x:0,txt:l.txt,style:a.labelStyle,size:_,coord:M})}}}.bind(this)),e.length){for(f.clearRect(0,0,o.width,o.height),u=0,h=e.length;h>u;u++)c=e[u],c.arrTxtWidth.forEach(function(e,t){var r=[c.coord[0],c.coord[1]+(t+1)*c.size];i.setLabel(f,e[0],r,c.style)});o.parentNode||this._addToPane()}else o.parentNode&&o.parentNode.removeChild(o);this._frame=null}}),t.labelsLayer=function(e,r){return new t.LabelsLayer(e,r)},t.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new t.LabelsLayer(this,this.options),this._labelsLayer.addTo(this))}),function(){var e=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;o>n;n++)for(var s=i[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;h>u;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,m=c.length;m>d;d++)if(c[d].intersects(e))return!0}return!1},r=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;o>n;n++)for(var s=i[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;h>u;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,m=c.length;m>d;d++)if(e.intersects(c[d]))return!0}return!1},n=function(e,t){if(!t||0===Object.keys(t).length)return!0;for(var r in t)for(var n=t[r],o=0,s=n.length;s>o;o++)for(var a=n[o],l=a.geometry.type,u=a.boundsArr,h=0,c=u.length;c>h;h++){var d=u[h];"Polygon"===l&&(d=[d]);for(var m=0,f=d.length;f>m;m++)if(d[m].contains(e)){var p=a.geometry.coordinates,g=!1;"Polygon"===l&&(p=[p]);for(var v=0,y=p.length;y>v;v++)if(i.isPointInPolygonWithHoles(e,p[v])){g=!0;break}if(g)return!0}}return!1},o=function(e){var t=i.convertGeometry(e),r=i.geoItemBounds(t);return r.geometry=t,r},s=function(e){var t=document.createElement("canvas");t.width=t.height=256;var r=t.getContext("2d"),n=e.clipPolygons;e.ctx=r,r.fillStyle=r.createPattern(e.tile,"no-repeat");for(var o in n)for(var s=n[o],a=0,l=s.length;l>a;a++){var u=s[a].geometry,h=u.coordinates;"Polygon"===u.type&&(h=[h]);for(var c=0,d=h.length;d>c;c++){var m=h[c];r.beginPath();for(var f=0,p=m.length;p>f;f++){e.coords=m[f];var g=i.getRingPixels(e);e.coords=g.coords,i.polygonToCanvasFill(e)}r.closePath(),r.fill()}}r=e.tile.getContext("2d"),r.clearRect(0,0,256,256),r.drawImage(t,0,0)};t.gmx.VectorLayer.include({isPointInClipPolygons:function(e){return n(e,this._gmx._clipPolygons)},addClipPolygon:function(i){var a,l,u=[];if("coordinates"in i&&"type"in i)u.push(o(i));else if(i instanceof t.Polygon)u.push(o(i.toGeoJSON().geometry));else if(i instanceof t.GeoJSON){var h=i.getLayers();for(a=0,l=h.length;l>a;a++){var c=h[a];c instanceof t.Polygon&&c.feature?u.push(o(c.feature.geometry)):c instanceof t.MultiPolygon&&c.feature&&u.push(o(c.feature.geometry))}}if(u.length){var d=this._gmx,m=d.dataManager,f=this,p=t.stamp(i);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[p]=u,m.setTileFilteringHook(function(t){return e(t.bounds,f._gmx._clipPolygons)}),m.addFilter("clipFilter",function(e,t,i){return r(i,f._gmx._clipPolygons)}),m.addFilter("clipPointsFilter",function(e){if("POINT"===e.type){var t=e.properties,r=t[t.length-1];return n(r.coordinates,f._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&d.renderHooks.unshift(function(e,t){e&&Object.keys(f._gmx._clipPolygons).length>0&&s({tile:e,topLeft:t.topLeft,tpx:t.tpx,tpy:t.tpy,gmx:{mInPixel:d.mInPixel},clipPolygons:f._gmx._clipPolygons})})}return this},removeClipPolygon:function(e){var r=t.stamp(e);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[r],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}(),t.gmx.gmxImageTransform=function(e,r){var n=r.gmx,o=r.gmxTilePoint,s=n.mInPixel,a=r.geoItem,l=a.properties,u=a.dataOption||{},h=n.tileAttributeIndexes,c=l[h[n.quicklookPlatform]]||n.quicklookPlatform||"",d={};"LANDSAT8"===c?(d.x1=u.bounds.min.x,d.y1=u.bounds.max.y,d.x2=u.bounds.max.x,d.y2=u.bounds.max.y,d.x3=u.bounds.max.x,d.y3=u.bounds.min.y,d.x4=u.bounds.min.x,d.y4=u.bounds.min.y):d=i.getQuicklookPointsFromProperties(l,n);var m=s*d.x1,f=s*d.y1,p=s*d.x2,g=s*d.y2,v=s*d.x3,y=s*d.y3,x=s*d.x4,_=s*d.y4,b=i.bounds([[m,f],[p,g],[v,y],[x,_]]),S=Math.round(b.max.x-b.min.x),P=Math.round(b.max.y-b.min.y),T=256-b.max.y+256*o.y,I=a.item.bounds,L=i.worldWidthMerc,M=o.x;0>M&&I.max.x>L&&I.min.x<-L&&(M+=Math.round(L*s/128));var k=b.min.x-256*M;m-=b.min.x,f=b.max.y-f,p-=b.min.x,g=b.max.y-g,v-=b.min.x,y=b.max.y-y,x-=b.min.x,_=b.max.y-_;var C=[[m,f],[p,g],[v,y],[x,_]];n.ProjectiveImage||(n.ProjectiveImage=(n.useWebGL?t.gmx.projectiveImageWebGL():null)||t.gmx.projectiveImage());var O=n.ProjectiveImage.getCanvas({imageObj:e,points:C,wView:S,hView:P,deltaX:k,deltaY:T});return O.canvas},function(){function e(e){return[e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]]}function r(e,t){for(var r=Array(9),i=0;3!==i;++i)for(var n=0;3!==n;++n){for(var o=0,s=0;3!==s;++s)o+=e[3*i+s]*t[3*s+n];r[3*i+n]=o}return r}function i(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[3]*t[0]+e[4]*t[1]+e[5]*t[2],e[6]*t[0]+e[7]*t[1]+e[8]*t[2]]}function n(t){var n=[t[0],t[2],t[4],t[1],t[3],t[5],1,1,1],o=i(e(n),[t[6],t[7],1]);return r(n,[o[0],0,0,0,o[1],0,0,0,o[2]])}var o=t.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;            uniform mat4 uTransformMatrix;            varying vec2 vTextureCoord;            void main(void) {                vTextureCoord = aVertCoord;                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);            }        ",shaderFS:"precision mediump float;            varying vec2 vTextureCoord;            uniform sampler2D uSampler;            void main(void) {                gl_FragColor = texture2D(uSampler, vTextureCoord);            }        "},setOptions:function(e){t.setOptions(this,e)},initialize:function(e){this.setOptions(e);var t=document.createElement("canvas"),r={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},i=t.getContext("webgl",r)||t.getContext("experimental-webgl",r);if(i){var n=this._setupGlContext(i);n&&(t.width=t.height=256,n.canvas=t,this.glResources=n,this.canvas=t,this.gl=i)}},_getShader:function(e,t,r){var i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(r.deleteShader(i),null)},_setupGlContext:function(e){var t=this._getShader(e.VERTEX_SHADER,this.options.shaderVS,e),r=this._getShader(e.FRAGMENT_SHADER,this.options.shaderFS,e);if(t&&r){var i=e.createProgram();if(e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)){e.useProgram(i),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var n=e.createBuffer(),o=e.getAttribLocation(i,"aVertCoord");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),{transMatUniform:e.getUniformLocation(i,"uTransformMatrix"),samplerUniform:e.getUniformLocation(i,"uSampler"),screenTexture:e.createTexture()}}}return null},_bindTexture:function(e,t,r){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},getCanvas:function(e){var t=e.points,r=e.deltaX,i=e.deltaY,n=new Float32Array([(t[0][0]+r)/128-1,1-(t[0][1]+i)/128,(t[1][0]+r)/128-1,1-(t[1][1]+i)/128,(t[3][0]+r)/128-1,1-(t[3][1]+i)/128,(t[2][0]+r)/128-1,1-(t[2][1]+i)/128]),s=o.Utils.general2DProjection(this.vertices,n),a=this.gl,l=this.glResources;return this._bindTexture(a,e.imageObj,l.screenTexture),a.viewport(0,0,256,256),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.uniformMatrix4fv(l.transMatUniform,!1,[s[0],s[3],0,s[6],s[1],s[4],0,s[7],0,0,1,0,s[2],s[5],0,1]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,l.screenTexture),a.uniform1i(l.samplerUniform,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),this}});o.Utils={general2DProjection:function(t,i){var o=r(n(i),e(n(t)));if(o[8])for(var s=0;9!==s;++s)o[s]=o[s]/o[8];return o},getWebGlResources:function(e){var t=new o(e);return t.gl?t:null}},t.gmx.projectiveImageWebGL=function(e){var t=new o(e);return t.gl?t:null}}(),function(){var e=function(){var e=0,t=4,r=64,n=null,o=function(e,t){for(var r=[],i=0;t>i;++i){r[i]=[];for(var n=0;e>n;++n)r[i][n]=0}return r},s=function(e,t,r){this.w=e,this.h=t,this.values=r||o(t)},a=function(e){for(var t=[],r=0;r<e.length;++r)t[r]=[].concat(e[r]);return t};s.prototype={add:function(e){if(e.w!==this.w||e.h!==this.h)throw new Error("Matrix add size mismatch");for(var t=o(this.w,this.h),r=0;r<this.h;++r)for(var i=0;i<this.w;++i)t[r][i]=this.values[r][i]+e.values[r][i];return new s(this.w,this.h,t)},transformProjectiveVector:function(e){var t,r,i=[];for(r=0;r<this.h;++r)for(i[r]=0,t=0;t<this.w;++t)i[r]+=this.values[r][t]*e[t];var n=i[i.length-1];if(n){var o=1/i[i.length-1];for(r=0;r<this.h;++r)i[r]*=o}return i},multiply:function(e){var t,r,i;if(+e!==e){if(e.h!==this.w)throw new Error("Matrix mult size mismatch");for(t=o(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<e.w;++r){for(var n=0,a=0;a<this.w;a++)n+=this.values[i][a]*e.values[a][r];t[i][r]=n}return new s(e.w,this.h,t)}for(t=o(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<this.w;++r)t[i][r]=this.values[i][r]*e;return new s(this.w,this.h,t)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var e=a(this.values),t=0;t<this.h;++t){for(var r=e[t][t];0===r;){for(var i=t+1;i<this.h;++i)if(0!==e[i][t]){var n=e[i];e[i]=e[t],e[t]=n;break}if(i===this.h)return new s(this.w,this.h,e);r=e[t][t]}for(var o=1/r,l=t;l<this.w;++l)e[t][l]*=o;for(var u=0;u<this.h;++u)if(u!==t){var h=e[u][t];for(e[u][t]=0,l=t+1;l<this.w;++l)e[u][l]-=h*e[t][l]}}return new s(this.w,this.h,e)},invert:function(){var e,t;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var r=o(2*this.w,this.h);for(t=0;t<this.h;++t)for(e=0;e<this.w;++e)r[t][e]=this.values[t][e],r[t][e+this.w]=e===t?1:0;r=new s(2*this.w,this.h,r),r=r.rowEchelon();var i=o(this.w,this.h);for(t=0;t<this.w;++t)for(e=0;e<this.w;++e)i[t][e]=r.values[t][e+this.w];return new s(this.w,this.h,i)}};var l=function(e){var t=new s(9,8,[[1,1,1,0,0,0,-e[2][0],-e[2][0],-e[2][0]],[0,1,1,0,0,0,0,-e[3][0],-e[3][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[2][1],e[2][1],e[2][1]],[0,0,0,0,-1,-1,0,e[3][1],e[3][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]),r=t.rowEchelon().values,i=new s(3,3,[[-r[0][8],-r[1][8],-r[2][8]],[-r[3][8],-r[4][8],-r[5][8]],[-r[6][8],-r[7][8],1]]);return i},u=function(t,i,o,s,a,l,h,c,d,m){if(d){var f=[l[0]+h[0]-2*a[0],l[1]+h[1]-2*a[1]],p=[l[0]+h[0]-2*c[0],l[1]+h[1]-2*c[1]],g=[f[0]+p[0],f[1]+p[1]],v=Math.abs((g[0]*g[0]+g[1]*g[1])/(f[0]*p[0]+f[1]*p[1]));f=[l[0]-a[0]+c[0]-h[0],l[1]-a[1]+c[1]-h[1]],p=[h[0]-a[0]+c[0]-l[0],h[1]-a[1]+c[1]-l[1]];var y=Math.abs(f[0]*p[1]-f[1]*p[0]);if(0===t&&1===o||(.25+5*v)*y>r*r){var x=(t+o)/2,_=(i+s)/2,b=n.transformProjectiveVector([x,_,1]),S=n.transformProjectiveVector([x,i,1]),P=n.transformProjectiveVector([x,s,1]),T=n.transformProjectiveVector([t,_,1]),I=n.transformProjectiveVector([o,_,1]);return d--,u.call(this,t,i,x,_,a,S,T,b,d,m),u.call(this,x,i,o,_,S,l,b,I,d,m),u.call(this,t,_,x,s,T,b,h,P,d,m),u.call(this,x,_,o,s,b,I,P,c,d,m),void 0}}var L=m.ctx,M=[l[0]-a[0],l[1]-a[1]],k=[c[0]-l[0],c[1]-l[1]],C=[h[0]-c[0],h[1]-c[1]],O=[a[0]-h[0],a[1]-h[1]],w=Math.abs(M[0]*O[1]-M[1]*O[0]),D=Math.abs(k[0]*M[1]-k[1]*M[0]),F=Math.abs(C[0]*k[1]-C[1]*k[0]),R=Math.abs(O[0]*C[1]-O[1]*C[0]),E=Math.max(Math.max(w,D),Math.max(R,F)),N=0,A=0,G=0,U=0;E===w?(L.setTransform(M[0],M[1],-O[0],-O[1],a[0]+m.deltaX,a[1]+m.deltaY),1!==o&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1]))):E===D?(L.setTransform(M[0],M[1],k[0],k[1],l[0]+m.deltaX,l[1]+m.deltaY),1!==o&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),N=-1):E===F?(L.setTransform(-C[0],-C[1],k[0],k[1],c[0]+m.deltaX,c[1]+m.deltaY),1!==o&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),N=-1,A=-1):E===R&&(L.setTransform(-C[0],-C[1],-O[0],-O[1],h[0]+m.deltaX,h[1]+m.deltaY),1!==o&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1])),A=-1);var z=o-t,B=s-i;G++,U++;var H=m.imageObj.width,V=m.imageObj.height,q=Math.floor(t*H),Z=Math.floor(i*V),j=Math.floor(Math.min(G*z,1)*H),K=Math.floor(Math.min(U*B,1)*V);e++,L.drawImage(m.imageObj,q,Z,j,K,N,A,G,U)};this.getCanvas=function(o){e=0,n=l(o.points);var s=n.transformProjectiveVector([0,0,1]),a=n.transformProjectiveVector([1,0,1]),h=n.transformProjectiveVector([0,1,1]),c=n.transformProjectiveVector([1,1,1]),d=document.createElement("canvas");d.width=d.height=256,o.canvas=d,o.ctx=d.getContext("2d");var m=i.bounds([s,a,c,h]),f=Math.max(m.max.x-m.min.x,m.max.y-m.min.y);t="limit"in o?o.limit:200>f?1:4,r="patchSize"in o?o.patchSize:f/8;try{u(0,0,1,1,s,a,h,c,t,o)}catch(p){console.log("Error: ProjectiveImage event:",p),d=null}return{canvas:d,ptl:s,ptr:a,pbl:h,pbr:c,cnt:e}}};t.gmx.projectiveImage=function(){return new e}}(),t.RotatedMarker=t.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:t.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){t.Marker.prototype._initIcon.call(this),this._icon.style[t.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var e=this.options.icon.options.iconAnchor;return e?e[0]+"px "+e[1]+"px":"50% 50%"},_setPos:function(e){if(t.Marker.prototype._setPos.call(this,e),t.DomUtil.TRANSFORM)this._icon.style[t.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(t.Browser.ie){var r=this.options.angle*(Math.PI/180),i=Math.cos(r),n=Math.sin(r);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+i+", M12="+-n+", M21="+n+", M22="+i+")"}},setAngle:function(e){this.options.angle=e}}),t.rotatedMarker=function(e,r){return new t.RotatedMarker(e,r)},t.gmx.ExternalLayer=t.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var e=this.parentLayer._gmx;this._observer.setDateInterval(e.beginDate,e.endDate)}},options:{useDataManager:!0,observerOptions:{delta:0,filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(e,r){t.setOptions(this,e),this.parentLayer=r,r.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),r._map&&(this._addEvent({target:{_map:r._map}}),this._updateBbox())},_addObserver:function(e){this._items={},this._observer=this.parentLayer.addObserver(t.extend({bbox:i.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:t.bind(this.updateData,this)},e)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var e=this._map||this.parentLayer._map;this._onRemove(!e),this._removeMapHandlers()},_addMapHandlers:function(e){e&&(this._map=e,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this))},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(e){this._addMapHandlers(e.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(e){var t=e.layer;return t._gmx&&t._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(e){this._isParentLayer(e)&&this._chkZoom()},_layerremove:function(e){this._isParentLayer(e)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(e){this._observer&&this._observer.deactivate();var t=this._map;t&&(t.hasLayer(this.externalLayer)&&(this._chkZoom(),t.removeLayer(this.externalLayer)),e||this.parentLayer.onAdd(t))},_chkZoom:function(){if(this._map){var e=this.parentLayer,t=this._observer,r=this._map,i=r.hasLayer(this.externalLayer);e.setCurrentZoom&&e.setCurrentZoom(r),this.isExternalVisible(r.getZoom())?e._map&&(e.onRemove(r),i||r.addLayer(this.externalLayer),this.setDateInterval(),t&&e.getIcons(function(){t.activate()}.bind(this)),e.disablePopup()):(t&&t.deactivate(),e._map||(i&&r.removeLayer(this.externalLayer),e.onAdd(r)),e.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var e=this._map,r=e.getBounds(),i=r.getNorthWest(),n=r.getSouthEast(),o=t.gmxUtil.bounds([[i.lng,i.lat],[n.lng,n.lat]]),s=this.options.observerOptions.delta,a=s?s*t.gmxUtil.tileSizes[e.getZoom()]/256:0;this._observer.setBounds(o,a)}}}),function(){var e=t.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var e=this.parentLayer.options,r={map:e.mapID,layers:e.layerID,format:this.options.format,transparent:this.options.transparent},i=this.parentLayer.getGmxProperties();return i&&i.Temporal&&this._extendOptionsByDateInterval(r),this.options.apikey&&(r.apikey=this.options.apikey),t.tileLayer.wms(t.gmxUtil.protocol+"//"+e.hostName+"/TileService.ashx",r)},_extendOptionsByDateInterval:function(e){var r=this.parentLayer.getDateInterval(),i=r.beginDate,n=r.endDate;t.extend(e,{StartDate:i&&i.toLocaleDateString(),EndDate:n&&n.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)}});t.gmx.VectorLayer.include({bindWMS:function(t){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new e(t,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}(),function(){var e=t.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return t.heatLayer([],t.extend({},this.options))},isExternalVisible:function(e){return!(e<this.options.minHeatMapZoom||e>this.options.maxHeatMapZoom)},updateData:function(e){if(e.added){var r=[],i=this.parentLayer.getTileAttributeIndexes(),n=null,o=this.options.intensityField||"",s=this.options.intensityScale||1;o&&o in i&&(n=i[o]);for(var a=0,l=e.added.length;l>a;a++){var u=e.added[a].properties,h=null!==n?u[n]:1,c=u[u.length-1],d=c.coordinates,m=t.Projection.Mercator.unproject({x:d[0],y:d[1]});r.push([m.lat,m.lng,"function"==typeof s?s(h):s*h])}this.externalLayer.setLatLngs(r)}}});t.gmx.VectorLayer.include({bindHeatMap:function(r){return t.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new e(r,this)),this},unbindHeatMap:function(){return t.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}(),function(){var e={radiusFunc:function(e){var t=Math.floor(e/15);return t>40?t=40:20>t&&(t=20),t},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},r=t.gmx.ExternalLayer.extend({options:{observerOptions:{delta:256,filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,minZoom:1,maxZoom:6},createExternalLayer:function(){var r=t.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var i=this.options.clusterIconOptions;if("radialGradient"in i){var n=i.radialGradient,o=i.text||e.text;r.iconCreateFunction=function(r){var i=r.getChildCount();return o.count=i,t.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(n.radiusFunc||e.radiusFunc)(i),text:o,fillRadialGradient:n})}}}this.options.clusterclick&&(r.clusterclick=this.options.clusterclick,r.clusterclick===!0&&(r.zoomToBoundsOnClick=!1)),this._popup=new t.Popup({maxWidth:1e4,className:"gmxPopup"});var s=new t.MarkerClusterGroup(r),a=null;return s.on("click",function(e){var r=e.layer.options.properties,i=this.parentLayer.getItemProperties(r),n=[r[r.length-1]],o=r[0];!a||a.getAllChildMarkers().indexOf(e.layer)+1?this._openPopup(r,e.latlng):(a.unspiderfy(),s.once("unspiderfied",function(){this._openPopup(r,e.latlng)},this)),this.parentLayer.fire("click",t.extend(e,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:o,layer:this.parentLayer,properties:i,target:{id:o,properties:r,geometry:n}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(e){this.parentLayer.fire("clusterclick",t.extend(e,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(e){a=e.cluster},this).on("unspiderfied",function(){a=null},this),r.clusterclick&&s.on("clusterclick",r.clusterclick instanceof Function?r.clusterclick:function(e){e.layer.spiderfy()}),s},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)},updateData:function(e){var r,i,n,o,s,a=[];if(e.removed){for(r=0,i=e.removed.length;i>r;r++)n=e.removed[r],o=n.id,s=this._items[o],s&&a.push(s),delete this._items[o];this.externalLayer.removeLayers(a),a=[]}if(e.added){for(r=0,i=e.added.length;i>r;r++){n=e.added[r],o=n.id,s=this._items[o];var l=n.properties;if(s&&l.processing&&(this.externalLayer.removeLayer(s),s=null),!s){n.item.parsedStyleKeys||(n.item.parsedStyleKeys=this.parentLayer.getItemStyle(o));var u=l[l.length-1],h=n.item.parsedStyleKeys,c=u.coordinates,d=t.Projection.Mercator.unproject({x:c[0],y:c[1]}),m={properties:n.properties,mPoint:c};if(this.options.notClusteredIcon){var f=this.options.notClusteredIcon;m.icon=f instanceof t.Icon?f:t.icon(f)}else if(h)if(h.iconUrl){var p=h.iconAnchor;if(!p){var g=this.parentLayer.getItemStyle(o);p=g.image?[g.sx/2,g.sy/2]:[8,10]}m.icon=t.icon({iconAnchor:p,iconUrl:h.iconUrl})}else m.icon=t.gmxUtil.getSVGIcon(h);s=h.rotate?t.rotatedMarker(d,t.extend(m,{angle:h.rotate})):t.marker(d,t.extend(m,{angle:h.rotate})),this._items[o]=s}a.push(s)}this.externalLayer.addLayers(a)}},_openPopup:function(e,r){var i=this.parentLayer._gmx,n=e[0],o=i.styleManager.getItemBalloon(n),s=this.parentLayer.getItemProperties(e),a=[e[e.length-1]];if(o&&!o.DisableBalloonOnClick){var l=this.parentLayer.getItemStyle(n);if(l&&l.iconAnchor){var u=t.Popup.prototype.options.offset;this._popup.options.offset=[-u[0]-l.iconAnchor[0]+l.sx/2,u[1]-l.iconAnchor[1]+l.sy/2]}this._popup.setLatLng(r).setContent(t.gmxUtil.parseBalloonTemplate(o.templateBalloon,{properties:s,tileAttributeTypes:i.tileAttributeTypes,unitOptions:this._map.options||{},geometries:a})).openOn(this._map)
}}});t.gmx.VectorLayer.include({bindClusters:function(e){return t.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new r(e,this)),this},unbindClusters:function(){return t.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}(),t.gmx=t.gmx||{};var y="maps.kosmosnimki.ru",x=2e6;t.gmx._layerClasses={Raster:t.gmx.RasterLayer,Vector:t.gmx.VectorLayer,VectorView:t.gmx.DummyLayer},t.gmx._loadingLayerClasses={},t.gmx.addLayerClass=function(e,r){t.gmx._layerClasses[e]=r},t.gmx._layerClassLoaders=[],t.gmx.addLayerClassLoader=function(e){t.gmx._layerClassLoaders.push(e),t.gmx._loadingLayerClasses={}},t.gmx._loadLayerClass=function(e){if(!t.gmx._loadingLayerClasses[e]){var r=new t.gmx.Deferred;r.resolve(),t.gmx._layerClassLoaders.forEach(function(i){r=r.then(function(r){return r?(t.gmx._layerClasses[e]=r,r):i(e)},function(){})}),r=r.then(function(r){return r?(t.gmx._layerClasses[e]=r,r):void 0},function(){}),t.gmx._loadingLayerClasses[e]=r}return t.gmx._loadingLayerClasses[e]},t.gmx.loadLayer=function(e,r,n){return new Promise(function(o,s){var a={mapID:e,layerID:r};n=n||{},n.skipTiles||(n.skipTiles="All");for(var l in n)a[l]=n[l];var h=i.normalizeHostname(n.hostName||y);a.hostName=h,u.loadMapProperties({srs:n.srs,hostName:h,apiKey:n.apiKey,mapName:e,skipTiles:n.skipTiles}).then(function(){var i=u.findLayerInfo(h,e,r);if(!i)return s("There is no layer "+r+" in map "+e),void 0;i.properties.hostName=h;var n=i.properties.ContentID||i.properties.type,l=function(){var e=t.gmx.createLayer(i,a);e?o(e):s("Unknown type of layer "+r)};n in t.gmx._layerClasses?l():t.gmx._loadLayerClass(n).then(l)},function(t){s("Can't load layer "+r+" from map "+e+": "+t.error)})})},t.gmx.loadLayers=function(e,r){return new Promise(function(i){Promise.all(e.map(function(e){var i=t.extend({},r,e.options);return t.gmx.loadLayer(e.mapID,e.layerID,i)})).then(function(e){i(e)})})},t.gmx.loadMap=function(e,r){return-1!==location.search.indexOf("debug=1")&&console.warn("L.gmx.loadMap:",e,r),r=t.extend({},r),r.hostName=i.normalizeHostname(r.hostName||y),r.mapName=e,r.skipTiles||(r.skipTiles="All"),r.srs||(r.srs=3857),r.ftc||(r.ftc="osm"),new Promise(function(i,n){u.loadMapProperties(r).then(function(n){var o=t.gmx._maps[r.hostName][e];if(o.loaded)i(o.loaded);else{var s=new t.gmx.gmxMap(n,r);o.loaded=s,s.layersCreated.then(function(){if(r.leafletMap||r.setZIndex)for(var e,t,o=0,a=s.layers.length-1;a>=0;a--)e=s.layers[a],t=e.getGmxProperties(),"VectorOnTop"===n.properties.LayerOrder&&e.setZIndexOffset&&"Raster"!==t.type&&e.setZIndexOffset(x),r.setZIndex&&e.setZIndex&&e.setZIndex(++o),r.leafletMap&&t.visible&&e.addTo(r.leafletMap);i(s)})}},function(t){var i=t&&t.ErrorInfo&&t.ErrorInfo.ErrorMessage||"Server error";n("Can't load map "+e+" from "+r.hostName+": "+i)})})},t.gmx.DummyLayer=function(e){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return e}},t.gmx.createLayer=function(e,r){e||(e={}),e.properties||(e.properties={type:"Vector"});var i,n=e.properties,o=n.ContentID||n.type||"Vector";if(r||(r=n),o in t.gmx._layerClasses)try{i=new t.gmx._layerClasses[o](r||e.properties),i=i.initFromDescription(e)}catch(s){i=new t.gmx.DummyLayer(n)}else i=new t.gmx.DummyLayer(n);return i}}();