/*
 Leaflet-GeoMixer, Leaflet plugin for visualization data from GeoMixer server
 (c) 2013-2016, RDC ScanEx
*/
!function(){"use strict";function e(e,t){this.layer=e,this.tileElem=t,this.tile=t.el;var i=t.coords,n=i.z,o=Math.pow(2,n),s=i.x%o,a=i.y%o,l=r;s<0&&(s+=o),a<0&&(a+=o),this.ntp={z:n,x:s,y:a},this.tilePoint=i,this.zoom=n,this.gmx=e._gmx,this.zKey=this.layer._tileCoordsToKey(i,n),this.worldWidthMerc=l.worldWidthMerc;var u=l.getTileNumFromLeaflet(i,n);this.tpx=256*u.x,this.tpy=256*(1+u.y);var h=l.tileSizes[i.z];this.tbounds=l.getBoundsByTilePoint(this.ntp),this.topLeft={tilePoint:i,tileSize:h,mInPixel:256/h,pix:{px:256*i.x,py:256*i.y},wm:{x:h*i.x-this.worldWidthMerc,y:this.worldWidthMerc-h*i.y},bounds:l.getBoundsByTilePoint(i)},this.gmxTilePoint=u,this.showRaster=n>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||n>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this.itemsView=[],this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}var t;"undefined"!=typeof module&&module.exports?(t=require("leaflet"),t.gmx={},module.exports=t.gmx):t=window.L,function(){var e=/\[(.+?)\]/g,i=/(floor\()/g,r={functionFromExpression:function(t){return new Function("props","indexes","return "+t.replace(e,'props[indexes["$1"]]').replace(i,"Math.$1")+";")}},n=function(e,t){return{head:e,tail:t}},o=function(e,t){return n(e,t)},s=function(e,t){return n(e,t)},a=new s((-1),null),l=function(e){return e.head===-1},u=function(e,t){return new s(e.head+t,e.tail)},h=function(e){var t=e.length;return function(i,r){return i.substr(r.head,t)===e?u(r,t):a}},c=function(e){var t=e.length;return e=e.toLowerCase(),function(i,r){return i.substr(r.head,t).toLowerCase()===e?u(r,t):a}},d=function(e,t){var i=e.charCodeAt(0),r=t.charCodeAt(0);return function(e,t){var n=e.charCodeAt(t.head);return n>=i&&n<=r?u(t,1):a}},p=function(e){return function(t,i){return t.length>i.head&&l(e(t,i))?u(i,1):a}},f=function(e){return function(t,i){for(var r=0;r<e.length;r++)if(i=e[r](t,i),l(i))return a;return i}},m=function(e){return function(t,i){for(var r=0;r<e.length;r++){var n=e[r](t,i);if(!l(n))return n}return a}},g=function(e,t){return t},v=function(e){return m([e,g])},y=function(e,t){return function(i,r){for(var n=0;;){var o=t(i,r);if(l(o))return n>=e?r:a;n+=1,r=o}}},x=function(e,t,i){var r=f([t,y(e-1,f([i,t]))]);return e>0?r:m([r,g])},_=y(0,m([h(" "),h("\t"),h("\n")])),b=function(e,t,i){return x(e,t,f([_,i,_]))},P=function(e){for(var t=[],i=0;i<e.length;i++)t.length>0&&t.push(_),t.push(e[i]);return f(t)},S=function(e){return function(t,i){var r=e(t,i);return l(r)?a:new s(r.head,new o(t.substr(i.head,r.head-i.head),r.tail))}},T=function(e,t){return function(i,r){var n=r,u=e(i,new s(n.head,null));return l(u)?a:new s(u.head,new o(t(u.tail),n.tail))}},L=S(y(1,m([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_")]))),I=S(y(1,m([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_"),h(" ")]))),M=m([L,f([h('"'),I,h('"')]),f([h("`"),I,h("`")])]),k=f([h("'"),S(y(0,p(h("'")))),h("'")]),C=y(1,d("0","9")),O=S(f([v(h("-")),C,v(f([h("."),C]))])),w=m([O,k]),D=function(e,t){return t(e,new s(0,null))},F=T(P([M,S(m([h("=="),h("!="),h("<>"),h("<="),h(">="),h("="),h("<"),h(">"),c("LIKE")])),m([w,M])]),function(e){var i=e.tail.tail.head,r=e.tail.head,n=e.head,o=null;return"LIKE"===r.toUpperCase()&&(o=function(e){var t=null;return(t=function(i,r){var o=n.charAt(i),s=e.charAt(r);return""===o?""===s:"%"===o?t(i+1,r)||""!==s&&t(i,r+1):o===s&&t(i+1,r+1)})(0,0)}),function(e,s,a){var l=e[s[i]],u=n;if(n in s&&(u=e[s[u]]),"date"!==a[i]&&"datetime"!==a[i]||"string"!=typeof u||(u=t.gmxUtil.getUnixTimeFromStr(u)),"boolean"==typeof l&&"string"==typeof u&&(l=l?"True":"False"),null===l)return!1;if(null!==o)return o(l);if("="===r||"=="===r)return l==u;if("!="===r||"<>"===r)return l!=u;var h,c;return n in s||"string"!=typeof u||D(u,O).head!==u.length?(h=l,c=u,"<"===r?h<c:">"===r?h>c:"<="===r?h<=c:">="===r&&h>=c):(h=parseFloat(l),c=parseFloat(u),"<"===r?h<c:">"===r?h>c:"<="===r?h<=c:">="===r&&h>=c)}}),R=T(P([M,c("IN"),h("("),b(0,w,h(",")),h(")")]),function(e){for(var t=e;null!=t.tail;)t=t.tail;var i=t.head;return function(t,r){var n=t[r[i]];if(null==n)return!1;for(var o=e;null!==o.tail;){if(o.head===n)return!0;o=o.tail}return!1}}),N=function(e,t){return N(e,t)},E=function(e,t){return E(e,t)},A=T(P([c("NOT"),N]),function(e){var t=e.head;return function(e,i,r){return!t(e,i,r)}});N=m([A,F,R,P([h("("),E,h(")")])]);var G=T(b(2,N,c("AND")),function(e){return function(t,i,r){for(var n=!0,o=e;null!=o;)n=n&&o.head(t,i,r),o=o.tail;return n}}),U=T(b(2,N,c("OR")),function(e){return function(t,i,r){for(var n=!1,o=e;null!=o;)n=n||o.head(t,i,r),o=o.tail;return n}});E=m([G,U,N]);var B=f([_,E,_]);r.parseSQL=function(e){var t=D(e,B);return t.head===e.length?t.tail.head:D(e,_).head===e.length?function(){return!0}:null};var z=function(e,t){return z(e,t)},H=function(e,t){return H(e,t)};z=T(b(1,H,S(m([h("+"),h("-")]))),function(e){return function(t,i,r){for(var n=e,o=0;null!==n;){if(o+=n.head(t,i,r),null===n.tail)return o;"-"===n.tail.head&&(o=-o),n=n.tail.tail}return o}});var V=m([T(O,function(e){return function(){return parseFloat(e.head)}}),T(f([h("floor("),z,h(")")]),function(e){return function(t,i,r){var n=e.head(t,i,r);return Math.floor(n)}}),T(f([h("["),L,h("]")]),function(e){return function(t,i){return parseFloat(t[i[e.head]])}}),P([h("("),z,h(")")])]);V=m([V,T(P([h("-"),V]),function(e){return function(t,i,r){return-e.head(t,i,r)}})]),H=T(b(1,V,S(m([h("*"),h("/")]))),function(e){return function(t,i,r){for(var n=e,o=1;null!==n;){if(o*=n.head(t,i,r),null===n.tail)return o;"/"===n.tail.head&&(o=1/o),n=n.tail.tail}return o}}),V=m([V,T(P([h("-"),V]),function(e){return function(t,i,r){return-e.head(t,i,r)}})]);var q=f([_,z,_]);r.parseExpression=function(e){var t=D(e,q);return t.head===e.length?t.tail.head:null};var Z=T(y(0,m([O,h(","),h("M"),h("C"),y(1,m([h(" "),h("\t"),h("\r"),h("\n")]))])),function(e){for(var t=[];null!==e;)t.push(parseFloat(e.head)),e=e.tail;return t.reverse(),t});r.parseSVGPath=function(e){var t=D(e,Z);return t.head===e.length?t.tail.head:[]},t.gmx=t.gmx||{},t.gmx.Parsers=r}();var i=function(e){var t,r=[],n=[],o=!1,s=!1,a=!1,l=!1,u=this._fulfill=function(e){if(!o){var i=e?r:n;t=[].slice.call(arguments,1),o=!0,s=e,i.forEach(function(e){e.apply(null,t)}),r=n=[]}};this.resolve=function(){l||u.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||u.apply(null,[!1].concat([].slice.call(arguments)))};var h=this.cancel=function(){l||o||(l=!0,e&&e())},c=this.then=function(e,a){if(l)return null;var u=null,c=new i(function(){h(),u&&u.cancel()}),d=function(e,t){return function(){if(e){var r=e.apply(null,arguments);r instanceof i?(u=r,r.then(c.resolve,c.reject)):c.resolve(r)}else c._fulfill.apply(null,[t].concat([].slice.call(arguments)))}};return o?d(s?e:a,s).apply(null,t):(r.push(d(e,!0)),n.push(d(a,!1))),c};this.once=function(e){a||(a=!0,c(e))},this.always=function(e){c(e,e)},this.getFulfilledData=function(){return t}};i.all=function(){var e=[].slice.apply(arguments),t=new i,r=e.length,n=new Array(e.length);return r?e.forEach(function(e,i){e.then(function(e){n[i]=e,r--,0===r&&t.resolve.apply(t,n)},function(){t.reject()})}):t.resolve(),t},t.gmx=t.gmx||{},t.gmx.Deferred=i,function(){var e=function(e,i,r){this._id=e,this.remove=t.gmx.imageLoader._removeRequestFromCache.bind(t.gmx.imageLoader,this),this.url=i,this.options=r||{},this.promise=this.def=new Promise(function(e,i){this.resolve=e,this.reject=function(){i(this.url),t.gmx.imageLoader._cancelRequest(this)}}.bind(this))["catch"](function(e){console.warn("Warning: skip url ",e)})},i=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_checkIE11bugFix:function(e,t){if(!this.divIE11bugFix){var i=document.createElement("div");this.divIE11bugFix=i,i.style.visibility="hidden",i.style.position="absolute",document.body.insertBefore(i,document.body.childNodes[0])}var r=function(){e.resolve(t)};this.divIE11bugFix.appendChild(t),setTimeout(r,0)},_resolveRequest:function(e,i,r){if(i){if(!r&&e.options.cache){var n=e.url,o=this.requestsCache[n],s=e._id;o||(o=this.requestsCache[n]={image:i,requests:{}}),o.requests[s]||(o.requests[s]=e)}t.gmxUtil.isIE11&&/\.svg/.test(e.url)?this._checkIE11bugFix(e,i):e.resolve(i)}else r||e.reject();this.fire("requestdone",{request:e})},_imageLoaded:function(e,i,r){if(e in this.inProgress){var n=function(e){this._resolveRequest(e,i,r)};this.inProgress[e].requests.forEach(n.bind(this)),--this.curCount,delete this.inProgress[e]}t.gmxUtil.loaderStatus(e,!0),this.fire("imageloaded",{url:e}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=i.MAX_COUNT)&&this.requests.length){var e=this.requests.shift(),r=e.url;if(r in this.inProgress)this.inProgress[r].requests.push(e);else{var n=[e];this.inProgress[r]={requests:n},++this.curCount;for(var o=this.requests.length-1;o>=0;o--)this.requests[o].url===r&&(n.push(this.requests[o]),this.requests.splice(o,1));var s=this._loadImage(e);s.width||t.gmxUtil.loaderStatus(r),this.inProgress[r]&&(this.inProgress[r].image=s)}}},_loadImage:function(e){var i=new Image,r=e.url,n=this;return e.options.crossOrigin&&(i.crossOrigin=e.options.crossOrigin),i.onload=this._imageLoaded.bind(this,r,i,!1),i.onerror=function(){n._imageLoaded(r)},t.gmxUtil.isIEOrEdge?setTimeout(function(){i.src=r},0):i.src=r,this.fire("imageloadstart",{url:r}),i},_cancelRequest:function(e){var i,r=e._id,n=e.url,o=0;if(n in this.inProgress){var s=this.inProgress[n],a=s.requests;if(i=a.length,1===i&&a[0]._id===r)s.image.onload=t.Util.falseFn,s.image.onerror=t.Util.falseFn,s.image.src=t.Util.emptyImageUrl,this._imageLoaded(n,null,!0);else for(o=0;o<i;o++)if(a[o]._id===r){a.splice(o,1);break}}else for(o=0,i=this.requests.length;o<i;o++)if(this.requests[o]._id===r){this.requests.splice(o,1);break}this.fire("requestdone",{request:e})},_removeRequestFromCache:function(e){this._cancelRequest(e),this._clearCacheItem(e.url,e._id)},_clearCacheItem:function(e,t){if(this.requestsCache[e]){var i=this.requestsCache[e];delete i.requests[t],0===Object.keys(i.requests).length&&delete this.requestsCache[e]}},_add:function(i,r,n){r=r.replace(/^http:/,t.gmxUtil.protocol);var o="id"+ ++this.uniqueID,s=new e(o,r,n);return r in this.inProgress?this.inProgress[r].requests.push(s):(i?this.requests.unshift(s):this.requests.push(s),this._nextLoad()),this.fire("request",{request:s}),s},push:function(e,t){return this._add(!1,e,t)},unshift:function(e,t){return this._add(!0,e,t)}});t.gmx.imageLoader=new i}();var r={lastMapId:0,fromWebMercY:function(e){return 90*(4*Math.atan(Math.exp(e/r.rMajor))/Math.PI-1)},newId:function(){return r.lastMapId+=1,"_"+r.lastMapId},uniqueGlobalName:function(e){var t=r.newId();return window[t]=e,t},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(e){var i=t.gmxUtil.parseUri(("http"!==e.substr(0,4)?t.gmxUtil.protocol+"//":"")+e);return e=i.host+i.directory,"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e},getLayerItemFromServer:function(e){var i=e.query?e.query:"["+e.field+"]="+e.value,n=t.gmxUtil.protocol+"//maps.kosmosnimki.ru/",o={WrapStyle:"func",geometry:!0,layer:e.layerID,query:i};return e.border&&(o.border=e.border),r.requestJSONP(e.url||(window.serverBase||n)+"VectorLayer/Search.ashx",o,e)},getCadastreFeatures:function(e){if(e.latlng){var t=e.latlng,i={WrapStyle:"func",text:(t.lat+" "+t.lng).replace(/\./g,","),tolerance:e.tolerance||0};return r.requestJSONP(e.url||"http://pkk5.rosreestr.ru/api/features/",i,e)}return null},getFormData:function(e){var t=[];for(var i in e){var r=e[i];t.push(i+"="+("object"==typeof r?JSON.stringify(r):r))}return t.join("&")},requestLink:function(e,i,r){return r=r||{},new Promise(function(n,o){var s=null;if(e.indexOf(".css")===-1){s=document.createElement("script"),s.setAttribute("charset","UTF-8");var a=t.extend({},i,t.gmx.gmxMapManager.syncParams),l=[];for(var u in a)l.push(u+"="+encodeURIComponent(a[u]));var h=e+(e.indexOf("?")===-1?"?":"&")+l.join("&"),c=function(a){t.gmxUtil.loaderStatus(h,!0),s.parentNode.removeChild(s),a?(o(e),console.warn("Not found script:",e)):n(e,i,r)};s.onerror=c,s.onload=function(){c()},t.gmxUtil.loaderStatus(h,null,"vector"),s.setAttribute("src",h)}else s=document.createElement("link"),s.rel="stylesheet",s.type="text/css",s.href=e,n(e,i,r);document.getElementsByTagName("head").item(0).appendChild(s)})},requestJSONP:function(e,i,n){n=n||{};var o=new t.gmx.Deferred,s=document.createElement("script");s.setAttribute("charset","UTF-8");var a="callbackParamName"in n?n.callbackParamName:"CallbackName",l=t.extend({},i,t.gmx.gmxMapManager.syncParams);if(a){var u=r.uniqueGlobalName(function(e){delete window[u],o.resolve(e,n)});l[a]=u}var h=[];for(var c in l)h.push(c+"="+encodeURIComponent(l[c]));var d=e+(e.indexOf("?")===-1?"?":"&")+h.join("&");return s.onerror=function(e){o.reject(e),t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},s.onload=function(){t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},t.gmxUtil.loaderStatus(d,null,"vector"),s.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(s),o},getXmlHttp:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){e=!1}}return e},request:function(e){var i=r.getXmlHttp();if(i){if(i.open(e.type?e.type:"GET",e.url,e.async||!1),e.headers)for(var n in e.headers)i.setRequestHeader(n,e.headers[n]);var o=t.gmxUtil.loaderStatus(e.url);e.async&&(e.withCredentials&&(i.withCredentials=!0),i.onreadystatechange=function(){4===i.readyState&&(t.gmxUtil.loaderStatus(o,!0),200===i.status?(e.callback(i.responseText),i=null):e.onError&&e.onError(i))});var s=null;if(e.params){s=e.params;var a=t.gmx.gmxMapManager.getSyncParams(!0);a&&(s+="&"+a)}return i.send(s),!(!e.async&&200===i.status)||(e.callback(i.responseText),t.gmxUtil.loaderStatus(o,!0),i.status)}return e.onError&&e.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(e,t){"z"in e&&(t=e.z);var i=Math.pow(2,t),r=e.x%i+(e.x<0?i:0),n=e.y%i+(e.y<0?i:0);return{z:t,x:r%i-i/2,y:i/2-1-n%i}},getTilePosZoomDelta:function(e,t,i){var r=Math.pow(2,t-i),n=256/r,o=e.x%r,s=e.y%r;return{size:n,zDelta:r,x:n*o,y:n*s}},isItemIntersectBounds:function(e,t){var i=e.type,r=e.coordinates;"POLYGON"!==i&&"Polygon"!==i||(r=[r]);for(var n=0,o=r.length;n<o;n++)for(var s=0,a=r[n].length;s<a;s++)if(t.clipPolygon(r[n][s]).length)return!0;return!1},geoItemBounds:function(e){if(!e)return{bounds:null,boundsArr:[]};var t=e.type,i=e.coordinates,n=null,o=0,s=0,a=null,l=[];if("MULTIPOLYGON"===t||"MultiPolygon"===t)for(a=r.bounds(),o=0,s=i.length;o<s;o++){for(var u=[],h=0,c=i[o].length;h<c;h++)n=r.bounds(i[o][h]),u.push(n),0===h&&a.extendBounds(n);l.push(u)}else if("POLYGON"===t||"Polygon"===t)for(a=r.bounds(),o=0,s=i.length;o<s;o++)n=r.bounds(i[o]),l.push(n),0===o&&a.extendBounds(n);else if("POINT"===t||"Point"===t)a=r.bounds([i]);else if("MULTIPOINT"===t||"MultiPoint"===t)for(a=r.bounds(),o=0,s=i.length;o<s;o++)n=r.bounds([i[o]]),a.extendBounds(n);else if("LINESTRING"===t||"LineString"===t)a=r.bounds(i);else if("MULTILINESTRING"===t||"MultiLineString"===t)for(a=r.bounds(),o=0,s=i.length;o<s;o++)n=r.bounds(i[o]),a.extendBounds(n);return{bounds:a,boundsArr:l}},getUnFlattenGeo:function(e){var t=e.type,i=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n=e.coordinates,o=n;if(i){o=[];var s="POLYGON"===t||"Polygon"===t;s&&(n=[n]);for(var a=0,l=n.length;a<l;a++){for(var u=[],h=0,c=n[a].length;h<c;h++)u[h]=r.unFlattenRing(n[a][h]);o.push(u)}s&&(o=o[0])}return{type:t,coordinates:o}},unFlattenRing:function(e){if("number"!=typeof e[0])return e;for(var t=e.length,i=0,r=new Array(t/2),n=0;n<t;n+=2)r[i++]=[e[n],e[n+1]];return r},geoFlatten:function(e){var t=e.type,i=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n="POLYGON"===t||"Polygon"===t,o=e.coordinates;if(i){n&&(o=[o]);for(var s=0,a=o.length;s<a;s++)for(var l=0,u=o[s].length;l<u;l++)o[s][l]=r.flattenRing(o[s][l])}},flattenRing:function(e){for(var t=e.length,i=0,r="function"==typeof Float64Array?Float64Array:Array,n=new r(2*t),o=0;o<t;o++)n[i++]=e[o][0],n[i++]=e[o][1];return n},isRectangle:function(e){return e&&e[0]&&(5===e[0].length||4===e[0].length)&&(e[0][0][0]===e[0][1][0]||e[0][0][1]===e[0][1][1])&&(e[0][1][0]===e[0][2][0]||e[0][1][1]===e[0][2][1])&&(e[0][2][0]===e[0][3][0]||e[0][2][1]===e[0][3][1])&&(e[0][3][0]===e[0][0][0]||e[0][3][1]===e[0][0][1])},getGeometryBounds:function(e){var t=r.geoItemBounds(e);return t.bounds},getMarkerPolygon:function(e,t,i){var r=(e.min.x+e.max.x)/2,n=(e.min.y+e.max.y)/2;return[[r-t,n-i],[r-t,n+i],[r+t,n+i],[r+t,n-i],[r-t,n-i]]},getQuicklookPointsFromProperties:function(e,i){var n=i.tileAttributeIndexes,o={x1:r.getPropItem(i.quicklookX1||("x1"in n?"x1":"X1"),e,n)||0,y1:r.getPropItem(i.quicklookY1||("y1"in n?"y1":"Y1"),e,n)||0,x2:r.getPropItem(i.quicklookX2||("x2"in n?"x2":"X2"),e,n)||0,y2:r.getPropItem(i.quicklookY2||("y2"in n?"y2":"Y2"),e,n)||0,x3:r.getPropItem(i.quicklookX3||("x3"in n?"x3":"X3"),e,n)||0,y3:r.getPropItem(i.quicklookY3||("y3"in n?"y3":"Y3"),e,n)||0,x4:r.getPropItem(i.quicklookX4||("x4"in n?"x4":"X4"),e,n)||0,y4:r.getPropItem(i.quicklookY4||("y4"in n?"y4":"Y4"),e,n)||0},s=r.bounds([[o.x1,o.y1],[o.x2,o.y2],[o.x3,o.y3],[o.x4,o.y4]]);if(s.max.x===s.min.x||s.max.y===s.min.y)return null;if(!i.quicklookPlatform){var a=3857==i.srs?t.CRS.EPSG3857:t.Projection.Mercator,l=a.project(t.latLng(o.y1,o.x1));o.x1=l.x,o.y1=l.y,l=a.project(t.latLng(o.y2,o.x2)),o.x2=l.x,o.y2=l.y,l=a.project(t.latLng(o.y3,o.x3)),o.x3=l.x,o.y3=l.y,l=a.project(t.latLng(o.y4,o.x4)),o.x4=l.x,o.y4=l.y}return o},getPropertiesHash:function(e,t){var i={};for(var r in t)i[r]=e[t[r]];return i},getPropItem:function(e,t,i){return e in i?t[i[e]]:""},dec2rgba:function(e,t){var i=e>>16&255,r=e>>8&255,n=255&e;return"rgba("+i+", "+r+", "+n+", "+t+")"},dec2hex:function(e){return(e+16777216).toString(16).substr(-6)},dec2color:function(e,t){return t<1?this.dec2rgba(e,t):"#"+this.dec2hex(e)},oneDay:86400,isTileKeysIntersects:function(e,t){if(e.z<t.z){var i=e;e=t,t=i}var r=e.z-t.z;return e.x>>r===t.x&&e.y>>r===t.y},rotatePoints:function(e,t,i,r){var n=[];t*=Math.PI/180;var o=Math.sin(t),s=Math.cos(t);i||(i=1);for(var a=0;a<e.length;a++){var l=i*e[a].x-r.x,u=i*e[a].y-r.y;n.push({x:s*l-o*u+r.x,y:o*l+s*u+r.y})}return n},getPatternIcon:function(e,t,i){if(!t.fillPattern)return null;var n=!0,o=t.fillPattern,s=e?e.properties:null,a=o.step>0?o.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};o.patternStepFunction&&null!==s&&(a=o.patternStepFunction(s,i),n=!1),a>l.maxStep?a=l.maxStep:a<l.minStep&&(a=l.minStep);var u=o.width>0?o.width:8;o.patternWidthFunction&&null!==s&&(u=o.patternWidthFunction(s,i),n=!1),u>l.maxWidth?u=l.maxWidth:u<l.minWidth&&(u=l.minWidth);var h=t.fillOpacity;t.opacityFunction&&null!==s&&(h=t.opacityFunction(s,i)/100,n=!1);var c=[16711680,65280,255],d=null!=o.colors?o.colors:c,p=d.length,f=[],m=0;for(m=0;m<p;m++){var g=d[m];o.patternColorsFunction&&null!==o.patternColorsFunction[m]&&(g=null!==s?o.patternColorsFunction[m](s,i):c[m%3],n=!1),f.push(g)}0===p&&(f=[0],h=0,p=1);var v=u+a,y=v*p,x=0,_=0,b=y,P=y,S=o.style||"horizontal",T=!1;if("diagonal1"===S||"diagonal2"===S||"cross"===S||"cross1"===S?T=!0:"circle"===S?(P=b=2*v,x=Math.floor(P/2),_=2*Math.PI/p):"vertical"===S?b=1:"horizontal"===S&&(P=1),P*b>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var L=document.createElement("canvas");L.width=P,L.height=b;var I=L.getContext("2d");for(I.clearRect(0,0,L.width,L.height),"diagonal2"!==S&&"vertical"!==S||(I.translate(P,0),I.rotate(Math.PI/2)),m=0;m<p;m++){I.beginPath();var M=r.dec2color(f[m],h);if(I.fillStyle=M,T){var k=m*v,C=k+u;I.moveTo(k,0),I.lineTo(C,0),I.lineTo(0,C),I.lineTo(0,k),I.lineTo(k,0),k+=y,C=k+u,I.moveTo(k,0),I.lineTo(C,0),I.lineTo(0,C),I.lineTo(0,k),I.lineTo(k,0),"cross"!==S&&"cross1"!==S||(k=m*v,C=k+u,I.moveTo(P,k),I.lineTo(P,C),I.lineTo(P-C,0),I.lineTo(P-k,0),I.lineTo(P,k),k+=y,C=k+u,I.moveTo(P,k),I.lineTo(P,C),I.lineTo(P-C,0),I.lineTo(P-k,0),I.lineTo(P,k))}else"circle"===S?(I.arc(x,x,u,m*_,(m+1)*_),I.lineTo(x,x)):I.fillRect(0,m*v,P,u);I.closePath(),I.fill()}var O=document.createElement("canvas");O.width=P,O.height=b;var w=O.getContext("2d");return w.drawImage(L,0,0,P,b),{notFunc:n,canvas:O}},getSVGIcon:function(e){var i='<svg xmlns="'+t.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',r=e.type,n=e.fillStyle||"rgba(255, 255, 255, 0.5)",o=e.strokeStyle||"#0000ff",s=e.lineWidth||2,a={className:"gmx-svg-icon"};e.className&&(a.className=e.className);var l=e.iconSize;if(a.iconSize=[l,l],i+=' height = "'+l+'px"  width = "'+l+'px">',"circle"===r){if(e.fillRadialGradient){i+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var u=e.fillRadialGradient.colorStop||e.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],h=0,c=u.length;h<c;h++){var d=u[h];i+='<stop offset="'+100*d[0]+'%"   stop-color="'+d[1]+'" stop-opacity="'+d[2]+'"/>'}i+="</radialGradient></defs>",n="url(#myRadialGradient4)",o=s=null}l/=2,i+='<g><circle cx="'+l+'" cy="'+l+'" r="'+l+'" style="',n&&(i+=" fill:"+n+";"),o&&(i+=' stroke:"'+o+";"),s&&(i+=' stroke-width:"'+s+";"),i+=';" />'}else"square"===r&&(i+='<g><rect width="'+l+'" height="'+l+'" style="',n&&(i+=" fill:"+n+";"),o&&(i+=" stroke:"+o+";"),s&&(i+=" stroke-width:"+2*s+";"),i+='" />');if(e.text){var p=e.text;i+='<text x="50%" y="50%" dy="0.4em"';for(var f in p)"count"!==f&&(i+=" "+f+'="'+p[f]+'"');i+=">"+p.count+"</text>"}return i+="</g></svg>",a.html=i,new t.DivIcon(a)},toPixels:function(e,t,i,r){var n=e[0]*r;n=.5+n<<0;var o=e[1]*r;return o=.5+o<<0,[n-t,i-o].concat(e.slice(2))},getPixelPoint:function(e,t){var i=e.topLeft,n=i.mInPixel,o=e.item,s=o.currentStyle||o.parsedStyleKeys||{},a=e.style||{},l=s.iconScale||1,u=s.iconCenter||!1,h=s.sx||a.sx||4,c=s.sy||a.sy||4,d=s.weight||a.weight||0,p=s.iconAnchor||a.iconAnchor||null,f=e.tpx,m=e.tpy;!u&&p&&(v-=p[0],g-=p[1]),h*=l,c*=l,h+=d,c+=d;var g=m-t[1]*n,v=t[0]*n-f;return v-h>256?v=(t[0]-2*r.worldWidthMerc)*n-f:v<-h&&(v=(t[0]+2*r.worldWidthMerc)*n-f),g-c>256||v-h>256||v+h<0||g+c<0?null:{sx:h,sy:c,px1:.5+v<<0,py1:.5+g<<0}},getImageData:function(e){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return null;var i=document.createElement("canvas"),r=e.width,n=e.height;i.width=r,i.height=n;var o=i.getContext("2d");return o.drawImage(e,0,0),o.getImageData(0,0,r,n).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(e){return e===r.getIEversion()},gtIE:function(e){return e<r.getIEversion()},getIEversion:function(){var e=navigator.userAgent||"",t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var i=e.indexOf("Trident/");if(i>0){var r=e.indexOf("rv:");return parseInt(e.substring(r+3,e.indexOf(".",r)),10)}var n=e.indexOf("Edge/");return n>0?parseInt(e.substring(n+5,e.indexOf(".",n)),10):-1},replaceColor:function(e,i,r){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return e;var n=document.createElement("canvas"),o=e.width,s=e.height;n.width=o,n.height=s;var a,l=!1,u=n.getContext("2d");if("string"==typeof i&&(i=parseInt("0x"+i.replace(/#/,""))),i!==this.DEFAULT_REPLACEMENT_COLOR){var h=i>>16&255,c=i>>8&255,d=255&i;r?a=u.createImageData(o,s):(u.drawImage(e,0,0),a=u.getImageData(0,0,o,s),r=a.data);for(var p=a.data,f=0,m=r.length;f<m;f+=4)255!==r[f]&&238!==r[f]||0!==r[f+1]||255!==r[f+2]||(p[f]=h,p[f+1]=c,p[f+2]=d,p[f+3]=r[f+3],l=!0)}return l?u.putImageData(a,0,0):u.drawImage(e,0,0),n},drawIconPath:function(e,i){if(t.Util.isArray(e)&&!(e.length<3)&&i.ctx){var n=!1,o=i.ctx,s=i.radian;(i.px||i.py)&&(o.translate(i.px||0,i.py||0),n=!0),!s&&i.rotateRes&&(s=Math.PI+r.degRad(i.rotateRes)),s&&(o.rotate(s),n=!0),o.moveTo(e[0],e[1]);for(var a=2,l=e.length;a<l;a+=2)o.lineTo(e[a],e[a+1]);n&&o.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(e){var i=e.gmx,n=e.topLeft,o=n.mInPixel,s=e.pointAttr,a=e.style||{},l=e.item,u=l.currentStyle||l.parsedStyleKeys,h=u.iconScale||1,c=u.image,d=s.sx,p=s.sy,f=s.px1,m=s.py1,g=f,v=m,y=e.ctx;if("image"===u.type&&(d=a.sx,p=a.sy,c=a.image),u.iconCenter?(g-=d/2,v-=p/2):"circle"===a.type&&(f+=d/2,m+=p/2),u.iconPath&&(e.px=f,e.py=m,e.rotateRes=u.rotate||0),c)"iconColor"in u&&!t.gmxUtil.isIE11&&(c=this.replaceColor(c,u.iconColor,e.imageData)),a.rotateRes=u.rotate||0,"opacity"in a&&(y.globalAlpha=u.opacity||a.opacity),i.transformFlag?(y.setTransform(o,0,0,o,-e.tpx,e.tpy),y.drawImage(c,f,-m,d,p),y.setTransform(o,0,0,-o,-e.tpx,e.tpy)):(1!==h&&(d*=h,p*=h,f=s.px1,m=s.py1,g=f,v=m,u.iconCenter&&(g-=d/2,v-=p/2)),a.rotateRes?(y.translate(f,m),y.rotate(r.degRad(a.rotateRes)),y.translate(-f,-m),y.drawImage(c,g,v,d,p),y.setTransform(1,0,0,1,0,0)):y.drawImage(c,g,v,d,p)),"opacity"in a&&(y.globalAlpha=1);else if(a.fillColor||u.fillRadialGradient){if(y.beginPath(),u.iconPath)r.drawIconPath(u.iconPath,e);else if("circle"===a.type||u.fillRadialGradient){var x=a.iconSize/2;if(u.fillRadialGradient){var _=u.fillRadialGradient;x=_.r2*h;for(var b=y.createRadialGradient(f+_.x1,m+_.y1,_.r1*h,f+_.x2,m+_.y2,x),P=0,S=_.addColorStop.length;P<S;P++){var T=_.addColorStop[P];b.addColorStop(T[0],T[1])}y.fillStyle=b}y.arc(f,m,x,0,2*Math.PI)}else y.fillRect(g,v,d,p);y.fill()}u.strokeStyle&&(y.beginPath(),u.iconPath?r.drawIconPath(u.iconPath,e):"circle"===a.type?y.arc(f,m,a.iconSize/2,0,2*Math.PI):y.strokeRect(g,v,d,p),y.stroke())},lineToCanvasAsIcon:function(e,t){var i=e.length,n=t.ctx,o=t.item,s=o.currentStyle||o.parsedStyleKeys,a=s.iconPath;if(i>0){"getLineDash"in n&&n.getLineDash().length>0&&n.setLineDash([]),n.beginPath();for(var l,u=0;u<i;u++)l=e[u],r.drawIconPath(a,{ctx:n,px:l.x,py:l.y,radian:l.radian});s.strokeStyle&&n.stroke(),s.fillStyle&&n.fill()}},lineToCanvas:function(e){var t=e.topLeft,i=t.mInPixel,n=e.coords,o=e.ctx,s=e.item,a=s.currentStyle||s.parsedStyleKeys,l=a.iconPath?[]:null,u=null,h=null;o.beginPath();for(var c=0,d=n.length;c<d;c++){var p=r.toPixels(n[c],e.tpx,e.tpy,i,e.topLeft),f=p[0],m=p[1];u===f&&h===m||(l&&l.push({x:f,y:m,radian:p[2]}),0===c?o.moveTo(f,m):o.lineTo(f,m),u=f,h=m)}return o.stroke(),l},getCoordsPixels:function(e){for(var t=e.gmx,i=e.coords,n=e.hiddenLines||[],o=[],s=[],a=!1,l={gmx:t,topLeft:e.topLeft,tpx:e.tpx,tpy:e.tpy,coords:null,hiddenLines:null},u=0,h=i.length;u<h;u++){for(var c=i[u],d=n[u]||[],p=[],f=[],m=0,g=c.length;m<g;m++){l.coords=c[m],l.hiddenLines=d[m]||[];var v=r.getRingPixels(l);p.push(v.coords),f.push(v.hidden),v.hidden&&(a=!0)}o.push(p),s.push(f)}return{coords:o,hidden:a?s:null,z:e.topLeft.tilePoint.z}},getRingPixels:function(e){if(0===e.coords.length)return null;for(var t=e.topLeft,i=t.mInPixel,r=e.coords,n=e.hiddenLines||null,o=e.tpx,s=e.tpy,a=0,l=0,u=null,h=null,c="number"==typeof r[0]?2:1,d=[],p=[],f=0,m=r.length;f<m;f+=c){var g=!1;n&&f===n[l]&&(g=!0,l++);var v=1===c?r[f]:[r[f],r[f+1]],y=Math.round(v[0]*i),x=Math.round(v[1]*i),_=Math.round(y-o),b=Math.round(s-x);u===_&&h===b||(u=_,h=b,g&&p.push(a),d[a++]=y,d[a++]=x)}return{coords:d,hidden:p.length?p:null}},polygonToCanvas:function(e){if(0===e.coords.length)return null;var t=e.hiddenLines||null,i=e.coords,r=e.ctx,n=e.tpx,o=e.tpy,s=0,a=0,l="number"==typeof i[0]?2:1,u=null,h=null;r.beginPath();for(var c=0,d=i.length;c<d;c+=l){var p=1===l?i[c]:[i[c],i[c+1]],f=Math.round(p[0]-n),m=Math.round(o-p[1]),g=!1,v="round";t&&c===t[a]&&(g=!0,v="butt",a++),r.lineCap!==v&&(r.lineCap=v),u===f&&h===m||(r[g?"moveTo":"lineTo"](f,m),u=f,h=m,s++)}1===s&&r.lineTo(u+1,h),r.stroke()},polygonToCanvasFill:function(e){if(!(e.coords.length<3)){var t=e.coords,i=e.tpx,r=e.tpy,n=1,o=e.ctx;o.lineWidth=0,"number"==typeof t[0]?(n=2,o.moveTo(Math.round(t[0]-i),Math.round(r-t[1]))):o.moveTo(Math.round(t[0][0]-i),Math.round(r-t[0][1]));for(var s=n,a=t.length;s<a;s+=n){var l=1===n?t[s]:[t[s],t[s+1]];o.lineTo(Math.round(l[0]-i),Math.round(r-l[1]))}}},isPatternNode:function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(e,t){if(t){if(!r.labelCanvasContext){var i=document.createElement("canvas");i.width=i.height=512,r.labelCanvasContext=i.getContext("2d")}var n=r.labelCanvasContext;n.clearRect(0,0,512,512),n.font!==t.font&&(n.font=t.font),n.fillStyle!==t.fillStyle&&(n.fillStyle=t.fillStyle);var o=e.split("\n");return o.map(function(e){return n.fillText(e,0,0),[e,n.measureText(e).width]})}return 0},setLabel:function(e,i,r,n){var o=r[0],s=r[1];e.shadowColor!==n.strokeStyle&&(e.shadowColor=n.strokeStyle),e.shadowBlur!==n.shadowBlur&&(e.shadowBlur=n.shadowBlur),e.font!==n.font&&(e.font=n.font),t.Browser.gecko?e.strokeStyle!==n.fillStyle&&(e.strokeStyle=n.fillStyle):(e.strokeStyle!==n.strokeStyle&&(e.strokeStyle=n.strokeStyle),e.fillStyle!==n.fillStyle&&(e.fillStyle=n.fillStyle)),e.strokeText(i,o,s),t.Browser.gecko||e.fillText(i,o,s)},worldWidthFull:40075016.685578495,rMajor:6378137,degRad:function(e){return e*(Math.PI/180)},distVincenty:function(e,t,i,n){for(var o={lon:r.degRad(e),lat:r.degRad(t)},s={lon:r.degRad(i),lat:r.degRad(n)},a=r.rMajor,l=6356752.3142,u=1/298.257223563,h=s.lon-o.lon,c=Math.atan((1-u)*Math.tan(o.lat)),d=Math.atan((1-u)*Math.tan(s.lat)),p=Math.sin(c),f=Math.cos(c),m=Math.sin(d),g=Math.cos(d),v=h,y=2*Math.PI,x=20;Math.abs(v-y)>1e-12&&--x>0;){var _=Math.sin(v),b=Math.cos(v),P=Math.sqrt(g*_*(g*_)+(f*m-p*g*b)*(f*m-p*g*b));if(0===P)return 0;var S=p*m+f*g*b,T=Math.atan2(P,S),L=f*g*_/P,I=1-L*L,M=S-2*p*m/I;isNaN(M)&&(M=0);var k=u/16*I*(4+u*(4-3*I));y=v,v=h+(1-k)*u*L*(T+k*P*(M+k*S*(-1+2*M*M)))}if(0===x)return NaN;var C=I*(a*a/(l*l)-1),O=1+C/16384*(4096+C*(-768+C*(320-175*C))),w=C/1024*(256+C*(-128+C*(74-47*C))),D=w*P*(M+w/4*(S*(-1+2*M*M)-w/6*M*(-3+4*P*P)*(-3+4*M*M))),F=l*O*(T-D);return F},_vfi:function(e,t,i){return[-Math.cos(e)*Math.sin(t)+Math.sin(e)*Math.sin(i)*Math.cos(t),Math.cos(e)*Math.cos(t)+Math.sin(e)*Math.sin(i)*Math.sin(t),-Math.sin(e)*Math.cos(i)]},getCircleLatLngs:function(e,i){var n=0,o=0;if(e instanceof t.LatLng)n=e.lng,o=e.lat;else{if(!t.Util.isArray(e))return null;n=e[1],o=e[0]}for(var s=Math.PI/180,a=n*s,l=o*s,u=r.rMajor,h=u*Math.sin(i/u),c=u*Math.cos(i/u),d=[c*Math.cos(l)*Math.cos(a),c*Math.cos(l)*Math.sin(a),c*Math.sin(l)],p=[],f=0,m=2*Math.PI+1e-6;f<m;f+=s){for(var g=r._vfi(f,a,l),v=[],y=0;y<3;y++)v[y]=d[y]+h*g[y];var x=Math.acos(v[0]/Math.sqrt(v[0]*v[0]+v[1]*v[1]))/s;v[1]<0&&(x=-x),x<n-180?x+=360:x>n+180&&(x-=360),p.push([Math.asin(v[2]/u)/s,x])}return p},parseCoordinates:function(e){var i=null,r=/\(EPSG:(\d+)\)/g,n=r.exec(e);if(n&&(i=n[1],e=e.replace(r,"")),e.match(/[йцукенгшщзхъфывапролджэячсмитьбюЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮqrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(e.indexOf(" ")===-1&&e.indexOf(",")===-1)return null;e.indexOf(" ")!==-1&&(e=e.replace(/,/g,"."));var o=[];for(r=/(-?\d+(\.\d+)?)([^\d\-]*)/g,n=r.exec(e);n;)o.push(n[1]),n=r.exec(e);if(o.length<2)return null;var s,a=Math.floor(o.length/2),l=0,u=1;for(s=0;s<a;s++)l+=parseFloat(o[s])*u,u/=60;var h=0;for(u=1,s=a;s<o.length;s++)h+=parseFloat(o[s])*u,u/=60;Math.max(e.indexOf("N"),e.indexOf("S"))>Math.max(e.indexOf("E"),e.indexOf("W"))&&(n=h,h=l,l=n);var c;return 3857==i&&(c=t.CRS.Simple.unproject(new t.Point(l,h)),h=c.lng,l=c.lat),(Math.abs(h)>180||Math.abs(l)>180)&&(c=t.Projection.Mercator.unproject(new t.Point(l,h)),h=c.lng,l=c.lat),e.indexOf("W")!==-1&&(h=-h),e.indexOf("S")!==-1&&(l=-l),[l,h]},pad2:function(e){return e>=0&&e<10?"0"+e:""+e},trunc:function(e){return(""+(Math.round(1e7*e)/1e7+1e-8)).substring(0,9)},formatDegrees:function(e,t){e=Math.round(1e7*e)/1e7+1e-8;var i=Math.floor(e),n=Math.floor(60*(e-i)),o=r.toPrecision(3600*(e-i-n/60),2),s=r.pad2(i)+"°";return void 0===t&&(t=2),t>0&&(s+=r.pad2(n)+"'"),t>1&&(s+=r.pad2(o)+'"'),s},latLonFormatCoordinates:function(e,t){return e%=360,e>180?e-=360:e<-180&&(e+=360),r.formatDegrees(Math.abs(t))+(t>0?" N, ":" S, ")+r.formatDegrees(Math.abs(e))+(e>0?" E":" W");
},latLonToString:function(e,t,i){return e%=360,e>180?e-=360:e<-180&&(e+=360),i&&(e=r.toPrecision(e,i),t=r.toPrecision(t,i)),t+(t>0?" N, ":" S, ")+e+(e>0?" E":" W")},formatCoordinates:function(e,t){return r.latLonFormatCoordinates(e,t)},latLonFormatCoordinates2:function(e,t){return r.trunc(Math.abs(t))+(t>0?" N, ":" S, ")+r.trunc(Math.abs(e))+(e>0?" E":" W")},formatCoordinates2:function(e,t){return r.latLonFormatCoordinates2(e,t)},getPixelScale:function(e){return 256/r.tileSizes[e]},forEachPoint:function(e,t){if(!e||0===e.length)return[];var i,n,o=[];if(e[0].length)for(i=0,n=e.length;i<n;i++)"string"!=typeof e[i]&&o.push(r.forEachPoint(e[i],t));else{if(2===e.length)return t(e);for(i=0,n=e.length/2;i<n;i++)o.push(t([e[2*i],e[2*i+1]]))}return o},getItemCenter:function(e,t){var i=e.bounds,n=i.min,o=i.max,s=e.type,a="POINT"===s||"MULTIPOINT"===s,l=a?[n.x,n.y]:[(n.x+o.x)/2,(n.y+o.y)/2];if("MULTIPOLYGON"===s)return l;if("POLYGON"===s)for(var u=0,h=t.length;u<h;u++){var c=t[u],d=c.geo,p=d.coordinates,f=c.dataOption,m=f.bounds;if(m.contains(l)){"POLYGON"===d.type&&(p=[p]);for(var g=0,v=p.length;g<v;g++)for(var y=0,x=p[g],_=x.length;y<_;y++){var b=r.getHSegmentsInPolygon(l[1],x[y]);if(b)return b.max.center}}}else{if("POINT"===s||"MULTIPOINT"===s)return l;if("LINESTRING"===s||"MULTILINESTRING"===s)return l}return null},getHSegmentsInPolygon:function(e,t){var i,r,n,o=[],s=1,a=t[0];"number"==typeof t[0]&&(s=2,a=[t[0],t[1]]);var l=e>a[1];for(i=s,r=t.length;i<r;i+=s){var u=1===s?t[i]:[t[i],t[i+1]],h=e>u[1];l!==h&&o.push(a[0]-(a[0]-u[0])*(a[1]-e)/(a[1]-u[1])),a=u,l=h}if(r=o.length){o=o.sort();var c=0,d=-1;for(i=1;i<r;i+=2){var p=i-1,f=Math.abs(o[i]-o[p]);f>c&&(c=f,d=p)}n={y:e,segArr:o,max:{width:c,center:[(o[d]+o[d+1])/2,e]}}}return n},isPointInPolygonArr:function(e,t){var i=!1,r=e[0],n=e[1],o=1,s=t[0];"number"==typeof t[0]&&(o=2,s=[t[0],t[1]]);for(var a=o,l=t.length;a<l;a+=o){var u=1===o?t[a]:[t[a],t[a+1]],h=Math.min(s[0],u[0]),c=Math.max(s[0],u[0]),d=Math.max(s[1],u[1]);if(r>h&&r<=c&&n<=d&&s[0]!==u[0]){var p=(r-s[0])*(u[1]-s[1])/(u[0]-s[0])+s[1];(s[1]===u[1]||n<=p)&&(i=!i)}s=u}return i},isPointInPolygonWithHoles:function(e,t){if(!r.isPointInPolygonArr(e,t[0]))return!1;for(var i=1,n=t.length;i<n;i++)if(r.isPointInPolygonArr(e,t[i]))return!1;return!0},isClockwise:function(e){for(var t,i=0,r=0,n=e.length;r<n;r++)t=(r+1)%n,i+=e[r][0]*e[t][1],i-=e[t][0]*e[r][1];return i<0},isPointInPolyLine:function(e,i,r,n){var o=e[0],s=e[1],a={x:o,y:s},l=o-i,u=o+i,h=s-i,c=s+i,d=0;i*=i;for(var p=1,f=r.length;p<f;p++)if(n&&p===n[d])d++;else{var m=r[p-1],g=r[p],v=m[0],y=m[1],x=g[0],_=g[1];if(!(Math.max(v,x)<l||Math.min(v,x)>u||Math.max(y,_)<h||Math.min(y,_)>c)){var b=t.LineUtil._sqClosestPointOnSegment(a,{x:v,y:y},{x:x,y:_},!0);if(b<i)return!0}}return!1},isPointInLines:function(e){for(var t=e.coords,i=e.point,n=e.delta,o=e.boundsArr,s=e.hidden,a=0,l=t.length,u=!1;a<l;a++)if(u=!o[a]||o[a].contains(i),u&&r.isPointInPolyLine(i,n,t[a],s?s[a]:null))return!0;return!1},getLength:function(e,i){var n=0;if(e&&e.length){var o=!1,s=!1;i=void 0===i||i,e.forEach(function(e){if(t.Util.isArray(e)){if(t.Util.isArray(e[0]))return n+=r.getLength(e,i);i&&(e=t.Projection.Mercator.unproject({x:e[0],y:e[1]}))}o!==!1&&s!==!1&&(n+=parseFloat(r.distVincenty(o,s,e.lng,e.lat))),o=e.lng,s=e.lat})}return n},prettifyDistance:function(e,i){var r=" "+t.gmxLocale.getText("units.km");return"nm"===i?Math.round(.539956803*e)/1e3+" "+t.gmxLocale.getText("units.nm"):"km"===i?Math.round(e)/1e3+r:e<2e3||"m"===i?Math.round(e)+" "+t.gmxLocale.getText("units.m"):e<2e5?Math.round(e/10)/100+r:Math.round(e/1e3)+r},geoJSONGetLength:function(e){var t,i,n,o,s,a=0;if("GeometryCollection"===e.type?a+=e.geometries.forEach(r.geoJSONGetLength):"Feature"===e.type?a+=r.geoJSONGetLength(e.geometry):"FeatureCollection"===e.type&&(a+=e.features.forEach(r.geoJSONGetLength)),"LineString"===e.type||"MultiLineString"===e.type)for(s=e.coordinates,"LineString"===e.type&&(s=[s]),t=0,n=s.length;t<n;t++)a+=r.getRingLength(s[t]);if("Polygon"===e.type||"MultiPolygon"===e.type)for(s=e.coordinates,"Polygon"===e.type&&(s=[s]),t=0,n=s.length;t<n;t++)for(i=0,o=s[t].length;i<o;i++)a+=r.getRingLength(s[t][i]);return a},getRingLength:function(e){var i=0;if(e&&e.length){var n=!1,o=!1;e.forEach(function(e){return t.Util.isArray(e)&&e.length>2?i+=r.getRingLength(e):(n!==!1&&o!==!1&&(i+=parseFloat(r.distVincenty(n,o,e[0],e[1]))),n=e[0],void(o=e[1]))})}return i},geoJSONGetArea:function(e){var t=0;if("GeometryCollection"===e.type?t+=e.geometries.forEach(r.geoJSONGetArea):"Feature"===e.type?t+=r.geoJSONGetArea(e.geometry):"FeatureCollection"===e.type&&(t+=e.features.forEach(r.geoJSONGetArea)),"Polygon"===e.type||"MultiPolygon"===e.type){var i=e.coordinates;"Polygon"===e.type&&(i=[i]);for(var n=0,o=i.length;n<o;n++){t+=r.getRingArea(i[n][0]);for(var s=1,a=i[n].length;s<a;s++)t-=r.getRingArea(i[n][s])}}return t},geoJSONGetLatLng:function(e){if("Feature"===e.type)return r.geoJSONGetLatLng(e.geometry);if("Point"===e.type)return t.latLng(e.coordinates[1],e.coordinates[0]);throw new Error("cannot get "+e.type+" latLng")},getRingArea:function(e){for(var t=0,i=0,n=e.length;i<n;i++){var o=i===n-1?0:i+1,s=e[i],a=e[o];t+=s[0]*Math.sin(r.degRad(a[1]))-a[0]*Math.sin(r.degRad(s[1]))}var l=Math.abs(t*r.lambertCoefX*r.lambertCoefY/2);return l},getArea:function(e){for(var t=0,i=0,n=e.length;i<n;i++){var o=i===n-1?0:i+1,s=e[i],a=e[o];t+=s.lng*Math.sin(r.degRad(a.lat))-a.lng*Math.sin(r.degRad(s.lat))}return Math.abs(t*r.lambertCoefX*r.lambertCoefY/2)},prettifyArea:function(e,i){var r=" "+t.gmxLocale.getText("units.km2");return"km2"===i?""+Math.round(e/100)/1e4+r:"ha"===i?""+Math.round(e/100)/100+" "+t.gmxLocale.getText("units.ha"):e<1e5||"m2"===i?Math.round(e)+" "+t.gmxLocale.getText("units.m2"):e<3e6?(""+Math.round(e/1e3)/1e3).replace(".",",")+r:e<3e7?(""+Math.round(e/1e4)/100).replace(".",",")+r:e<3e8?(""+Math.round(e/1e5)/10).replace(".",",")+r:Math.round(e/1e6)+r},geoLength:function(e){var t=0,i=e.type;if("MULTILINESTRING"===i||"MultiLineString"===i){for(var n=0,o=e.coordinates.length;n<o;n++)t+=r.geoLength({type:"LINESTRING",coordinates:e.coordinates[n]});return t}return"LINESTRING"!==i&&"LineString"!==i||(t=r.getLength(e.coordinates)),t},geometryToGeoJSON:function(e,t,i){if(!e)return null;var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return t&&(o=r.coordsFromMercator(n,o,i)),{type:n,coordinates:o}},convertGeometry:function(e,t,i){var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return o=t?r.coordsFromMercator(n,o,i):r.coordsToMercator(n,o,i),{type:e.type,coordinates:o}},geoJSONtoGeometry:function(e,t){if("FeatureCollection"===e.type)return r.geoJSONtoGeometry(e.features[0],t);if("Feature"===e.type)return r.geoJSONtoGeometry(e.geometry,t);if("FeatureCollection"===e.type)return r.geoJSONtoGeometry(e.features[0],t);var i="MultiPolygon"===e.type?"MULTIPOLYGON":"Polygon"===e.type?"POLYGON":"MultiLineString"===e.type?"MULTILINESTRING":"LineString"===e.type?"LINESTRING":"MultiPoint"===e.type?"MULTIPOINT":"Point"===e.type?"POINT":e.type,n=e.coordinates;return t&&(n=r.coordsToMercator(e.type,n)),{type:i,coordinates:n}},_coordsConvert:function(e,i,n,o){var s,a,l,u=[];if("Point"===e)n?(l=(o?t.CRS.EPSG3857:t.Projection.Mercator).project({lat:i[1],lng:i[0]}),u=[l.x,l.y]):(l=t.Projection.Mercator.unproject({y:i[1],x:i[0]}),u=[l.lng,l.lat],o&&(u[1]=r.fromWebMercY(i[1])));else if("LineString"===e||"MultiPoint"===e)for(s=0,a=i.length;s<a;s++)u.push(r._coordsConvert("Point",i[s],n,o));else if("Polygon"===e||"MultiLineString"===e)for(s=0,a=i.length;s<a;s++)u.push(r._coordsConvert("MultiPoint",i[s],n,o));else if("MultiPolygon"===e)for(s=0,a=i.length;s<a;s++)u.push(r._coordsConvert("Polygon",i[s],n,o));return u},coordsFromMercator:function(e,t,i){return r._coordsConvert(e,t,!1,i)},coordsToMercator:function(e,t,i){return r._coordsConvert(e,t,!0,i)},transformGeometry:function(e,t){return e?{type:e.type,coordinates:r.forEachPoint(e.coordinates,function(e){return t(e)})}:e},geoArea:function(e,i){var n,o,s=0,a=e.type||"";if(i=void 0===i||i,"MULTIPOLYGON"===a||"MultiPolygon"===a){for(n=0,o=e.coordinates.length;n<o;n++)s+=r.geoArea({type:"POLYGON",coordinates:e.coordinates[n]},i);return s}if("POLYGON"===a||"Polygon"===a){for(s=r.geoArea(e.coordinates[0],i),n=1,o=e.coordinates.length;n<o;n++)s-=r.geoArea(e.coordinates[n],i);return s}if(e.length){var l=[],u="number"==typeof e[0]?2:1;for(n=0,o=e.length;n<o;n+=u){var h=1===u?e[n]:[e[n],e[n+1]];l.push(i?t.Projection.Mercator.unproject({y:h[1],x:h[0]}):{lat:h[1],lng:h[0]})}return r.getArea(l)}return 0},getGeoJSONSummary:function(e,t){var i,n,o,s=e.type,a=t||{},l=0;if("Point"===s)o=e.coordinates,l=r.formatCoordinates(o[0],o[1]);else if("Polygon"===s)l=r.prettifyArea(r.geoArea(e,!1),a.squareUnit);else if("MultiPolygon"===s){for(o=e.coordinates,i=0,n=o.length;i<n;i++)l+=r.geoArea({type:"Polygon",coordinates:o[i]},!1);l=r.prettifyArea(l,a.squareUnit)}else if("LineString"===s)l=r.prettifyDistance(r.geoJSONGetLength(e),a.distanceUnit);else if("MultiLineString"===s){for(o=e.coordinates,i=0,n=o.length;i<n;i++)l+=r.geoJSONGetLength({type:"LineString",coordinates:o[i]});l=r.prettifyDistance(l,a.distanceUnit)}return l},getCoordinatesString:function(e,i){var n,o=e.lng,s=e.lat,a=["",""," (EPSG:3395)"," (EPSG:3857)"],l=a.length,u="";return i=i||0,o>180&&(o-=360),o<-180&&(o+=360),i%l===0?u=r.formatCoordinates2(o,s):i%l===1?u=r.formatCoordinates(o,s):i%l===2?(n=t.Projection.Mercator.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[2]):(n=t.CRS.EPSG3857.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[3]),u},getGeometriesSummary:function(e,i){var n="",o="",s=0;return i||(i={}),e&&e.forEach(function(e){if(e){o=e.type.toUpperCase();var a=t.gmxUtil.geometryToGeoJSON(e,!0,3857==i.srs);if(o.indexOf("POINT")!==-1){var l=t.latLng(a.coordinates.reverse());n="<b>"+t.gmxLocale.getText("Coordinates")+"</b>: "+r.getCoordinatesString(l,i.coordinatesFormat)}else o.indexOf("LINESTRING")!==-1?s+=r.geoJSONGetLength(a):o.indexOf("POLYGON")!==-1&&(s+=r.geoJSONGetArea(a))}}),n||(o.indexOf("LINESTRING")!==-1?n="<b>"+t.gmxLocale.getText("Length")+"</b>: "+r.prettifyDistance(s,i.distanceUnit):o.indexOf("POLYGON")!==-1&&(n="<b>"+t.gmxLocale.getText("Area")+"</b>: "+r.prettifyArea(s,i.squareUnit))),n},getGeometrySummary:function(e,t){return r.getGeometriesSummary([e],t||{})},chkOnEdge:function(e,t,i){return e[0]<i.min.x&&t[0]<i.min.x||e[0]>i.max.x&&t[0]>i.max.x||(e[1]<i.min.y&&t[1]<i.min.y||e[1]>i.max.y&&t[1]>i.max.y)},getHidden:function(e,t){for(var i=[],n="number"==typeof e[0]?2:1,o=null,s=0,a=e.length;s<a;s+=n){var l=1===n?e[s]:[e[s],e[s+1]];o&&r.chkOnEdge(l,o,t)&&i.push(s),o=l}return i},getNormalizeBounds:function(e,i){var n=e.getNorthWest(),o=e.getSouthEast(),s=n.lng,a=o.lng,l=(a-s)/2,u=null,h=null,c=[];if(l>=180)s=-180,a=180;else if(a>180||s<-180){var d=(a+s)/2%360;d>180?d-=360:d<-180&&(d+=360),s=d-l,a=d+l,s<-180?(u=s+360,h=180,s=-180):a>180&&(u=-180,h=a-360,a=180)}var p={x:s,y:o.lat},f={x:a,y:n.lat};if(void 0!==i&&(p=t.Projection.Mercator.project(new t.LatLng([o.lat,s])),f=t.Projection.Mercator.project(new t.LatLng([n.lat,a])),p.y-=i,f.y-=i),c.push(r.bounds([[p.x,p.y],[f.x,f.y]])),u){var m={x:u,y:o.lat},g={x:h,y:n.lat};void 0!==i&&(m=t.Projection.Mercator.project(new t.LatLng([o.lat,u])),g=t.Projection.Mercator.project(new t.LatLng([n.lat,h])),m.y-=i,g.y-=i),c.push(r.bounds([[m.x,m.y],[g.x,g.y]]))}return c},toPrecision:function(e,t){var i=Math.pow(10,t?t:4);return Math.round(i*e)/i},getBoundsByTilePoint:function(e){var t=r.tileSizes[e.z],i=e.x*t-r.worldWidthMerc,n=r.worldWidthMerc-e.y*t;return r.bounds([[i,n-t],[i+t,n]])},getTileBounds:function(e,t,i){var n=r.tileSizes[i],o=e*n,s=t*n;return r.bounds([[o,s],[o+n,s+n]])},parseTemplate:function(e,t){var i=e.match(/\[([^\]]+)\]/gi);if(i)for(var r=0,n=i.length;r<n;r++){var o=i[r],s=o.substr(1,o.length-2),a=s in t?t[s]:"";e=e.replace(o,a)}return e},getDefaultBalloonTemplate:function(e,t){var i="";for(var r in e)(!t||r in t)&&(i+="<b>"+r+":</b> ["+r+"]<br />");return i+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(e,i){var n=i.properties;e||(e=r.getDefaultBalloonTemplate(n,i.tileAttributeTypes));var o=e.match(/\[([^\]]+)\]/gi);if(o)for(var s=i.tileAttributeTypes,a=i.unitOptions,l=i.geometries,u=0,h=o.length;u<h;u++){var c=o[u],d=c.substr(1,c.length-2),p="";d in n?p=t.gmxUtil.attrToString(s[d],n[d]):"SUMMARY"===d&&(p=i.summary||t.gmxUtil.getGeometriesSummary(l,a)),e=e.replace(c,p)}return e},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(e){var i=r.defaultStyles,n=t.extend({},i);return n.RenderStyle=i.RenderStyle[e],n},toServerStyle:function(e){var t={};for(var i in r.styleKeys)for(var n=r.styleKeys[i],o=0,s=n.client.length;o<s;o++){var a=n.client[o];if(a in e){t[i]||(t[i]={});var l=e[a];"opacity"!==a&&"fillOpacity"!==a||(l*=100),t[i][n.server[o]]=l}}return"iconAnchor"in e&&(t.marker||(t.marker={}),t.marker.dx=-e.iconAnchor[0],t.marker.dy=-e.iconAnchor[1]),t},fromServerStyle:function(e){var i,n,o,s,a,l={type:""};for(s in r.styleKeys){var u=r.styleKeys[s];for(n=0,o=u.client.length;n<o;n++)a=u.client[n],a in e&&(l[a]=e[a]);if(i=e[s],i&&"object"==typeof i)for(n=0,o=u.server.length;n<o;n++)if(a=u.server[n],a in i){var h=u.client[n],c=i[a];if("string"==typeof c){if(r.styleFuncKeys[h])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=t.gmx.Parsers.parseExpression(c);null===d?c=r.styleFuncError[h]():l[r.styleFuncKeys[h]]=d}}else"opacity"===a&&(c/=100);l[h]=c}}if(e.marker&&(i=e.marker,"dx"in i||"dy"in i)){var p=i.dx||0,f=i.dy||0;l.iconAnchor=[-p,-f]}for(s in e)r.styleKeys[s]||(l[s]=e[s]);return l},getUnixTimeFromStr:function(e){var i=t.Util.trim(e).split(" "),r=i[0].split("."),n=i[1]?i[1].split(":"):[0,0,0];return 4===r[2].length&&(r=r.reverse()),Date.UTC(r[0],r[1]-1,r[2],n[0]||0,n[1]||0,n[2]||0)/1e3},getDateFromStr:function(e){var i=t.Util.trim(e).split(" ");i=i[0].split("."),4===i[2].length&&(i=i.reverse());var r=new Date(i[0],i[1]-1,i[2]);return r},getUTCdate:function(e){var t=new Date(1e3*e);return[t.getUTCFullYear(),r.pad2(t.getUTCMonth()+1),r.pad2(t.getUTCDate())].join(".")},getUTCtime:function(e){var t=Math.floor(e/3600),i=Math.floor((e-3600*t)/60),n=Math.floor(e-3600*t-60*i);return[r.pad2(t),r.pad2(i),r.pad2(n)].join(":")},getUTCdateTime:function(e){var t=e%86400;return t?[r.getUTCdate(e),r.getUTCtime(e%86400)].join(" "):r.getUTCdate(e)},attrToString:function(e,i){return"date"===e?i?t.gmxUtil.getUTCdate(i):i:"time"===e?i?t.gmxUtil.getUTCtime(i):i:"datetime"===e&&i?t.gmxUtil.getUTCdateTime(i):i},getTileAttributes:function(e){var t={},i={};if(e.attributes){var r=e.attributes,n=e.attrTypes||null;e.identityField&&(t[e.identityField]=0);for(var o=0;o<r.length;o++){var s=r[o];t[s]=o+1,i[s]=n?n[o]:"string"}}return{tileAttributeTypes:i,tileAttributeIndexes:t}}};r.lambertCoefX=100*r.distVincenty(0,0,.01,0),r.lambertCoefY=100*r.distVincenty(0,0,0,.01)*180/Math.PI,function(){for(var e=0;e<30;e++)r.tileSizes[e]=r.worldWidthFull/Math.pow(2,e)}(),r.worldWidthMerc=r.worldWidthFull/2,r.Bounds=function(e){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(e)},r.Bounds.prototype={extend:function(e,t){return e<this.min.x&&(this.min.x=e),e>this.max.x&&(this.max.x=e),t<this.min.y&&(this.min.y=t),t>this.max.y&&(this.max.y=t),this},extendBounds:function(e){return this.extendArray([[e.min.x,e.min.y],[e.max.x,e.max.y]])},extendArray:function(e){if(!e||!e.length)return this;var t,i;if("number"==typeof e[0])for(t=0,i=e.length;t<i;t+=2)this.extend(e[t],e[t+1]);else for(t=0,i=e.length;t<i;t++)this.extend(e[t][0],e[t][1]);return this},addBuffer:function(e,t,i,r){return this.min.x-=e,this.min.y-=t||e,this.max.x+=i||e,this.max.y+=r||t||e,this},contains:function(e){var t=this.min,i=this.max,r=e[0],n=e[1];return r>=t.x&&r<=i.x&&n>=t.y&&n<=i.y},getCenter:function(){var e=this.min,t=this.max;return[(e.x+t.x)/2,(e.y+t.y)/2]},addOffset:function(e){return this.min.x+=e[0],this.max.x+=e[0],this.min.y+=e[1],this.max.y+=e[1],this},intersects:function(e){var t=this.min,i=this.max,r=e.min,n=e.max;return n.x>t.x&&r.x<i.x&&n.y>t.y&&r.y<i.y},intersectsWithDelta:function(e,t,i){var r=this.min,n=this.max,o=t||0,s=i||0,a=e.min,l=e.max;return l.x+o>r.x&&a.x-o<n.x&&l.y+s>r.y&&a.y-s<n.y},isEqual:function(e){var t=this.min,i=this.max,r=e.min,n=e.max;return n.x===i.x&&r.x===t.x&&n.y===i.y&&r.y===t.y},isNodeIntersect:function(e){for(var t=0,i=e.length;t<i;t++)if(this.contains(e[t]))return{num:t,point:e[t]};return null},clipPolygon:function(e,i){if(e.length){var r,n,o,s,a,l,u,h,c,d=[1,4,2,8];if(t.LineUtil.isFlat(e)){var p=e;e=p.map(function(e){return new t.Point(e[0],e[1],i)})}for(n=0,u=e.length;n<u;n++)e[n]._code=this._getBitCode(e[n]);for(s=0;s<4;s++){for(h=d[s],r=[],n=0,u=e.length,o=u-1;n<u;o=n++)a=e[n],l=e[o],a._code&h?l._code&h||(c=this._getEdgeIntersection(l,a,h,i),c._code=this._getBitCode(c),r.push(c)):(l._code&h&&(c=this._getEdgeIntersection(l,a,h,i),c._code=this._getBitCode(c),r.push(c)),r.push(a));e=r}}return e.map(function(e){return[e.x,e.y]})},_getBitCode:function(e){var t=0;return e.x<this.min.x?t|=1:e.x>this.max.x&&(t|=2),e.y<this.min.y?t|=4:e.y>this.max.y&&(t|=8),t},_getEdgeIntersection:function(e,i,r,n){var o,s,a=i.x-e.x,l=i.y-e.y,u=this.min,h=this.max;return 8&r?(o=e.x+a*(h.y-e.y)/l,s=h.y):4&r?(o=e.x+a*(u.y-e.y)/l,s=u.y):2&r?(o=h.x,s=e.y+l*(h.x-e.x)/a):1&r&&(o=u.x,s=e.y+l*(u.x-e.x)/a),new t.Point(o,s,n)},clipPolyLine:function(e,t,i){i=i||0;var r,n,o,s,a,l,u=this.min,h=this.max,c=[u.x-i,u.y-i,h.x+i,h.y+i],d=function(e){var t=0;return e[0]<c[0]?t|=1:e[0]>c[2]&&(t|=2),e[1]<c[1]?t|=4:e[1]>c[3]&&(t|=8),t},p=function(e,t){return Math.PI/2+Math.atan2(t[1]-e[1],e[0]-t[0])},f=function(e,t,i){return 8&i?[e[0]+(t[0]-e[0])*(c[3]-e[1])/(t[1]-e[1]),c[3]]:4&i?[e[0]+(t[0]-e[0])*(c[1]-e[1])/(t[1]-e[1]),c[1]]:2&i?[c[2],e[1]+(t[1]-e[1])*(c[2]-e[0])/(t[0]-e[0])]:1&i?[c[0],e[1]+(t[1]-e[1])*(c[0]-e[0])/(t[0]-e[0])]:null},m=[],g=e.length,v=d(e[0],c),y=[];for(r=1;r<g;r++)if(n=e[r-1],o=e[r],n[0]!==o[0]||n[1]!==o[1]){for(a=l=d(o,c);;){if(!(v|a)){t&&(n[2]=p(n,o),s=e[r+1],o[2]=s?p(o,s):n[2]),y.push(n),a!==l?(y.push(o),r<g-1&&(m.push(y),y=[])):r===g-1&&y.push(o);break}if(v&a)break;v?(n=f(n,o,v,c),v=d(n,c)):(o=f(n,o,a,c),a=d(o,c))}v=l}return y.length&&m.push(y),m},toLatLngBounds:function(e){var i=t.Projection.Mercator,n=i.unproject(this.min),o=i.unproject(this.max),s=[[n.lat,n.lng],[o.lat,o.lng]];return e&&(s[0][0]=r.fromWebMercY(this.min.y),s[1][0]=r.fromWebMercY(this.max.y)),t.latLngBounds(s)}},r.bounds=function(e){return new r.Bounds(e)},r.parseUri=function(e){for(var t=r.parseUri.options,i=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=i[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,i,r){i&&(n[t.q.name][i]=r)}),n.hostOnly=n.host,n.host=n.authority,n},r.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},t.gmxUtil||(t.gmxUtil={}),t.extend(t.gmxUtil,{newId:r.newId,isPageHidden:r.isPageHidden,protocol:"https:"!==location.protocol?"http:":location.protocol,loaderStatus:function(){},isIE9:r.isIE(9),isIE10:r.isIE(10),isIE11:r.isIE(11),gtIE11:r.gtIE(11),getFormData:r.getFormData,requestJSONP:r.requestJSONP,requestLink:r.requestLink,getCadastreFeatures:r.getCadastreFeatures,request:r.request,getLayerItemFromServer:r.getLayerItemFromServer,fromServerStyle:r.fromServerStyle,toServerStyle:r.toServerStyle,getDefaultStyle:r.getDefaultStyle,bounds:r.bounds,getNormalizeBounds:r.getNormalizeBounds,getGeometryBounds:r.getGeometryBounds,tileSizes:r.tileSizes,getDateFromStr:r.getDateFromStr,getUnixTimeFromStr:r.getUnixTimeFromStr,getUTCdate:r.getUTCdate,getUTCtime:r.getUTCtime,getUTCdateTime:r.getUTCdateTime,attrToString:r.attrToString,getTileAttributes:r.getTileAttributes,formatCoordinates:function(e,t){return r["formatCoordinates"+(t?"2":"")](e.lng,e.lat)},formatDegrees:r.formatDegrees,pad2:r.pad2,dec2hex:r.dec2hex,dec2rgba:r.dec2rgba,trunc:r.trunc,latLonFormatCoordinates:r.latLonFormatCoordinates,latLonFormatCoordinates2:r.latLonFormatCoordinates2,latLonToString:r.latLonToString,toPrecision:r.toPrecision,getLength:r.getLength,geoLength:r.geoLength,prettifyDistance:r.prettifyDistance,getArea:r.getArea,prettifyArea:r.prettifyArea,geoArea:r.geoArea,parseBalloonTemplate:r.parseBalloonTemplate,getSVGIcon:r.getSVGIcon,getCoordinatesString:r.getCoordinatesString,getGeometriesSummary:r.getGeometriesSummary,getGeometrySummary:r.getGeometrySummary,getGeoJSONSummary:r.getGeoJSONSummary,getPropertiesHash:r.getPropertiesHash,distVincenty:r.distVincenty,parseCoordinates:r.parseCoordinates,geometryToGeoJSON:r.geometryToGeoJSON,coordsFromMercator:r.coordsFromMercator,convertGeometry:r.convertGeometry,transformGeometry:r.transformGeometry,geoJSONtoGeometry:r.geoJSONtoGeometry,geoJSONGetArea:r.geoJSONGetArea,geoJSONGetLength:r.geoJSONGetLength,geoJSONGetLatLng:r.geoJSONGetLatLng,fromWebMercY:r.fromWebMercY,parseUri:r.parseUri,isRectangle:r.isRectangle,isClockwise:r.isClockwise,isPointInPolygonWithHoles:r.isPointInPolygonWithHoles,getPatternIcon:r.getPatternIcon,getCircleLatLngs:r.getCircleLatLngs,normalizeHostname:r.normalizeHostname,getTileBounds:r.getTileBounds,getBoundsByTilePoint:r.getBoundsByTilePoint,parseTemplate:r.parseTemplate}),t.gmxUtil.isIEOrEdge=t.gmxUtil.gtIE11||t.gmxUtil.isIE11||t.gmxUtil.isIE10||t.gmxUtil.isIE9,function(){function e(e,o,s){var a="gmxAPIutils_id"+n++,l=t.DomUtil.create("iframe");l.style.display="none",l.setAttribute("id",e),l.setAttribute("name",e),l.src="javascript:true",l.callbackName=a;var u=r.parseUri(s),h=(u.protocol?u.protocol+":":t.gmxUtil.protocol)+"//"+(u.host||window.location.host);return i[h]=i[h]||{},i[h][a]={callback:o,iframe:l},l}var i={},n=0,o=function(e){if(e.origin in i){var t=decodeURIComponent(e.data.replace(/\n/g,"\n\\"));try{var r=JSON.parse(t)}catch(n){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:t}})}var o=i[e.origin][r.CallbackName];o&&(delete i[e.origin][r.CallbackName],delete r.CallbackName,o.iframe.parentNode&&o.iframe.parentNode.removeChild(o.iframe),"callback"in o&&o.callback(r))}};t.DomEvent.on(window,"message",o),r.createPostIframe2=e}(),function(){function e(e,i,n,o){var s,a,l="$$iframe_"+r.newId(),u=r.createPostIframe2(l,n,e);if(o)s=o,a=s.getAttribute("action"),s.setAttribute("action",e),s.target=l;else if(t.Browser.ielt9){var h="<form id="+l+'" enctype="multipart/form-data" style="display:none" target="'+l+'" action="'+e+'" method="post"></form>';s=document.createElement(h)}else s=document.createElement("form"),s.style.display="none",s.setAttribute("enctype","multipart/form-data"),s.target=l,s.setAttribute("method","POST"),s.setAttribute("action",e),s.id=l;var c=document.createElement("div");c.style.display="none","window"===i.WrapStyle&&(i.WrapStyle="message"),"message"===i.WrapStyle&&(i.CallbackName=u.callbackName);for(var d in i){var p=document.createElement("input"),f="undefined"!=typeof i[d]?i[d]:"";p.setAttribute("type","hidden"),p.setAttribute("name",d),p.setAttribute("value",f),c.appendChild(p)}s.appendChild(c),o||document.body.appendChild(s),document.body.appendChild(u),s.submit(),o?(s.removeChild(c),null!==a?s.setAttribute("action",a):s.removeAttribute("action")):s.parentNode.removeChild(s)}t.gmxUtil.sendCrossDomainPostRequest=r.sendCrossDomainPostRequest=e}();var n=["strokeStyle","fillStyle","lineWidth"],o=n.length,s=r,a=function(e,t,i,r){for(var a=0;a<o;a++){var l=n[a],u=r[l];u!==i[l]&&(i[l]=u)}if(r.dashArray){var h=r.dashArray,c=r.dashOffset||0;"setLineDash"in i&&(i.setLineDash(h),i.lineDashOffset!==c&&(i.lineDashOffset=c))}else"getLineDash"in i&&i.getLineDash().length>0&&i.setLineDash([]);if("round"!==i.lineCap&&(i.lineCap="round"),"round"!==i.lineJoin&&(i.lineJoin="round"),r.canvasPattern)i.fillStyle=i.createPattern(r.canvasPattern.canvas,"repeat");else if(r.fillLinearGradient){for(var d=r.fillLinearGradient,p=d.x1Function?d.x1Function(e,t):d.x1,f=d.y1Function?d.y1Function(e,t):d.y1,m=d.x2Function?d.x2Function(e,t):d.x2,g=d.y2Function?d.y2Function(e,t):d.y2,v=i.createLinearGradient(p,f,m,g),y=0,x=d.addColorStop.length;y<x;y++){var _=d.addColorStop[y],b=d.addColorStopFunctions[y],P=b[0]?b[0](e,t):_[0],S=_.length<3?100:b[2]?b[2](e,t):_[2],T=s.dec2color(b[1]?b[1](e,t):_[1],S>1?S/100:S);v.addColorStop(P,T)}i.fillStyle=r.fillStyle=v}};t.gmxUtil.drawGeoItem=function(e,i,n,o,l){var u,h,c,d,p=e.properties,f=p[0],m=n.gmx,g=n.ctx,v=p[p.length-1],y=null,x=e.dataOption,_=n.rasters||{},b=n.tbounds;if(i.currentStyle=t.extend({},o),l){if(m.styleHook){if(e.styleExtend||(e.styleExtend=m.styleHook(i,m.lastHover&&f===m.lastHover.id)),!e.styleExtend)return!1;"number"==typeof e.styleExtend.strokeStyle&&(e.styleExtend.strokeStyle=r.dec2color(e.styleExtend.strokeStyle,1)),"number"==typeof e.styleExtend.fillStyle&&(e.styleExtend.fillStyle=r.dec2color(e.styleExtend.fillStyle,1)),i.currentStyle=t.extend(i.currentStyle,e.styleExtend)}a(p,m.tileAttributeIndexes,g,i.currentStyle)}else l={};var P=v.type.toUpperCase(),S={gmx:m,item:i,style:l,styleExtend:e.styleExtend||{},ctx:g,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy};if("POINT"===P&&(S.pointAttr=s.getPixelPoint(S,v.coordinates),!S.pointAttr))return!1;if("POINT"===P||"MULTIPOINT"===P)if(y=v.coordinates,"iconColor"in l&&l.image&&!t.gmxUtil.isIE11&&(l.lastImage!==l.image&&(l.lastImage=l.image,l.lastImageData=s.getImageData(l.image)),S.imageData=l.lastImageData),"MULTIPOINT"===P)for(u=0,h=y.length;u<h;u++)S.coords=y[u],s.pointToCanvas(S);else S.coords=y,s.pointToCanvas(S);else if("POLYGON"===P||"MULTIPOLYGON"===P)if(l.image)S.coords=[(x.bounds.min.x+x.bounds.max.x)/2,(x.bounds.min.y+x.bounds.max.y)/2],S.pointAttr=s.getPixelPoint(S,S.coords),S.pointAttr&&s.pointToCanvas(S);else{y=v.coordinates,"POLYGON"===P&&(y=[y]);var T=x.hiddenLines||[],L=x.pixels,I=!0;L&&L.z===n.topLeft.tilePoint.z||(L=x.pixels=s.getCoordsPixels({gmx:m,coords:y,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy,hiddenLines:T}));var M=function(e,t){for(y=L.coords,T=L.hidden||[],S.flagPixels=I,u=0,h=y.length;u<h;u++){var i=y[u],r=T[u]||[];for(g.beginPath(),c=0,d=i.length;c<d;c++)S.coords=i[c],S.hiddenLines=r[c]||[],e(S);g.closePath(),t&&g.fill()}},k=i.currentStyle.strokeStyle||l.strokeStyle,C=i.currentStyle.lineWidth||l.lineWidth;k&&C&&M(s.polygonToCanvas),n.bgImage?S.bgImage=n.bgImage:_[f]&&(S.bgImage=_[f]),(S.styleExtend.skipRasters||i.skipRasters)&&delete S.bgImage,l.imagePattern?i.currentStyle.fillStyle=g.createPattern(l.imagePattern,"repeat"):S.bgImage&&b.intersectsWithDelta(x.bounds,-1,-1)&&(s.isPatternNode(S.bgImage)&&("rasterOpacity"in m&&(g.globalAlpha=m.rasterOpacity),g.fillStyle=g.createPattern(S.bgImage,"no-repeat"),l.bgImage=!0),M(s.polygonToCanvasFill,!0),g.globalAlpha=1),(i.currentStyle.fillStyle||i.currentStyle.canvasPattern)&&(g.fillStyle=i.currentStyle.canvasPattern||i.currentStyle.fillStyle,M(s.polygonToCanvasFill,!0))}else if("LINESTRING"===P||"MULTILINESTRING"===P){y=v.coordinates,"LINESTRING"===P&&(y=[y]);var O=i.currentStyle||i.parsedStyleKeys,w=O.iconPath||O.iconPath,D=(i.currentStyle.maxSize||i.currentStyle.lineWidth)/n.topLeft.mInPixel;for(u=0,h=y.length;u<h;u++)if(w){var F=b.clipPolyLine(y[u],!0,D);for(c=0,d=F.length;c<d;c++){S.coords=F[c];var R=s.lineToCanvas(S);R&&(g.save(),s.lineToCanvasAsIcon(R,S),g.restore())}}else S.coords=y[u],s.lineToCanvas(S)}return!0};var l={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var e=this;if(this._scriptSearched)return this._scriptAPIKey;for(var t=document.getElementsByTagName("script"),i=0;i<t.length;i++){for(var r=t[i].getAttribute("src"),n=this.SCRIPT_REGEXP,o=0,s=n.length;o<s;o++)if(n[o].exec(r)){var a=r.split("?")[1];if(a)for(var l=a.split("&"),u=0;u<l.length;u++){var h=l[u].split("=");if(h[0]===e.APIKEY_PARAM){e._scriptAPIKey=h[1];break}}break}if(e._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(e,i){var n=this._sessionKeys;return e in n||(i="undefined"==typeof i?this._searchScriptAPIKey():i,n[e]=new Promise(function(n,o){i?r.requestJSONP(t.gmxUtil.protocol+"//"+e+"/ApiKey.ashx",{WrapStyle:"func",Key:i}).then(function(e){e&&"ok"===e.Status?n(e.Result.Key):o()},o):n("")})),n[e]},getSessionKey:function(e){return this._sessionKeys[e]},_sessionKeys:{}};t.gmx=t.gmx||{},t.gmx.gmxSessionManager=l;var u={getMap:function(e,t,i,r,n){return u.loadMapProperties({srs:n,hostName:e,apiKey:t,mapName:i,skipTiles:r})},loadMapProperties:function(e){var i=this._maps,n=e.hostName||e.serverHost,o=e.mapName;if(!i[n]||!i[n][o]){var s={WrapStyle:"func",skipTiles:e.skipTiles||"None",MapName:o,srs:e.srs||3857,ftc:e.ftc||"osm",ModeKey:"map"},a=new Promise(function(i,a){l.requestSessionKey(n,e.apiKey).then(function(e){s.key=e,r.requestJSONP(t.gmxUtil.protocol+"//"+n+"/TileSender.ashx",s).then(function(r){r&&"ok"===r.Status&&r.Result?(r.Result.properties.hostName=n,r.Result.properties.sessionKey=e,t.gmx._maps[n]=t.gmx._maps[n]||{},t.gmx._maps[n][o]={_rawTree:r.Result,_nodes:{}},i(r.Result)):a(r)},a)},a)});i[n]=i[n]||{},i[n][o]={promise:a}}return i[n][o].promise},syncParams:{},setSyncParams:function(e){this.syncParams=e},getSyncParams:function(e){var t=this.syncParams;if(e){var i=[];for(var r in t)i.push(r+"="+t[r]);t=i.join("&")}return t},findLayerInfo:function(e,i,r){var n=t.gmx._maps[e],o=null;if(n&&n[i]){var s=n[i];s._nodes[r]||u.iterateNode(s._rawTree,function(e){s._nodes[e.content.properties.name]=e}),o=s._nodes[r]}return o?o.content:null},iterateLayers:function(e,t){var i=function(e){for(var r=0,n=e.length;r<n;r++){var o=e[r];"group"===o.type?i(o.content.children):"layer"===o.type&&t(o.content);
}};e&&i(e.children)},iterateNode:function(e,t){var i=function(e){for(var r=e.children,n=0,o=r.length;n<o;n++){var s=r[n];t(s),"group"===s.type&&i(s.content)}};e&&i(e)},_maps:{}};t.gmx=t.gmx||{},t.gmx._maps={},t.gmx._clientLayers={},/\bsw=1\b/.test(location.search)&&(t.gmx._sw=1,"serviceWorker"in navigator?navigator.serviceWorker.register("./gmx-sw1.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)})["catch"](function(e){console.log("ServiceWorker registration failed: ",e)}):console.error("Your browser does not support Service Workers.")),t.gmx.gmxMapManager=u;var h=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e,i){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={};var r=this;this.properties=t.extend({},e.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=e;var n=i.skipTiles||"All",o=i.ftc||"osm",s=i.srs||3857,a=this.properties.name;this.layersCreated=new Promise(function(l){var h={},c={};u.iterateLayers(e,function(n){var o=n.properties,s={mapID:a,sessionKey:e.properties.sessionKey,layerID:o.name};o.hostName=e.properties.hostName,e.srs&&(o.srs=e.srs);var l=o.ContentID||o.type,u=o.MetaProperties||{},d=t.extend(s,i);o.dataSource||"parentLayer"in u?(d.parentLayer=o.dataSource||"","parentLayer"in u&&(d.parentLayer=u.parentLayer.Value||""),c[s.layerID]={info:n,options:d}):l in t.gmx._layerClasses?r.addLayer(t.gmx.createLayer(n,d)):(h[l]=h[l]||[],h[l].push({info:n,options:d}))});var d=[];for(var p in h)d.push(t.gmx._loadLayerClass(p).then(function(e){for(var i=h[e],n=0,o=i.length;n<o;n++)r.addLayer(t.gmx.createLayer(i[n].info,i[n].options))}.bind(null,p)));var f,m,v,y={};for(m in c){v=c[m];var x=v.options,_=x.parentLayer,b=this.layersByID[_];b?(v.options.parentOptions=b.getGmxProperties(),v.options.dataManager=this.dataManagers[_]||new g(v.options.parentOptions,(!0)),this.dataManagers[_]=v.options.dataManager,this.addLayer(t.gmx.createLayer(v.info,v.options))):(f=x.hostName,y[f]||(y[f]={}),y[f][_]||(y[f][_]=[]),y[f][_].push(m))}for(f in y){var P=[],S=t.gmxUtil.protocol+"//"+f;for(m in y[f])P.push({Layer:m});d.push(t.gmxUtil.requestJSONP(S+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",skipTiles:n,srs:s,ftc:o,Layers:JSON.stringify(P)},{ids:y[f]}).then(function(e,i){if(e&&"ok"===e.Status&&e.Result)e.Result.forEach(function(e){var n=e.properties,a=n.name;n.tiles=[],n.srs=s,n.ftc=o;var l=r.addDataManager(e);i&&i.ids&&i.ids[a]&&i.ids[a].forEach(function(i){var n=c[i];n.options.parentOptions=e.properties,n.options.dataManager=l,n.info.properties.tiles=[],n.info.properties.srs=s,n.info.properties.ftc=o,r.addLayer(t.gmx.createLayer(n.info,n.options))})});else if(console.info("Error: loading ",S+"/Layer/GetLayerJson.ashx",e.ErrorInfo),i&&i.ids)for(var n in i.ids)i.ids[n].forEach(function(e){r.addLayer(new t.gmx.DummyLayer(c[e].info.properties))})}))}Promise.all(d).then(l)}.bind(this))},addDataManager:function(e){var t=e.properties.name;return this.dataManagers[t]||(this.dataManagers[t]=new g(e.properties)),this.dataManagers[t]},getDataManager:function(e){return this.dataManagers[e]},addLayer:function(e){var t=e.getGmxProperties();return this.layers.push(e),this.layersByTitle[t.title]=e,this.layersByID[t.name]=e,this.fire("layeradd",{layer:e}),this},removeLayer:function(e){for(var t=e.getGmxProperties(),i=0;i<this.layers.length;i++)if(this.layers[i].getGmxProperties().name===t.name){this.layers.splice(i,1);break}return delete this.layersByTitle[t.title],delete this.layersByID[t.name],this.fire("layerremove",{layer:e}),this},addLayersToMap:function(e){for(var t=this.layers.length-1;t>=0;t--){var i=this.layers[t];i.getGmxProperties().visible&&e.addLayer(i)}return this}});t.gmx=t.gmx||{},t.gmx.gmxMap=h;var c=t.Handler.extend({options:{},initialize:function(e){this._map=e,this._layers={},this._lastLayer=null,this._lastId=null;var i=this;this._drawstart=null,this._lastCursor="";var r=function(){if(i._drawstart)return!0;if(null===i._drawstart){if(e.gmxControlsManager){var t=e.gmxControlsManager.get("drawing");t&&t.on("activechange",function(t){i._drawstart=t.activeIcon,e._container.style.cursor=i._drawstart?"pointer":""})}i._drawstart=!1}return!1},n=function(e){var t=e._container;if(t)for(var i=t.parentNode.childNodes,r=0,n=i.length;r<n;r++)if(t===i[r])return r;return 0},o=function(){i._lastLayer&&(i._lastLayer.gmxEventCheck({type:"mousemove"},!0),i._lastLayer=null)},s=function(e){var n=e.type,s=i._map;if(e.originalEvent&&(s.gmxMouseDown=t.Browser.webkit&&!t.gmxUtil.isIEOrEdge?e.originalEvent.which:e.originalEvent.buttons),s._animatingZoom||r()||!e.latlng||"click"===n&&s._skipClick||"mousemove"===n&&s.gmxMouseDown)return o(),void(s._skipClick=!1);e.layerPoint&&(s._gmxMouseLatLng=e.latlng,s.gmxMousePos=s.getPixelOrigin().add(e.layerPoint));for(var a,l=Object.keys(i._layers).sort(function(e,t){var r=s._layers[e],n=s._layers[t];if(r&&n){var o=r.options,a=n.options,l=(o.zIndexOffset||0)+(o.zIndex||0),u=(a.zIndexOffset||0)+(a.zIndex||0),h=u-l;return h?h:i._layers[t]-i._layers[e]}return 0}),u=null,h="",c=0,d=l.length;c<d;c++){var p=l[c];if(a=s._layers[p],a&&a._map&&!a._animating&&a.options.clickable&&a.gmxEventCheck(e)){a.hasEventListeners("mouseover")&&(h="pointer"),u=a;break}}i._lastCursor===h||r()||(s._container.style.cursor=h),i._lastCursor=h,"zoomend"!==n&&(u?(i._lastLayer!==u&&o(),i._lastLayer=u):o())};e.on({zoomend:function(){e._gmxMouseLatLng&&setTimeout(function(){s({type:"mousemove",latlng:e._gmxMouseLatLng})},0)},click:s,dblclick:s,mousedown:s,mouseup:s,mousemove:s,contextmenu:s,layeradd:function(e){var t=e.layer;"gmxEventCheck"in t&&t.options.clickable&&(i._layers[t._leaflet_id]=n(t))},layerremove:function(e){var t=e.layer._leaflet_id;delete i._layers[t],i._lastLayer&&i._lastLayer._leaflet_id===t&&(i._lastLayer=null,i._lastId=0)}},this)}});t.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new c(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart},this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()}))}),function(){var e="rus",i=function(e,t,i,r){r[e]||(r[e]={}),r[e][t]=i};t.gmxLocale={setLanguage:function(e){this._language=e},getLanguage:function(){return window.language||this._language||e}},t.gmxLocaleMixin={addText:function(){var e=arguments[0],t=arguments[1];1===arguments.length&&(t=e,e=null);for(var r in t)if(null===e)for(var n in t[r])i(r,n,t[r][n],this);else i(e,r,t[r],this);return this},getText:function(e){for(var i=t.gmxLocale.getLanguage(),r=this[i]||{},n=e?e.split(/\./):[],o=0,s=n.length;o<s&&r;o++)r=r[n[o]];return r}},t.extend(t.gmxLocale,t.gmxLocaleMixin)}(),t.extend(t.gmxLocale,{rus:{Coordinates:"Координаты",Length:"Длина",nodeLength:"Длина от начала",edgeLength:"Длина сегмента",Area:"Площадь",Perimeter:"Периметр",units:{m:"м",nm:"м.мили",km:"км",m2:"кв. м",km2:"кв. км",ha:"га",m2html:"м<sup>2",km2html:"км<sup>2"}}}),t.extend(t.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}});var d={_loadedTiles:{},_getKey:function(e){return[e.layerID,e.x,e.y,e.z,"undefined"==typeof e.d?-1:e.d,"undefined"==typeof e.s?-1:e.s,e.v].join(":")},load:function(e,i){var r=d._getKey(i);if(!this._loadedTiles[r]){var n={ModeKey:"tile",ftc:"osm",r:"j",LayerName:i.layerID,z:i.z,x:i.x,y:i.y,v:i.v};i.srs&&(n.srs=i.srs),i.d!==-1&&(n.Level=i.d,n.Span=i.s),t.gmx._sw&&(n.sw=t.gmx._sw);var o=new Promise(function(t,i){var r=e+"&"+Object.keys(n).map(function(e){return e+"="+n[e]}).join("&");fetch(r,{mode:"cors",credentials:"include"}).then(function(e){return e.text()}).then(function(e){var r="gmxAPI._vectorTileReceiver(";if(e.substr(0,r.length)===r){e=e.replace(r,"");var n=JSON.parse(e.substr(0,e.length-1));t(n)}else i()})});this._loadedTiles[r]=o}return this._loadedTiles[r]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(e){var t=d._getKey({layerID:e.LayerName,x:e.x,y:e.y,z:e.z,d:e.level,s:e.span,v:e.v});d._loadedTiles[t]&&d._loadedTiles[t].resolve({bbox:e.bbox,srs:e.srs,isGeneralized:e.isGeneralized,values:e.values})};var p=function(e,t){this.dataProvider=e,this.x=t.x,this.y=t.y,this.z=t.z,this.v=t.v,this.s=t.s||-1,this.d=t.d||-1,this.attributes=t.attributes,this.isGeneralized=t.isGeneralized,this.isFlatten=t.isFlatten,this.bounds=r.getBoundsByTilePoint(this.z?t:{z:0,x:0,y:0}),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=p.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&t.dateZero&&(this.beginDate=new Date(t.dateZero.valueOf()+this.s*this.d*r.oneDay*1e3),this.endDate=new Date(t.dateZero.valueOf()+(this.s+1)*this.d*r.oneDay*1e3)),this.clear()};p.prototype={addData:function(e,t){t&&this.removeData(t,!0);for(var i=e.length,n=new Array(i),o=r.bounds(),s=0;s<i;s++){var a=this._parseItem(e[s]);n[s]=a,o.extendBounds(a.bounds)}return this.data?(this.data=this.data.concat(e),this.dataOptions=this.dataOptions.concat(n)):(this.data=e,this.dataOptions=n),this.loaded(e),o},removeData:function(e){for(var t=this.data||[],i=t.length-1;i>=0;i--)e[t[i][0]]&&(t.splice(i,1),this.dataOptions&&this.dataOptions.splice(i,1))},loaded:function(e){this.state="loaded",this._resolve(e)},load:function(){if("notLoaded"===this.state){this.state="loading";var e=this;this.dataProvider.load(e.x,e.y,e.z,e.v,e.s,e.d,function(t){e.bbox=t.bbox,e.srs=t.srs,e.isGeneralized=t.isGeneralized,e.addData(t.values)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this))},_parseItem:function(e){var t,i=e.length-1;for(t=1;t<i;t++)null===e[t]&&(e[t]="");var n=e[i],o=this.isFlatten,s=n.type,a=s.indexOf("POLYGON")!==-1||s.indexOf("Polygon")!==-1,l="POLYGON"===s||"Polygon"===s,u=n.coordinates,h=[],c=null,d=[];if(a){l&&(u=[u]),c=r.bounds();var p=r.bounds().extendBounds(this.bounds).addBuffer(-.05),f=!1;for(t=0,i=u.length;t<i;t++){for(var m=[],g=[],v=0,y=u[t].length;v<y;v++){o&&"number"!=typeof u[t][v][0]&&(u[t][v]=r.flattenRing(u[t][v]));var x=r.bounds(u[t][v]);m.push(x),0===v&&c.extendBounds(x);var _=r.getHidden(u[t][v],p);g.push(_),_.length&&(f=!0)}d.push(m),h.push(g)}f||(h=null),l&&(d=d[0])}else if("POINT"===s||"Point"===s)c=r.bounds([u]);else if("MULTIPOINT"===s||"MultiPoint"===s)for(c=r.bounds(),t=0,i=u.length;t<i;t++)c.extendBounds(r.bounds([u[t]]));else if("LINESTRING"===s||"LineString"===s)c=r.bounds(u);else if("MULTILINESTRING"===s||"MultiLineString"===s)for(c=r.bounds(),t=0,i=u.length;t<i;t++)c.extendBounds(r.bounds(u[t]));var b={bounds:c,boundsArr:d};return h&&(b.hiddenLines=h),b}},p.makeTileKey=function(e,t,i,r,n,o){return i+"_"+e+"_"+t+"_"+r+"_"+n+"_"+o},p.createTileKey=function(e){return[e.z,e.x,e.y,e.v,e.s,e.d].join("_")},p.parseTileKey=function(e){var t=e.split("_").map(function(e){return Number(e)});return{z:t[0],x:t[1],y:t[2],v:t[3],s:t[4],d:t[5]}},p.boundsFromTileKey=function(e){var t=p.parseTileKey(e);return r.getTileBounds(t.x,t.y,t.z)};var f=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this.type=e.type||"update",this._callback=e.callback,this.layerID=e.layerID,this.target=e.target,this.itemHook=e.itemHook,this._items=null,this.bbox=e.bbox,this.needBbox=e.needBbox,this.filters=e.filters||[],this.targetZoom=e.targetZoom||null,this.active=!("active"in e)||e.active,this.srs=e.srs||3857,e.bounds&&this.setBounds(e.bounds);var t,i=r.worldWidthMerc;this.bbox?this.bbox.max.x>i?(t=this.bbox.max.x-i,this.bbox1=r.bounds([[t-i,this.bbox.max.y],[-(t+i),this.bbox.min.y]])):this.bbox.min.x<-i&&(t=this.bbox.min.x+i,this.bbox1=r.bounds([[t+i,this.bbox.max.y],[i-t,this.bbox.min.y]])):(this.bbox=r.bounds([[-i,-i],[i,i]]),this.world=!0),e.dateInterval&&this._setDateInterval(e.dateInterval[0],e.dateInterval[1])},hasFilter:function(e){for(var t=0,i=this.filters.length;t<i;t++)if(this.filters[t]===e)return!0;return!1},activate:function(){return this.active||(this.active=!0,this.fire("activate")),this},deactivate:function(){return this.active&&(this.active=!1,this.fire("activate")),this},toggleActive:function(e){return e?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(e){var t=e.length,i={count:t};if("update"===this.type){this._items||(this._items={});for(var r,n=this._items,o={},s=[],a=[],l=0;l<t;l++){var u=e[l];r=u.id+"_"+u.tileKey,o[r]=u,n[r]||s.push(u)}for(r in n)o[r]||a.push(n[r]);s.length&&(i.added=s),a.length&&(i.removed=a),this._items=o}else i.added=e;return this.fire("data",{data:this._callback(i)}),i=null,e=null,this},removeData:function(e){if("update"!==this.type||!this._items)return this;var t=this._items,i=[];for(var r in e)t[r]&&(i.push(t[r]),delete t[r]);return i.length&&this._callback({removed:i}),this},setBounds:function(e,i){var n;if(!e)return this.world||(n=r.worldWidthMerc,this.bbox=r.bounds([[-n,-n],[n,n]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var o=e.min,s=e.max;if(!o||!s){var a=t.latLngBounds(e),l=a.getSouthWest(),u=a.getNorthEast();o={x:l.lng,y:l.lat},s={x:u.lng,y:u.lat}}var h=o.x,c=s.x,d=o.y,p=s.y,f=null,m=null;if(this.world=!1,n=(c-h)/2,n>=180)h=-180,c=180,this.world=!0;else if(c>180||h<-180){var g=(c+h)/2%360;g>180?g-=360:g<-180&&(g+=360),h=g-n,c=g+n,h<-180?(f=h+360,m=180,h=-180):c>180&&(f=-180,m=c-360,c=180)}var v=3857==this.srs?t.CRS.EPSG3857:t.Projection.Mercator,y=v.project(t.latLng(d,h)),x=v.project(t.latLng(p,c));return this.bbox=r.bounds([[y.x,y.y],[x.x,x.y]]),i&&this.bbox.addBuffer(i),this.bbox1=null,f&&(y=v.project(t.latLng(d,f)),x=v.project(t.latLng(p,m)),this.bbox1=r.bounds([[y.x,y.y],[x.x,x.y]]),i&&this.bbox1.addBuffer(i)),this.fire("update"),this},intersects:function(e){return this.world||this.bbox.intersects(e)||!(!this.bbox1||!this.bbox1.intersects(e))},intersectsWithTile:function(e){if(this.targetZoom&&!this.needBbox){var t=this.targetZoom+(this.targetZoom%2?1:0);if(e.isGeneralized&&e.z!==t||e.z>t)return!1}var i=this.dateInterval;return this.intersects(e.bounds)&&(!e.beginDate||i&&i.endDate>=e.beginDate&&i.beginDate<=e.endDate)},intersectsWithGeometry:function(e){var t=e.type.toUpperCase(),i=e.coordinates;if("POINT"===t)return this.world||this.bbox.contains(i)||!(!this.bbox1||!this.bbox1.contains(i));"POLYGON"===t?i=[i[0]]:"MULTIPOLYGON"===t?i=i.map(function(e){return e[0]}):"LINESTRING"===t&&(i=[i]);for(var r=0,n=i.length;r<n;r++)if(this.bbox.clipPolygon(i[r]).length||this.bbox1&&this.bbox1.clipPolygon(i[r]).length)return!0;return!1},_setDateInterval:function(e,t){e&&t?this.dateInterval={beginDate:e,endDate:t}:this.dateInterval=null},setDateInterval:function(e,t){var i=e&&t;return(!this.dateInterval!=!i||i&&(this.dateInterval.beginDate.valueOf()!==e.valueOf()||this.dateInterval.endDate.valueOf()!==t.valueOf()))&&(this._setDateInterval(e,t),this.fire("update",{temporalFilter:!0})),this}});t.gmx.observer=function(e){return new f(e)},function(){var e=function(e){var t=[],i=e.TemporalTiles||[],n=e.TemporalVers||[],o=e.TemporalPeriods||[],s=o[o.length-1],a=Number.MAX_VALUE,l=e.ZeroDate.split("."),u=new Date(l.length>2?l[2]:2008,l.length>1?l[1]-1:0,l.length>0?l[0]:1),h=new Date(u.getTime()-6e4*u.getTimezoneOffset()),c=h.getTime()/1e3;this.dateZero=h;var d,f,m=function(e,t,i){var n=e.d;if(t.d===o[n])return e.count++,void e.tiles.push(i);var s=o[n-1],a=o[n]/s;"children"in e||(e.children=new Array(a));var l=Math.floor(t.s*t.d/s),u=l-e.s*a;if(!e.children[u]){var h=s*r.oneDay,d=l*h+c;e.children[u]={d:n-1,s:l,t1:d,t2:d+h,count:0,children:[],tiles:[]}}m(e.children[u],t,i)},g=o.length-1,v=o[g]*r.oneDay;for(d=0,f=i.length;d<f;d++){l=i[d];var y=Number(l[1]),x=Number(l[0]);x===s&&(a=Math.min(a,y))}for(d=0,f=i.length;d<f;d++){l=i[d];var _={x:Number(l[2]),y:Number(l[3]),z:Number(l[4]),v:Number(n[d]),s:Number(l[1]),d:Number(l[0])};if(!(_.d<0)){var b=Math.floor(_.s*_.d/o[g])-a,P=b+a;t[b]=t[b]||{d:g,s:P,t1:P*v+c,t2:(P+1)*v+c,count:0,tiles:[]};var S=p.createTileKey(_);m(t[b],_,S)}}i=n=null,this.selectTiles=function(e,i,r){r=r||{};for(var n=e.valueOf()/1e3,s=i.valueOf()/1e3,a=0,l=(s-n)/3600/24,u=0;u<o.length;u++)if(o[u]>l){a=Math.max(0,u-1);break}o[o.length-1]<=l&&(a=o.length-1);for(var h=Math.min(o.length-1,a+Number(l>o[a])),c=function(e,t){for(var i=0,r=0;r<e.length;r++)e[r].intersects(t)&&i++;return i},d=function(e,t,i){if(t>=e.t2||i<=e.t1)return{count:0,tiles:[],nodes:[]};if(r.bounds&&!e.tileBounds&&(e.tileBounds=e.tiles.map(function(e){return p.boundsFromTileKey(e)})),e.d===a){var n=r.bounds?c(e.tileBounds,r.bounds):e.count;return{tiles:e.tiles,count:n,nodes:[e]}}var o,s=0,l=[],u=e.children?e.children.length:0;for(o=0;o<u;o++)e.children[o]?l[o]=d(e.children[o],Math.max(t,e.t1),Math.min(i,e.t2)):l[o]={count:0,tiles:[],nodes:[]},s+=l[o].count;var f=r.bounds?c(e.tileBounds,r.bounds):e.count;if(e.d>h||s<f){var m=[],g=[];for(o=0;o<l.length;o++)g.push(l[o].nodes),m.push(l[o].tiles);return{tiles:[].concat.apply([],m),count:s,nodes:[].concat.apply([],g)}}return{tiles:e.tiles,count:f,nodes:[e]}},f=[],m=0;m<t.length;m++)if(t[m]){var g=d(t[m],n,s);g.tiles.length&&(f=f.concat(g.tiles))}for(var v={},y=0;y<f.length;y++)v[f[y]]=!0;return{tiles:v}},this.getNode=function(e,i){if(e<0||i<0)return null;for(var r=function(e,t,i){if(!e)return null;if(o[e.d]===t)return e.s===i?e:null;var n=o[e.d]/o[e.d-1],s=Math.floor(i*t/o[e.d-1]),a=s-e.s*n;return e.children[a]?r(e.children[a],t,i):null},n=0;n<t.length;n++){var s=r(t[n],e,i);if(s)return s}return null}};t.gmx.tilesTree=function(t){return new e(t)}}();var m=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this._dataManager=e,this._observerData={},this._tileData={}},addObserver:function(e){return this._observerData[e.id]={observer:e,tiles:{},leftToLoad:0,loadingState:!1},e.on("update",this._updateObserver.bind(this,e)),this._updateObserver(e),this},removeObserver:function(e){var t=this._observerData[e].tiles;for(var i in t)delete this._tileData[i].observers[e];return delete this._observerData[e],this},addTile:function(e){var t="loaded"===e.state?0:1;e.loadDef.then(this._tileLoadedCallback.bind(this,e));var i={};for(var r in this._observerData){var n=this._observerData[r];n.observer.intersectsWithTile(e)&&(n.tiles[e.vectorTileKey]=!0,n.leftToLoad+=t,i[r]=!0)}return this._tileData[e.vectorTileKey]={observers:i,tile:e},this},removeTile:function(e){var t=this._tileData[e],i="loaded"===t.tile.state?0:1;for(var r in t.observers){var n=this._observerData[r];n.leftToLoad-=i,delete n.tiles[e]}return delete this._tileData[e],this},startLoadTiles:function(e){this._dataManager._getActiveTileKeys();var t=this._observerData[e.id];if(t.leftToLoad<1)return this.fire("observertileload",{observer:e}),this;t.loadingState||(t.loadingState=!0,e.fire("startLoadingTiles"));for(var i in t.tiles)this._tileData[i].tile.load();return this},getTileObservers:function(e){return this._tileData[e].observers},getObserverLoadingState:function(e){return this._observerData[e.id].loadingState},getObserverLeftToLoad:function(e){return this._observerData[e.id].leftToLoad},_updateObserver:function(e){if(this._observerData[e.id]){var t,i=this._observerData[e.id],r={},n=0;for(t in this._tileData){var o=this._tileData[t].tile;e.intersectsWithTile(o)&&(r[t]=!0,"loaded"!==o.state&&n++,this._tileData[t].observers[e.id]=!0)}for(t in i.tiles)t in r||delete this._tileData[t].observers[e.id];i.tiles=r,i.leftToLoad=n}},_tileLoadedCallback:function(e){if(this.fire("tileload",{tile:e}),e.vectorTileKey in this._tileData){var t=this._tileData[e.vectorTileKey].observers;for(var i in t){var r=this._observerData[i];r.leftToLoad--,r.leftToLoad<1&&(r.loadingState&&(r.loadingState=!1,r.observer.fire("stopLoadingTiles")),this.fire("observertileload",{observer:r.observer}))}}}}),g=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,options:{name:null,srs:"",identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:-1,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,needBbox:!1,isFlatten:!1},setOptions:function(e){this._clearProcessing(),e.GeoProcessing&&(this.processingTile=this.addData([]),this._chkProcessing(e.GeoProcessing)),t.setOptions(this,e),this.optionsLink=e,this._isTemporalLayer=this.options.Temporal;var i=t.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=i.tileAttributeIndexes,this.temporalColumnType=i.tileAttributeTypes[this.options.TemporalColumnName];var r=this.options.hostName,n=this.options.sessionKey;this.tileSenderPrefix=t.gmxUtil.protocol+"//"+r+"/TileSender.ashx?WrapStyle=None&key="+encodeURIComponent(n),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(e,t,i,r,n,o,s){var a=this;d.load(a.tileSenderPrefix,{x:e,y:t,z:i,v:r,s:n,d:o,srs:this.options.srs,layerID:a.options.name}).then(s,function(){console.log("Error loading vector tile"),s({values:[]}),a.fire("chkLayerUpdate",{dataProvider:a})})},initialize:function(e,t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._filtersView={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var i=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new m(this),this._observerTileLoader.on("tileload",function(e){var t=e.tile;if(i._updateItemsFromTile(t),i._tilesTree){var r=i._tilesTree.getNode(t.d,t.s);r&&r.count--}}),this._observerTileLoader.on("observertileload",function(e){var t=e.observer;t.isActive()&&(t.needRefresh=!1,t.updateData(i.getItems(t.id)))}),this.setOptions(e),t&&(this.options.LayerVersion=-1),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(e,t,i){var r=e.options.unixTimeStamp,n=i.dateInterval;return n&&r>=n.beginDate.valueOf()&&r<n.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),this.options.needBbox||!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var e={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),e=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(e)}else this.initTilesList();return this._activeTileKeys},getViewFilters:function(e,t){var i=[];e=e||"screen";for(var r in this._filtersView[t])0===r.indexOf(e)&&i.push(r);return i},_getObserversByFilterName:function(e,t){var i={};for(var r in this._observers){var n=this._observers[r];n.hasFilter(e)?i[r]=!0:t&&t===n.target&&(n.filters.push(e),i[r]=!0)}return i},addLayerFilter:function(e,t){if(t&&t.layerID){var i=t.layerID,r=t.target||"screen",n=r;this._filtersView[i]||(this._filtersView[i]={}),t.id&&(n+="_"+t.id),this._filtersView[i][n]=e,this._triggerObservers(this._getObserversByFilterName(n,r))}return this},removeLayerFilter:function(e){if(this._filtersView[e.layerID]){var t=e.layerID,i=e.target||"screen",r=i;if(e.id&&(r+="_"+e.id),this._filtersView[t][r]){var n=this._getObserversByFilterName(r,i);delete this._filtersView[t][r],this._triggerObservers(n)}}return this},addFilter:function(e,t){return this._filters[e]=t,this._triggerObservers(this._getObserversByFilterName(e)),this},removeFilter:function(e){if(this._filters[e]){var t=this._getObserversByFilterName(e);delete this._filters[e],this._triggerObservers(t)}return this},getItems:function(e){var t=[],i=this._observers[e];if(!i)return[];var r=i.layerID,n=this._filtersView[r]||{},o=i.filters.concat("processingFilter");this._isTemporalLayer&&o.push("TemporalFilter"),o=o.filter(function(e){return e in this._filters||e in n}.bind(this));var s=this,a=function(e){var r=e.data,a=t.length,l=r.length;t.length=a+l;for(var u=0;u<l;u++){var h=e.dataOptions[u];if(i.intersects(h.bounds)){var c=r[u],d=c[c.length-1];if(i.intersectsWithGeometry(d)){for(var p=c[0],f=s.getItem(p),m=!1,g=0;g<o.length;g++){var v=o[g],y=s._filters[v]||n[v];if(y&&!y(f,e,i,d,h)){m=!0;break}}if(!m){var x={id:p,properties:c,item:f,dataOption:h,v:e.v,tileKey:e.vectorTileKey};i.itemHook?i.itemHook(x):t[a++]=x}}}}t.length=a},l=this._getActiveTileKeys();for(var u in l){var h=s._tiles[u].tile;h.data&&h.data.length>0&&(0===h.z||i.intersectsWithTile(h))&&a(h)}return t},_updateItemsFromTile:function(e){for(var t=e.vectorTileKey,i=e.data||[],r=i.length,n=i[0]&&i[0].length-1,o=0;o<r;o++){var s=i[o],a=s[n],l=s[0],u=this._items[l];if(u?(u.processing?e.data[o]=u.properties:(u.properties=s,u.type.indexOf("MULTI")===-1&&(u.type="MULTI"+u.type)),delete u.bounds,u.currentFilter=null):(u={id:l,type:a.type,properties:s,options:{fromTiles:{}}},this._items[l]=u),u.options.fromTiles[t]=o,e.isGeneralized&&(u.options.isGeneralized=!0),this.options.TemporalColumnName){var h=s[this.tileAttributeIndexes[this.options.TemporalColumnName]];u.options.unixTimeStamp=1e3*h}}return r},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var e=this._observers,t=null,i=null;for(var r in e){var n=e[r],o=n.dateInterval;o&&((!t||o.beginDate<t)&&(t=o.beginDate),(!i||o.endDate>i)&&(i=o.endDate))}t&&i&&(this._beginDate!==t||this._endDate!==i)&&(this._beginDate=t,this._endDate=i,this._needCheckActiveTiles=!0)}},addObserver:function(e,i){i=i||"s"+ ++this._freeSubscrID;var r=this,n=new f(e);return n.id=i,n.needRefresh=!0,this._observerTileLoader.addObserver(n),n.on("update",function(e){n.needRefresh=!0,e.temporalFilter&&(r._needCheckDateInterval=!0),t.gmx.layersVersion.now(),r._waitCheckObservers()}).on("activate",function(){r.fire("observeractivate"),r.checkObserver(n)}),r._needCheckDateInterval=!0,this._observers[i]=n,this._waitCheckObservers(),n.isActive()&&this.fire("observeractivate"),n},getActiveObserversCount:function(){var e=0;for(var t in this._observers)this._observers[t].isActive()&&e++;return e},getObserver:function(e){return this._observers[e]},removeScreenObservers:function(){for(var e in this._observers){var t=this._observers[e];"screen"===t.target&&(t.deactivate(),this.removeObserver(e))}},removeObserver:function(e){if(this._observers[e]){this._observerTileLoader.removeObserver(e);var t=this._observers[e].isActive();delete this._observers[e],t&&this.fire("observeractivate")}},getObserverLoadingState:function(e){return this._observerTileLoader.getObserverLoadingState(e)},getObserverLeftToLoad:function(e){return this._observerTileLoader.getObserverLeftToLoad(e)},getTileKeysToLoad:function(e,t){var i=this._tilesTree.selectTiles(e,t).tiles;return i},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=r.bounds();for(var e in this._items){var t=this.getItem(e);this._itemsBounds.extendBounds(t.bounds)}}return this._itemsBounds},getItem:function(e){var t=this._items[e];if(t&&!t.bounds){var i=t.options.fromTiles,n=[];for(var o in i)if(this._tiles[o]){var s=i[o],a=this._tiles[o].tile;"loaded"===a.state&&a.dataOptions[s]?n.push(a.dataOptions[s].bounds):delete i[o]}if(1===n.length)t.bounds=n[0];else{t.bounds=r.bounds();for(var l=r.worldWidthMerc,u=0,h=n.length;u<h;u++){var c=n[u];t.bounds.max.x-c.min.x>l&&(c=r.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),t.bounds.extendBounds(c)}}}return t},getItemMembers:function(e){var t=this._items[e].options.fromTiles,i=[];for(var r in t)if(this._tiles[r]){var n=this._tiles[r].tile;if(n.data){var o=t[r],s=n.data[o],a=n.dataOptions[o],l=a.bounds;i.push({geo:s[s.length-1],width:l.max.x-l.min.x,dataOption:a})}}return i.sort(function(e,t){return t.width-e.width})},getItemGeometries:function(e){var t=this._items[e]?this._items[e].options.fromTiles:{},i=[];for(var n in t)if(this._tiles[n]&&this._tiles[n].tile.data){var o=this._tiles[n].tile.data,s=o[t[n]];i.push(r.getUnFlattenGeo(s[s.length-1]))}return i},addTile:function(e){this._tiles[e.vectorTileKey]={tile:e},this._getActiveTileKeys()[e.vectorTileKey]=!0,this._observerTileLoader.addTile(e),this.checkObservers()},checkObserver:function(e){e.needRefresh&&e.isActive()&&this._observerTileLoader.startLoadTiles(e)},checkObservers:function(){var e=this._observers;for(var t in this._observers)this.checkObserver(e[t])},_waitCheckObservers:function(){t.Util.requestAnimFrame(this.checkObservers,this)},_triggerObservers:function(e){var t=e||this._observers;for(var i in t)this._observers[i]&&(this._observers[i].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(e){var t=this._observers;for(var i in t)this._observers[i].removeData(e);this._waitCheckObservers()},preloadTiles:function(e,t,r){var n={};this._isTemporalLayer?(this._tilesTree||this.initTilesTree(),n=this._tilesTree.selectTiles(e,t).tiles):(this._needCheckActiveTiles=!0,n=this._getActiveTileKeys());var o=[];for(var s in n){var a=this._getVectorTile(s,!0).tile;if("notLoaded"===a.state&&(!r||r.intersects(a.bounds))){var l=a.load();o.push(l)}}return i.all.apply(null,o)},_updateActiveTilesList:function(e){if(this._tileFilteringHook){var t={};for(var i in e)this._tileFilteringHook(this._getVectorTile(i,!0).tile)&&(t[i]=!0);e=t}var r,n=this._activeTileKeys||{},o={},s=this;this.processingTile&&(e[this.processingTile.vectorTileKey]=!0),this._rasterVectorTile&&(r=this._rasterVectorTile.vectorTileKey,e[r]=!0,this._tiles[r]={tile:this._rasterVectorTile});var a=function(e){var t=s._observerTileLoader.getTileObservers(e);for(var i in t)o[i]=!0};for(r in e)n[r]||(this._observerTileLoader.addTile(this._getVectorTile(r,!0).tile),a(r));for(r in n)e[r]||(a(r),this._observerTileLoader.removeTile(r));this._activeTileKeys=e,this._triggerObservers(o)},_propertiesToArray:function(e){var t=e.properties,i=this.tileAttributeIndexes,r=[];for(var n in i)r[i[n]]=t[n];return r[r.length]=e.geometry,r[0]=e.id,r},_clearProcessing:function(){if(this.processingTile){for(var e=this._items,t=this.processingTile,i=t.vectorTileKey,r=t.data||[],n=0,o=r.length;n<o;n++){var s=r[n][0];if(e[s]){var a=e[s];a.processing=null,a.currentFilter=null,delete a.options.fromTiles[i],delete a.fromServerProps,delete a.geometry}}t.clear()}},_chkProcessing:function(e){var t,i,r,n,o,s=this._items,a=!1,l={};if(e){if(e.Deleted)for(i=0,r=e.Deleted.length;i<r;i++)t=e.Deleted[i],l[t]=!0,s[t]&&(s[t].processing=!0,s[t].currentFilter=null),r>0&&(a=!0);var u={};if(e.Inserted)for(i=0,r=e.Inserted.length;i<r;i++)n=e.Inserted[i],l[n[0]]||(u[n[0]]=n);if(e.Updated){for(i=0,r=e.Updated.length;i<r;i++)n=e.Updated[i],l[n[0]]||(u[n[0]]=n);!a&&r>0&&(a=!0)}o=[];for(t in u)this._items[t]&&(this._items[t].properties=u[t],this._items[t].processing=!0,this._items[t].currentFilter=null),o.push(u[t]);o.length>0&&(this.processingTile=this.addData(o))}a?this.addFilter("processingFilter",function(e,t){return 0===t.z||!e.processing}):this.removeFilter("processingFilter")},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())},_resetTilesTree:function(){this._tilesTree=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},updateVersion:function(e,i){if(!t.gmx.skipLoadTiles)if(e&&this.setOptions(e),i){this._needCheckActiveTiles=!1;for(var r,n={},o={},s=0,a=0,l=i.length;s<l;s+=6,a++)r=p.createTileKey({z:Number(i[s]),x:Number(i[s+1]),y:Number(i[s+2]),v:Number(i[s+3]),d:Number(i[s+4]),s:Number(i[s+5])}),n[r]=this._getVectorTile(r,!0),o[r]=!0;this._tiles=n,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile}),this._updateActiveTilesList(o)}else this._resetTilesTree();
},getNotLoadedVectorTiles:function(e){var t=0;if(e.tiles)for(var i=e.tiles||[],r=0,n=0,o=i.length;r<o;r+=6,n++)this._tiles[p.createTileKey({z:Number(i[r]),x:Number(i[r+1]),y:Number(i[r+2]),v:Number(i[r+3]),d:Number(i[r+4]),s:Number(i[r+5])})]||t++;return t},_getDataKeys:function(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i][0]]=!0;return t},_getProcessingTile:function(){if(!this.processingTile){var e=-.5,t=-.5,i=0,r=0,n=-1,o=-1,s=this.options.isFlatten;this.processingTile=new p({load:function(e,t,i,r,n,o,s){s({values:[]})}},{x:e,y:t,z:i,v:r,s:n,d:o,isFlatten:s}),this.addTile(this.processingTile)}return this.processingTile},addData:function(e){e||(e=[]);var t=this._getProcessingTile(),i=this._getDataKeys(e),r=t.addData(e,i);return this._itemsBounds&&this._itemsBounds.extendBounds(r),this._updateItemsFromTile(t),this._triggerObservers(),t},removeData:function(e){this._itemsBounds=null;var t=this.processingTile;if(t){var i=(e||t.data).reduce(function(e,t){var i=t[0];return e[i]=!0,delete this._items[i],e}.bind(this),{});this._removeDataFromObservers(i),t.removeData(i,!0),this._updateItemsFromTile(t),this._triggerObservers()}return t},initTilesTree:function(){this._tilesTree=t.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(e,t){if(!this._tiles[e]&&t){var i=p.parseTileKey(e);i.dateZero=this.dateZero,this._addVectorTile(i)}return this._tiles[e]},_addVectorTile:function(e){e.isFlatten=this.options.isFlatten,e.needBbox=this.options.needBbox,e.attributes=this.options.attributes;var t=new p(this._vectorTileDataProvider,e),i=t.vectorTileKey;return this._tiles[i]={tile:t},i},_getGeneralizedTileKeys:function(e){for(var i=e.z%2?1:2,r=Math.pow(2,i),n=e.z-i,o=Math.floor(e.x/r),s=Math.floor(e.y/r),a={v:e.v,s:-1,d:-1,isGeneralized:!0},l={};n>1;){var u=[n,o,s].join("_");l[u]=t.extend({},a,{x:o,y:s,z:n}),n-=2,o=Math.floor(o/4),s=Math.floor(s/4)}return l},initTilesList:function(){var e={};if(this.options.tiles){for(var t,i,r,n,o=this.options.tiles||[],s=this.options.tilesVers,a=this.options.isGeneralized?{}:null,l={},u=0,h=0,c=o.length;u<c;u+=3,h++)if(r={x:Number(o[u]),y:Number(o[u+1]),z:Number(o[u+2]),v:Number(s[h]),s:-1,d:-1},n=this._getVectorTile(p.createTileKey(r),!0),i=n.tile.vectorTileKey,l[i]=n,e[i]=!0,a){var d=this._getGeneralizedTileKeys(r);for(t in d){var f=d[t];a[t]?a[t].v=Math.max(f.v,a[t].v):a[t]=f}}if(a)for(t in a)r=a[t],i=p.createTileKey(r),l[i]||(this._tiles[i]||this._addVectorTile(r),l[i]=this._tiles[i],e[i]=!0);this._tiles=l,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(e)},setTileFilteringHook:function(e){this._tileFilteringHook=e,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});t.gmx=t.gmx||{},t.gmx.DataManager=g,t.gmx.VectorLayer=t.GridLayer.extend({options:{tilesCRS:t.CRS.EPSG3395,openPopups:[],minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,skipTiles:"All",iconsUrlReplace:[],cacheRasters:!0,cacheQuicklooks:!0,clearCacheOnLoad:!0,showScreenTiles:!1,updateWhenZooming:!1,clickable:!0},initialize:function(e){e=t.setOptions(this,e),this._initPromise=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this)),this.repaintObservers={},this._gmx={hostName:r.normalizeHostname(e.hostName||"maps.kosmosnimki.ru"),mapName:e.mapID,sessionKey:this.options.sessionKey,iconsUrlReplace:this.options.iconsUrlReplace,showScreenTiles:this.options.showScreenTiles,skipTiles:e.skipTiles,needBbox:"All"===e.skipTiles,useWebGL:e.useWebGL,srs:e.srs||"",layerID:e.layerID,beginDate:e.beginDate,endDate:e.endDate,sortItems:e.sortItems||null,styles:e.styles||[],shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},e.cacheQuicklooks&&(this._gmx.quicklooksCache={}),e.cacheRasters&&(this._gmx.rastersCache={}),e.crossOrigin&&(this._gmx.crossOrigin=e.crossOrigin)},_repaintNotLoaded:function(){if(this._map){var e,i,r,n=[];for(e in this._tiles)i=this._tiles[e],r=i.coords.z,r==this._tileZoom&&(i.loaded?i.count?!i.el.parentNode&&this._levels[r]&&this._levels[r].appendChild(i.el):i.el.parentNode&&i.el.parentNode.removeChild(i.el):n.push(e));n.length?(this.repaint(n),t.Util.requestAnimFrame(t.bind(this._repaintNotLoaded,this))):this.options.clearCacheOnLoad&&(this._gmx.rastersCache={},this._gmx.quicklooksCache={})}},_setView:function(e,i,r,n){this._map&&t.GridLayer.prototype._setView.call(this,e,i,r,n)},_updateOpacity:function(){if(this._map&&!t.Browser.ielt9){var e=!1;for(var i in this._tiles){var r=this._tiles[i];r.current&&r.loaded&&(r.active&&(e=!0),r.active=!0)}e&&!this._noPrune&&this._pruneTiles()}},_tileReady:function(e,i,r){if(this._map){i&&this.fire("tileerror",{error:i,tile:r,coords:e});var n=this._tileCoordsToKey(e);r=this._tiles[n],r&&(r.loaded=+new Date,this._map._fadeAnimated?(t.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=t.Util.requestAnimFrame(this._updateOpacity,this)):r.active=!0,i||(t.DomUtil.addClass(r.el,"leaflet-tile-loaded"),this.fire("tileload",{tile:r.el,coords:e})),this._noTilesToLoad()&&(this._loading=!1,this.fire("load"),t.Browser.ielt9||!this._map._fadeAnimated?t.Util.requestAnimFrame(this._pruneTiles,this):setTimeout(t.bind(this._pruneTiles,this),250)))}},_onCreateLevel:function(e){this._updateShiftY(e.zoom)},_initContainer:function(){this._container||(this._container=t.DomUtil.create("div","leaflet-layer "+(this.options.className||"")),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),this._updateZIndex(),this.getPane(this.options.pane).appendChild(this._container))},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},_getEvents:function(){var i=t.GridLayer.prototype.getEvents.call(this),r=this._gmx;return"Vector"===r.properties.type&&(i.moveend=function(){"dataManager"in this._gmx&&this._gmx.dataManager.fire("moveend"),t.Util.requestAnimFrame(t.bind(this._repaintNotLoaded,this))}),{map:i,owner:{dateIntervalChanged:function(){setTimeout(t.bind(this._repaintNotLoaded,this),25)},tileloadstart:function(i){var r=this._tileCoordsToKey(i.coords),n=this._tiles[r];n.loaded=0,n.screenTile=new e(this,n),t.Util.requestAnimFrame(t.bind(this.__drawTile,this,i))},stylechange:function(){var e=this._gmx;!e.balloonEnable&&this._popup?this.unbindPopup():e.balloonEnable&&!this._popup&&this.bindPopup(""),this._map&&(this.options.minZoom===e.styleManager.minZoom&&this.options.maxZoom===e.styleManager.maxZoom||(this.options.minZoom=e.styleManager.minZoom,this.options.maxZoom=e.styleManager.maxZoom,this._map._updateZoomLevels()),e.labelsLayer?this._map._labelsLayer.add(this):e.labelsLayer||this._map._labelsLayer.remove(this),this.redraw())},versionchange:this._onVersionChange}}},beforeAdd:function(e){this._updateShiftY(e.getZoom()),t.GridLayer.prototype.beforeAdd.call(this,e),this._map=e},onAdd:function(e){if(e=e||this._map,e.options.crs!==t.CRS.EPSG3857&&e.options.crs!==t.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";this.beforeAdd(e);var i=this._gmx;this.options.tilesCRS=3857==i.srs?t.CRS.EPSG3857:t.CRS.EPSG3395,i.shiftY=0,i.applyShift=e.options.crs===t.CRS.EPSG3857&&3857!=i.srs,i.currentZoom=e.getZoom(),this._levels={},this._tiles={},this._initContainer(),i.styleManager.promise.then(function(){if(i.balloonEnable&&!this._popup&&this.bindPopup(""),this._map){var r=this._getEvents();e.on(r.map,this),this.on(r.owner,this),this.once("remove",function(){e.off(r.map,this),this.off(r.owner,this)},this),this._resetView(),this._update()}t.gmx.layersVersion.add(this),this.fire("add")}.bind(this)),i.styleManager.initStyles()},onRemove:function(e){var i=this._gmx,r=i.dataManager;r&&r.removeScreenObservers(),this._removeAllTiles(),this._container&&t.DomUtil.remove(this._container),e._removeZoomLimit(this),this._container=null,this._tileZoom=void 0,i.labelsLayer&&e._labelsLayer.remove(this),i.quicklooksCache={},i.rastersCache={},this._map=null,delete i.map,r&&!r.getActiveObserversCount()&&t.gmx.layersVersion.remove(this),this.fire("remove")},_updateZIndex:function(){if(this._container){var e=this.options,t=e.zIndex||0,i=e.zIndexOffset||0;this._container.style.zIndex=i+t}},_update:function(e){var i=this._map;if(i){var r=this._clampZoom(i.getZoom());if(void 0===e&&(e=i.getCenter()),void 0!==this._tileZoom){var n=this._getTiledPixelBounds(e),o=this._pxBoundsToTileRange(n),s=[],a=this.options.keepBuffer,l=new t.Bounds(o.getBottomLeft().subtract([a,-a]),o.getTopRight().add([a,-a]));if(!(isFinite(o.min.x)&&isFinite(o.min.y)&&isFinite(o.max.x)&&isFinite(o.max.y)))throw new Error("Attempted to load an infinite number of tiles");for(var u in this._tiles){var h=this._tiles[u].coords;h.z===this._tileZoom&&l.contains(new t.Point(h.x,h.y))||(this._tiles[u].current=!1)}if(Math.abs(r-this._tileZoom)>1)return void this._setView(e,r);var c,d,p,f;for(d=o.min.y;d<=o.max.y;d++)for(c=o.min.x;c<=o.max.x;c++)if(f=new t.Point(c,d),f.z=this._tileZoom,this._isValidTile(f)){var m=this._tiles[this._tileCoordsToKey(f)];m?m.current=!0:s.push(f)}if(0!==s.length)for(this._loading||(this._loading=!0,this.fire("loading")),c=0,p=s.length;c<p;c++)this._addTile(s[c])}}},createTile:function(e,i){this._test=[e,i];var r=t.DomUtil.create("canvas","leaflet-tile"),n=this.getTileSize();return r.width=n.x,r.height=n.y,r.style.width=n.x+"px",r.style.height=n.y+"px",r.onselectstart=t.Util.falseFn,r.onmousemove=t.Util.falseFn,t.Browser.android&&!t.Browser.android23&&(r.style.WebkitBackfaceVisibility="hidden"),r},_addTile:function(e){var i=this.createTile(this._wrapCoords(e),t.bind(this._tileReady,this,e)),r=this._tileCoordsToKey(e);this._tiles[r]={el:i,coords:e,current:!0},this.fire("tileloadstart",{tile:i,coords:e})},initFromDescription:function(e){var i=this._gmx;if(i.properties=e.properties,i.geometry=e.geometry,i.properties._initDone&&delete i.properties[i.properties.Temporal?"TemporalTiles":"tiles"],i.properties._initDone=!0,!i.geometry){var n=r.tileSizes[1];i.geometry={type:"POLYGON",coordinates:[[[-n,-n],[-n,n],[n,n],[n,-n],[-n,-n]]]}}if(i.rawProperties=e.rawProperties||e.properties,this._updateProperties(e.properties),"Vector"===i.rawProperties.type&&(e.properties.srs=i.srs=3857,i.RasterSRS=Number(i.rawProperties.RasterSRS)||3857),e.properties.needBbox=i.needBbox,e.properties.isGeneralized=this.options.isGeneralized,e.properties.isFlatten=this.options.isFlatten,i.dataManager=this.options.dataManager||new g(e.properties),this.options.parentOptions&&(e.properties.styles||(e.properties.styles=this.options.parentOptions.styles),i.dataManager.on("versionchange",this._onVersionChange,this)),i.styleManager=new v(i),this.options.minZoom=i.styleManager.minZoom,this.options.maxZoom=i.styleManager.maxZoom,i.dataManager.on("observeractivate",function(){i.dataManager.getActiveObserversCount()?t.gmx.layersVersion.add(this):t.gmx.layersVersion.remove(this)},this),"Vector"!==i.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==i.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),i.clusters&&this.bindClusters(JSON.parse(i.clusters)),i.filter){var o=t.gmx.Parsers.parseSQL(i.filter.replace(/[\[\]]/g,'"'));o&&i.dataManager.addFilter("userFilter_"+i.layerID,function(e){return i.layerID!==this._gmx.layerID||!o||o(e.properties,i.tileAttributeIndexes,i.tileAttributeTypes)?e.properties:null}.bind(this))}return i.dateBegin&&i.dateEnd&&this.setDateInterval(i.dateBegin,i.dateEnd),this._resolve(),this},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._gmx.dataManager.enableGeneralization(),this.redraw()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._gmx.dataManager.disableGeneralization(),this.redraw()))},setRasterOpacity:function(e){return this._gmx.rasterOpacity!==e&&(this._gmx.rasterOpacity=e,this._initPromise.then(this.repaint.bind(this))),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(e){return this._gmx.styleManager.getIcons(e),this},setStyles:function(e){return this._initPromise.then(function(){this._gmx.styleManager.clearStyles(),e?e.forEach(function(e,t){this.setStyle(e,t,!0)}.bind(this)):this.fire("stylechange")}.bind(this)),this},getStyle:function(e){return this.getStyles()[e]},setStyle:function(e,t,i){return this._initPromise.then(function(){this._gmx.styleManager.setStyle(e,t,i).then(function(){this.fire("stylechange",{num:t||0})}.bind(this))}.bind(this)),this},setStyleHook:function(e){return this._gmx.styleHook=e,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(e){return this._gmx.rasterProcessingHook=e,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(e){var t=this._gmx;return t.dataManager.addFilter("userFilter",function(i){return t.layerID!==this._gmx.layerID||!e||e(i)?i.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},addLayerFilter:function(e,t){var i=this._gmx;return t=t||{},t.layerID=i.layerID,i.dataManager.addLayerFilter(function(t){return!e||e(t)?t.properties:null}.bind(this),t),this},removeLayerFilter:function(e){return e=e||{},e.layerID=this._gmx.layerID,this._gmx.dataManager.removeLayerFilter(e),this},setDateInterval:function(e,i){var r=this._gmx;if(r.dateBegin&&r.dateEnd&&(e=r.dateBegin,i=r.dateEnd),!r.beginDate!=!e||!r.endDate!=!i||e&&r.beginDate.valueOf()!==e.valueOf()||i&&r.endDate.valueOf()!==i.valueOf()){if(r.rawProperties.maxShownPeriod&&e){var n=24*r.rawProperties.maxShownPeriod*3600*1e3;e=new Date(Math.max(e.valueOf(),i.valueOf()-n))}r.beginDate=e,r.endDate=i;var o=null,s=r.dataManager;for(var a in this._tiles)this._tiles[a].loaded=0,o=this._tiles[a].observer,o&&o.setDateInterval(e,i);o=s.getObserver("_Labels"),o&&o.setDateInterval(e,i),("NotVisible"===r.skipTiles||r.needBbox||r.properties.UseTiles===!1)&&(r.needBbox||(r.properties.LayerVersion=-1,s.setOptions({LayerVersion:-1})),this._map&&t.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(e){return this._gmx.dataManager.addObserver(e)},removeObserver:function(e){return this._gmx.dataManager.removeObserver(e.id)},setPositionOffset:function(e,t){var i=this._gmx;return i.shiftXlayer=e,i.shiftYlayer=t,this._update(),this},getPositionOffset:function(){var e=this._gmx;return{shiftX:e.shiftXlayer,shiftY:e.shiftYlayer}},setZIndexOffset:function(e){return arguments.length&&(this.options.zIndexOffset=e),this._updateZIndex(),this},_clearLoaded:function(e){this._tiles[e]&&(this._tiles[e].loaded=0)},repaint:function(e){if(this._map){if(e){if(t.Util.isArray(e)){var i=e;e={},i.forEach(function(t){e[t]=!0,this._clearLoaded(t)}.bind(this))}else if("string"==typeof e){var r=e;this._clearLoaded(r),e={},e[r]=!0}}else{e={};for(var n in this._tiles)e[n]=!0,this._clearLoaded(n);t.extend(e,this.repaintObservers)}this._gmx.dataManager._triggerObservers(e)}},redrawItem:function(e){if(this._map){var t=this._gmx.dataManager.getItem(e),i=this._getTilesByBounds(t.bounds);this.repaint(i)}},appendTileToContainer:function(e){if(this._tileZoom===e.coords.z){var i=this._getTilePos(e.coords),r=e.el,n=this._levels[e.coords.z],o=n?n.el:this._tileContainer;o.appendChild(r),t.DomUtil.setPosition(r,i,t.Browser.chrome||t.Browser.android23)}},addData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.addData(e,t),this.repaint()),this},removeData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.removeData(e,t),this.repaint()),this},getStylesByProperties:function(e,t){return this._gmx.styleManager.getCurrentFilters(e,t)},getItemStyle:function(e){var t=this._gmx,i=t.dataManager.getItem(e);return t.styleManager.getObjStyle(i)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(e){var i=this._gmx,r=i.dataManager.getItem(e),n=this.getStyles(),o="";if(r&&n[r.currentFilter]){var s=r.properties;o=t.gmxUtil.parseBalloonTemplate(n[r.currentFilter].Balloon,{properties:this.getItemProperties(s),geometries:[s[s.length-1]],tileAttributeTypes:i.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return o},getItemProperties:function(e){var t={},i=this._gmx.tileAttributeIndexes;for(var r in i)t[r]=e[i[r]];return t},addPreRenderHook:function(e){this._gmx.preRenderHooks.push(e),this.repaint()},removePreRenderHook:function(e){for(var t=this._gmx.preRenderHooks,i=0,r=t.length;i<r;i++)if(t[i]===e){t.splice(i,1),this.repaint();break}},addRenderHook:function(e){this._gmx.renderHooks.push(e),this.repaint()},removeRenderHook:function(e){for(var t=this._gmx.renderHooks,i=0,r=t.length;i<r;i++)if(t[i]===e){t.splice(i,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var e=this._gmx.layerID?r.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return e?e.toLatLngBounds(3857==this._gmx.srs):new t.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=t.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0,3857==this._gmx.srs)),this._gmx.latLngGeometry},getPropItem:function(e,t){return r.getPropItem(e,t,this._gmx.tileAttributeIndexes)},_getTilesByBounds:function(e){var t=this._gmx,i=this._tileZoom||this._map._zoom,r=t.shiftX||0,n=t.shiftY||0,o=e.toLatLngBounds(3857==t.srs),s=o.getSouthWest(),a=o.getNorthEast(),l=this._map.getBounds(),u=l.getSouthWest(),h=l.getNorthEast(),c=0;h.lng-u.lng<360&&(a.lng<u.lng?c=360*(1+Math.floor((u.lng-a.lng)/360)):s.lng>h.lng&&(c=360*Math.floor((h.lng-s.lng)/360))),s.lng+=c,a.lng+=c;var d,p,f,m,g=this._map.getPixelBounds(),v=this._map.project(s),y=this._map.project(a);g?(d=Math.floor((Math.max(y.y,g.min.y)+n)/256),p=Math.floor((Math.min(v.y,g.max.y)+n)/256),f=s.lng<=-180?g.min.x:Math.max(v.x,g.min.x),f=Math.floor((f+r)/256),m=a.lng>=180?g.max.x:Math.min(y.x,g.max.x),m=Math.floor((m+r)/256)):(d=Math.floor((y.y+n)/256),p=Math.floor((v.y+n)/256),f=Math.floor((v.x+r)/256),m=Math.floor((y.x+r)/256));for(var x={},_=f;_<=m;_++)for(var b=d;b<=p;b++){var P=this._tileCoordsToKey({x:_,y:b,z:i});x[P]=!0}return x},_updateProperties:function(e){var i=this._gmx;i.sessionKey=e.sessionKey=this.options.sessionKey||"",this.options.parentOptions&&(e=this.options.parentOptions),i.identityField=e.identityField,i.GeometryType=(e.GeometryType||"").toLowerCase(),i.minZoomRasters=e.RCMinZoomForRasters||1,i.minZoomQuicklooks=i.minZoomRasters;var r=e.type||"Vector";if(e.Temporal&&(r+="Temporal"),i.layerType=r,i.items={},t.extend(i,t.gmxUtil.getTileAttributes(e)),i.dataManager&&i.dataManager.setOptions(e),"ZIndexField"in e&&e.ZIndexField in i.tileAttributeIndexes&&(i.zIndexField=i.tileAttributeIndexes[e.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),i.filter=e.filter,i.dateBegin=e.dateBegin,i.dateEnd=e.dateEnd,i.dataSource=e.dataSource,"MetaProperties"in i.rawProperties){var n=i.rawProperties.MetaProperties;"srs"in n&&(i.srs=n.srs.Value||""),"parentLayer"in n&&(i.dataSource=n.parentLayer.Value||""),"filter"in n&&(i.filter=n.filter.Value||""),"dateBegin"in n&&(i.dateBegin=t.gmxUtil.getDateFromStr(n.dateBegin.Value||"01.01.1980")),"dateEnd"in n&&(i.dateEnd=t.gmxUtil.getDateFromStr(n.dateEnd.Value||"01.01.1980")),("shiftX"in n||"shiftY"in n)&&(i.shiftXlayer=n.shiftX?Number(n.shiftX.Value):0,i.shiftYlayer=n.shiftY?Number(n.shiftY.Value):0),("shiftXfield"in n||"shiftYfield"in n)&&(n.shiftXfield&&(i.shiftXfield=n.shiftXfield.Value),n.shiftYfield&&(i.shiftYfield=n.shiftYfield.Value)),"quicklookPlatform"in n&&(i.quicklookPlatform=n.quicklookPlatform.Value,"image"===i.quicklookPlatform&&delete i.quicklookPlatform),"quicklookX1"in n&&(i.quicklookX1=n.quicklookX1.Value),"quicklookY1"in n&&(i.quicklookY1=n.quicklookY1.Value),"quicklookX2"in n&&(i.quicklookX2=n.quicklookX2.Value),"quicklookY2"in n&&(i.quicklookY2=n.quicklookY2.Value),"quicklookX3"in n&&(i.quicklookX3=n.quicklookX3.Value),"quicklookY3"in n&&(i.quicklookY3=n.quicklookY3.Value),"quicklookX4"in n&&(i.quicklookX4=n.quicklookX4.Value),"quicklookY4"in n&&(i.quicklookY4=n.quicklookY4.Value),"multiFilters"in n&&(i.multiFilters="1"===n.multiFilters.Value),"isGeneralized"in n&&(this.options.isGeneralized="false"!==n.isGeneralized.Value),"isFlatten"in n&&(this.options.isFlatten="false"!==n.isFlatten.Value)}if(e.Temporal&&(this.options.isGeneralized=!1),e.IsRasterCatalog){i.IsRasterCatalog=e.IsRasterCatalog;var o=i.tileAttributeIndexes.GMX_RasterCatalogID;o&&(i.rasterBGfunc=function(e,r,n,s,a){var l=s.properties,u=t.gmxUtil.protocol+"//"+i.hostName+"/TileSender.ashx?ModeKey=tile&ftc=osm&x="+e+"&y="+r+"&z="+n;return(a||i.srs)&&(u+="&srs="+(a||i.srs)),i.crossOrigin&&(u+="&cross="+i.crossOrigin),u+="&LayerName="+l[o],i.sessionKey&&(u+="&key="+encodeURIComponent(i.sessionKey)),t.gmx._sw&&s.v&&(u+="&sw="+t.gmx._sw+"&v="+s.v),u})}if(e.Quicklook){var s;s="{"===e.Quicklook[0]?JSON.parse(e.Quicklook):{minZoom:i.minZoomRasters,template:e.Quicklook},"X1"in s&&(i.quicklookX1=s.X1),"Y1"in s&&(i.quicklookY1=s.Y1),"X2"in s&&(i.quicklookX2=s.X2),"Y2"in s&&(i.quicklookY2=s.Y2),"X3"in s&&(i.quicklookX3=s.X3),"Y3"in s&&(i.quicklookY3=s.Y3),"X4"in s&&(i.quicklookX4=s.X4),"Y4"in s&&(i.quicklookY4=s.Y4);var a=i.Quicklook=s.template;"minZoom"in s&&(i.minZoomQuicklooks=s.minZoom),i.quicklookBGfunc=function(e){for(var t=a,r=/\[([^\]]+)\]/,n=r.exec(t);n&&n.length>1;)t=t.replace(n[0],e.properties[i.tileAttributeIndexes[n[1]]]),n=r.exec(t);return i.srs&&(t+=(t.indexOf("?")===-1?"?":"&")+"srs="+i.srs),t},i.imageQuicklookProcessingHook=t.gmx.gmxImageTransform}this.options.attribution=e.Copyright||""},_updateShiftY:function(e){var t=this._gmx;t.currentZoom=e,t.tileSize=r.tileSizes[e],t.mInPixel=256/t.tileSize},__drawTile:function(e){var t=e.coords,i=this._tileCoordsToKey(t),r=this._tiles[i];if(r){var n=this,o=this._tileZoom,s=this._gmx;r&&!r.promise?(r.loaded=0,r.key=i,r.promise=new Promise(function(e,a){r.resolve=e,r.reject=a;var l=s.dataManager.getViewFilters("screen",s.layerID),u=function(){n._tileReady(t,null,r.el)};r.observer=s.dataManager.addObserver({type:"resend",layerID:s.layerID,needBbox:s.needBbox,topLeft:r.screenTile.topLeft,srs:s.srs,target:"screen",targetZoom:n.options.isGeneralized?o:null,dateInterval:"VectorTemporal"===s.layerType?[s.beginDate,s.endDate]:null,active:!0,bbox:s.styleManager.getStyleBounds(t),filters:["clipFilter","userFilter_"+s.layerID,"styleFilter","userFilter"].concat(l),callback:function(e){n._tiles[i]?(n._tiles[i].loaded=0,r.screenTile.drawTile(e).then(function(e){e&&(r.count=e.count),u(e)},function(e){u(e)})):u()}},i).on("activate",function(){this.isActive()||u()})})["catch"](function(e){console.warn("catch:",e)})):r.resolve()}}}),t.Map.addInitHook(function(){t.Mixin.ContextMenu&&t.gmx.VectorLayer.include(t.Mixin.ContextMenu),this.options.ftc=this.options.ftc||"osm",this.options.srs=this.options.srs||3857,this.options.skipTiles=this.options.skipTiles||"All"}),e.prototype={_getUrlFunction:function(e,t){return this.gmx.rasterBGfunc(e.x,e.y,e.z,t)},_loadTileRecursive:function(e,i){var r=this.gmx,n={z:e.z,x:this.ntp.x,y:this.ntp.y},o=this;return this.rasterRequests={},new Promise(function(e){var s=function(n,a){var l=o._getUrlFunction(n,i);if(r.rastersCache&&r.rastersCache[l])e({gtp:n,image:r.rastersCache[l]});else{var u=function(t){t&&(r.badTiles[t]=!0),n.z>1?s({x:Math.floor(n.x/2),y:Math.floor(n.y/2),z:n.z-1},""):e({gtp:n})};if(r.badTiles[l]||r.maxNativeZoom&&r.maxNativeZoom<n.z)return void u();var h=o.rasterRequests[l];h?h.options.tileRastersId=o._uniqueID:(r.rasterProcessingHook&&(a="anonymous"),h=t.gmx.imageLoader.push(l,{tileRastersId:o._uniqueID,zoom:o.zoom,cache:!0,crossOrigin:r.crossOrigin||a||""}),o.rasterRequests[l]=h),h.promise.then(function(t){t?(r.rastersCache&&(r.rastersCache[l]=t),e({gtp:n,image:t})):u(l)},function(){u(l)})}};s(n)})},_rasterHook:function(e){var t=e.sourceTilePoint||e.destinationTilePoint,i={geoItem:e.geoItem,destination:{z:e.destinationTilePoint.z,x:e.destinationTilePoint.x,y:e.destinationTilePoint.y},source:{z:t.z,x:t.x,y:t.y}};return e.url&&(i.quicklook=e.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(e.res,e.image,e.sx||0,e.sy||0,e.sw||256,e.sh||256,e.dx||0,e.dy||0,e.dw||256,e.dh||256,i)},_defaultRasterHook:function(e,t,i,r,n,o,s,a,l,u){if(t){var h=e.getContext("2d");h.drawImage(t,i,r,n,o,s,a,l,u)}},_getShiftPixels:function(e){var t=e.dx+(e.dx<0?256:0),i=e.dy+(e.dy<0?256:0),r=0,n=256-t,o=t,s=n;if(e.tx>e.x&&(r=n,n=t,o=0,s=n),256===r||n<1)return null;var a=i,l=256-i,u=0,h=l;return e.ty>e.y&&(a=0,u=l,l=i,h=l),256===a||l<1?null:{sx:r,sy:a,sw:n,sh:l,dx:o,dy:u,dw:s,dh:h}},_getShiftTilesArray:function(e,t,i){var r=this.topLeft.mInPixel,n=this.gmxTilePoint,o=t*r,s=i*r,a=Math.floor(.5+o%256),l=Math.floor(.5+s%256),u=256/r,h=n.x-t/u,c=n.y-i/u,d=Math.floor(h),p=d+(h===d?0:1),f=Math.floor(c),m=f+(c===f?0:1),g=Math.floor((e.min.x-t)/u),v=Math.floor((e.max.x-t)/u),y=Math.floor((e.min.y-i)/u),x=Math.floor((e.max.y-i)/u);d<g&&(d=g),p>v&&(p=v),f<y&&(f=y),m>x&&(m=x);for(var _=[],b=f;b<=m;b++)for(var P=d;P<=p;P++)_.push({z:n.z,x:P,y:b,dx:a,dy:l,tx:h,ty:c});return _},_chkRastersByItemIntersect:function(e,t){var i=t.properties[t.properties.length-1],n=[];return e.forEach(function(e){var t=r.getBoundsByTilePoint(e);r.isItemIntersectBounds(i,t)&&n.push(e)}),n},getTilePosZoomDelta:function(e,t,i){var r=Math.pow(2,t-i),n=256/r,o=e.x%r,s=e.y%r;return{size:n,zDelta:r,x:n*o,y:n*s}},_getItemRasters:function(e){var i=e.properties,n=i[0],o=this,s=this.gmx,a=s.tileAttributeIndexes,l=this.rasters,u=Number(s.shiftXfield?r.getPropItem(s.shiftXfield,i,a):0)%this.worldWidthMerc,h=Number(s.shiftYfield?r.getPropItem(s.shiftYfield,i,a):0),c=u||h,d=r.getPropItem("urlBG",i,a),p="",f=null,m=!1,g=s.dataManager.getItem(n),v=this.gmxTilePoint,y=this.tilePoint,x=this.ntp,_=null;g.v=e.v;var b=new Promise(function(b){s.IsRasterCatalog&&("Raster"===s.rawProperties.type||r.getPropItem("GMX_RasterCatalogID",i,a))?m=!0:s.quicklookBGfunc?(p=s.quicklookBGfunc(g),f=s.imageQuicklookProcessingHook):d&&(p=d,f=s.imageQuicklookProcessingHook),new Promise(function(i){if(m){var r=e.dataOption||{},a=this._chkRastersByItemIntersect(c?this._getShiftTilesArray(r.bounds,u,h):[x],e),d=a.length,v=function(){d<1&&i()},b=function(){d--,v()},P=function(i,r,a){g.skipRasters=!1;var u=!0;f&&(a=f(a,{gmx:s,geoItem:e,item:g,gmxTilePoint:i}),u=!1);var h={geoItem:e,image:a,destinationTilePoint:y,sourceTilePoint:i,sx:0,sy:0,sw:256,sh:256,dx:0,dy:0,dw:256,dh:256};if(c){var p=o._getShiftPixels(r);if(null===p)return void b();t.extend(h,p),u=!1}if(i.z!==x.z){var m=o.getTilePosZoomDelta(x,x.z,i.z);if(m.size<1/256)return void v();if(u=!1,h.sx=Math.floor(m.x),h.sy=Math.floor(m.y),h.sw=h.sh=m.size,c){var P=Math.floor(h.dw/m.zDelta);h.sx=(0===h.dx?h.sw:256)-P,h.sw=P;var S=Math.floor(h.dh/m.zDelta);h.sy=(0===h.dy?h.sh:256)-S,h.sh=S}}if(u&&!s.rasterProcessingHook)d--,_=a,l[n]=_,v();else{_||(_=document.createElement("canvas"),_.width=_.height=256),h.res=_;var T=o._rasterHook(h),L=function(){d--,l[n]=_,v()};T?T.then&&T.then(L):null===T?(g.skipRasters=!0,b()):L()}};d?a.map(function(e){var t=o._loadTileRecursive(e,g);return t.then(function(t){P(t.gtp,e,t.image)},b),t}):(g.skipRasters=!0,b())}else{if(p)if(s.sessionKey&&(p+=(p.indexOf("?")===-1?"?":"&")+"key="+encodeURIComponent(s.sessionKey)),s.quicklooksCache&&s.quicklooksCache[p])i(s.quicklooksCache[p]);else{var S=this.rasterRequests[p];S?S.options.tileRastersId=this._uniqueID:(S=t.gmx.imageLoader.push(p,{tileRastersId:o._uniqueID,crossOrigin:s.crossOrigin||"anonymous"}),this.rasterRequests[p]=S),S.promise.then(i,i)}else i();g.skipRasters=!1}}.bind(this)).then(function(t){if(m)b();else{if(t){s.quicklooksCache&&(s.quicklooksCache[p]=t);var i={gmx:s,topLeft:o.topLeft,geoItem:e,item:g,gmxTilePoint:v};_||(_=document.createElement("canvas"),_.width=_.height=256);var r=function(t){var r=o._rasterHook({topLeft:o.topLeft,geoItem:e,res:_,image:f?f(t,i):t,destinationTilePoint:v,url:p}),s=function(){l[n]=_,b()};r?r.then&&r.then(s):null===r?(g.skipRasters=!0,b()):s()};r(t)}else g.skipRasters=!0,b();delete o.rasterRequests[p]}}.bind(this))}.bind(this));return b},_getVisibleItems:function(e){if(e.length<2)return this.itemsView=e,e;r._tileCanvas||(r._tileCanvas=document.createElement("canvas"),r._tileCanvas.width=r._tileCanvas.height=256);var i,n,o=this.gmx,s=o.dataManager,a=r._tileCanvas,l=a.getContext("2d"),u={tbounds:this.tbounds,gmx:o,topLeft:this.topLeft,tpx:this.tpx,tpy:this.tpy,ctx:l};for(l.clearRect(0,0,256,256),l.imageSmoothingEnabled=!1,i=0,n=e.length;i<n;i++){l.fillStyle=r.dec2rgba(i+1,1);var h=e[i];t.gmxUtil.drawGeoItem(h,s.getItem(h.properties[0]),u,{fillStyle:l.fillStyle})}var c={},d=l.getImageData(0,0,256,256).data;for(i=0,n=d.length;i<n;i+=4)if(255===d[i+3]){var p=d[i+2];d[i+1]&&(p+=d[i+1]<<8),d[i]&&(p+=d[i]<<16),p&&(c[p]=!0)}var f=[];for(var m in c){var g=e[Number(m)-1];g&&f.push(g)}return this.itemsView=f,f},_getNeedRasterItems:function(e){for(var t=this.gmx,i=t.tileAttributeIndexes,n=this.tbounds,o=[],s=0,a=e.length;s<a;s++){var l=e[s],u=l.properties,h=u[0],c=l.dataOption||{},d=!1;if(t.quicklookBGfunc&&!r.getPropItem("GMX_RasterCatalogID",u,i)){if(t.minZoomQuicklooks&&this.zoom<t.minZoomQuicklooks)continue;var p=r.getPropItem(t.quicklookPlatform,u,i)||t.quicklookPlatform||"";if(!(p&&"imageMercator"!==p||r.getQuicklookPointsFromProperties(u,t)))continue}t.styleHook&&(l.styleExtend=t.styleHook(t.dataManager.getItem(h),t.lastHover&&h===t.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&n.intersectsWithDelta(c.bounds,-1,-1)&&o.push(l)}return this._getVisibleItems(o)},_getTileRasters:function(e){return new Promise(function(t){Promise.all(this._getNeedRasterItems(e).map(this._getItemRasters.bind(this))).then(t)}.bind(this))},_chkItems:function(e){var t=this.layer;if(!t._map)return null;var i=e&&e.added&&e.added.length?e.added:null;if(!i){var r=t._tiles[this.zKey];return r&&r.el&&r.el.getContext("2d").clearRect(0,0,256,256),null}return this.gmx.sortItems?t.getSortedItems(i):i},destructor:function(){this._preRenderPromise&&this._preRenderPromise.reject(),this._renderPromise&&this._renderPromise.reject(),this._cancelRastersPromise(),this._clearCache()},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.reject&&this.rastersPromise.reject(),this.rastersPromise=null)},_clearCache:function(){for(var e in this.rasterRequests)this.rasterRequests[e].remove();this.rasterRequests={}},drawTile:function(e){return this.destructor(),new Promise(function(i,r){var n=this._chkItems(e),o=function(){i({count:n.length})}.bind(this),s=this;if(this._uniqueID++,n){var a=this.tile,l=a.getContext("2d"),u=this.gmx,h={tbounds:this.tbounds,rasters:this.rasters,gmx:u,topLeft:this.topLeft,tpx:this.tpx,tpy:this.tpy,ctx:l};t.DomUtil.addClass(a,"zKey:"+this.zKey);var c=function(){l.clearRect(0,0,256,256),u.showScreenTiles&&(l.strokeRect(0,0,255,255),l.strokeText(s.zKey,50,50));var e,i={zKey:s.zKey,topLeft:s.topLeft,tpx:s.tpx,tpy:s.tpy,x:s.tilePoint.x,y:s.tilePoint.y,z:s.zoom},c=[];u.preRenderHooks.forEach(function(t){e||(e=document.createElement("canvas"),e.width=e.height=256);var r=t(e,i);r&&r.then&&c.push(r)}),Promise.all(c).then(function(){e&&(h.bgImage=e);for(var l=0,c=n.length;l<c;l++){var d=n[l],p=d.id,f=u.dataManager.getItem(p);if(f){var m=u.styleManager.getObjStyle(f,s.zoom),g=u.lastHover&&u.lastHover.id===d.id&&m;
if(u.multiFilters)for(var v=0,y=f.multiFilters.length;v<y;v++){var x=f.multiFilters[v];t.gmxUtil.drawGeoItem(d,f,h,g?x.parsedStyleHover:x.parsedStyle,x.style)}else t.gmxUtil.drawGeoItem(d,f,h,g?f.parsedStyleHover:f.parsedStyleKeys,m);p in u._needPopups&&!u._needPopups[p]&&(u._needPopups[p]=!0)}}s.rasters={},Promise.all(s._getHooksPromises(u.renderHooks,a,i)).then(o,r)},r),s.layer.appendTileToContainer(s.tileElem)};this.showRaster?(this.rastersPromise=this._getTileRasters(n),this.rastersPromise.then(c,r)):c()}else i()}.bind(this))["catch"](function(e){console.warn("catch1:",e)})},_getHooksPromises:function(e,t,i){var r=[];return e.forEach(function(e){var n=e(t,i);n&&n.then&&r.push(n)}),r}},function(){var e=1e6,i=function(e){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=e,e.on("add",this.onAdd,this),e.on("remove",this.onRemove,this)};i.prototype={addToReorder:function(e,t){++this.count,this.all[e]=t?-this.count:this.count},clickFunc:function(e){if(!this.disabled){var t=e.gmx.id;this.addToReorder(t,e.originalEvent.ctrlKey),this.layer.redrawItem(t)}},sortItems:function(t,i){var r=this._objectsReorder;if(r.count>0){var n=r.all[t.id],o=r.all[i.id];if(n||o)return n=n?n+(n>0?e:-e):0,o=o?o+(o>0?e:-e):0,n-o}return r.sortFunc?r.sortFunc.call(this,t,i):0},resetSortFunc:function(){var e=this.layer,t=e._gmx,i=t.zIndexField;t.sortItems=this.sortItems,this.sortFunc=i&&!this.userSetSortFunc?function(e,t){var r=Number(e.properties[i])-Number(t.properties[i]);return r?r:e.id-t.id}:function(e,t){return e.id-t.id}},initialize:function(){var e=this.layer._gmx;this.userSetSortFunc||"polygon"!==e.GeometryType&&"linestring"!==e.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},t.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new i(this))},getReorderArrays:function(){var e={top:[],bottom:[]};if(this._objectsReorder)for(var t=this._objectsReorder,i=Object.keys(t.all).sort(function(e,i){return t.all[e]-t.all[i]}),r=0,n=i.length;r<n;r++){var o=i[r];t.all[o]>0?e.top.push(o):e.bottom.push(o)}return e},bringToTopItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e),this.redrawItem(e),this},bringToBottomItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e,!0),this.redrawItem(e),this},clearReorderArrays:function(){if(this._objectsReorder){var e=this._objectsReorder;e.all={},e.count=0,this.repaint()}return this},setReorderArrays:function(e,t){this._objectsReorderInit();var i=this._objectsReorder;return i.all={},i.count=0,t&&t.forEach(function(e){i.addToReorder(e,!0)}),e&&e.forEach(function(e){i.addToReorder(e)}),this.repaint(),this},getSortedItems:function(e){return this._objectsReorderInit(),e.sort(t.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))},setSortFunc:function(e){this._objectsReorderInit();var t=this._objectsReorder;return t.sortFunc=e,t.userSetSortFunc=!!e,this._gmx.sortItems=t.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}();var v=function(e){this.gmx=e,this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this)),this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var t=1/0,i=-(1/0),r=e.properties.styles||[],n=0,o=r.length;n<o;n++){var s=r[n];t=Math.min(t,s.MinZoom),i=Math.max(i,s.MaxZoom)}this.minZoom=t===1/0?0:t,this.maxZoom=i===-(1/0)?18:i};v.prototype={_getMaxStyleSize:function(e){for(var t=0,i=0,r=this._styles.length;i<r;i++){var n=this._styles[i];if(!(e>n.MaxZoom||e<n.MinZoom)){var o=n.RenderStyle;if(this._needLoadIcons||!o||!("maxSize"in o)){t=v.MAX_STYLE_SIZE;break}var s=0;"iconAnchor"in o&&!o.iconCenter&&(s=Math.max(Math.abs(o.iconAnchor[0]),Math.abs(o.iconAnchor[1]))),t=Math.max(o.maxSize+s,t)}}return t},getStyleBounds:function(e){if(!e)return r.bounds();this._maxStyleSize=this._getMaxStyleSize(e.z);var t=2*this._maxStyleSize*r.tileSizes[e.z]/256;return r.getBoundsByTilePoint(e).addBuffer(t)},isVisibleAtZoom:function(e){for(var t=0,i=this._styles.length;t<i;t++){var r=this._styles[t];if(e>=r.MinZoom&&e<=r.MaxZoom)return!0}return!1},getIcons:function(e){var t=this;this.promise.then(function(){for(var i=[],r=0,n=t._styles.length;r<n;r++){var o=t._styles[r],s={};o.RenderStyle&&(s.RenderStyle={image:o.RenderStyle.image}),o.HoverStyle&&(s.HoverStyle={image:o.HoverStyle.image}),i.push(s)}e&&e(i)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var e=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(t){return e._chkStyleFilter(t)}),this.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=0,t=this._deferredIcons.length;e<t;e++)this._getImageSize(this._deferredIcons[e]);return this._deferredIcons=[],this._chkReady(),this.promise},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=[],i=0,r=this._styles.length;i<r;i++){var n=t.extend({},this._styles[i]);n.RenderStyle=v.getStyleKeys(n.RenderStyle),n.HoverStyle&&(n.HoverStyle=v.getStyleKeys(n.HoverStyle)),delete n.filterFunction,delete n.version,delete n.common,delete n.type,e.push(n)}return e},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var e=this;this._styles.map(function(t){t.version=++e._maxVersion})},setStyle:function(e,i,r){if(i=i||0,i<this._styles.length||r){var n=this._styles[i];if(n||(n=this._prepareItem({}),this._styles[i]=n),n.version=++this._maxVersion,"Filter"in e){n.Filter=e.Filter;var o=typeof e.Filter;n.filterFunction="string"===o?t.gmx.Parsers.parseSQL(n.Filter.replace(/[\[\]]/g,'"')):"function"===o?n.Filter:null,this._changeStylesVersion()}for(var s=0,a=v.DEFAULT_KEYS.length;s<a;s++){var l=v.DEFAULT_KEYS[s];l in e&&(n[l]=e[l])}e.RenderStyle&&(n.RenderStyle=this._parseStyle(e.RenderStyle)),e.HoverStyle&&(n.HoverStyle=this._parseStyle(e.HoverStyle,n.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(e){var t=this.gmx.dataManager.getItem(e),i=t?t.currentFilter:0,r=this._styles[i];return r?{DisableBalloonOnMouseMove:r.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:r.DisableBalloonOnClick||!1,templateBalloon:r.Balloon||null,isSummary:/\[SUMMARY\]/.test(r.Balloon)}:null},getObjStyle:function(e,t){this._chkStyleFilter(e,t);var i,r=this._styles[e.currentFilter];return r?r.hoverDiff&&this.gmx.lastHover&&e.id===this.gmx.lastHover.id?r.HoverStyle?(i=r.HoverStyle.version||-1,i!==e.styleVersion&&(e.parsedStyleHover=this._itemStyleParser(e,r.HoverStyle)),r.HoverStyle):(delete e.parsedStyleHover,null):(i=r.version||-1,i!==e.styleVersion&&(e.parsedStyleKeys=this._itemStyleParser(e,r.RenderStyle)),r.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(e){var i=e.iconUrl||e.fillIconUrl||"",r={crossOrigin:"anonymous"},n=t.gmxUtil.isIE11&&/\.svg/.test(i),o=this;"file:"!==self.location.protocol&&(i=i.replace(/http(s*):/,"")),n&&(i+=(i.indexOf("?")===-1?"?":"&")+"crossOrigin="+r.crossOrigin),r.layerID=this.gmx.layerID,++this._needLoadIcons,t.gmx.imageLoader.unshift(i,r).def.then(function(t){if(e.version=++o._maxVersion,e.fillIconUrl)e.imagePattern=t;else{e.sx=t.width||t.offsetWidth,e.sy=t.height||t.offsetHeight,e.image=t;var i=e.iconAngle?Math.sqrt(e.sx*e.sx+e.sy*e.sy):Math.max(e.sx,e.sy);e.scaleFunction||e.rotateFunction||((e.iconScale||1===e.iconScale)&&(i*=e.iconScale),e.common=!0),e.maxSize=Number(i.toFixed())}o._needLoadIcons--,o._chkReady()},function(){e.version=++o._maxVersion,e.sx=1,e.sy=0,e.image=null,o._needLoadIcons--,o._chkReady(),console.log({url:i,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(e,t){var i=this.gmx,r=i.tileAttributeIndexes,n=i.tileAttributeTypes,o=t||1,s=[];this._serverStylesParsed||this._parseServerStyles();for(var a=0,l=this._styles.length;a<l;a++){var u=this._styles[a];if(!(o>u.MaxZoom||o<u.MinZoom||u.filterFunction&&!u.filterFunction(e,r,n)||(s.push(a),i.multiFilters)))break}return s},_chkStyleFilter:function(e,t){var i=this.gmx,r=i.multiFilters?-1:e.currentFilter,n=this._styles[r],o=!n||n.version!==e.styleVersion;if(t=t||i.currentZoom,o||e._lastZoom!==t){e.currentFilter=-1,e.multiFilters=[];for(var s=this.getCurrentFilters(e.properties,t),a=0,l=s.length;a<l;a++){var u=s[a],h=this._styles[u];if(e.hoverDiff=h.hoverDiff,e.currentFilter=u,o||r!==u){var c=h.common&&h.common.RenderStyle||this._itemStyleParser(e,h.RenderStyle),d=null;e.parsedStyleKeys=c,h.HoverStyle&&(d=h.common&&h.common.HoverStyle||this._itemStyleParser(e,h.HoverStyle),e.parsedStyleHover=d),i.multiFilters&&e.multiFilters.push({style:h.RenderStyle,styleHover:h.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(e.styleVersion=h.version,!i.multiFilters)break}e._lastZoom=t}return!!this._styles[e.currentFilter]||(e.currentFilter=-1,!1)},_parseServerStyles:function(){for(var e=this.gmx,t=e.properties,i=t.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:v.DEFAULT_STYLE}],r=Math.max(i.length,e.styles.length),n=0;n<r;n++)if(!this._styles[n]){var o=e.styles[n]||i[n];if(o.RenderStyle||(o.RenderStyle=v.DEFAULT_STYLE),void 0===o.HoverStyle){var s=JSON.parse(JSON.stringify(o.RenderStyle));s.outline&&(s.outline.thickness+=1),o.HoverStyle=s}else null===o.HoverStyle&&delete o.HoverStyle;var a=this._prepareItem(o);this._styles.push(a),this._isLabel(a.RenderStyle)&&(e.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_iconsUrlReplace:function(e){var t=e||"";return e&&this.gmx.iconsUrlReplace&&this.gmx.iconsUrlReplace.forEach(function(e){t=t.replace(e.from,e.to)}),t},_checkStyles:function(){for(var e=1/0,t=-(1/0),i=!1,r=!1,n=0,o=this._styles.length;n<o;n++){var s=this._styles[n];s.DisableBalloonOnMouseMove=s.DisableBalloonOnMouseMove!==!1,s.DisableBalloonOnClick=s.DisableBalloonOnClick||!1,s.DisableBalloonOnMouseMove!==!1&&s.DisableBalloonOnClick!==!1||(i=!0,s.BalloonEnable=!0),s.hoverDiff=null,s.common={},s.RenderStyle&&(s.RenderStyle.iconUrl&&(s.RenderStyle.iconUrl=this._iconsUrlReplace(s.RenderStyle.iconUrl)),s.HoverStyle&&s.HoverStyle.iconUrl&&(s.HoverStyle.iconUrl=this._iconsUrlReplace(s.HoverStyle.iconUrl)),r||this._isLabel(s.RenderStyle)&&(r=!0),s.RenderStyle.common&&(s.common.RenderStyle=this._itemStyleParser({},s.RenderStyle)),s.HoverStyle&&(s.hoverDiff=v.checkDiff(s.RenderStyle,s.HoverStyle))),s.HoverStyle&&s.HoverStyle.common&&(s.common.HoverStyle=this._itemStyleParser({},s.HoverStyle)),e=Math.min(e,s.MinZoom),t=Math.max(t,s.MaxZoom)}this.minZoom!==1/0&&(this.minZoom=e),this.maxZoom!==-(1/0)&&(this.maxZoom=t),this.gmx.balloonEnable=i,this.gmx.labelsLayer=r},_parseStyle:function(e,i){if(e){e.common=!0;for(var n in e)if(r.styleFuncKeys[n]){var o=r.styleFuncKeys[n],s=e[n];"string"==typeof s?(e.common=!1,i&&i[n]===s?e[o]=i[o]:(this._parserFunctions[s]||(this._parserFunctions[s]=t.gmx.Parsers.parseExpression(s)),e[o]=this._parserFunctions[s])):"function"==typeof s&&(e.common=!1,e[o]=s)}var a="";if("iconUrl"in e)a="image",e.iconUrl&&(e.maxSize=256,this._deferredIcons.push(e));else if(e.fillIconUrl)a="square",this._deferredIcons.push(e);else if(e.fillPattern)a="square",e.common=v.parsePattern(e.fillPattern),e.canvasPattern=r.getPatternIcon(null,e);else if(e.iconCircle)a="circle","iconSize"in e||(e.iconSize=4);else if(e.iconPath){a="iconPath";var l=0,u=t.Util.isArray(e.iconPath)?e.iconPath:v.DEFAULT_ICONPATH;e.iconPath=v.DEFAULT_ICONPATH.map(function(e,t){var i=u[t]||e;return l=Math.max(l,i),i}),e.iconSize=2*l}else if(e.fillRadialGradient){a="circle","iconCenter"in e||(e.iconCenter=!0);var h=v.parseRadialGradient(e.fillRadialGradient);null===h?e.common=!1:e.iconSize=h}else e.fillLinearGradient?(a="square",e.common=v.parseLinearGradient(e.fillLinearGradient)):e.iconSize&&(a="square","iconCenter"in e||(e.iconCenter=!0));e.type=a,e.common&&!e.maxSize&&(e.maxSize=e.iconSize||0,e.maxSize+=e.weight?e.weight:0,"iconScale"in e&&(e.maxSize*=e.iconScale))}return e},_prepareItem:function(e){var i={MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18,Filter:e.Filter||null,Balloon:e.Balloon||"",RenderStyle:e.RenderStyle?this._parseStyle(t.gmxUtil.fromServerStyle(e.RenderStyle)):{},version:++this._maxVersion};if(i.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove!==!1,i.DisableBalloonOnClick=e.DisableBalloonOnClick||!1,e.HoverStyle&&(i.HoverStyle=this._parseStyle(t.gmxUtil.fromServerStyle(e.HoverStyle),i.RenderStyle)),"Filter"in e){var r=t.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));r&&(i.filterFunction=r)}return i},_isLabel:function(e){var t=this.gmx.tileAttributeIndexes;return e&&(e.labelTemplate||e.labelField&&e.labelField in t)},_itemStyleParser:function(e,t){t=t||{};var i,n,o,s={},a=this.gmx.tileAttributeIndexes,l=e.properties||{},u=e.type,h=t.type,c="color"in t?t.color:255,d="opacity"in t?t.opacity:1;if(s.sx=t.sx,s.sy=t.sy,t.maxSize&&(s.maxSize=t.maxSize),t.iconAngle){var p=t.iconAngle||0;p&&"string"==typeof p&&(p=t.rotateFunction?t.rotateFunction(l,a):0),s.rotate=p||0}if("iconColor"in t&&(s.iconColor="iconColorFunction"in t?t.iconColorFunction(l,a):t.iconColor),"iconScale"in t&&(s.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,a):1:t.iconScale),"image"===h)s.type=h,t.iconUrl&&(s.iconUrl=t.iconUrl),t.image&&(s.image=t.image);else if(t.fillRadialGradient){var f=t.fillRadialGradient,m=f.r1Function?f.r1Function(l,a):f.r1,g=f.r2Function?f.r2Function(l,a):f.r2,v=f.x1Function?f.x1Function(l,a):f.x1,y=f.y1Function?f.y1Function(l,a):f.y1,x=f.x2Function?f.x2Function(l,a):f.x2,_=f.y2Function?f.y2Function(l,a):f.y2;f.r2max&&(g=Math.min(g,f.r2max));var b=[];for(o=f.addColorStop.length,f.addColorStopFunctions||(f.addColorStopFunctions=new Array(o)),n=0;n<o;n++){i=f.addColorStop[n];var P=f.addColorStopFunctions[n]||[],S=P[0]?P[0](l,a):i[0],T=i[3];if(i.length<4){var L=i.length<3?1:P[2]?P[2](l,a):i[2];T=r.dec2color(P[1]?P[1](l,a):i[1],L)}b.push([S,T])}s.maxSize=s.sx=s.sy=s.iconSize=g,s.fillRadialGradient={x1:v,y1:y,r1:m,x2:x,y2:_,r2:g,addColorStop:b},s._radialGradientParsed={create:[v,y,m,x,_,g],colorStop:b}}else if(t.fillLinearGradient)s.fillLinearGradient=t.fillLinearGradient;else{if(t.fillPattern&&(s.canvasPattern=t.canvasPattern?t.canvasPattern:r.getPatternIcon(e,t,a)),"iconPath"===h&&(s.type=h,s.iconPath=t.iconPath),"POLYGON"!==u&&"MULTIPOLYGON"!==u&&"polygon"!==this.gmx.GeometryType||(h="polygon"),t.iconSize){var I="sizeFunction"in t?t.sizeFunction(l,a):t.iconSize;s.sx=s.sy=I,s.iconSize=I,"iconScale"in t&&(s.iconSize*=t.iconScale),s.maxSize=I}s.stroke=!0,("colorFunction"in t||"opacityFunction"in t)&&(c="colorFunction"in t?t.colorFunction(l,a):c,d="opacityFunction"in t?t.opacityFunction(l,a):d),s.strokeStyle=r.dec2color(c,d),s.lineWidth="weight"in t?t.weight:1}if("iconScale"in t&&(s.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,a):1:t.iconScale),"iconAnchor"in t&&(s.iconAnchor=t.iconAnchor),"iconCenter"in t&&(s.iconCenter=t.iconCenter),"square"===h||"polygon"===h||"circle"===h||"iconPath"===h){s.type=h;var M=t.fillOpacity,k=t.fillColor,C="string"==typeof k?parseInt(k.replace(/#/,""),16):k;"fillColor"in t&&(s.fillStyle=r.dec2color(C,1)),"fillColorFunction"in t||"fillOpacityFunction"in t?(c="fillColorFunction"in t?t.fillColorFunction(l,a):k||255,d="fillOpacityFunction"in t?t.fillOpacityFunction(l,a):M||1,s.fillStyle=r.dec2color(c,d)):"fillOpacity"in t&&"fillColor"in t&&(s.fillStyle=r.dec2color(C,M))}if("dashArray"in t&&(s.dashArray=t.dashArray),"dashOffset"in t&&(s.dashOffset=t.dashOffset),this.gmx.labelsLayer){for(i=r.styleKeys.label.client,n=0,o=i.length;n<o;n++){var O=i[n];if(O in t){if("labelField"===O){if(!a[t[O]])continue}else if("labelTemplate"===O){var w=r.getPropertiesHash(l,a);s.labelText=r.parseTemplate(t[O],w)}s[O]=t[O]}}"labelAnchor"in t&&(s.labelAnchor=t.labelAnchor)}return s}},v.MAX_STYLE_SIZE=256,v.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8}},v.DEFAULT_KEYS=["MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick"],v.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],v.parsePattern=function(e){var i=!0,r=t.gmx.Parsers;if("step"in e&&"string"==typeof e.step&&(e.patternStepFunction=r.parseExpression(e.step),i=!1),"width"in e&&"string"==typeof e.width&&(e.patternWidthFunction=r.parseExpression(e.width),i=!1),"colors"in e){for(var n=[],o=0,s=e.colors.length;o<s;o++){var a=e.colors[o];"string"==typeof a?(n.push(r.parseExpression(a)),i=!1):n.push(null)}e.patternColorsFunction=n}return i},v.getStyleKeys=function(e){var t={};for(var i in r.styleKeys)for(var n=r.styleKeys[i],o=0,s=n.client.length;o<s;o++){var a=n.client[o];a in e&&(void 0!==e[a]&&(t[a]=JSON.parse(JSON.stringify(e[a]))),"fillPattern"===a?delete t[a].patternColorsFunction:"fillLinearGradient"===a&&delete t[a].addColorStopFunctions)}return"iconAnchor"in e&&(t.iconAnchor=e.iconAnchor),"labelAnchor"in e&&(t.labelAnchor=e.labelAnchor),t},v.checkDiff=function(e,t){for(var i in e)if(e[i]!==t[i])return i;return null},v.parseRadialGradient=function(e){var i=!0,n=t.gmx.Parsers,o=0,s=["r1","x1","y1","r2","x2","y2"],a=s.length;for(o=0;o<a;o++){var l=s[o];e[l]||(e[l]=0),"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),i=!1)}for(e.addColorStop=e.addColorStop||[[0,16711680,.5],[1,16777215,.5]],e.addColorStopFunctions=[],o=0,a=e.addColorStop.length;o<a;o++){s=e.addColorStop[o];var u=["string"==typeof s[0]?n.parseExpression(s[0]):null,"string"==typeof s[1]?n.parseExpression(s[1]):null,"string"==typeof s[2]?n.parseExpression(s[2]):null];e.addColorStopFunctions.push(u),null===u[1]&&null===u[2]?s[3]=r.dec2color(s[1],s[2]>1?s[2]/100:s[2]):i=!1}return"r2Function"in e&&(i=!1),i?Math.max(e.r1,e.r2):null},v.parseLinearGradient=function(e){var i=!0,r=0,n=t.gmx.Parsers,o=["x1","y1","x2","y2"],s=[0,0,0,256],a=o.length;for(r=0;r<a;r++){var l=o[r];l in e?"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),i=!1):e[l]=s[r]}for(e.addColorStop=e.addColorStop||[[0,16711680],[1,16777215]],e.addColorStopFunctions=[],r=0,a=e.addColorStop.length;r<a;r++)o=e.addColorStop[r],e.addColorStopFunctions.push(["string"==typeof o[0]?n.parseExpression(o[0]):null,"string"==typeof o[1]?n.parseExpression(o[1]):null,"string"==typeof o[2]?n.parseExpression(o[2]):null]);return i},t.gmx.VectorLayer.include({bindPopup:function(e,i){var r=t.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},i);return this._popup&&this.unbindPopup(),e instanceof t.Popup?this._popup=e:(this._popup&&!i||(this._popup=new t.Popup(r)),this._popup.setContent(e)),this._popup._initContent=e,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),r&&r.popupopen&&(this._popupopen=r.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var e in this._gmx._needPopups)this._gmx._needPopups[e]&&(this.addPopup(e),delete this._gmx._needPopups[e])},disablePopup:function(){return this._popupDisabled=!0,this},enablePopup:function(){return this._popupDisabled=!1,this},openPopup:function(e,t){return this._popup&&(e=e||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],t=t||{},t.latlng=e,this._openPopup(t)),this},closePopup:function(e){return this._popup&&(this._popup._close(),"mouseout"!==e&&this.getPopups().forEach(this._clearPopup.bind(this)),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(e){if("mouseover"===this._popup._state){var t=this._popup.options._gmxID||-1;t!==e.gmx.id&&this._setPopupContent(e),this._popup.setLatLng(e.latlng)}},_overPopup:function(e){var t=this._popup;t._map?this.fire("popupopen",{popup:t,gmx:this._setPopupContent(e,t)}):this._openPopup(e),"mouseover"===t._state&&t.setLatLng(e.latlng)},_outPopup:function(e){"mouseover"!==this._popup._state||e.gmx.prevId||this.closePopup(e.type)},_callBalloonHook:function(e,t){var i,r,n,o=t.getElementsByTagName("span"),s={};for(i in this._balloonHook){var a=this._balloonHook[i].hookID;for(s[i]=0,r=0,n=o.length;r<n;r++)o[r].id===a&&s[i]++}for(i in this._balloonHook){var l=this._balloonHook[i],u=l.hookID,h=!0;for(r=0,n=o.length;r<n;r++){var c=o[r];c.id===u&&(h=!1,c.id+="_"+r,l.callback(e,t,c,s))}h&&l.callback(e,t,null,s)}},_setPopupContent:function(e,i){i||(i=this._popup);var n=e.gmx||{},o=n.balloonData||{},s=t.extend({},n.properties),a=n.target||{},l=a.geometry||{},u=a.offset,h=i._initContent||o.templateBalloon||"",c=e.type,d=this.options.isGeneralized&&("mouseover"===c||"mousemove"===c),p={id:n.id,type:c,nodePoint:n.nodePoint,latlng:e.latlng,properties:s,templateBalloon:h};if("POINT"===l.type){var f=t.gmxUtil.geometryToGeoJSON(l,!0,3857==n.srs);p.latlng=t.latLng(f.coordinates.reverse())}if(u){var m=t.Popup.prototype.options.offset;i.options.offset=[-m[0]-u[0],m[1]-u[1]]}else i.options.offset[1]="mouseover"===c?-7:7;if(this._popupopen)this._popupopen({popup:i,latlng:p.latlng,layerPoint:e.layerPoint,contentNode:i._contentNode,containerPoint:e.containerPoint,originalEvent:e.originalEvent,gmx:p});else if(!(h instanceof t.Popup)){if(!(h instanceof HTMLElement)){var g,v="",y=this._map?this._map.options:{};if(d||(g=a.geometry?[a.geometry]:n.geometries||this._gmx.dataManager.getItemGeometries(n.id)||[],p.summary=v=t.gmxUtil.getGeometriesSummary(g,y)),this._balloonHook){h||(h=r.getDefaultBalloonTemplate(s));for(var x in this._balloonHook)s[x]=r.parseTemplate(this._balloonHook[x].resStr,s)}h=t.gmxUtil.parseBalloonTemplate(h,{properties:s,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:y,summary:v,geometries:g})}var _=t.DomUtil.create("div","");_.innerHTML=h,i.setContent(_),this._balloonHook&&this._callBalloonHook(n.properties,i.getContent())}return i.options._gmxID=n.id,p},_openClickPopup:function(e){var i=e.originalEvent||{},n=!e.gmx||this._popupDisabled||i.ctrlKey||i.altKey||i.shiftKey;if(!n){var o=e.type,s=e.gmx,a=s.balloonData,l="click"===o&&a.isSummary&&!a.DisableBalloonOnClick,u=s.target;if(l&&u.options.isGeneralized&&!u.geometry){var h=s.layer.getGmxProperties();r.getLayerItemFromServer({options:e,layerID:h.name,value:u.id,field:h.identityField}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result){var i=e.Result.values[0];t.options.gmx.target.fromServerProps=i,t.options.gmx.target.geometry=i[i.length-1],this._openPopup(t.options)}}.bind(this))}else u.type.indexOf("POINT")!==-1&&(e.latlng=t.latLng(t.gmxUtil.geometryToGeoJSON(u.properties[u.properties.length-1],!0,3857==this._gmx.srs).coordinates.reverse())),this._openPopup(e)}},_openPopup:function(e,i){var r=this._map,n=e.originalEvent||{},o=i?!i:this._popupDisabled||n.ctrlKey||n.altKey||n.shiftKey;if(!o){var s=e.type,a=this._popup,l=e.gmx||{},u=l.balloonData||{};if("click"===s){if(!i&&u.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in r||(r._gmxPopups=[]),"maxPopupCount"in r.options||(r.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,r.on({layerremove:function(e){if(e.layer instanceof t.Popup)this._clearPopup(e.layer);else if(e.layer===this){if(r._gmxPopups){var i=this._gmx.layerID;r._gmxPopups=r._gmxPopups.reduce(function(e,t){return t._map&&(t.options.layerId===i?t._map.removeLayer(t):e.push(t)),e},[])}this.closePopup()}}},this)),this._clearPopup(l.id);var h=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};a=new t.Popup(t.extend({},h,{closeOnClick:1===r.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==s)return;if(u.DisableBalloonOnMouseMove)return void(a._state="");a.options.autoPan=!1}a.options.objectId=l.id,a._state=s;var c=this._setPopupContent(e,a);if(a.setLatLng(c.latlng),this.fire("popupopen",{popup:a,gmx:c}),"click"===s&&(r._gmxPopups.length>=r.options.maxPopupCount&&r.removeLayer(r._gmxPopups.shift()),r._gmxPopups.push(a)),a.addTo(r),a._closeButton){var d=a._closeButton.style;"mouseover"===s&&"hidden"!==d?(d.visibility="hidden",a._container.style.marginBottom="7px",a._container.style.pointerEvents="none"):"click"===s&&"inherit"!==d&&(d.visibility="inherit",a._container.style.marginBottom="",a._container.style.pointerEvents="")}}},_clearPopup:function(e){var i=this._map;if(i&&i._gmxPopups){var r=this._gmx.layerID,n=e instanceof t.Popup;i._gmxPopups=i._gmxPopups.reduce(function(t,i){return i._map&&(n&&i===e?i._map.removeLayer(i):i.options.layerId===r&&i.options.objectId===e?i._map.removeLayer(i):t.push(i)),t},[])}},getPopups:function(e){var t=this._map,i=[];if(t&&t._gmxPopups){var r=this._gmx.layerID;t._gmxPopups.reduce(function(t,i){return i.options.layerId===r&&t.push(e?i:i.options.objectId),t},i)}return i},addPopup:function(e){var i=this._gmx,r=i.dataManager.getItem(e);if(r&&this._map){var n=r.bounds.getCenter(),o=t.latLng(t.gmxUtil.coordsFromMercator("Point",n,3857==i.srs).reverse());this._openPopup({type:"click",latlng:o,gmx:this.getHoverOption(r)},!0),delete i._needPopups[e]}else i._needPopups[e]=!1;return this},addPopupHook:function(e,i){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[e]){var r="_"+t.stamp({});this._balloonHook[e]={key:e,hookID:r,resStr:'<span id="'+r+'"></span>',callback:i}}return this},removePopupHook:function(e){return this._balloonHook&&delete this._balloonHook[e],this}}),t.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(e,t,i){for(var n,o,s=this._gmx,a=s.mInPixel,l=e.length-1;l>=0;l--){var u=e[l].properties,h=u[0],c=e[l].dataOption||{},d=s.dataManager.getItem(h),p=d.currentStyle||d.parsedStyleKeys||{},f=p.iconScale||1,m=p.iconCenter,g=!m&&p.iconAnchor?p.iconAnchor:null,v=s.styleManager.getObjStyle(d),y=p.lineWidth||v.lineWidth||0,x=y+(v.sx||p.sx||0),_=y+(v.sy||p.sy||0),b=[f*x/2,f*_/2],P=t,S=u[u.length-1],T=S.type;"POINT"===T&&"circle"===v.type&&(b[0]*=2,b[1]*=2);var L=b[0],I=r.bounds().extendBounds(c.bounds).addBuffer(b[0]/a,b[1]/a);if(g&&(b=[g[0]-b[0],g[1]-b[1]],P=[t[0]+b[0]/a,t[1]-b[1]/a]),I.contains(P)){var M=p.fillStyle||p.canvasPattern||v.bgImage||v.fillColor,k=v&&v.image?v.image:null,C=T,O=c.hiddenLines||[],w=c.boundsArr,D=S.coordinates,F=null,R={point:t,bounds:i,coords:D,boundsArr:w};if("MULTIPOLYGON"!==T&&"POLYGON"!==T||(k?C="POINT":M||("POLYGON"===T?(C="MULTILINESTRING",O=O[0]):C="LIKEMULTILINESTRING",R.hidden=O)),"LINESTRING"===C){if(!r.isPointInPolyLine(t,y/a,D)&&(F=r.bounds([P]).addBuffer(b[0]/a,b[1]/a).isNodeIntersect(D),null===F))continue}else if("LIKEMULTILINESTRING"===C){R.delta=y/a;var N=!1;for(n=0,o=D.length;n<o;n++)if(R.coords=D[n],R.hidden=O?O[n]:null,R.boundsArr=w[n],r.isPointInLines(R)){N=!0;break}if(!N)continue}else if("MULTILINESTRING"===C){if(R.delta=y/a,R.hidden=O,!r.isPointInLines(R)){var E=r.bounds([P]).addBuffer(b[0]/a,b[1]/a);for(n=0,o=D.length;n<o;n++)if(F=E.isNodeIntersect(D[n]),null!==F){F.ring=n;break}if(null===F)continue}}else if("MULTIPOLYGON"===C||"POLYGON"===C){var A=t;for(N=!1,"POLYGON"===C&&(D=[S.coordinates],w=[c.boundsArr]),n=0,o=D.length;n<o;n++)for(var G=D[n],U=w[n],B=0,z=G.length;B<z;B++){var H=U[B];if(H.intersects(i)&&r.isPointInPolygonWithHoles(A,G)){N=0===B;break}}if(!N)continue}else if("POINT"===C&&"circle"===v.type){var V=(D[0]-P[0])*a,q=(D[1]-P[1])*a;if(V*V+q*q>L*L)continue}if(this.isPointInClipPolygons(t))return{id:h,properties:d.properties,geometry:S,bounds:d.bounds,nodePoint:F,offset:g?b:null,parsedStyle:v}}}return null},gmxEventCheck:function(e,i){if(!this._map)return 0;var n=this,o=n._gmx,s=e.type,a=o.lastHover,l=function(t){a&&"mousemove"===s&&(t&&n.hasEventListeners(t)&&(e.gmx=a,n.fire(t,e)),a.hoverDiff&&n.redrawItem(a.id))},u=this._map.getZoom();if((u>this.options.maxZoom||u<this.options.minZoom)&&(i=!0),i)a&&(a.prevId=null),l("mouseout"),o.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(s)||"mousemove"===s&&"Raster"!==o.properties.fromType){var h=e.latlng.lng%360,c=new t.LatLng(e.latlng.lat,h+(h<-180?360:h>180?-360:0)),d=3857==o.srs?t.CRS.EPSG3857:t.Projection.Mercator,p=d.project(c)._subtract({x:o.shiftXlayer||0,y:o.shiftYlayer||0}),f=Math.max(5,o.styleManager._getMaxStyleSize(u))/o.mInPixel,m=[p.x,p.y],g=o.dataManager.getViewFilters("screen",o.layerID),v={type:"resend",layerID:o.layerID,needBbox:o.needBbox,bbox:r.bounds([m]).addBuffer(f),dateInterval:"VectorTemporal"===o.layerType?[o.beginDate,o.endDate]:null,filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"].concat(g),active:!1};this.options.isGeneralized&&(v.targetZoom=u),o.dataManager.addObserver(v,"hover");var y=o.dataManager.getItems("hover");if(o.dataManager.removeObserver("hover"),y&&y.length){y.length>1&&o.sortItems&&(y=this.getSortedItems(y));var x=this._gmxFirstObjectsByPoint(y,m,v.bbox);if(x){var _=x.id,b=o.dataManager.getItem(_),P=a?a.id:null,S=!a||a.id!==_;if("mousemove"===s&&a){if(!S)return e.gmx=a,this.fire(s,e),_;e.gmx=a,this.fire("mouseout",e),l(b.currentFilter!==a.currentFilter?"mouseout":""),o.lastHover=null}return e.gmx=t.extend(this.getHoverOption(b),{targets:y,nodePoint:x.nodePoint,prevId:P,hoverDiff:b.hoverDiff}),this.hasEventListeners(s)&&this.fire(s,e),"mousemove"===s&&S&&(a=o.lastHover=e.gmx,l("mouseover"),o.lastMouseover=o.lastHover),this._map.doubleClickZoom.disable(),_}}}return this._map&&this._map.doubleClickZoom.enable(),0},getHoverOption:function(e){return{layer:this,target:e,balloonData:this._gmx.styleManager.getItemBalloon(e.id),properties:this.getItemProperties(e.properties),currentFilter:e.currentFilter||0,id:e.id}}}),function(){var e=2e4,i={},r={},n="/Layer/CheckVersion.ashx",o=null,s=null,a={},l=function(e){var t=e.Temporal?"TemporalTiles":"tiles";return t in e||e.currentTiles},u=function(e,t,i){var r={Name:e.name,Version:l(e)?e.LayerVersion:-1};if(t&&(e.UseTiles===!1||"NotVisible"===i.skipTiles||i.needBbox)){var n=t.getMaxDateInterval(),o=n.beginDate||i.beginDate,s=n.endDate||i.endDate;o&&(r.dateBegin=Math.floor(o.getTime()/1e3)),s&&(r.dateEnd=Math.floor(s.getTime()/1e3))}return r},h=function(e){var r,n,o,s,a={};if(e)e.target instanceof t.gmx.DataManager&&(e=e.target),e instanceof t.gmx.DataManager?(o=e,r=o.options):(r=e._gmx.properties,o=e._gmx.dataManager,s=e._gmx),n=r.hostName||e._gmx.hostName,a[n]=[u(r,o,s)];else{var l={};for(var h in i){var c=i[h],d=c instanceof t.gmx.DataManager;if(c.options.chkUpdate||d){o=d?c:c._gmx.dataManager,r=d?c.options:c._gmx.properties,s=d?c:c._gmx,n=r.hostName||c._gmx.hostName;var p=u(r,o,s),f=p.Name+p.Version;l[f]||(a[n]?a[n].push(p):a[n]=[p]),l[f]=!0}}}return a},c=function(e,r){var o=d._map,s=function(n){if(n&&"ok"===n.Status&&n.Result){var s,a,l,u,h,c=n.Result,p=c.length,f=0;if(d.needBbox){for(s=0;s<p;s++){if(h=c[s],u=h.name||h.properties.name,l=null,e&&e._gmx.properties.name===u)l=e;else for(a in i)if(l=i[a],!(e&&e===l&&"updateVersion"in e)){if(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l)break;if(l instanceof t.gmx.DataManager&&l.options.name===u)break}l&&(f+=(l.getDataManager?l.getDataManager():l).getNotLoadedVectorTiles(h))}if(o.fire("needLoadTiles",{count:f}),t.gmx.skipLoadTiles)return void console.log("Skiped tiles: ",t.gmx.needLoadTiles)}for(s=0;s<p;s++){h=c[s],u=h.name||h.properties.name,e&&e._gmx.properties.name===u&&"updateVersion"in e&&e.updateVersion(h);for(a in i)l=i[a],e&&e===l||(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l?l.updateVersion(h):l instanceof t.gmx.DataManager&&l.options.name===u&&l.updateVersion(h.properties,h.tiles));
}}r&&r(n)};if(document.body&&!t.gmxUtil.isPageHidden()){var l=h(e),u=function(r){var u=t.gmxUtil.protocol+"//"+r+n,h=JSON.stringify(l[r]),c="WrapStyle=None&ftc=osm";if(d.needBbox){var p=t.Projection.Mercator;3857==o.options.srs&&(c+="&srs=3857",p=t.CRS.EPSG3857);var f=o.getZoom(),m=o.getBounds(),g=p.project(m.getSouthWest()),v=p.project(m.getNorthEast()),y=[g.x,g.y,v.x,v.y].join(",");c+="&zoom="+f,c+="&bbox=["+y+"]"}if(c+="&layers="+encodeURIComponent(h),e||!a[r]||a[r]!==c){"FormData"in window&&t.gmxUtil.request({url:u,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:c,withCredentials:!0,callback:function(e){a[r]=c,s(JSON.parse(e))},onError:function(e){console.log("Error: LayerVersion ",e)}});var x=Date.now();for(var _ in i){var b=i[_],P=b._gmx||b.options;P.hostName===r&&(P._stampVersionRequest=x)}}};for(var c in l)u(c)}},d={needBbox:!1,addDataManager:function(e){var t=e.options,r=t.name;r in i||(t.needBbox&&!d.needBbox&&(d.needBbox=t.needBbox),e.on("chkLayerUpdate",c.bind(e)),i[r]=e)},removeDataManager:function(e){var t=e.options.name;t in i&&(e.off("chkLayerUpdate",c.bind(e)),delete i[t])},remove:function(e){delete i[e._gmx.layerID];var t=e._gmx,n=e.options.parentOptions;if(n){var o=n.name;r[o]&&(delete r[o][t.properties.name],Object.keys(r[o]).length||(d.removeDataManager(t.dataManager),delete r[o]))}else t.dataManager.off("chkLayerUpdate",t._chkVersion)},add:function(e){var t=e._gmx.layerID;if(!(t in i)){var n=e._gmx,o=n.properties;if("LayerVersion"in o){i[t]=e,n._chkVersion=function(){c(e)},n.dataManager.on("chkLayerUpdate",n._chkVersion);var s=e.options.parentOptions;if(s){var a=s.name;d.addDataManager(n.dataManager),r[a]||(r[a]={}),r[a][o.name]=e}n.needBbox&&!d.needBbox&&(d.needBbox=n.needBbox),d.start(),d.now()}}},chkVersion:c,now:function(){s&&clearTimeout(s),s=setTimeout(c,0)},stop:function(){o&&clearInterval(o),o=null},start:function(t){t&&(e=t),d.stop(),o=setInterval(c,e)}};t.gmx||(t.gmx={}),t.gmx.layersVersion=d,t.gmx.VectorLayer.include({updateVersion:function(e){if(e){var i=this._gmx;e.geometry&&(i.geometry=e.geometry),e.properties&&(t.extend(i.properties,e.properties),i.properties.currentTiles=e.tiles,i.properties.GeoProcessing=e.properties.GeoProcessing,i.rawProperties=i.properties,this.fire("versionchange")),!i.dataSource&&i.dataManager&&i.dataManager.updateVersion(i.rawProperties,e.tiles)}}}),t.Map.addInitHook(function(){d._map=this;var e=this,t={};this.on("moveend",function(){var i=e.getZoom(),r=e.getPixelBounds().getCenter();(i!==t.z||t.center.distanceTo(r)>128)&&(c(),t.z=i,t.center=r)})})}(),t.gmx.RasterLayer=t.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(e){var i=e.properties,n=i.styles[0]||{MinZoom:i.MinZoom||0,MaxZoom:i.MaxZoom||21},o={type:"Vector",fromType:i.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,RasterSRS:Number(i.RasterSRS)||3857,Copyright:i.Copyright||"",RCMinZoomForRasters:n.MinZoom,visible:i.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:n.MinZoom,MaxZoom:n.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},s=this._gmx,a=r.tileSizes[1];return i.MaxZoom&&(s.maxNativeZoom=i.MaxZoom),e.geometry?3857==s.srs&&s.srs!=o.RasterSRS&&(e.geometry=r.convertGeometry(r.convertGeometry(e.geometry,!0,!0),!1,!0)):e.geometry={type:"POLYGON",coordinates:[[[-a,-a],[-a,a],[a,a],[a,-a],[-a,-a]]]},t.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:e.geometry,properties:o,rawProperties:e.properties}),s.rasterBGfunc=function(e,i,r){var n=t.gmxUtil.protocol+"//"+s.hostName+"/TileSender.ashx?ModeKey=tile&ftc=osm&z="+r+"&x="+e+"&y="+i;return s.srs&&(n+="&srs="+s.srs),s.crossOrigin&&(n+="&cross="+s.crossOrigin),n+="&LayerName="+s.layerID,s.sessionKey&&(n+="&key="+encodeURIComponent(s.sessionKey)),n},s.dataManager._rasterVectorTile=new p({load:function(t,i,n,o,l,u,h){var c=[[777,e.geometry]],d=r.geoItemBounds(e.geometry),p=d.bounds;if(p.max.x>a){var f=2*a,m=777,g=e.geometry.coordinates,v=d.boundsArr;c=[],"POLYGON"===e.geometry.type&&(g=[g],v=[v]);for(var y=0,x=g.length;y<x;y++){var _=g[y],b=v[y][0],P=_;if(c.push([m++,{type:"POLYGON",coordinates:P}]),b.max.x>a){P=[];for(var S=0,T=_.length;S<T;S++){for(var L=_[S],I=0,M=[],k=L.length;I<k;I++){var C=L[I];M.push([C[0]-f,C[1]])}P.push(M)}c.push([m++,{type:"POLYGON",coordinates:P}])}}}h({bbox:[p.min.x,p.min.y,p.max.x,p.max.y],srs:s.srs,isGeneralized:!1,changeState:!0,values:c}),s.dataManager._updateItemsFromTile(s.dataManager._rasterVectorTile)}},{x:0,y:0,z:0,v:0,s:-2,d:-2}),s.dataManager.addTile(s.dataManager._rasterVectorTile),this},setZoomBounds:function(e,i){var r=this.getStyles().slice(0);r[0]=t.extend({},r[0]),r[0].MinZoom=e,r[0].MaxZoom=i,this.setStyles(r)}}),t.LabelsLayer=(t.Layer||t.Class).extend({options:{labels:"default",pane:"overlayPane"},initialize:function(e,i){t.setOptions(this,i),this._observers={},this._styleManagers={},this._labels={},this._labelsIndex={};var n=this;this.bbox=r.bounds();var o=function(i,o){if(i.added||i.removed){for(var s=o.options,a=e._zoom>=s.minZoom&&e._zoom<=s.maxZoom?i.added:[],l="_"+o._leaflet_id,u=o._gmx,h={},c=0,d=a.length;c<d;c++){var p=a[c].item,f="POINT"===p.type||"MULTIPOINT"===p.type,m=p.parsedStyleKeys||p.currentStyle||{};if(u.styleHook){var g=u.styleHook(p,u.lastHover&&p.id===u.lastHover.id);if(!g)continue;m=t.extend({},m,g)}if(p.multiFilters)for(var v=0,y=p.multiFilters.length;v<y;v++){var x=p.multiFilters[v].parsedStyle;if("labelField"in x||"labelText"in x){m=x;break}}var _=u.styleManager.getObjStyle(p)||{},b=m.labelText||_.labelText,P=m.labelField||_.labelField,S=u.tileAttributeTypes[P],T=String(b||t.gmxUtil.attrToString(S,o.getPropItem(P,p.properties)));if(_.labelTemplate){var L,I=/\[([^\]]*)\]/g;for(T=_.labelTemplate;L=I.exec(_.labelTemplate);)if(2===L.length){P=L[1],S=u.tileAttributeTypes[P];var M=t.gmxUtil.attrToString(S,o.getPropItem(P,p.properties));T=T.replace(L[0],M)}}if(T||0===T){var k,C=_.labelFontSize||m.labelFontSize||12,O="_"+p.id,w=!0,D=0,F=p.options,R={font:C+'px "Arial"',labelHaloColor:"labelHaloColor"in m?m.labelHaloColor:"labelHaloColor"in _?_.labelHaloColor:16777215,labelColor:m.labelColor||_.labelColor,labelAlign:m.labelAlign||_.labelAlign,labelAnchor:m.labelAnchor||_.labelAnchor,labelFontSize:C};if(F){if(!("center"in F)){var N=r.getItemCenter(p,u.dataManager.getItemMembers(p.id));if(!N)continue;F.center=N}if(F.label){D=F.label.width,k=F.label.arrTxtWidth;var E=F.label.style;w=F.label.txt!==T||E.labelHaloColor!==R.labelHaloColor||E.labelColor!==R.labelColor||E.labelAlign!==R.labelAlign||E.labelAnchor!==R.labelAnchor||E.labelFontSize!==R.labelFontSize}}if(w){if(D=0,k=r.getLabelWidth(T,R),k&&k.forEach(function(e){D=Math.max(D,e[1])}),!D){delete h[O];continue}D+=4,p.options.labelStyle=null}F.label={isPoint:f,width:D,sx:_.sx||0,txt:T,arrTxtWidth:k,style:R},h[O]=p}}n._labelsIndex[l]=o.options.zIndex,n._labels[l]=h}},s=function(e,t){var i=e._gmx,r=["styleFilter","userFilter"],s={type:"resend",bbox:n.bbox,filters:r,callback:function(t){o(t,e),n.redraw()}};return i.beginDate&&i.endDate&&(s.dateInterval=[i.beginDate,i.endDate]),i.dataManager.addObserver(s,"_Labels_"+t)};this.add=function(e){var t=e._leaflet_id,i=e._gmx;!n._observers[t]&&i&&i.labelsLayer&&t&&i.styleManager.promise.then(function(){var r=s(e,t),o=n._map._zoom;e.options.isGeneralized&&(r.targetZoom=o),r.dateInterval&&e.on("dateIntervalChanged",function(e){var t=e.target.getDateInterval();this.setDateInterval(t.beginDate,t.endDate)},r),i.styleManager.isVisibleAtZoom(o)||r.deactivate(),n._observers[t]=r,n._styleManagers[t]=i.styleManager,n._labels["_"+t]={},n._labelsIndex["_"+t]={},n._updateBbox()})},this.remove=function(e){var t=e._leaflet_id;if(n._observers[t]){var i=e._gmx,r=i.dataManager;r.removeObserver(n._observers[t].id),delete n._observers[t],delete n._styleManagers[t],delete n._labels["_"+t],delete n._labelsIndex["_"+t],n.redraw()}},this._layeradd=function(e){n.add(e.layer)},this._layerremove=function(e){n.remove(e.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=t.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var e=this._map.getPanes()[this.options.pane];e&&e.insertBefore(this._canvas,e.firstChild)},onAdd:function(e){this._map=e,this._canvas||this._initCanvas();var t=window.location.search.match("labels=([^&]+)");t&&(this.options.labels=t[1]),e.on("moveend",this._reset,this),e.on({layeradd:this._layeradd,layerremove:this._layerremove}),e.on("zoomstart",function(){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas)},this),this._reset()},onRemove:function(e){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("layeradd",this._layeradd),e.off("layerremove",this._layerremove)},addTo:function(e){return e.addLayer(this),this},_initCanvas:function(){var e=t.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer"),i=this._map.getSize();e.width=i.x,e.height=i.y,e.style.pointerEvents="none",this._canvas=e;var r=this._map.options.zoomAnimation&&t.Browser.any3d;t.DomUtil.addClass(e,"leaflet-zoom-"+(r?"animated":"hide"))},_updateBbox:function(){var e=this._map,i=e.getBounds(),n=i.getSouthWest(),o=i.getNorthEast(),s=3857==e.options.srs?t.CRS.EPSG3857:t.Projection.Mercator,a=s.project(n),l=s.project(o),u=e.getZoom();this.mInPixel=r.getPixelScale(u),this._ctxShift=[a.x*this.mInPixel,l.y*this.mInPixel];for(var h in this._observers){var c=this._observers[h];c.targetZoom&&(c.targetZoom=u),c.setBounds({min:{x:n.lng,y:n.lat},max:{x:o.lng,y:o.lat}})}},_reset:function(){this._updateBbox();for(var e in this._observers){var t=this._observers[e];!t.isActive()&&this._styleManagers[e].isVisibleAtZoom(this._map.getZoom())&&t.activate(),t.fire("update")}},_redraw:function(){var e=[],i=this._map,n=i.getSize(),o=this._canvas,s=this.options.labels,a=i.latLngToContainerPoint(i.getBounds().getNorthWest()),l=i.containerPointToLayerPoint(a);o.width=n.x,o.height=n.y,t.DomUtil.setPosition(o,l);var u,h,c,d=2*this.mInPixel*r.worldWidthMerc,p=d*Math.floor(i.getPixelBounds().min.x/d),f=o.getContext("2d"),m=Object.keys(this._labels).sort(function(e,t){return this._labelsIndex[t]-this._labelsIndex[e]}.bind(this));if(m.forEach(function(t){var i=this._labels[t];for(var o in i){c=i[o];var a=c.options,l=a.label,f=l.style,m=f.labelAlign||"center",g=l.arrTxtWidth,v=g.length||1,y=l.width,x=y/2,_=f.labelFontSize||12,b=_/2,P=a.center,S=[P[0]*this.mInPixel,P[1]*this.mInPixel],T=!1;if(l.isPoint){var L=l.sx;"left"===m?S[0]+=x+L:"right"===m&&(S[0]-=y+L)}S[0]-=x+this._ctxShift[0],S[1]=-b-S[1]+this._ctxShift[1],b*=v,f.labelAnchor&&(S[0]+=f.labelAnchor[0],S[1]+=f.labelAnchor[1]);for(var I=S[0]+p;I<n.x;I+=d){var M=[Math.floor(I),Math.floor(S[1])],k=r.bounds([[M[0],M[1]-b],[M[0]+y,M[1]+b]]);if("All"!==s){for(u=0,h=e.length;u<h;u++)if(k.intersects(e[u].bbox)){T=!0;break}if(T)continue}a.labelStyle||(a.labelStyle={font:_+'px "Arial"',fillStyle:r.dec2color(f.labelColor||0,1),shadowBlur:4},f.labelHaloColor!==-1&&(a.labelStyle.strokeStyle=a.labelStyle.shadowColor=r.dec2color(f.labelHaloColor,1))),e.push({arr:c.properties,bbox:k,arrTxtWidth:g,width2:"center"===m?x:0,txt:l.txt,style:a.labelStyle,size:_,coord:M})}}}.bind(this)),e.length){for(f.clearRect(0,0,o.width,o.height),u=0,h=e.length;u<h;u++)c=e[u],c.arrTxtWidth.forEach(function(e,t){var i=[c.coord[0],c.coord[1]+(t+1)*c.size];r.setLabel(f,e[0],i,c.style)});o.parentNode||this._addToPane()}else o.parentNode&&o.parentNode.removeChild(o);this._frame=null}}),t.labelsLayer=function(e,i){return new t.LabelsLayer(e,i)},t.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new t.LabelsLayer(this,this.options),this._labelsLayer.addTo(this))}),function(){var e=function(e,t){for(var i in t)for(var r=t[i],n=0,o=r.length;n<o;n++)for(var s=r[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,p=c.length;d<p;d++)if(c[d].intersects(e))return!0}return!1},i=function(e,t){for(var i in t)for(var r=t[i],n=0,o=r.length;n<o;n++)for(var s=r[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,p=c.length;d<p;d++)if(e.intersects(c[d]))return!0}return!1},n=function(e,t){if(!t||0===Object.keys(t).length)return!0;for(var i in t)for(var n=t[i],o=0,s=n.length;o<s;o++)for(var a=n[o],l=a.geometry.type,u=a.boundsArr,h=0,c=u.length;h<c;h++){var d=u[h];"Polygon"===l&&(d=[d]);for(var p=0,f=d.length;p<f;p++)if(d[p].contains(e)){var m=a.geometry.coordinates,g=!1;"Polygon"===l&&(m=[m]);for(var v=0,y=m.length;v<y;v++)if(r.isPointInPolygonWithHoles(e,m[v])){g=!0;break}if(g)return!0}}return!1},o=function(e){var t=r.convertGeometry(e),i=r.geoItemBounds(t);return i.geometry=t,i},s=function(e){var t=document.createElement("canvas");t.width=t.height=256;var i=t.getContext("2d"),n=e.clipPolygons;e.ctx=i,i.fillStyle=i.createPattern(e.tile,"no-repeat");for(var o in n)for(var s=n[o],a=0,l=s.length;a<l;a++){var u=s[a].geometry,h=u.coordinates;"Polygon"===u.type&&(h=[h]);for(var c=0,d=h.length;c<d;c++){var p=h[c];i.beginPath();for(var f=0,m=p.length;f<m;f++){e.coords=p[f];var g=r.getRingPixels(e);e.coords=g.coords,r.polygonToCanvasFill(e)}i.closePath(),i.fill()}}i=e.tile.getContext("2d"),i.clearRect(0,0,256,256),i.drawImage(t,0,0)};t.gmx.VectorLayer.include({isPointInClipPolygons:function(e){return n(e,this._gmx._clipPolygons)},addClipPolygon:function(r){var a,l,u=[];if("coordinates"in r&&"type"in r)u.push(o(r));else if(r instanceof t.Polygon)u.push(o(r.toGeoJSON().geometry));else if(r instanceof t.GeoJSON){var h=r.getLayers();for(a=0,l=h.length;a<l;a++){var c=h[a];c instanceof t.Polygon&&c.feature?u.push(o(c.feature.geometry)):c instanceof t.MultiPolygon&&c.feature&&u.push(o(c.feature.geometry))}}if(u.length){var d=this._gmx,p=d.dataManager,f=this,m=t.stamp(r);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[m]=u,p.setTileFilteringHook(function(t){return e(t.bounds,f._gmx._clipPolygons)}),p.addFilter("clipFilter",function(e,t,r){return i(r,f._gmx._clipPolygons)}),p.addFilter("clipPointsFilter",function(e){if("POINT"===e.type){var t=e.properties,i=t[t.length-1];return n(i.coordinates,f._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&d.renderHooks.unshift(function(e,t){e&&Object.keys(f._gmx._clipPolygons).length>0&&s({tile:e,topLeft:t.topLeft,tpx:t.tpx,tpy:t.tpy,gmx:{mInPixel:d.mInPixel},clipPolygons:f._gmx._clipPolygons})})}return this},removeClipPolygon:function(e){var i=t.stamp(e);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[i],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}(),t.gmx.gmxImageTransform=function(e,i){var n=i.gmx,o=i.topLeft,s=o.mInPixel,a=i.gmxTilePoint,l=i.geoItem,u=l.properties,h=l.dataOption||{},c=n.tileAttributeIndexes,d=u[c[n.quicklookPlatform]]||n.quicklookPlatform||"",p={};"LANDSAT8"===d?(p.x1=h.bounds.min.x,p.y1=h.bounds.max.y,p.x2=h.bounds.max.x,p.y2=h.bounds.max.y,p.x3=h.bounds.max.x,p.y3=h.bounds.min.y,p.x4=h.bounds.min.x,p.y4=h.bounds.min.y):p=r.getQuicklookPointsFromProperties(u,n);var f=s*p.x1,m=s*p.y1,g=s*p.x2,v=s*p.y2,y=s*p.x3,x=s*p.y3,_=s*p.x4,b=s*p.y4,P=r.bounds([[f,m],[g,v],[y,x],[_,b]]),S=Math.round(P.max.x-P.min.x),T=Math.round(P.max.y-P.min.y),L=256-P.max.y+256*a.y,I=l.item.bounds,M=r.worldWidthMerc,k=a.x;k<0&&I.max.x>M&&I.min.x<-M&&(k+=Math.round(M*s/128));var C=P.min.x-256*k;f-=P.min.x,m=P.max.y-m,g-=P.min.x,v=P.max.y-v,y-=P.min.x,x=P.max.y-x,_-=P.min.x,b=P.max.y-b;var O=[[f,m],[g,v],[y,x],[_,b]];n.ProjectiveImage||(n.ProjectiveImage=(n.useWebGL?t.gmx.projectiveImageWebGL():null)||t.gmx.projectiveImage());var w=n.ProjectiveImage.getCanvas({imageObj:e,points:O,wView:S,hView:T,deltaX:C,deltaY:L});return w.canvas},function(){function e(e){return[e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]]}function i(e,t){for(var i=Array(9),r=0;3!==r;++r)for(var n=0;3!==n;++n){for(var o=0,s=0;3!==s;++s)o+=e[3*r+s]*t[3*s+n];i[3*r+n]=o}return i}function r(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[3]*t[0]+e[4]*t[1]+e[5]*t[2],e[6]*t[0]+e[7]*t[1]+e[8]*t[2]]}function n(t){var n=[t[0],t[2],t[4],t[1],t[3],t[5],1,1,1],o=r(e(n),[t[6],t[7],1]);return i(n,[o[0],0,0,0,o[1],0,0,0,o[2]])}var o=t.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;            uniform mat4 uTransformMatrix;            varying vec2 vTextureCoord;            void main(void) {                vTextureCoord = aVertCoord;                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);            }        ",shaderFS:"precision mediump float;            varying vec2 vTextureCoord;            uniform sampler2D uSampler;            void main(void) {                gl_FragColor = texture2D(uSampler, vTextureCoord);            }        "},setOptions:function(e){t.setOptions(this,e)},initialize:function(e){this.setOptions(e);var t=document.createElement("canvas"),i={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},r=t.getContext("webgl",i)||t.getContext("experimental-webgl",i);if(r){var n=this._setupGlContext(r);n&&(t.width=t.height=256,n.canvas=t,this.glResources=n,this.canvas=t,this.gl=r)}},_getShader:function(e,t,i){var r=i.createShader(e);return i.shaderSource(r,t),i.compileShader(r),i.getShaderParameter(r,i.COMPILE_STATUS)?r:(i.deleteShader(r),null)},_setupGlContext:function(e){var t=this._getShader(e.VERTEX_SHADER,this.options.shaderVS,e),i=this._getShader(e.FRAGMENT_SHADER,this.options.shaderFS,e);if(t&&i){var r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,i),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)){e.useProgram(r),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var n=e.createBuffer(),o=e.getAttribLocation(r,"aVertCoord");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),{transMatUniform:e.getUniformLocation(r,"uTransformMatrix"),samplerUniform:e.getUniformLocation(r,"uSampler"),screenTexture:e.createTexture()}}}return null},_bindTexture:function(e,t,i){e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},getCanvas:function(e){var t=e.points,i=e.deltaX,r=e.deltaY,n=new Float32Array([(t[0][0]+i)/128-1,1-(t[0][1]+r)/128,(t[1][0]+i)/128-1,1-(t[1][1]+r)/128,(t[3][0]+i)/128-1,1-(t[3][1]+r)/128,(t[2][0]+i)/128-1,1-(t[2][1]+r)/128]),s=o.Utils.general2DProjection(this.vertices,n),a=this.gl,l=this.glResources;return this._bindTexture(a,e.imageObj,l.screenTexture),a.viewport(0,0,256,256),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.uniformMatrix4fv(l.transMatUniform,!1,[s[0],s[3],0,s[6],s[1],s[4],0,s[7],0,0,1,0,s[2],s[5],0,1]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,l.screenTexture),a.uniform1i(l.samplerUniform,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),this}});o.Utils={general2DProjection:function(t,r){var o=i(n(r),e(n(t)));if(o[8])for(var s=0;9!==s;++s)o[s]=o[s]/o[8];return o},getWebGlResources:function(e){var t=new o(e);return t.gl?t:null}},t.gmx.projectiveImageWebGL=function(e){var t=new o(e);return t.gl?t:null}}(),function(){var e=function(){var e=0,t=4,i=64,n=null,o=function(e,t){for(var i=[],r=0;r<t;++r){i[r]=[];for(var n=0;n<e;++n)i[r][n]=0}return i},s=function(e,t,i){this.w=e,this.h=t,this.values=i||o(t)},a=function(e){for(var t=[],i=0;i<e.length;++i)t[i]=[].concat(e[i]);return t};s.prototype={add:function(e){if(e.w!==this.w||e.h!==this.h)throw new Error("Matrix add size mismatch");for(var t=o(this.w,this.h),i=0;i<this.h;++i)for(var r=0;r<this.w;++r)t[i][r]=this.values[i][r]+e.values[i][r];return new s(this.w,this.h,t)},transformProjectiveVector:function(e){var t,i,r=[];for(i=0;i<this.h;++i)for(r[i]=0,t=0;t<this.w;++t)r[i]+=this.values[i][t]*e[t];var n=r[r.length-1];if(n){var o=1/r[r.length-1];for(i=0;i<this.h;++i)r[i]*=o}return r},multiply:function(e){var t,i,r;if(+e!==e){if(e.h!==this.w)throw new Error("Matrix mult size mismatch");for(t=o(this.w,this.h),r=0;r<this.h;++r)for(i=0;i<e.w;++i){for(var n=0,a=0;a<this.w;a++)n+=this.values[r][a]*e.values[a][i];t[r][i]=n}return new s(e.w,this.h,t)}for(t=o(this.w,this.h),r=0;r<this.h;++r)for(i=0;i<this.w;++i)t[r][i]=this.values[r][i]*e;return new s(this.w,this.h,t)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var e=a(this.values),t=0;t<this.h;++t){for(var i=e[t][t];0===i;){for(var r=t+1;r<this.h;++r)if(0!==e[r][t]){var n=e[r];e[r]=e[t],e[t]=n;break}if(r===this.h)return new s(this.w,this.h,e);i=e[t][t]}for(var o=1/i,l=t;l<this.w;++l)e[t][l]*=o;for(var u=0;u<this.h;++u)if(u!==t){var h=e[u][t];for(e[u][t]=0,l=t+1;l<this.w;++l)e[u][l]-=h*e[t][l]}}return new s(this.w,this.h,e)},invert:function(){var e,t;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var i=o(2*this.w,this.h);for(t=0;t<this.h;++t)for(e=0;e<this.w;++e)i[t][e]=this.values[t][e],i[t][e+this.w]=e===t?1:0;i=new s(2*this.w,this.h,i),i=i.rowEchelon();var r=o(this.w,this.h);for(t=0;t<this.w;++t)for(e=0;e<this.w;++e)r[t][e]=i.values[t][e+this.w];return new s(this.w,this.h,r)}};var l=function(e){var t=new s(9,8,[[1,1,1,0,0,0,-e[2][0],-e[2][0],-e[2][0]],[0,1,1,0,0,0,0,-e[3][0],-e[3][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[2][1],e[2][1],e[2][1]],[0,0,0,0,-1,-1,0,e[3][1],e[3][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]),i=t.rowEchelon().values,r=new s(3,3,[[-i[0][8],-i[1][8],-i[2][8]],[-i[3][8],-i[4][8],-i[5][8]],[-i[6][8],-i[7][8],1]]);return r},u=function(t,r,o,s,a,l,h,c,d,p){if(d){var f=[l[0]+h[0]-2*a[0],l[1]+h[1]-2*a[1]],m=[l[0]+h[0]-2*c[0],l[1]+h[1]-2*c[1]],g=[f[0]+m[0],f[1]+m[1]],v=Math.abs((g[0]*g[0]+g[1]*g[1])/(f[0]*m[0]+f[1]*m[1]));f=[l[0]-a[0]+c[0]-h[0],l[1]-a[1]+c[1]-h[1]],m=[h[0]-a[0]+c[0]-l[0],h[1]-a[1]+c[1]-l[1]];var y=Math.abs(f[0]*m[1]-f[1]*m[0]);if(0===t&&1===o||(.25+5*v)*y>i*i){var x=(t+o)/2,_=(r+s)/2,b=n.transformProjectiveVector([x,_,1]),P=n.transformProjectiveVector([x,r,1]),S=n.transformProjectiveVector([x,s,1]),T=n.transformProjectiveVector([t,_,1]),L=n.transformProjectiveVector([o,_,1]);return d--,u.call(this,t,r,x,_,a,P,T,b,d,p),u.call(this,x,r,o,_,P,l,b,L,d,p),u.call(this,t,_,x,s,T,b,h,S,d,p),void u.call(this,x,_,o,s,b,L,S,c,d,p)}}var I=p.ctx,M=[l[0]-a[0],l[1]-a[1]],k=[c[0]-l[0],c[1]-l[1]],C=[h[0]-c[0],h[1]-c[1]],O=[a[0]-h[0],a[1]-h[1]],w=Math.abs(M[0]*O[1]-M[1]*O[0]),D=Math.abs(k[0]*M[1]-k[1]*M[0]),F=Math.abs(C[0]*k[1]-C[1]*k[0]),R=Math.abs(O[0]*C[1]-O[1]*C[0]),N=Math.max(Math.max(w,D),Math.max(R,F)),E=0,A=0,G=0,U=0;N===w?(I.setTransform(M[0],M[1],-O[0],-O[1],a[0]+p.deltaX,a[1]+p.deltaY),1!==o&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1]))):N===D?(I.setTransform(M[0],M[1],k[0],k[1],l[0]+p.deltaX,l[1]+p.deltaY),1!==o&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),E=-1):N===F?(I.setTransform(-C[0],-C[1],k[0],k[1],c[0]+p.deltaX,c[1]+p.deltaY),1!==o&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),E=-1,A=-1):N===R&&(I.setTransform(-C[0],-C[1],-O[0],-O[1],h[0]+p.deltaX,h[1]+p.deltaY),1!==o&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1])),A=-1);var B=o-t,z=s-r;G++,U++;var H=p.imageObj.width,V=p.imageObj.height,q=Math.floor(t*H),Z=Math.floor(r*V),j=Math.floor(Math.min(G*B,1)*H),K=Math.floor(Math.min(U*z,1)*V);e++,I.drawImage(p.imageObj,q,Z,j,K,E,A,G,U)};this.getCanvas=function(o){e=0,n=l(o.points);var s=n.transformProjectiveVector([0,0,1]),a=n.transformProjectiveVector([1,0,1]),h=n.transformProjectiveVector([0,1,1]),c=n.transformProjectiveVector([1,1,1]),d=document.createElement("canvas");d.width=d.height=256,o.canvas=d,o.ctx=d.getContext("2d");var p=r.bounds([s,a,c,h]),f=Math.max(p.max.x-p.min.x,p.max.y-p.min.y);t="limit"in o?o.limit:f<200?1:4,i="patchSize"in o?o.patchSize:f/8;try{u(0,0,1,1,s,a,h,c,t,o)}catch(m){console.log("Error: ProjectiveImage event:",m),d=null}return{canvas:d,ptl:s,ptr:a,pbl:h,pbr:c,cnt:e}}};t.gmx.projectiveImage=function(){return new e}}(),t.RotatedMarker=t.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:t.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){t.Marker.prototype._initIcon.call(this),this._icon.style[t.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var e=this.options.icon.options.iconAnchor;return e?e[0]+"px "+e[1]+"px":"50% 50%"},_setPos:function(e){if(t.Marker.prototype._setPos.call(this,e),t.DomUtil.TRANSFORM)this._icon.style[t.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(t.Browser.ie){var i=this.options.angle*(Math.PI/180),r=Math.cos(i),n=Math.sin(i);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+r+", M12="+-n+", M21="+n+", M22="+r+")"}},setAngle:function(e){this.options.angle=e}}),t.rotatedMarker=function(e,i){return new t.RotatedMarker(e,i)},t.gmx.ExternalLayer=t.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var e=this.parentLayer._gmx;this._observer.setDateInterval(e.beginDate,e.endDate)}},options:{useDataManager:!0,observerOptions:{delta:0,filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(e,i){t.setOptions(this,e),this.parentLayer=i,i.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),i._map&&(this._addEvent({target:{_map:i._map}}),this._updateBbox())},_addObserver:function(e){this._items={},this._observer=this.parentLayer.addObserver(t.extend({bbox:r.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:t.bind(this.updateData,this)},e)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var e=this._map||this.parentLayer._map;this._onRemove(!e),this._removeMapHandlers()},_addMapHandlers:function(e){e&&(this._map=e,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this))},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(e){this._addMapHandlers(e.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(e){var t=e.layer;return t._gmx&&t._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(e){this._isParentLayer(e)&&this._chkZoom()},_layerremove:function(e){this._isParentLayer(e)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(e){this._observer&&this._observer.deactivate();var t=this._map;t&&(t.hasLayer(this.externalLayer)&&(this._chkZoom(),t.removeLayer(this.externalLayer)),e||this.parentLayer.onAdd(t))},_chkZoom:function(){if(this._map){var e=this.parentLayer,t=this._observer,i=this._map,r=i.hasLayer(this.externalLayer);e.setCurrentZoom&&e.setCurrentZoom(i),this.isExternalVisible(i.getZoom())?e._map&&(e.onRemove(i),r||i.addLayer(this.externalLayer),this.setDateInterval(),t&&e.getIcons(function(){t.activate()}.bind(this)),e.disablePopup()):(t&&t.deactivate(),e._map||(r&&i.removeLayer(this.externalLayer),e.onAdd(i)),e.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var e=this._map,i=e.getBounds(),r=i.getNorthWest(),n=i.getSouthEast(),o=t.gmxUtil.bounds([[r.lng,r.lat],[n.lng,n.lat]]),s=this.options.observerOptions.delta,a=s?s*t.gmxUtil.tileSizes[e.getZoom()]/256:0;this._observer.setBounds(o,a)}}}),function(){var e=t.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var e=this.parentLayer.options,i={map:e.mapID,layers:e.layerID,format:this.options.format,transparent:this.options.transparent},r=this.parentLayer.getGmxProperties();return r&&r.Temporal&&this._extendOptionsByDateInterval(i),this.options.apikey&&(i.apikey=this.options.apikey),t.tileLayer.wms(t.gmxUtil.protocol+"//"+e.hostName+"/TileService.ashx",i)},_extendOptionsByDateInterval:function(e){var i=this.parentLayer.getDateInterval(),r=i.beginDate,n=i.endDate;t.extend(e,{StartDate:r&&r.toLocaleDateString(),EndDate:n&&n.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)}});t.gmx.VectorLayer.include({bindWMS:function(t){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new e(t,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}(),function(){var e=t.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return t.heatLayer([],t.extend({},this.options))},isExternalVisible:function(e){return!(e<this.options.minHeatMapZoom||e>this.options.maxHeatMapZoom)},updateData:function(e){if(e.added){var i=[],r=this.parentLayer.getTileAttributeIndexes(),n=null,o=this.options.intensityField||"",s=this.options.intensityScale||1;o&&o in r&&(n=r[o]);for(var a=0,l=e.added.length;a<l;a++){var u=e.added[a].properties,h=null!==n?u[n]:1,c=u[u.length-1],d=c.coordinates,p=t.Projection.Mercator.unproject({x:d[0],y:d[1]});i.push([p.lat,p.lng,"function"==typeof s?s(h):s*h])}this.externalLayer.setLatLngs(i)}}});t.gmx.VectorLayer.include({bindHeatMap:function(i){return t.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new e(i,this)),this},unbindHeatMap:function(){return t.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}(),function(){var e={radiusFunc:function(e){var t=Math.floor(e/15);return t>40?t=40:t<20&&(t=20),t},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},i=t.gmx.ExternalLayer.extend({options:{observerOptions:{delta:256,filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,minZoom:1,maxZoom:6},createExternalLayer:function(){var i=t.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var r=this.options.clusterIconOptions;if("radialGradient"in r){var n=r.radialGradient,o=r.text||e.text;i.iconCreateFunction=function(i){var r=i.getChildCount();return o.count=r,t.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(n.radiusFunc||e.radiusFunc)(r),text:o,fillRadialGradient:n})}}}this.options.clusterclick&&(i.clusterclick=this.options.clusterclick,i.clusterclick===!0&&(i.zoomToBoundsOnClick=!1)),this._popup=new t.Popup({maxWidth:1e4,className:"gmxPopup"});var s=new t.MarkerClusterGroup(i),a=null;return s.on("click",function(e){var i=e.layer.options.properties,r=this.parentLayer.getItemProperties(i),n=[i[i.length-1]],o=i[0];!a||a.getAllChildMarkers().indexOf(e.layer)+1?this._openPopup(i,e.latlng):(a.unspiderfy(),
s.once("unspiderfied",function(){this._openPopup(i,e.latlng)},this)),this.parentLayer.fire("click",t.extend(e,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:o,layer:this.parentLayer,properties:r,target:{id:o,properties:i,geometry:n}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(e){this.parentLayer.fire("clusterclick",t.extend(e,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(e){a=e.cluster},this).on("unspiderfied",function(){a=null},this),i.clusterclick&&s.on("clusterclick",i.clusterclick instanceof Function?i.clusterclick:function(e){e.layer.spiderfy()}),s},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)},updateData:function(e){var i,r,n,o,s,a=[];if(e.removed){for(i=0,r=e.removed.length;i<r;i++)n=e.removed[i],o=n.id,s=this._items[o],s&&a.push(s),delete this._items[o];this.externalLayer.removeLayers(a),a=[]}if(e.added){var l=this.parentLayer.options.tilesCRS||t.Projection.Mercator;for(i=0,r=e.added.length;i<r;i++){n=e.added[i],o=n.id,s=this._items[o];var u=n.properties;if(s&&u.processing&&(this.externalLayer.removeLayer(s),s=null),!s){n.item.parsedStyleKeys||(n.item.parsedStyleKeys=this.parentLayer.getItemStyle(o));var h=u[u.length-1],c=n.item.parsedStyleKeys,d=h.coordinates,p=l.unproject({x:d[0],y:d[1]}),f={properties:n.properties,mPoint:d};if(this.options.notClusteredIcon){var m=this.options.notClusteredIcon;m instanceof t.Icon?f.icon=m:f.icon=t.icon(m)}else if(c)if(c.iconUrl){var g=c.iconAnchor;if(!g){var v=this.parentLayer.getItemStyle(o);g=v.image?[v.sx/2,v.sy/2]:[8,10]}f.icon=t.icon({iconAnchor:g,iconUrl:c.iconUrl})}else f.icon=t.gmxUtil.getSVGIcon(c);s=c.rotate?t.rotatedMarker(p,t.extend(f,{angle:c.rotate})):t.marker(p,t.extend(f,{angle:c.rotate})),this._items[o]=s}a.push(s)}this.externalLayer.addLayers(a)}},_openPopup:function(e,i){var r=this.parentLayer._gmx,n=e[0],o=r.styleManager.getItemBalloon(n),s=this.parentLayer.getItemProperties(e),a=[e[e.length-1]];if(o&&!o.DisableBalloonOnClick){var l=this.parentLayer.getItemStyle(n);if(l&&l.iconAnchor){var u=t.Popup.prototype.options.offset;this._popup.options.offset=[-u[0]-l.iconAnchor[0]+l.sx/2,u[1]-l.iconAnchor[1]+l.sy/2]}this._popup.setLatLng(i).setContent(t.gmxUtil.parseBalloonTemplate(o.templateBalloon,{properties:s,tileAttributeTypes:r.tileAttributeTypes,unitOptions:this._map.options||{},geometries:a})).openOn(this._map)}}});t.gmx.VectorLayer.include({bindClusters:function(e){return t.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new i(e,this)),this},unbindClusters:function(){return t.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}(),t.gmx=t.gmx||{};var y="maps.kosmosnimki.ru",x=2e6;t.gmx._layerClasses={Raster:t.gmx.RasterLayer,Vector:t.gmx.VectorLayer,VectorView:t.gmx.DummyLayer},t.gmx._loadingLayerClasses={},t.gmx.addLayerClass=function(e,i){t.gmx._layerClasses[e]=i},t.gmx._layerClassLoaders=[],t.gmx.addLayerClassLoader=function(e){t.gmx._layerClassLoaders.push(e),t.gmx._loadingLayerClasses={}},t.gmx._loadLayerClass=function(e){if(!t.gmx._loadingLayerClasses[e]){var i=new t.gmx.Deferred;i.resolve(),t.gmx._layerClassLoaders.forEach(function(r){i=i.then(function(i){return i?(t.gmx._layerClasses[e]=i,i):r(e)},function(){})}),i=i.then(function(i){if(i)return t.gmx._layerClasses[e]=i,i},function(){}),t.gmx._loadingLayerClasses[e]=i}return t.gmx._loadingLayerClasses[e]},t.gmx.loadLayer=function(e,i,n){return new Promise(function(o,s){var a={mapID:e,layerID:i};n=n||{},n.skipTiles||(n.skipTiles="All");for(var l in n)a[l]=n[l];var h=r.normalizeHostname(n.hostName||y);a.hostName=h,u.loadMapProperties({srs:n.srs,hostName:h,apiKey:n.apiKey,mapName:e,skipTiles:n.skipTiles}).then(function(){var r=u.findLayerInfo(h,e,i);if(!r)return void s("There is no layer "+i+" in map "+e);r.properties.hostName=h;var n=r.properties.ContentID||r.properties.type,l=function(){var e=t.gmx.createLayer(r,a);e?o(e):s("Unknown type of layer "+i)};n in t.gmx._layerClasses?l():t.gmx._loadLayerClass(n).then(l)},function(t){s("Can't load layer "+i+" from map "+e+": "+t.error)})})},t.gmx.loadLayers=function(e,i){return new Promise(function(r){Promise.all(e.map(function(e){var r=t.extend({},i,e.options);return t.gmx.loadLayer(e.mapID,e.layerID,r)})).then(function(e){r(e)})})},t.gmx.loadMap=function(e,i){return location.search.indexOf("debug=1")!==-1&&console.warn("L.gmx.loadMap:",e,i),i=t.extend({},i),i.hostName=r.normalizeHostname(i.hostName||y),i.mapName=e,i.skipTiles||(i.skipTiles="All"),i.srs||(i.srs=3857),i.ftc||(i.ftc="osm"),new Promise(function(r,n){u.loadMapProperties(i).then(function(n){var o=t.gmx._maps[i.hostName][e];if(o.loaded)r(o.loaded);else{var s=new t.gmx.gmxMap(n,i);o.loaded=s,s.layersCreated.then(function(){if(i.leafletMap||i.setZIndex)for(var e,t,o=0,a=s.layers.length-1;a>=0;a--)e=s.layers[a],t=e.getGmxProperties(),"VectorOnTop"===n.properties.LayerOrder&&e.setZIndexOffset&&"Raster"!==t.type&&e.setZIndexOffset(x),i.setZIndex&&e.setZIndex&&e.setZIndex(++o),i.leafletMap&&t.visible&&e.addTo(i.leafletMap);r(s)})}},function(t){var r=t&&t.ErrorInfo&&t.ErrorInfo.ErrorMessage||"Server error";n("Can't load map "+e+" from "+i.hostName+": "+r)})})},t.gmx.DummyLayer=function(e){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return e}},t.gmx.createLayer=function(e,i){e||(e={}),e.properties||(e.properties={type:"Vector"});var r,n=e.properties,o=n.ContentID||n.type||"Vector";if(i||(i=n),o in t.gmx._layerClasses)try{r=new t.gmx._layerClasses[o](i||e.properties),r=r.initFromDescription(e)}catch(s){r=new t.gmx.DummyLayer(n)}else r=new t.gmx.DummyLayer(n);return r}}();