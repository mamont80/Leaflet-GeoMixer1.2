/*
 Leaflet-GeoMixer, Leaflet plugin for visualization data from GeoMixer server
 (c) 2013-2016, RDC ScanEx
*/
!function(){"use strict";function e(e,t){this.layer=e,this.ts=e.options.tileSize,this.tileElem=t,this.tile=t.el;var r=t.coords,n=r.z,o=Math.pow(2,n),s=r.x%o,a=r.y%o,l=i;s<0&&(s+=o),a<0&&(a+=o),this.ntp={z:n,x:s,y:a},this.tilePoint=r,this.zoom=n,this.gmx=e._gmx,this.zKey=this.layer._tileCoordsToKey(r,n),this.worldWidthMerc=l.worldWidthMerc;var u=l.getTileNumFromLeaflet(r,n);this.tpx=this.ts*u.x,this.tpy=this.ts*(1+u.y);var h=l.tileSizes[r.z]*this.ts/256;this.tbounds=l.getBoundsByTilePoint(this.ntp,h),this.topLeft={tilePoint:r,tileSize:h,mInPixel:this.ts/h,pix:{px:this.ts*r.x,py:this.ts*r.y},wm:{x:h*r.x-this.worldWidthMerc,y:this.worldWidthMerc-h*r.y},bounds:l.getBoundsByTilePoint(r,h)},this.gmxTilePoint=u,this.showRaster=n>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||n>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this.itemsView=[],this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}var t;"undefined"!=typeof module&&module.exports?(t=require("leaflet"),t.gmx={},module.exports=t.gmx):t=window.L;var i={lastMapId:0,debug:function(){var e=/\bdebug=(\d)\b/.exec(location.search);return!!e&&Number(e[1])}(),fromWebMercY:function(e){return 90*(4*Math.atan(Math.exp(e/i.rMajor))/Math.PI-1)},newId:function(){return i.lastMapId+=1,"_"+i.lastMapId},uniqueGlobalName:function(e){var t=i.newId();return window[t]=e,t},_apiLoadedFrom:null,apiLoadedFrom:function(e){if(null===i._apiLoadedFrom){var t=document.currentScript?document.currentScript.src:i._searchApiScriptUrl(e);i._apiLoadedFrom=t?t.substring(0,t.lastIndexOf("/")):""}return i._apiLoadedFrom},_searchApiScriptUrl:function(e){for(var t=e?[new RegExp("\b"+e+"\b")]:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],r=document.getElementsByTagName("script"),n=0,o=r.length;n<o;n++){for(var s=r[n].getAttribute("src"),a=0,l=t.length;a<l;a++)if(t[a].exec(s)){i._apiLoadedFrom=s.split("?")[0];break}if(i._apiLoadedFrom)break}return i._apiLoadedFrom||""},searchScriptAPIKey:function(){for(var e=0,t=i._searchApiScriptUrl(),r=t.length;e<r;e++){var n=t[e].split("=");if("key"===n[0])return n[1]}return""},createWorker:function(e){return new Promise(function(t,i){"createImageBitmap"in window&&"Worker"in window?0===e.indexOf(location.origin)?t(new Worker(e)):fetch(e,{mode:"cors"}).then(function(e){return e.blob()}).then(function(e){t(new Worker(window.URL.createObjectURL(e,{type:"application/javascript; charset=utf-8"})))}):i({error:"Browser don`t support `createImageBitmap` or `Worker`"})})},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(e){var i=t.gmxUtil.parseUri(("http"!==e.substr(0,4)?t.gmxUtil.protocol+"//":"")+e);return e=i.host+i.directory,"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e},getLayerItemFromServer:function(e){var r=e.query?e.query:"["+e.field+"]="+e.value,n=t.gmxUtil.protocol+"//maps.kosmosnimki.ru/",o={WrapStyle:"func",geometry:!0,layer:e.layerID,query:r};return e.border&&(o.border=e.border),i.requestJSONP(e.url||(window.serverBase||n)+"VectorLayer/Search.ashx",o,e)},getCadastreFeatures:function(e){if(e.latlng){var t=e.latlng,r={WrapStyle:"func",text:(t.lat+" "+t.lng).replace(/\./g,","),tolerance:e.tolerance||0};return i.requestJSONP(e.url||"http://pkk5.rosreestr.ru/api/features/",r,e)}return null},getFormData:function(e){var t=[];for(var i in e){var r=e[i];t.push(i+"="+("object"==typeof r?JSON.stringify(r):r))}return t.join("&")},requestLink:function(e,i,r){return r=r||{},new Promise(function(n,o){var s=null;if(e.indexOf(".css")===-1){s=document.createElement("script"),s.setAttribute("charset","UTF-8");var a=t.extend({},i,t.gmx.gmxMapManager.syncParams),l=[];for(var u in a)l.push(u+"="+encodeURIComponent(a[u]));var h=e+(e.indexOf("?")===-1?"?":"&")+l.join("&"),c=function(a){t.gmxUtil.loaderStatus(h,!0),s.parentNode.removeChild(s),a?(o(e),console.warn("Not found script:",e)):n(e,i,r)};s.onerror=c,s.onload=function(){c()},t.gmxUtil.loaderStatus(h,null,"vector"),s.setAttribute("src",h)}else s=document.createElement("link"),s.rel="stylesheet",s.type="text/css",s.href=e,n(e,i,r);document.getElementsByTagName("head").item(0).appendChild(s)})},requestJSONP:function(e,r,n){n=n||{};var o=new t.gmx.Deferred,s=document.createElement("script");s.setAttribute("charset","UTF-8");var a="callbackParamName"in n?n.callbackParamName:"CallbackName",l=t.extend({},r,t.gmx.gmxMapManager.syncParams);if(a){var u=i.uniqueGlobalName(function(e){delete window[u],o.resolve(e,n)});l[a]=u}var h=[];for(var c in l)h.push(c+"="+encodeURIComponent(l[c]));var d=e+(e.indexOf("?")===-1?"?":"&")+h.join("&");return s.onerror=function(e){o.reject(e),t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},s.onload=function(){t.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},t.gmxUtil.loaderStatus(d,null,"vector"),s.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(s),o},getXmlHttp:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){e=!1}}return e},request:function(e){var r=i.getXmlHttp();if(r){if(r.open(e.type?e.type:"GET",e.url,e.async||!1),e.headers)for(var n in e.headers)r.setRequestHeader(n,e.headers[n]);var o=t.gmxUtil.loaderStatus(e.url);e.async&&(e.withCredentials&&(r.withCredentials=!0),r.onreadystatechange=function(){4===r.readyState&&(t.gmxUtil.loaderStatus(o,!0),200===r.status?(e.callback(r.responseText),r=null):e.onError&&e.onError(r))});var s=null;if(e.params){s=e.params;var a=t.gmx.gmxMapManager.getSyncParams(!0);a&&(s+="&"+a)}return r.send(s),!(!e.async&&200===r.status)||(e.callback(r.responseText),t.gmxUtil.loaderStatus(o,!0),r.status)}return e.onError&&e.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(e,t){"z"in e&&(t=e.z);var i=Math.pow(2,t),r=e.x%i+(e.x<0?i:0),n=e.y%i+(e.y<0?i:0);return{z:t,x:r%i-i/2,y:i/2-1-n%i}},getTilePosZoomDelta:function(e,t,i){var r=Math.pow(2,t-i),n=256/r,o=e.x%r,s=e.y%r;return{size:n,zDelta:r,x:n*o,y:n*s}},isItemIntersectBounds:function(e,t){var i=e.type,r=e.coordinates;"POLYGON"!==i&&"Polygon"!==i||(r=[r]);for(var n=0,o=r.length;n<o;n++)for(var s=0,a=r[n].length;s<a;s++)if(t.clipPolygon(r[n][s]).length)return!0;return!1},geoItemBounds:function(e){if(!e)return{bounds:null,boundsArr:[]};var t=e.type,r=e.coordinates,n=null,o=0,s=0,a=null,l=[];if("MULTIPOLYGON"===t||"MultiPolygon"===t)for(a=i.bounds(),o=0,s=r.length;o<s;o++){for(var u=[],h=0,c=r[o].length;h<c;h++)n=i.bounds(r[o][h]),u.push(n),0===h&&a.extendBounds(n);l.push(u)}else if("POLYGON"===t||"Polygon"===t)for(a=i.bounds(),o=0,s=r.length;o<s;o++)n=i.bounds(r[o]),l.push(n),0===o&&a.extendBounds(n);else if("POINT"===t||"Point"===t)a=i.bounds([r]);else if("MULTIPOINT"===t||"MultiPoint"===t)for(a=i.bounds(),o=0,s=r.length;o<s;o++)n=i.bounds([r[o]]),a.extendBounds(n);else if("LINESTRING"===t||"LineString"===t)a=i.bounds(r);else if("MULTILINESTRING"===t||"MultiLineString"===t)for(a=i.bounds(),o=0,s=r.length;o<s;o++)n=i.bounds(r[o]),a.extendBounds(n);return{bounds:a,boundsArr:l}},getUnFlattenGeo:function(e){var t=e.type,r=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n=e.coordinates,o=n;if(r){o=[];var s="POLYGON"===t||"Polygon"===t;s&&(n=[n]);for(var a=0,l=n.length;a<l;a++){for(var u=[],h=0,c=n[a].length;h<c;h++)u[h]=i.unFlattenRing(n[a][h]);o.push(u)}s&&(o=o[0])}return{type:t,coordinates:o}},unFlattenRing:function(e){if("number"!=typeof e[0])return e;for(var t=e.length,i=0,r=new Array(t/2),n=0;n<t;n+=2)r[i++]=[e[n],e[n+1]];return r},geoFlatten:function(e){var t=e.type,r=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n="POLYGON"===t||"Polygon"===t,o=e.coordinates;if(r){n&&(o=[o]);for(var s=0,a=o.length;s<a;s++)for(var l=0,u=o[s].length;l<u;l++)o[s][l]=i.flattenRing(o[s][l])}},flattenRing:function(e){for(var t=e.length,i=0,r="function"==typeof Float64Array?Float64Array:Array,n=new r(2*t),o=0;o<t;o++)n[i++]=e[o][0],n[i++]=e[o][1];return n},isRectangle:function(e){return e&&e[0]&&(5===e[0].length||4===e[0].length)&&(e[0][0][0]===e[0][1][0]||e[0][0][1]===e[0][1][1])&&(e[0][1][0]===e[0][2][0]||e[0][1][1]===e[0][2][1])&&(e[0][2][0]===e[0][3][0]||e[0][2][1]===e[0][3][1])&&(e[0][3][0]===e[0][0][0]||e[0][3][1]===e[0][0][1])},getGeometryBounds:function(e){var t=i.geoItemBounds(e);return t.bounds},getMarkerPolygon:function(e,t,i){var r=(e.min.x+e.max.x)/2,n=(e.min.y+e.max.y)/2;return[[r-t,n-i],[r-t,n+i],[r+t,n+i],[r+t,n-i],[r-t,n-i]]},getQuicklookPointsFromProperties:function(e,r){var n=r.tileAttributeIndexes,o={x1:i.getPropItem(r.quicklookX1||("x1"in n?"x1":"X1"),e,n)||0,y1:i.getPropItem(r.quicklookY1||("y1"in n?"y1":"Y1"),e,n)||0,x2:i.getPropItem(r.quicklookX2||("x2"in n?"x2":"X2"),e,n)||0,y2:i.getPropItem(r.quicklookY2||("y2"in n?"y2":"Y2"),e,n)||0,x3:i.getPropItem(r.quicklookX3||("x3"in n?"x3":"X3"),e,n)||0,y3:i.getPropItem(r.quicklookY3||("y3"in n?"y3":"Y3"),e,n)||0,x4:i.getPropItem(r.quicklookX4||("x4"in n?"x4":"X4"),e,n)||0,y4:i.getPropItem(r.quicklookY4||("y4"in n?"y4":"Y4"),e,n)||0},s=i.bounds([[o.x1,o.y1],[o.x2,o.y2],[o.x3,o.y3],[o.x4,o.y4]]);if(s.max.x===s.min.x||s.max.y===s.min.y)return null;if(!r.quicklookPlatform){var a=3857==r.srs?t.CRS.EPSG3857:t.Projection.Mercator,l=a.project(t.latLng(o.y1,o.x1));o.x1=l.x,o.y1=l.y,l=a.project(t.latLng(o.y2,o.x2)),o.x2=l.x,o.y2=l.y,l=a.project(t.latLng(o.y3,o.x3)),o.x3=l.x,o.y3=l.y,l=a.project(t.latLng(o.y4,o.x4)),o.x4=l.x,o.y4=l.y}return o},getPropertiesHash:function(e,t){var i={};for(var r in t)i[r]=e[t[r]];return i},getPropItem:function(e,t,i){return e in i?t[i[e]]:""},dec2rgba:function(e,t){var i=e>>16&255,r=e>>8&255,n=255&e;return"rgba("+i+", "+r+", "+n+", "+t+")"},dec2hex:function(e){return(e+16777216).toString(16).substr(-6)},dec2color:function(e,t){return t<1?this.dec2rgba(e,t):"#"+this.dec2hex(e)},oneDay:86400,isTileKeysIntersects:function(e,t){if(e.z<t.z){var i=e;e=t,t=i}var r=e.z-t.z;return e.x>>r===t.x&&e.y>>r===t.y},rotatePoints:function(e,t,i,r){var n=[];t*=Math.PI/180;var o=Math.sin(t),s=Math.cos(t);i||(i=1);for(var a=0;a<e.length;a++){var l=i*e[a].x-r.x,u=i*e[a].y-r.y;n.push({x:s*l-o*u+r.x,y:o*l+s*u+r.y})}return n},getPatternIcon:function(e,t,r){if(!t.fillPattern)return null;var n=!0,o=t.fillPattern,s=e?e.properties:null,a=o.step>0?o.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};o.patternStepFunction&&null!==s&&(a=o.patternStepFunction(s,r),n=!1),a>l.maxStep?a=l.maxStep:a<l.minStep&&(a=l.minStep);var u=o.width>0?o.width:8;o.patternWidthFunction&&null!==s&&(u=o.patternWidthFunction(s,r),n=!1),u>l.maxWidth?u=l.maxWidth:u<l.minWidth&&(u=l.minWidth);var h=t.fillOpacity;t.opacityFunction&&null!==s&&(h=t.opacityFunction(s,r)/100,n=!1);var c=[16711680,65280,255],d=null!=o.colors?o.colors:c,m=d.length,p=[],f=0;for(f=0;f<m;f++){var g=d[f];o.patternColorsFunction&&null!==o.patternColorsFunction[f]&&(g=null!==s?o.patternColorsFunction[f](s,r):c[f%3],n=!1),p.push(g)}0===m&&(p=[0],h=0,m=1);var y=u+a,v=y*m,x=0,_=0,b=v,S=v,T=o.style||"horizontal",P=!1;if("diagonal1"===T||"diagonal2"===T||"cross"===T||"cross1"===T?P=!0:"circle"===T?(S=b=2*y,x=Math.floor(S/2),_=2*Math.PI/m):"vertical"===T?b=1:"horizontal"===T&&(S=1),S*b>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var L=document.createElement("canvas");L.width=S,L.height=b;var I=L.getContext("2d");for(I.clearRect(0,0,L.width,L.height),"diagonal2"!==T&&"vertical"!==T||(I.translate(S,0),I.rotate(Math.PI/2)),f=0;f<m;f++){I.beginPath();var M=i.dec2color(p[f],h);if(I.fillStyle=M,P){var k=f*y,C=k+u;I.moveTo(k,0),I.lineTo(C,0),I.lineTo(0,C),I.lineTo(0,k),I.lineTo(k,0),k+=v,C=k+u,I.moveTo(k,0),I.lineTo(C,0),I.lineTo(0,C),I.lineTo(0,k),I.lineTo(k,0),"cross"!==T&&"cross1"!==T||(k=f*y,C=k+u,I.moveTo(S,k),I.lineTo(S,C),I.lineTo(S-C,0),I.lineTo(S-k,0),I.lineTo(S,k),k+=v,C=k+u,I.moveTo(S,k),I.lineTo(S,C),I.lineTo(S-C,0),I.lineTo(S-k,0),I.lineTo(S,k))}else"circle"===T?(I.arc(x,x,u,f*_,(f+1)*_),I.lineTo(x,x)):I.fillRect(0,f*y,S,u);I.closePath(),I.fill()}var O=document.createElement("canvas");O.width=S,O.height=b;var w=O.getContext("2d");return w.drawImage(L,0,0,S,b),{notFunc:n,canvas:O}},setSVGIcon:function(e){return'<svg role="img" class="svgIcon"><use xlink:href="#'+e+'" href="#'+e+'"></use></svg>'},getSVGIcon:function(e){var i='<svg xmlns="'+t.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',r=e.type,n=e.fillStyle||"rgba(255, 255, 255, 0.5)",o=e.strokeStyle||"#0000ff",s=e.lineWidth||2,a={className:"gmx-svg-icon"};e.className&&(a.className=e.className);var l=e.iconSize;if(a.iconSize=[l,l],i+=' height = "'+l+'px"  width = "'+l+'px">',"circle"===r){if(e.fillRadialGradient){i+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var u=e.fillRadialGradient.colorStop||e.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],h=0,c=u.length;h<c;h++){var d=u[h];i+='<stop offset="'+100*d[0]+'%"   stop-color="'+d[1]+'" stop-opacity="'+d[2]+'"/>'}i+="</radialGradient></defs>",n="url(#myRadialGradient4)",o=s=null}l/=2,i+='<g><circle cx="'+l+'" cy="'+l+'" r="'+l+'" style="',n&&(i+=" fill:"+n+";"),o&&(i+=' stroke:"'+o+";"),s&&(i+=' stroke-width:"'+s+";"),i+=';" />'}else"square"===r&&(i+='<g><rect width="'+l+'" height="'+l+'" style="',n&&(i+=" fill:"+n+";"),o&&(i+=" stroke:"+o+";"),s&&(i+=" stroke-width:"+2*s+";"),i+='" />');if(e.text){var m=e.text;i+='<text x="50%" y="50%" dy="0.4em"';for(var p in m)"count"!==p&&(i+=" "+p+'="'+m[p]+'"');i+=">"+m.count+"</text>"}return i+="</g></svg>",a.html=i,new t.DivIcon(a)},toPixels:function(e,t,i,r){var n=e[0]*r;n=.5+n<<0;var o=e[1]*r;return o=.5+o<<0,[n-t,i-o].concat(e.slice(2))},getPixelPoint:function(e,t){var r=e.topLeft,n=r.mInPixel,o=e.item,s=o.currentStyle||o.parsedStyleKeys||{},a=e.style||{},l=s.iconScale||1,u=s.iconCenter||!1,h=s.sx||a.sx||4,c=s.sy||a.sy||4,d=s.weight||a.weight||0,m=s.iconAnchor||a.iconAnchor||null,p=e.tpx,f=e.tpy;!u&&m&&(y-=m[0],g-=m[1]),h*=l,c*=l,h+=d,c+=d;var g=f-t[1]*n,y=t[0]*n-p;return y-h>256?y=(t[0]-2*i.worldWidthMerc)*n-p:y<-h&&(y=(t[0]+2*i.worldWidthMerc)*n-p),g-c>256||y-h>256||y+h<0||g+c<0?null:{sx:h,sy:c,px1:.5+y<<0,py1:.5+g<<0}},getImageData:function(e){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return null;var i=document.createElement("canvas"),r=e.width,n=e.height;i.width=r,i.height=n;var o=i.getContext("2d");return o.drawImage(e,0,0),o.getImageData(0,0,r,n).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(e){return e===i.getIEversion()},gtIE:function(e){return e<i.getIEversion()},getIEversion:function(){var e=navigator.userAgent||"",t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var i=e.indexOf("Trident/");if(i>0){var r=e.indexOf("rv:");return parseInt(e.substring(r+3,e.indexOf(".",r)),10)}var n=e.indexOf("Edge/");return n>0?parseInt(e.substring(n+5,e.indexOf(".",n)),10):-1},replaceColor:function(e,i,r){if(t.gmxUtil.isIE9||t.gmxUtil.isIE10)return e;var n=document.createElement("canvas"),o=e.width,s=e.height;n.width=o,n.height=s;var a,l=!1,u=n.getContext("2d");if("string"==typeof i&&(i=parseInt("0x"+i.replace(/#/,""))),i!==this.DEFAULT_REPLACEMENT_COLOR){var h=i>>16&255,c=i>>8&255,d=255&i;r?a=u.createImageData(o,s):(u.drawImage(e,0,0),a=u.getImageData(0,0,o,s),r=a.data);for(var m=a.data,p=0,f=r.length;p<f;p+=4)255!==r[p]&&238!==r[p]||0!==r[p+1]||255!==r[p+2]||(m[p]=h,m[p+1]=c,m[p+2]=d,m[p+3]=r[p+3],l=!0)}return l?u.putImageData(a,0,0):u.drawImage(e,0,0),n},drawIconPath:function(e,r){if(t.Util.isArray(e)&&!(e.length<3)&&r.ctx){var n=!1,o=r.ctx,s=r.radian;(r.px||r.py)&&(o.translate(r.px||0,r.py||0),n=!0),!s&&r.rotateRes&&(s=Math.PI+i.degRad(r.rotateRes)),s&&(o.rotate(s),n=!0),o.moveTo(e[0],e[1]);for(var a=2,l=e.length;a<l;a+=2)o.lineTo(e[a],e[a+1]);n&&o.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(e){var r=e.gmx,n=e.topLeft,o=n.mInPixel,s=e.pointAttr,a=e.style||{},l=e.item,u=l.currentStyle||l.parsedStyleKeys,h=u.iconScale||1,c=u.image,d=s.sx,m=s.sy,p=s.px1,f=s.py1,g=p,y=f,v=e.ctx;if("image"===u.type&&(d=a.sx,m=a.sy,c=a.image),u.iconCenter?(g-=d/2,y-=m/2):"circle"===a.type&&(p+=d/2,f+=m/2),u.iconPath&&(e.px=p,e.py=f,e.rotateRes=u.rotate||0),c)"iconColor"in u&&!t.gmxUtil.isIE11&&(c=this.replaceColor(c,u.iconColor,e.imageData)),a.rotateRes=u.rotate||0,"opacity"in a&&(v.globalAlpha=u.opacity||a.opacity),r.transformFlag?(v.setTransform(o,0,0,o,-e.tpx,e.tpy),v.drawImage(c,p,-f,d,m),v.setTransform(o,0,0,-o,-e.tpx,e.tpy)):(1!==h&&(d*=h,m*=h,p=s.px1,f=s.py1,g=p,y=f,u.iconCenter&&(g-=d/2,y-=m/2)),a.rotateRes?(v.translate(p,f),v.rotate(i.degRad(a.rotateRes)),v.translate(-p,-f),v.drawImage(c,g,y,d,m),v.setTransform(1,0,0,1,0,0)):v.drawImage(c,g,y,d,m)),"opacity"in a&&(v.globalAlpha=1);else if(a.fillColor||u.fillRadialGradient){if(v.beginPath(),u.iconPath)i.drawIconPath(u.iconPath,e);else if("circle"===a.type||u.fillRadialGradient){var x=a.iconSize/2;if(u.fillRadialGradient){var _=u.fillRadialGradient;x=_.r2*h;for(var b=v.createRadialGradient(p+_.x1,f+_.y1,_.r1*h,p+_.x2,f+_.y2,x),S=0,T=_.addColorStop.length;S<T;S++){var P=_.addColorStop[S];b.addColorStop(P[0],P[1])}v.fillStyle=b}v.arc(p,f,x,0,2*Math.PI)}else v.fillRect(g,y,d,m);v.fill()}u.strokeStyle&&(v.beginPath(),u.iconPath?i.drawIconPath(u.iconPath,e):"circle"===a.type?v.arc(p,f,a.iconSize/2,0,2*Math.PI):v.strokeRect(g,y,d,m),v.stroke())},lineToCanvasAsIcon:function(e,t){var r=e.length,n=t.ctx,o=t.item,s=o.currentStyle||o.parsedStyleKeys,a=s.iconPath;if(r>0){"getLineDash"in n&&n.getLineDash().length>0&&n.setLineDash([]),n.beginPath();for(var l,u=0;u<r;u++)l=e[u],i.drawIconPath(a,{ctx:n,px:l.x,py:l.y,radian:l.radian});s.strokeStyle&&n.stroke(),s.fillStyle&&n.fill()}},lineToCanvas:function(e){var t=e.topLeft,r=t.mInPixel,n=e.coords,o=e.ctx,s=e.item,a=s.currentStyle||s.parsedStyleKeys,l=a.iconPath?[]:null,u=null,h=null;o.beginPath();for(var c=0,d=n.length;c<d;c++){var m=i.toPixels(n[c],e.tpx,e.tpy,r,e.topLeft),p=m[0],f=m[1];u===p&&h===f||(l&&l.push({x:p,y:f,radian:m[2]}),0===c?o.moveTo(p,f):o.lineTo(p,f),u=p,h=f)}return o.stroke(),l},getCoordsPixels:function(e){for(var t=e.gmx,r=e.coords,n=e.hiddenLines||[],o=[],s=[],a=!1,l={gmx:t,topLeft:e.topLeft,tpx:e.tpx,tpy:e.tpy,coords:null,hiddenLines:null},u=0,h=r.length;u<h;u++){for(var c=r[u],d=n[u]||[],m=[],p=[],f=0,g=c.length;f<g;f++){l.coords=c[f],l.hiddenLines=d[f]||[];var y=i.getRingPixels(l);m.push(y.coords),p.push(y.hidden),y.hidden&&(a=!0)}o.push(m),s.push(p)}return{coords:o,hidden:a?s:null,z:e.topLeft.tilePoint.z}},getRingPixels:function(e){if(0===e.coords.length)return null;for(var t=e.topLeft,i=t.mInPixel,r=e.coords,n=e.hiddenLines||null,o=e.tpx,s=e.tpy,a=0,l=0,u=null,h=null,c="number"==typeof r[0]?2:1,d=[],m=[],p=0,f=r.length;p<f;p+=c){var g=!1;n&&p===n[l]&&(g=!0,l++);var y=1===c?r[p]:[r[p],r[p+1]],v=Math.round(y[0]*i),x=Math.round(y[1]*i),_=Math.round(v-o),b=Math.round(s-x);u===_&&h===b||(u=_,h=b,g&&m.push(a),d[a++]=v,d[a++]=x)}return{coords:d,hidden:m.length?m:null}},polygonToCanvas:function(e){if(0===e.coords.length)return null;var t=e.hiddenLines||null,i=e.coords,r=e.ctx,n=e.tpx,o=e.tpy,s=0,a=0,l="number"==typeof i[0]?2:1,u=null,h=null;r.beginPath();for(var c=0,d=i.length;c<d;c+=l){var m=1===l?i[c]:[i[c],i[c+1]],p=Math.round(m[0]-n),f=Math.round(o-m[1]),g=!1,y="round";t&&c===t[a]&&(g=!0,y="butt",a++),r.lineCap!==y&&(r.lineCap=y),u===p&&h===f||(r[g?"moveTo":"lineTo"](p,f),u=p,h=f,s++)}1===s&&r.lineTo(u+1,h),r.stroke()},polygonToCanvasFill:function(e){if(!(e.coords.length<3)){var t=e.coords,i=e.tpx,r=e.tpy,n=1,o=e.ctx;o.lineWidth=0,"number"==typeof t[0]?(n=2,o.moveTo(Math.round(t[0]-i),Math.round(r-t[1]))):o.moveTo(Math.round(t[0][0]-i),Math.round(r-t[0][1]));for(var s=n,a=t.length;s<a;s+=n){var l=1===n?t[s]:[t[s],t[s+1]];o.lineTo(Math.round(l[0]-i),Math.round(r-l[1]))}}},isPatternNode:function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(e,t){if(t){if(!i.labelCanvasContext){var r=document.createElement("canvas");r.width=r.height=512,i.labelCanvasContext=r.getContext("2d")}var n=i.labelCanvasContext;n.clearRect(0,0,512,512),n.font!==t.font&&(n.font=t.font),n.fillStyle!==t.fillStyle&&(n.fillStyle=t.fillStyle);var o=e.split("\n");return o.map(function(e){return n.fillText(e,0,0),[e,n.measureText(e).width]})}return 0},setLabel:function(e,i,r,n){var o=r[0],s=r[1];e.shadowColor!==n.strokeStyle&&(e.shadowColor=n.strokeStyle),e.shadowBlur!==n.shadowBlur&&(e.shadowBlur=n.shadowBlur),e.font!==n.font&&(e.font=n.font),t.Browser.gecko?e.strokeStyle!==n.fillStyle&&(e.strokeStyle=n.fillStyle):(e.strokeStyle!==n.strokeStyle&&(e.strokeStyle=n.strokeStyle),e.fillStyle!==n.fillStyle&&(e.fillStyle=n.fillStyle)),e.strokeText(i,o,s),t.Browser.gecko||e.fillText(i,o,s)},worldWidthFull:40075016.685578495,rMajor:6378137,degRad:function(e){return e*(Math.PI/180)},distVincenty:function(e,t,r,n){for(var o={lon:i.degRad(e),lat:i.degRad(t)},s={lon:i.degRad(r),lat:i.degRad(n)},a=i.rMajor,l=6356752.3142,u=1/298.257223563,h=s.lon-o.lon,c=Math.atan((1-u)*Math.tan(o.lat)),d=Math.atan((1-u)*Math.tan(s.lat)),m=Math.sin(c),p=Math.cos(c),f=Math.sin(d),g=Math.cos(d),y=h,v=2*Math.PI,x=20;Math.abs(y-v)>1e-12&&--x>0;){var _=Math.sin(y),b=Math.cos(y),S=Math.sqrt(g*_*(g*_)+(p*f-m*g*b)*(p*f-m*g*b));if(0===S)return 0;var T=m*f+p*g*b,P=Math.atan2(S,T),L=p*g*_/S,I=1-L*L,M=T-2*m*f/I;isNaN(M)&&(M=0);var k=u/16*I*(4+u*(4-3*I));v=y,y=h+(1-k)*u*L*(P+k*S*(M+k*T*(-1+2*M*M)))}if(0===x)return NaN;var C=I*(a*a/(l*l)-1),O=1+C/16384*(4096+C*(-768+C*(320-175*C))),w=C/1024*(256+C*(-128+C*(74-47*C))),D=w*S*(M+w/4*(T*(-1+2*M*M)-w/6*M*(-3+4*S*S)*(-3+4*M*M))),F=l*O*(P-D);return F},_vfi:function(e,t,i){return[-Math.cos(e)*Math.sin(t)+Math.sin(e)*Math.sin(i)*Math.cos(t),Math.cos(e)*Math.cos(t)+Math.sin(e)*Math.sin(i)*Math.sin(t),-Math.sin(e)*Math.cos(i)]},getCircleLatLngs:function(e,r){var n=0,o=0;if(e instanceof t.LatLng)n=e.lng,o=e.lat;else{if(!t.Util.isArray(e))return null;n=e[1],o=e[0]}for(var s=Math.PI/180,a=n*s,l=o*s,u=i.rMajor,h=u*Math.sin(r/u),c=u*Math.cos(r/u),d=[c*Math.cos(l)*Math.cos(a),c*Math.cos(l)*Math.sin(a),c*Math.sin(l)],m=[],p=0,f=2*Math.PI+1e-6;p<f;p+=s){for(var g=i._vfi(p,a,l),y=[],v=0;v<3;v++)y[v]=d[v]+h*g[v];var x=Math.acos(y[0]/Math.sqrt(y[0]*y[0]+y[1]*y[1]))/s;y[1]<0&&(x=-x),x<n-180?x+=360:x>n+180&&(x-=360),m.push([Math.asin(y[2]/u)/s,x])}return m},parseCoordinates:function(e){var i=null,r=/\(EPSG:(\d+)\)/g,n=r.exec(e);if(n&&(i=n[1],e=e.replace(r,"")),e.match(/[йцукенгшщзхъфывапролджэячсмитьбюЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮqrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(e.indexOf(" ")===-1&&e.indexOf(",")===-1)return null;e.indexOf(" ")!==-1&&(e=e.replace(/,/g,"."));var o=[];for(r=/(-?\d+(\.\d+)?)([^\d\-]*)/g,n=r.exec(e);n;)o.push(n[1]),n=r.exec(e);if(o.length<2)return null;var s,a=Math.floor(o.length/2),l=0,u=1;for(s=0;s<a;s++)l+=parseFloat(o[s])*u,u/=60;var h=0;for(u=1,s=a;s<o.length;s++)h+=parseFloat(o[s])*u,u/=60;Math.max(e.indexOf("N"),e.indexOf("S"))>Math.max(e.indexOf("E"),e.indexOf("W"))&&(n=h,h=l,l=n);var c;return 3857==i&&(c=t.Projection.SphericalMercator.unproject(new t.Point(l,h)),h=c.lng,l=c.lat),(Math.abs(h)>180||Math.abs(l)>180)&&(c=t.Projection.Mercator.unproject(new t.Point(l,h)),h=c.lng,l=c.lat),e.indexOf("W")!==-1&&(h=-h),e.indexOf("S")!==-1&&(l=-l),[l,h]},pad2:function(e){return e>=0&&e<10?"0"+e:""+e},trunc:function(e){return(""+(Math.round(1e7*e)/1e7+1e-8)).substring(0,9)},formatDegrees:function(e,t){e=Math.round(1e7*e)/1e7+1e-8;var r=Math.floor(e),n=Math.floor(60*(e-r)),o=i.toPrecision(3600*(e-r-n/60),2),s=i.pad2(r)+"°";return void 0===t&&(t=2),t>0&&(s+=i.pad2(n)+"'"),t>1&&(s+=i.pad2(o)+'"'),s},latLonFormatCoordinates:function(e,t){return e%=360,e>180?e-=360:e<-180&&(e+=360),i.formatDegrees(Math.abs(t))+(t>0?" N, ":" S, ")+i.formatDegrees(Math.abs(e))+(e>0?" E":" W")},latLonToString:function(e,t,r){return e%=360,e>180?e-=360:e<-180&&(e+=360),r&&(e=i.toPrecision(e,r),t=i.toPrecision(t,r)),t+(t>0?" N, ":" S, ")+e+(e>0?" E":" W")},formatCoordinates:function(e,t){return i.latLonFormatCoordinates(e,t)},latLonFormatCoordinates2:function(e,t){return i.trunc(Math.abs(t))+(t>0?" N, ":" S, ")+i.trunc(Math.abs(e))+(e>0?" E":" W")},formatCoordinates2:function(e,t){return i.latLonFormatCoordinates2(e,t)},getPixelScale:function(e){return 256/i.tileSizes[e]},forEachPoint:function(e,t){if(!e||0===e.length)return[];var r,n,o=[];if(e[0].length)for(r=0,n=e.length;r<n;r++)"string"!=typeof e[r]&&o.push(i.forEachPoint(e[r],t));else{if(2===e.length)return t(e);for(r=0,n=e.length/2;r<n;r++)o.push(t([e[2*r],e[2*r+1]]))}return o},getItemCenter:function(e,t){var r=e.bounds,n=r.min,o=r.max,s=e.type,a="POINT"===s||"MULTIPOINT"===s,l=a?[n.x,n.y]:[(n.x+o.x)/2,(n.y+o.y)/2];if("MULTIPOLYGON"===s)return l;if("POLYGON"===s)for(var u=0,h=t.length;u<h;u++){var c=t[u],d=c.geo,m=d.coordinates,p=c.dataOption,f=p.bounds;if(f.contains(l)){"POLYGON"===d.type&&(m=[m]);for(var g=0,y=m.length;g<y;g++)for(var v=0,x=m[g],_=x.length;v<_;v++){var b=i.getHSegmentsInPolygon(l[1],x[v]);if(b)return b.max.center}}}else{if("POINT"===s||"MULTIPOINT"===s)return l;if("LINESTRING"===s||"MULTILINESTRING"===s)return l}return null},getHSegmentsInPolygon:function(e,t){var i,r,n,o=[],s=1,a=t[0];"number"==typeof t[0]&&(s=2,a=[t[0],t[1]]);var l=e>a[1];for(i=s,r=t.length;i<r;i+=s){var u=1===s?t[i]:[t[i],t[i+1]],h=e>u[1];l!==h&&o.push(a[0]-(a[0]-u[0])*(a[1]-e)/(a[1]-u[1])),a=u,l=h}if(r=o.length){o=o.sort();var c=0,d=-1;for(i=1;i<r;i+=2){var m=i-1,p=Math.abs(o[i]-o[m]);p>c&&(c=p,d=m)}n={y:e,segArr:o,max:{width:c,center:[(o[d]+o[d+1])/2,e]}}}return n},isPointInPolygonArr:function(e,t){var i=!1,r=e[0],n=e[1],o=1,s=t[0];"number"==typeof t[0]&&(o=2,s=[t[0],t[1]]);for(var a=o,l=t.length;a<l;a+=o){var u=1===o?t[a]:[t[a],t[a+1]],h=Math.min(s[0],u[0]),c=Math.max(s[0],u[0]),d=Math.max(s[1],u[1]);if(r>h&&r<=c&&n<=d&&s[0]!==u[0]){var m=(r-s[0])*(u[1]-s[1])/(u[0]-s[0])+s[1];(s[1]===u[1]||n<=m)&&(i=!i)}s=u}return i},isPointInPolygonWithHoles:function(e,t){if(!i.isPointInPolygonArr(e,t[0]))return!1;for(var r=1,n=t.length;r<n;r++)if(i.isPointInPolygonArr(e,t[r]))return!1;return!0},isClockwise:function(e){for(var t,i=0,r=0,n=e.length;r<n;r++)t=(r+1)%n,i+=e[r][0]*e[t][1],i-=e[t][0]*e[r][1];return i<0},isPointInPolyLine:function(e,i,r,n){var o=e[0],s=e[1],a={x:o,y:s},l=o-i,u=o+i,h=s-i,c=s+i,d=0;i*=i;for(var m=1,p=r.length;m<p;m++)if(n&&m===n[d])d++;else{var f=r[m-1],g=r[m],y=f[0],v=f[1],x=g[0],_=g[1];if(!(Math.max(y,x)<l||Math.min(y,x)>u||Math.max(v,_)<h||Math.min(v,_)>c)){var b=t.LineUtil._sqClosestPointOnSegment(a,{x:y,y:v},{x:x,y:_},!0);if(b<i)return!0}}return!1},isPointInLines:function(e){for(var t=e.coords,r=e.point,n=e.delta,o=e.boundsArr,s=e.hidden,a=0,l=t.length,u=!1;a<l;a++)if(u=!o[a]||o[a].contains(r),u&&i.isPointInPolyLine(r,n,t[a],s?s[a]:null))return!0;return!1},getLength:function(e,r){var n=0;if(e&&e.length){var o=!1,s=!1;r=void 0===r||r,e.forEach(function(e){if(t.Util.isArray(e)){if(t.Util.isArray(e[0]))return n+=i.getLength(e,r);r&&(e=t.Projection.Mercator.unproject({x:e[0],y:e[1]}))}o!==!1&&s!==!1&&(n+=parseFloat(i.distVincenty(o,s,e.lng,e.lat))),o=e.lng,s=e.lat})}return n},getText:function(e){return e=e||"",t.gmxLocale?t.gmxLocale.getText(e):e.split(".").pop()},prettifyDistance:function(e,t){var r=" "+i.getText("units.km");return"nm"===t?Math.round(.539956803*e)/1e3+" "+i.getText("units.nm"):"km"===t?Math.round(e)/1e3+r:e<2e3||"m"===t?Math.round(e)+" "+i.getText("units.m"):e<2e5?Math.round(e/10)/100+r:Math.round(e/1e3)+r},geoJSONGetLength:function(e){var t,r,n,o,s,a=0;if("GeometryCollection"===e.type?a+=e.geometries.forEach(i.geoJSONGetLength):"Feature"===e.type?a+=i.geoJSONGetLength(e.geometry):"FeatureCollection"===e.type&&(a+=e.features.forEach(i.geoJSONGetLength)),"LineString"===e.type||"MultiLineString"===e.type)for(s=e.coordinates,"LineString"===e.type&&(s=[s]),t=0,n=s.length;t<n;t++)a+=i.getRingLength(s[t]);if("Polygon"===e.type||"MultiPolygon"===e.type)for(s=e.coordinates,"Polygon"===e.type&&(s=[s]),t=0,n=s.length;t<n;t++)for(r=0,o=s[t].length;r<o;r++)a+=i.getRingLength(s[t][r]);return a},getRingLength:function(e){var r=0;if(e&&e.length){var n=!1,o=!1;e.forEach(function(e){return t.Util.isArray(e)&&e.length>2?r+=i.getRingLength(e):(n!==!1&&o!==!1&&(r+=parseFloat(i.distVincenty(n,o,e[0],e[1]))),n=e[0],void(o=e[1]))})}return r},geoJSONGetArea:function(e){var t=0;if("GeometryCollection"===e.type?t+=e.geometries.forEach(i.geoJSONGetArea):"Feature"===e.type?t+=i.geoJSONGetArea(e.geometry):"FeatureCollection"===e.type&&(t+=e.features.forEach(i.geoJSONGetArea)),"Polygon"===e.type||"MultiPolygon"===e.type){var r=e.coordinates;"Polygon"===e.type&&(r=[r]);for(var n=0,o=r.length;n<o;n++){t+=i.getRingArea(r[n][0]);for(var s=1,a=r[n].length;s<a;s++)t-=i.getRingArea(r[n][s])}}return t},geoJSONGetLatLng:function(e){if("Feature"===e.type)return i.geoJSONGetLatLng(e.geometry);if("Point"===e.type)return t.latLng(e.coordinates[1],e.coordinates[0]);throw new Error("cannot get "+e.type+" latLng")},getRingArea:function(e){for(var t=0,r=0,n=e.length;r<n;r++){var o=r===n-1?0:r+1,s=e[r],a=e[o];t+=s[0]*Math.sin(i.degRad(a[1]))-a[0]*Math.sin(i.degRad(s[1]))}var l=Math.abs(t*i.lambertCoefX*i.lambertCoefY/2);return l},getArea:function(e){for(var t=0,r=0,n=e.length;r<n;r++){var o=r===n-1?0:r+1,s=e[r],a=e[o];t+=s.lng*Math.sin(i.degRad(a.lat))-a.lng*Math.sin(i.degRad(s.lat))}return Math.abs(t*i.lambertCoefX*i.lambertCoefY/2)},prettifyArea:function(e,t){var r=" "+i.getText("units.km2");return"km2"===t?""+Math.round(e/100)/1e4+r:"ha"===t?""+Math.round(e/100)/100+" "+i.getText("units.ha"):e<1e5||"m2"===t?Math.round(e)+" "+i.getText("units.m2"):e<3e6?(""+Math.round(e/1e3)/1e3).replace(".",",")+r:e<3e7?(""+Math.round(e/1e4)/100).replace(".",",")+r:e<3e8?(""+Math.round(e/1e5)/10).replace(".",",")+r:Math.round(e/1e6)+r},geoLength:function(e){var t=0,r=e.type;if("MULTILINESTRING"===r||"MultiLineString"===r){for(var n=0,o=e.coordinates.length;n<o;n++)t+=i.geoLength({type:"LINESTRING",coordinates:e.coordinates[n]});return t}return"LINESTRING"!==r&&"LineString"!==r||(t=i.getLength(e.coordinates)),t},geometryToGeoJSON:function(e,t,r){if(!e)return null;var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return t&&(o=i.coordsFromMercator(n,o,r)),{type:n,coordinates:o}},convertGeometry:function(e,t,r){var n="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,o=e.coordinates;return o=t?i.coordsFromMercator(n,o,r):i.coordsToMercator(n,o,r),{type:e.type,coordinates:o}},geoJSONtoGeometry:function(e,t){if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);if("Feature"===e.type)return i.geoJSONtoGeometry(e.geometry,t);if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);var r="MultiPolygon"===e.type?"MULTIPOLYGON":"Polygon"===e.type?"POLYGON":"MultiLineString"===e.type?"MULTILINESTRING":"LineString"===e.type?"LINESTRING":"MultiPoint"===e.type?"MULTIPOINT":"Point"===e.type?"POINT":e.type,n=e.coordinates;return t&&(n=i.coordsToMercator(e.type,n)),{type:r,coordinates:n}},_coordsConvert:function(e,r,n,o){var s,a,l,u=[];if("Point"===e)n?(l=(o?t.CRS.EPSG3857:t.Projection.Mercator).project({lat:r[1],lng:r[0]}),u=[l.x,l.y]):(l=t.Projection.Mercator.unproject({y:r[1],x:r[0]}),u=[l.lng,l.lat],o&&(u[1]=i.fromWebMercY(r[1])));else if("LineString"===e||"MultiPoint"===e)for(s=0,a=r.length;s<a;s++)u.push(i._coordsConvert("Point",r[s],n,o));else if("Polygon"===e||"MultiLineString"===e)for(s=0,a=r.length;s<a;s++)u.push(i._coordsConvert("MultiPoint",r[s],n,o));else if("MultiPolygon"===e)for(s=0,a=r.length;s<a;s++)u.push(i._coordsConvert("Polygon",r[s],n,o));return u},coordsFromMercator:function(e,t,r){
return i._coordsConvert(e,t,!1,r)},coordsToMercator:function(e,t,r){return i._coordsConvert(e,t,!0,r)},transformGeometry:function(e,t){return e?{type:e.type,coordinates:i.forEachPoint(e.coordinates,function(e){return t(e)})}:e},geoArea:function(e,r){var n,o,s=0,a=e.type||"";if(r=void 0===r||r,"MULTIPOLYGON"===a||"MultiPolygon"===a){for(n=0,o=e.coordinates.length;n<o;n++)s+=i.geoArea({type:"POLYGON",coordinates:e.coordinates[n]},r);return s}if("POLYGON"===a||"Polygon"===a){for(s=i.geoArea(e.coordinates[0],r),n=1,o=e.coordinates.length;n<o;n++)s-=i.geoArea(e.coordinates[n],r);return s}if(e.length){var l=[],u="number"==typeof e[0]?2:1;for(n=0,o=e.length;n<o;n+=u){var h=1===u?e[n]:[e[n],e[n+1]];l.push(r?t.Projection.Mercator.unproject({y:h[1],x:h[0]}):{lat:h[1],lng:h[0]})}return i.getArea(l)}return 0},getGeoJSONSummary:function(e,t){var r,n,o,s=e.type,a=t||{},l=0;if("Point"===s)o=e.coordinates,l=i.formatCoordinates(o[0],o[1]);else if("Polygon"===s)l=i.prettifyArea(i.geoArea(e,!1),a.squareUnit);else if("MultiPolygon"===s){for(o=e.coordinates,r=0,n=o.length;r<n;r++)l+=i.geoArea({type:"Polygon",coordinates:o[r]},!1);l=i.prettifyArea(l,a.squareUnit)}else if("LineString"===s)l=i.prettifyDistance(i.geoJSONGetLength(e),a.distanceUnit);else if("MultiLineString"===s){for(o=e.coordinates,r=0,n=o.length;r<n;r++)l+=i.geoJSONGetLength({type:"LineString",coordinates:o[r]});l=i.prettifyDistance(l,a.distanceUnit)}return l},getCoordinatesString:function(e,r){var n,o=e.lng,s=e.lat,a=["",""," (EPSG:3395)"," (EPSG:3857)"],l=a.length,u="";return r=r||0,o>180&&(o-=360),o<-180&&(o+=360),r%l===0?u=i.formatCoordinates2(o,s):r%l===1?u=i.formatCoordinates(o,s):r%l===2?(n=t.Projection.Mercator.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[2]):(n=t.CRS.EPSG3857.project(new t.LatLng(s,o)),u=""+Math.round(n.x)+", "+Math.round(n.y)+a[3]),u},getGeometriesSummary:function(e,r){var n="",o="",s=0;return r||(r={}),e&&e.forEach(function(e){if(e){o=e.type.toUpperCase();var a=t.gmxUtil.geometryToGeoJSON(e,!0,3857==r.srs);if(o.indexOf("POINT")!==-1){var l=t.latLng(a.coordinates.reverse());n="<b>"+i.getText("Coordinates")+"</b>: "+i.getCoordinatesString(l,r.coordinatesFormat)}else o.indexOf("LINESTRING")!==-1?s+=i.geoJSONGetLength(a):o.indexOf("POLYGON")!==-1&&(s+=i.geoJSONGetArea(a))}}),n||(o.indexOf("LINESTRING")!==-1?n="<b>"+i.getText("Length")+"</b>: "+i.prettifyDistance(s,r.distanceUnit):o.indexOf("POLYGON")!==-1&&(n="<b>"+i.getText("Area")+"</b>: "+i.prettifyArea(s,r.squareUnit))),n},getGeometrySummary:function(e,t){return i.getGeometriesSummary([e],t||{})},chkOnEdge:function(e,t,i){return e[0]<i.min.x&&t[0]<i.min.x||e[0]>i.max.x&&t[0]>i.max.x||(e[1]<i.min.y&&t[1]<i.min.y||e[1]>i.max.y&&t[1]>i.max.y)},getHidden:function(e,t){for(var r=[],n="number"==typeof e[0]?2:1,o=null,s=0,a=e.length;s<a;s+=n){var l=1===n?e[s]:[e[s],e[s+1]];o&&i.chkOnEdge(l,o,t)&&r.push(s),o=l}return r},getNormalizeBounds:function(e,r){var n=e.getNorthWest(),o=e.getSouthEast(),s=n.lng,a=o.lng,l=(a-s)/2,u=null,h=null,c=[];if(l>=180)s=-180,a=180;else if(a>180||s<-180){var d=(a+s)/2%360;d>180?d-=360:d<-180&&(d+=360),s=d-l,a=d+l,s<-180?(u=s+360,h=180,s=-180):a>180&&(u=-180,h=a-360,a=180)}var m={x:s,y:o.lat},p={x:a,y:n.lat};if(void 0!==r&&(m=t.Projection.Mercator.project(new t.LatLng([o.lat,s])),p=t.Projection.Mercator.project(new t.LatLng([n.lat,a])),m.y-=r,p.y-=r),c.push(i.bounds([[m.x,m.y],[p.x,p.y]])),u){var f={x:u,y:o.lat},g={x:h,y:n.lat};void 0!==r&&(f=t.Projection.Mercator.project(new t.LatLng([o.lat,u])),g=t.Projection.Mercator.project(new t.LatLng([n.lat,h])),f.y-=r,g.y-=r),c.push(i.bounds([[f.x,f.y],[g.x,g.y]]))}return c},toPrecision:function(e,t){var i=Math.pow(10,t?t:4);return Math.round(i*e)/i},getBoundsByTilePoint:function(e){var t=i.getTileNumFromLeaflet(e);return i.getTileBounds(t.x,t.y,t.z)},getTileBounds:function(e,t,r){var n=i.tileSizes[r],o=e*n,s=t*n;return i.bounds([[o,s],[o+n,s+n]])},parseTemplate:function(e,t){var i=e.match(/\[([^\]]+)\]/gi);if(i)for(var r=0,n=i.length;r<n;r++){var o=i[r],s=o.substr(1,o.length-2),a=s in t?t[s]:"";e=e.replace(o,a)}return e},getDefaultBalloonTemplate:function(e,t){var i="";for(var r in e)(!t||r in t)&&(i+="<b>"+r+":</b> ["+r+"]<br />");return i+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(e,r){var n=r.properties;e||(e=i.getDefaultBalloonTemplate(n,r.tileAttributeTypes));var o=e.match(/\[([^\]]+)\]/gi);if(o)for(var s=r.tileAttributeTypes,a=r.unitOptions,l=r.geometries,u=0,h=o.length;u<h;u++){var c=o[u],d=c.substr(1,c.length-2),m="";d in n?m=t.gmxUtil.attrToString(s[d],n[d]):"SUMMARY"===d&&(m=r.summary||t.gmxUtil.getGeometriesSummary(l,a)),e=e.replace(c,m)}return e},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(e){var r=i.defaultStyles,n=t.extend({},r);return n.RenderStyle=r.RenderStyle[e],n},toServerStyle:function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,s=n.client.length;o<s;o++){var a=n.client[o];if(a in e){t[r]||(t[r]={});var l=e[a];"opacity"!==a&&"fillOpacity"!==a||(l*=100),t[r][n.server[o]]=l}}return"iconAnchor"in e&&(t.marker||(t.marker={}),t.marker.dx=-e.iconAnchor[0],t.marker.dy=-e.iconAnchor[1]),t},fromServerStyle:function(e){var r,n,o,s,a,l={type:""};for(s in i.styleKeys){var u=i.styleKeys[s];for(n=0,o=u.client.length;n<o;n++)a=u.client[n],a in e&&(l[a]=e[a]);if(r=e[s],r&&"object"==typeof r)for(n=0,o=u.server.length;n<o;n++)if(a=u.server[n],a in r){var h=u.client[n],c=r[a];if("string"==typeof c){if(i.styleFuncKeys[h])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=t.gmx.Parsers.parseExpression(c);null===d?c=i.styleFuncError[h]():l[i.styleFuncKeys[h]]=d}}else"opacity"===a&&(c/=100);l[h]=c}}if(e.marker&&(r=e.marker,"dx"in r||"dy"in r)){var m=r.dx||0,p=r.dy||0;l.iconAnchor=[-m,-p]}for(s in e)i.styleKeys[s]||(l[s]=e[s]);return l},getUnixTimeFromStr:function(e){var i=t.Util.trim(e).split(" "),r=i[0].split("."),n=i[1]?i[1].split(":"):[0,0,0];return 4===r[2].length&&(r=r.reverse()),Date.UTC(r[0],r[1]-1,r[2],n[0]||0,n[1]||0,n[2]||0)/1e3},getDateFromStr:function(e){var i=t.Util.trim(e).split(" ");i=i[0].split("."),4===i[2].length&&(i=i.reverse());var r=new Date(i[0],i[1]-1,i[2]);return r},getUTCdate:function(e){var t=new Date(1e3*e);return[t.getUTCFullYear(),i.pad2(t.getUTCMonth()+1),i.pad2(t.getUTCDate())].join(".")},getUTCtime:function(e){var t=Math.floor(e/3600),r=Math.floor((e-3600*t)/60),n=Math.floor(e-3600*t-60*r);return[i.pad2(t),i.pad2(r),i.pad2(n)].join(":")},getUTCdateTime:function(e){var t=e%86400;return t?[i.getUTCdate(e),i.getUTCtime(e%86400)].join(" "):i.getUTCdate(e)},attrToString:function(e,i){return"date"===e?i?t.gmxUtil.getUTCdate(i):i:"time"===e?i?t.gmxUtil.getUTCtime(i):i:"datetime"===e&&i?t.gmxUtil.getUTCdateTime(i):i},getTileAttributes:function(e){var t={},i={};if(e.attributes){var r=e.attributes,n=e.attrTypes||null;e.identityField&&(t[e.identityField]=0);for(var o=0;o<r.length;o++){var s=r[o];t[s]=o+1,i[s]=n?n[o]:"string"}}return{tileAttributeTypes:i,tileAttributeIndexes:t}}};i.lambertCoefX=100*i.distVincenty(0,0,.01,0),i.lambertCoefY=100*i.distVincenty(0,0,0,.01)*180/Math.PI,function(){for(var e=0;e<30;e++)i.tileSizes[e]=i.worldWidthFull/Math.pow(2,e)}(),i.worldWidthMerc=i.worldWidthFull/2,i.Bounds=function(e){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(e)},i.Bounds.prototype={extend:function(e,t){return e<this.min.x&&(this.min.x=e),e>this.max.x&&(this.max.x=e),t<this.min.y&&(this.min.y=t),t>this.max.y&&(this.max.y=t),this},extendBounds:function(e){return this.extendArray([[e.min.x,e.min.y],[e.max.x,e.max.y]])},extendArray:function(e){if(!e||!e.length)return this;var t,i;if("number"==typeof e[0])for(t=0,i=e.length;t<i;t+=2)this.extend(e[t],e[t+1]);else for(t=0,i=e.length;t<i;t++)this.extend(e[t][0],e[t][1]);return this},addBuffer:function(e,t,i,r){return this.min.x-=e,this.min.y-=t||e,this.max.x+=i||e,this.max.y+=r||t||e,this},contains:function(e){var t=this.min,i=this.max,r=e[0],n=e[1];return r>=t.x&&r<=i.x&&n>=t.y&&n<=i.y},getCenter:function(){var e=this.min,t=this.max;return[(e.x+t.x)/2,(e.y+t.y)/2]},addOffset:function(e){return this.min.x+=e[0],this.max.x+=e[0],this.min.y+=e[1],this.max.y+=e[1],this},intersects:function(e){var t=this.min,i=this.max,r=e.min,n=e.max;return n.x>t.x&&r.x<i.x&&n.y>t.y&&r.y<i.y},intersectsWithDelta:function(e,t,i){var r=this.min,n=this.max,o=t||0,s=i||0,a=e.min,l=e.max;return l.x+o>r.x&&a.x-o<n.x&&l.y+s>r.y&&a.y-s<n.y},isEqual:function(e){var t=this.min,i=this.max,r=e.min,n=e.max;return n.x===i.x&&r.x===t.x&&n.y===i.y&&r.y===t.y},isNodeIntersect:function(e){for(var t=0,i=e.length;t<i;t++)if(this.contains(e[t]))return{num:t,point:e[t]};return null},clipPolygon:function(e,i){if(e.length){var r,n,o,s,a,l,u,h,c,d=[1,4,2,8];if(t.LineUtil.isFlat(e)){var m=e;e=m.map(function(e){return new t.Point(e[0],e[1],i)})}for(n=0,u=e.length;n<u;n++)e[n]._code=this._getBitCode(e[n]);for(s=0;s<4;s++){for(h=d[s],r=[],n=0,u=e.length,o=u-1;n<u;o=n++)a=e[n],l=e[o],a._code&h?l._code&h||(c=this._getEdgeIntersection(l,a,h,i),c._code=this._getBitCode(c),r.push(c)):(l._code&h&&(c=this._getEdgeIntersection(l,a,h,i),c._code=this._getBitCode(c),r.push(c)),r.push(a));e=r}}return e.map(function(e){return[e.x,e.y]})},_getBitCode:function(e){var t=0;return e.x<this.min.x?t|=1:e.x>this.max.x&&(t|=2),e.y<this.min.y?t|=4:e.y>this.max.y&&(t|=8),t},_getEdgeIntersection:function(e,i,r,n){var o,s,a=i.x-e.x,l=i.y-e.y,u=this.min,h=this.max;return 8&r?(o=e.x+a*(h.y-e.y)/l,s=h.y):4&r?(o=e.x+a*(u.y-e.y)/l,s=u.y):2&r?(o=h.x,s=e.y+l*(h.x-e.x)/a):1&r&&(o=u.x,s=e.y+l*(u.x-e.x)/a),new t.Point(o,s,n)},clipPolyLine:function(e,t,i){i=i||0;var r,n,o,s,a,l,u=this.min,h=this.max,c=[u.x-i,u.y-i,h.x+i,h.y+i],d=function(e){var t=0;return e[0]<c[0]?t|=1:e[0]>c[2]&&(t|=2),e[1]<c[1]?t|=4:e[1]>c[3]&&(t|=8),t},m=function(e,t){return Math.PI/2+Math.atan2(t[1]-e[1],e[0]-t[0])},p=function(e,t,i){return 8&i?[e[0]+(t[0]-e[0])*(c[3]-e[1])/(t[1]-e[1]),c[3]]:4&i?[e[0]+(t[0]-e[0])*(c[1]-e[1])/(t[1]-e[1]),c[1]]:2&i?[c[2],e[1]+(t[1]-e[1])*(c[2]-e[0])/(t[0]-e[0])]:1&i?[c[0],e[1]+(t[1]-e[1])*(c[0]-e[0])/(t[0]-e[0])]:null},f=[],g=e.length,y=d(e[0],c),v=[];for(r=1;r<g;r++)if(n=e[r-1],o=e[r],n[0]!==o[0]||n[1]!==o[1]){for(a=l=d(o,c);;){if(!(y|a)){t&&(n[2]=m(n,o),s=e[r+1],o[2]=s?m(o,s):n[2]),v.push(n),a!==l?(v.push(o),r<g-1&&(f.push(v),v=[])):r===g-1&&v.push(o);break}if(y&a)break;y?(n=p(n,o,y,c),y=d(n,c)):(o=p(n,o,a,c),a=d(o,c))}y=l}return v.length&&f.push(v),f},toLatLngBounds:function(e){var r=t.Projection.Mercator,n=r.unproject(this.min),o=r.unproject(this.max),s=[[n.lat,n.lng],[o.lat,o.lng]];return e&&(s[0][0]=i.fromWebMercY(this.min.y),s[1][0]=i.fromWebMercY(this.max.y)),t.latLngBounds(s)}},i.bounds=function(e){return new i.Bounds(e)},i.parseUri=function(e){for(var t=i.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,i,r){i&&(n[t.q.name][i]=r)}),n.hostOnly=n.host,n.host=n.authority,n},i.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},i.layerHelper={modifyObject:function(e,i,r,n){return new Promise(function(o,s){r.forEach(function(e){e.action=e.action||(e.id?"update":"insert")});var a={WrapStyle:"None",LayerName:i,objects:JSON.stringify(r)};a.geometry_cs=n?n:"EPSG:4326",t.gmxUtil.sendCrossDomainPostRequest(e,a,function(e){e&&"ok"===e.Status?(t.gmx.layersVersion.chkVersion(i),o(e.Result)):s()})})["catch"](console.log)}},t.gmxUtil||(t.gmxUtil={}),t.extend(t.gmxUtil,{debug:i.debug,createWorker:i.createWorker,apiLoadedFrom:i.apiLoadedFrom,newId:i.newId,isPageHidden:i.isPageHidden,protocol:"https:"!==location.protocol?"http:":location.protocol,prefixURL:location.href.substr(0,location.href.lastIndexOf("/")+1),loaderStatus:function(){},isIE9:i.isIE(9),isIE10:i.isIE(10),isIE11:i.isIE(11),gtIE11:i.gtIE(11),getText:i.getText,getFormData:i.getFormData,requestJSONP:i.requestJSONP,requestLink:i.requestLink,getCadastreFeatures:i.getCadastreFeatures,request:i.request,getLayerItemFromServer:i.getLayerItemFromServer,fromServerStyle:i.fromServerStyle,toServerStyle:i.toServerStyle,getDefaultStyle:i.getDefaultStyle,bounds:i.bounds,getNormalizeBounds:i.getNormalizeBounds,getGeometryBounds:i.getGeometryBounds,tileSizes:i.tileSizes,getDateFromStr:i.getDateFromStr,getUnixTimeFromStr:i.getUnixTimeFromStr,getUTCdate:i.getUTCdate,getUTCtime:i.getUTCtime,getUTCdateTime:i.getUTCdateTime,attrToString:i.attrToString,getTileAttributes:i.getTileAttributes,formatCoordinates:function(e,t){return i["formatCoordinates"+(t?"2":"")](e.lng,e.lat)},formatDegrees:i.formatDegrees,pad2:i.pad2,dec2hex:i.dec2hex,dec2rgba:i.dec2rgba,trunc:i.trunc,latLonFormatCoordinates:i.latLonFormatCoordinates,latLonFormatCoordinates2:i.latLonFormatCoordinates2,latLonToString:i.latLonToString,toPrecision:i.toPrecision,getLength:i.getLength,geoLength:i.geoLength,prettifyDistance:i.prettifyDistance,getArea:i.getArea,prettifyArea:i.prettifyArea,geoArea:i.geoArea,parseBalloonTemplate:i.parseBalloonTemplate,setSVGIcon:i.setSVGIcon,getSVGIcon:i.getSVGIcon,getCoordinatesString:i.getCoordinatesString,getGeometriesSummary:i.getGeometriesSummary,getGeometrySummary:i.getGeometrySummary,getGeoJSONSummary:i.getGeoJSONSummary,getPropertiesHash:i.getPropertiesHash,distVincenty:i.distVincenty,parseCoordinates:i.parseCoordinates,geometryToGeoJSON:i.geometryToGeoJSON,coordsFromMercator:i.coordsFromMercator,convertGeometry:i.convertGeometry,transformGeometry:i.transformGeometry,geoJSONtoGeometry:i.geoJSONtoGeometry,geoJSONGetArea:i.geoJSONGetArea,geoJSONGetLength:i.geoJSONGetLength,geoJSONGetLatLng:i.geoJSONGetLatLng,fromWebMercY:i.fromWebMercY,parseUri:i.parseUri,isRectangle:i.isRectangle,isClockwise:i.isClockwise,isPointInPolygonWithHoles:i.isPointInPolygonWithHoles,getPatternIcon:i.getPatternIcon,getCircleLatLngs:i.getCircleLatLngs,normalizeHostname:i.normalizeHostname,getTileBounds:i.getTileBounds,getBoundsByTilePoint:i.getBoundsByTilePoint,parseTemplate:i.parseTemplate}),t.gmxUtil.layerHelper=i.layerHelper,t.gmxUtil.isOldVersion="0.7"===t.version.substr(0,3),t.gmxUtil.isIEOrEdge=t.gmxUtil.gtIE11||t.gmxUtil.isIE11||t.gmxUtil.isIE10||t.gmxUtil.isIE9,"requestIdleCallback"in window||(window.requestIdleCallback=function(e,t){var i=t?t.timeout:0;return window.setTimeout(e,i)},window.cancelIdleCallback=window.clearTimeout),String.prototype.eval||(String.prototype.eval=function(e){return this.replace(/\${(.*?)}/g,function(t,i){var r=i.replace(/(["'\.\w\$]+)/g,function(e){return/["']/.test(e[0])?e:"scope."+e});try{return new Function("scope","return "+r)(e)}catch(n){return""}})}),t.gmx=t.gmx||{},t.gmx.gmxProxy="//maps.kosmosnimki.ru/ApiSave.ashx",function(){function e(e,o,s){var a="gmxAPIutils_id"+n++,l=t.DomUtil.create("iframe");l.style.display="none",l.setAttribute("id",e),l.setAttribute("name",e),l.src="javascript:true",l.callbackName=a;var u=i.parseUri(s),h=(u.protocol?u.protocol+":":t.gmxUtil.protocol)+"//"+(u.host||window.location.host);return r[h]=r[h]||{},r[h][a]={callback:o,iframe:l},l}var r={},n=0,o=function(e){if(e.origin in r){var t=decodeURIComponent(e.data.replace(/\n/g,"\n\\"));try{var i=JSON.parse(t)}catch(n){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:t}})}var o=r[e.origin][i.CallbackName];o&&(delete r[e.origin][i.CallbackName],delete i.CallbackName,o.iframe.parentNode&&o.iframe.parentNode.removeChild(o.iframe),"callback"in o&&o.callback(i))}};t.DomEvent.on(window,"message",o),i.createPostIframe2=e}(),function(){function e(e,r,n,o){var s,a,l="$$iframe_"+i.newId(),u=i.createPostIframe2(l,n,e);if(o)s=o,a=s.getAttribute("action"),s.setAttribute("action",e),s.target=l;else if(t.Browser.ielt9){var h="<form id="+l+'" enctype="multipart/form-data" style="display:none" target="'+l+'" action="'+e+'" method="post"></form>';s=document.createElement(h)}else s=document.createElement("form"),s.style.display="none",s.setAttribute("enctype","multipart/form-data"),s.target=l,s.setAttribute("method","POST"),s.setAttribute("action",e),s.id=l;var c=document.createElement("div");c.style.display="none","window"===r.WrapStyle&&(r.WrapStyle="message"),"message"===r.WrapStyle&&(r.CallbackName=u.callbackName);for(var d in r){var m=document.createElement("input"),p="undefined"!=typeof r[d]?r[d]:"";m.setAttribute("type","hidden"),m.setAttribute("name",d),m.setAttribute("value",p),c.appendChild(m)}s.appendChild(c),o||document.body.appendChild(s),document.body.appendChild(u),s.submit(),o?(s.removeChild(c),null!==a?s.setAttribute("action",a):s.removeAttribute("action")):s.parentNode.removeChild(s)}t.gmxUtil.sendCrossDomainPostRequest=i.sendCrossDomainPostRequest=e}(),function(){var e=/\[(.+?)\]/g,i=/(floor\()/g,r={functionFromExpression:function(t){return new Function("props","indexes","return "+t.replace(e,'props[indexes["$1"]]').replace(i,"Math.$1")+";")}},n=function(e,t){return{head:e,tail:t}},o=function(e,t){return n(e,t)},s=function(e,t){return n(e,t)},a=new s((-1),null),l=function(e){return e.head===-1},u=function(e,t){return new s(e.head+t,e.tail)},h=function(e){var t=e.length;return function(i,r){return i.substr(r.head,t)===e?u(r,t):a}},c=function(e){var t=e.length;return e=e.toLowerCase(),function(i,r){return i.substr(r.head,t).toLowerCase()===e?u(r,t):a}},d=function(e,t){var i=e.charCodeAt(0),r=t.charCodeAt(0);return function(e,t){var n=e.charCodeAt(t.head);return n>=i&&n<=r?u(t,1):a}},m=function(e){return function(t,i){return t.length>i.head&&l(e(t,i))?u(i,1):a}},p=function(e){return function(t,i){for(var r=0;r<e.length;r++)if(i=e[r](t,i),l(i))return a;return i}},f=function(e){return function(t,i){for(var r=0;r<e.length;r++){var n=e[r](t,i);if(!l(n))return n}return a}},g=function(e,t){return t},y=function(e){return f([e,g])},v=function(e,t){return function(i,r){for(var n=0;;){var o=t(i,r);if(l(o))return n>=e?r:a;n+=1,r=o}}},x=function(e,t,i){var r=p([t,v(e-1,p([i,t]))]);return e>0?r:f([r,g])},_=v(0,f([h(" "),h("\t"),h("\n")])),b=function(e,t,i){return x(e,t,p([_,i,_]))},S=function(e){for(var t=[],i=0;i<e.length;i++)t.length>0&&t.push(_),t.push(e[i]);return p(t)},T=function(e){return function(t,i){var r=e(t,i);return l(r)?a:new s(r.head,new o(t.substr(i.head,r.head-i.head),r.tail))}},P=function(e,t){return function(i,r){var n=r,u=e(i,new s(n.head,null));return l(u)?a:new s(u.head,new o(t(u.tail),n.tail))}},L=T(v(1,f([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_")]))),I=T(v(1,f([d("a","z"),d("A","Z"),d("а","я"),d("А","Я"),d("0","9"),h("_"),h(" ")]))),M=f([L,p([h('"'),I,h('"')]),p([h("`"),I,h("`")])]),k=p([h("'"),T(v(0,m(h("'")))),h("'")]),C=v(1,d("0","9")),O=T(p([y(h("-")),C,y(p([h("."),C]))])),w=f([O,k]),D=function(e,t){return t(e,new s(0,null))},F=P(S([M,T(f([h("=="),h("!="),h("<>"),h("<="),h(">="),h("="),h("<"),h(">"),c("LIKE")])),f([w,M])]),function(e){var i=e.tail.tail.head,r=e.tail.head,n=e.head,o=null;return"LIKE"===r.toUpperCase()&&(o=function(e){var t=null;return(t=function(i,r){var o=n.charAt(i),s=e.charAt(r);return""===o?""===s:"%"===o?t(i+1,r)||""!==s&&t(i,r+1):o===s&&t(i+1,r+1)})(0,0)}),function(e,s,a){var l=e[s[i]],u=n;if(n in s&&(u=e[s[u]]),"date"!==a[i]&&"datetime"!==a[i]||"string"!=typeof u||(u=t.gmxUtil.getUnixTimeFromStr(u)),"boolean"==typeof l&&"string"==typeof u&&(l=l?"True":"False"),null===l)return!1;if(null!==o)return o(l);if("="===r||"=="===r)return l==u;if("!="===r||"<>"===r)return l!=u;var h,c;return n in s||"string"!=typeof u||D(u,O).head!==u.length?(h=l,c=u,"<"===r?h<c:">"===r?h>c:"<="===r?h<=c:">="===r&&h>=c):(h=parseFloat(l),c=parseFloat(u),"<"===r?h<c:">"===r?h>c:"<="===r?h<=c:">="===r&&h>=c)}}),R=P(S([M,c("IN"),h("("),b(0,w,h(",")),h(")")]),function(e){for(var t=e;null!=t.tail;)t=t.tail;var i=t.head;return function(t,r){var n=t[r[i]];if(null==n)return!1;for(var o=e;null!==o.tail;){if(o.head===n)return!0;o=o.tail}return!1}}),N=function(e,t){return N(e,t)},E=function(e,t){return E(e,t)},A=P(S([c("NOT"),N]),function(e){var t=e.head;return function(e,i,r){return!t(e,i,r)}});N=f([A,F,R,S([h("("),E,h(")")])]);var z=P(b(2,N,c("AND")),function(e){return function(t,i,r){for(var n=!0,o=e;null!=o;)n=n&&o.head(t,i,r),o=o.tail;return n}}),U=P(b(2,N,c("OR")),function(e){return function(t,i,r){for(var n=!1,o=e;null!=o;)n=n||o.head(t,i,r),o=o.tail;return n}});E=f([z,U,N]);var G=p([_,E,_]);r.parseSQL=function(e){var t=D(e,G);return t.head===e.length?t.tail.head:D(e,_).head===e.length?function(){return!0}:null};var B=function(e,t){return B(e,t)},H=function(e,t){return H(e,t)};B=P(b(1,H,T(f([h("+"),h("-")]))),function(e){return function(t,i,r){for(var n=e,o=0;null!==n;){if(o+=n.head(t,i,r),null===n.tail)return o;"-"===n.tail.head&&(o=-o),n=n.tail.tail}return o}});var Z=f([P(O,function(e){return function(){return parseFloat(e.head)}}),P(p([h("floor("),B,h(")")]),function(e){return function(t,i,r){var n=e.head(t,i,r);return Math.floor(n)}}),P(p([h("["),L,h("]")]),function(e){return function(t,i){return parseFloat(t[i[e.head]])}}),S([h("("),B,h(")")])]);Z=f([Z,P(S([h("-"),Z]),function(e){return function(t,i,r){return-e.head(t,i,r)}})]),H=P(b(1,Z,T(f([h("*"),h("/")]))),function(e){return function(t,i,r){for(var n=e,o=1;null!==n;){if(o*=n.head(t,i,r),null===n.tail)return o;"/"===n.tail.head&&(o=1/o),n=n.tail.tail}return o}}),Z=f([Z,P(S([h("-"),Z]),function(e){return function(t,i,r){return-e.head(t,i,r)}})]);var V=p([_,B,_]);r.parseExpression=function(e){var t=D(e,V);return t.head===e.length?t.tail.head:null};var K=P(v(0,f([O,h(","),h("M"),h("C"),v(1,f([h(" "),h("\t"),h("\r"),h("\n")]))])),function(e){for(var t=[];null!==e;)t.push(parseFloat(e.head)),e=e.tail;return t.reverse(),t});r.parseSVGPath=function(e){var t=D(e,K);return t.head===e.length?t.tail.head:[]},t.gmx=t.gmx||{},t.gmx.Parsers=r}();var r=function(e){var t,i=[],n=[],o=!1,s=!1,a=!1,l=!1,u=this._fulfill=function(e){if(!o){var r=e?i:n;t=[].slice.call(arguments,1),o=!0,s=e,r.forEach(function(e){e.apply(null,t)}),i=n=[]}};this.resolve=function(){l||u.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||u.apply(null,[!1].concat([].slice.call(arguments)))};var h=this.cancel=function(){l||o||(l=!0,e&&e())},c=this.then=function(e,a){if(l)return null;var u=null,c=new r(function(){h(),u&&u.cancel()}),d=function(e,t){return function(){if(e){var i=e.apply(null,arguments);i instanceof r?(u=i,i.then(c.resolve,c.reject)):c.resolve(i)}else c._fulfill.apply(null,[t].concat([].slice.call(arguments)))}};return o?d(s?e:a,s).apply(null,t):(i.push(d(e,!0)),n.push(d(a,!1))),c};this.once=function(e){a||(a=!0,c(e))},this.always=function(e){c(e,e)},this.getFulfilledData=function(){return t}};r.all=function(){var e=[].slice.apply(arguments),t=new r,i=e.length,n=new Array(e.length);return i?e.forEach(function(e,r){e.then(function(e){n[r]=e,i--,0===i&&t.resolve.apply(t,n)},function(){t.reject()})}):t.resolve(),t},t.gmx=t.gmx||{},t.gmx.Deferred=r,function(){t.gmx=t.gmx||{},t.gmx.workerPromise=t.gmxUtil.createWorker(t.gmxUtil.apiLoadedFrom()+"/ImageBitmapLoader-worker.js").then(function(e){var i=function(){this.jobs={},this.worker=e,this.worker.onmessage=this.chkMessage.bind(this)};i.prototype={chkMessage:function(e){for(var i,r=e.data,n=r.url,o=0,s=this.jobs[n]||[],a=s.length;o<a;o++)i=s[o],r.load?i.resolve(r):i.reject(r);delete this.jobs[n],t.gmxUtil.loaderStatus(n,!0)},push:function(e,i){e&&"."===e[0]&&0!==e.indexOf(t.gmxUtil.prefixURL)&&(e=t.gmxUtil.prefixURL+e);var r={options:i},n=e||t.gmxUtil.newId();return"undefined"==typeof this.jobs[n]&&(this.jobs[n]=[]),this.jobs[n].push(r),this.worker.postMessage({src:n,options:i}),t.gmxUtil.loaderStatus(n),new Promise(function(e,t){r.resolve=e,r.reject=t})["catch"](t.Util.falseFn)}};var r=new i;t.gmx.getBitmap=r.push.bind(r),t.gmx.getJSON=r.push.bind(r),2===t.gmxUtil.debug&&(t.gmx.sendCmd=function(e,i){return i.cmd=e,i.syncParams=t.gmx.gmxMapManager.syncParams,r.push(null,i)}),e.onerror=function(e){console.warn("Error: Worker init: ImageBitmapLoader-worker.js",e),e.target.terminate(),delete t.gmx.getBitmap,delete t.gmx.getJSON,delete t.gmx.sendCmd}})}(),function(){var e=function(e,i,r){this._id=e,this.def=new t.gmx.Deferred(t.gmx.imageLoader._cancelRequest.bind(t.gmx.imageLoader,this)),this.remove=t.gmx.imageLoader._removeRequestFromCache.bind(t.gmx.imageLoader,this),this.url=i,this.options=r||{}},i=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_checkIE11bugFix:function(e,t){if(!this.divIE11bugFix){var i=document.createElement("div");this.divIE11bugFix=i,i.style.visibility="hidden",i.style.position="absolute",document.body.insertBefore(i,document.body.childNodes[0])}var r=function(){e.resolve(t)};this.divIE11bugFix.appendChild(t),setTimeout(r,0)},_resolveRequest:function(e,i,r){var n=e.def;if(i){if(!r&&e.options.cache){var o=e.url,s=this.requestsCache[o],a=e._id;s||(s=this.requestsCache[o]={image:i,requests:{}}),s.requests[a]||(s.requests[a]=e)}t.gmxUtil.isIE11&&/\.svg/.test(e.url)?this._checkIE11bugFix(n,i):n.resolve(i)}else r||n.reject();this.fire("requestdone",{request:e})},_imageLoaded:function(e,i,r){if(e in this.inProgress){var n=function(e){this._resolveRequest(e,i,r)};this.inProgress[e].requests.forEach(n.bind(this)),--this.curCount,delete this.inProgress[e]}t.gmxUtil.loaderStatus(e,!0),this.fire("imageloaded",{url:e}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=i.MAX_COUNT)&&this.requests.length){var e=this.requests.shift(),r=e.url;if(r in this.inProgress)this.inProgress[r].requests.push(e);else{var n=[e];this.inProgress[r]={requests:n},++this.curCount;for(var o=this.requests.length-1;o>=0;o--)this.requests[o].url===r&&(n.push(this.requests[o]),this.requests.splice(o,1));var s=this._loadImage(e);s.width||t.gmxUtil.loaderStatus(r),this.inProgress[r]&&(this.inProgress[r].image=s)}}},_loadImage:function(e){var i=new Image,r=e.url,n=this;return e.options.crossOrigin&&(i.crossOrigin=e.options.crossOrigin),i.onload=this._imageLoaded.bind(this,r,i,!1),i.onerror=function(){n._imageLoaded(r)},t.gmxUtil.isIEOrEdge?setTimeout(function(){i.src=r},0):i.src=r,this.fire("imageloadstart",{url:r}),i},_cancelRequest:function(e){var i,r=e._id,n=e.url,o=0;if(n in this.inProgress){var s=this.inProgress[n],a=s.requests;if(i=a.length,1===i&&a[0]._id===r)s.image.onload=t.Util.falseFn,s.image.onerror=t.Util.falseFn,s.image.src=t.Util.emptyImageUrl,this._imageLoaded(n,null,!0);else for(o=0;o<i;o++)if(a[o]._id===r){a.splice(o,1);break}}else for(o=0,i=this.requests.length;o<i;o++)if(this.requests[o]._id===r){this.requests.splice(o,1);break}this.fire("requestdone",{request:e})},_removeRequestFromCache:function(e){this._cancelRequest(e),this._clearCacheItem(e.url,e._id)},_clearCacheItem:function(e,t){if(this.requestsCache[e]){var i=this.requestsCache[e];delete i.requests[t],0===Object.keys(i.requests).length&&delete this.requestsCache[e]}},_add:function(i,r,n){r=r.replace(/^http:/,t.gmxUtil.protocol);var o="id"+ ++this.uniqueID,s=new e(o,r,n);return r in this.inProgress?this.inProgress[r].requests.push(s):(i?this.requests.unshift(s):this.requests.push(s),this._nextLoad()),this.fire("request",{request:s}),s},push:function(e,t){return this._add(!1,e,t)},unshift:function(e,t){return this._add(!0,e,t)}});t.gmx.imageLoader=new i}();var n=["strokeStyle","fillStyle","lineWidth"],o=n.length,s=i,a=function(e,t,i,r){for(var a=0;a<o;a++){var l=n[a],u=r[l];u!==i[l]&&(i[l]=u)}if(r.dashArray){var h=r.dashArray,c=r.dashOffset||0;"setLineDash"in i&&(i.setLineDash(h),i.lineDashOffset!==c&&(i.lineDashOffset=c))}else"getLineDash"in i&&i.getLineDash().length>0&&i.setLineDash([]);if("round"!==i.lineCap&&(i.lineCap="round"),"round"!==i.lineJoin&&(i.lineJoin="round"),r.canvasPattern)i.fillStyle=i.createPattern(r.canvasPattern.canvas,"repeat");else if(r.fillLinearGradient){for(var d=r.fillLinearGradient,m=d.x1Function?d.x1Function(e,t):d.x1,p=d.y1Function?d.y1Function(e,t):d.y1,f=d.x2Function?d.x2Function(e,t):d.x2,g=d.y2Function?d.y2Function(e,t):d.y2,y=i.createLinearGradient(m,p,f,g),v=0,x=d.addColorStop.length;v<x;v++){var _=d.addColorStop[v],b=d.addColorStopFunctions[v],S=b[0]?b[0](e,t):_[0],T=_.length<3?100:b[2]?b[2](e,t):_[2],P=s.dec2color(b[1]?b[1](e,t):_[1],T>1?T/100:T);y.addColorStop(S,P)}i.fillStyle=r.fillStyle=y}};t.gmxUtil.drawGeoItem=function(e,r,n,o,l){var u,h,c,d,m=e.properties,p=m[0],f=n.gmx,g=n.ctx,y=m[m.length-1],v=null,x=e.dataOption,_=n.rasters||{},b=n.tbounds;if(r.currentStyle=t.extend({},o),l){if(f.styleHook){if(e.styleExtend||(e.styleExtend=f.styleHook(r,f.lastHover&&p===f.lastHover.id)),!e.styleExtend)return!1;"number"==typeof e.styleExtend.strokeStyle&&(e.styleExtend.strokeStyle=i.dec2color(e.styleExtend.strokeStyle,1)),"number"==typeof e.styleExtend.fillStyle&&(e.styleExtend.fillStyle=i.dec2color(e.styleExtend.fillStyle,1)),r.currentStyle=t.extend(r.currentStyle,e.styleExtend)}a(m,f.tileAttributeIndexes,g,r.currentStyle)}else l={};var S=y.type.toUpperCase(),T={gmx:f,item:r,style:l,styleExtend:e.styleExtend||{},ctx:g,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy};if("POINT"===S&&(T.pointAttr=s.getPixelPoint(T,y.coordinates),!T.pointAttr))return!1;if("POINT"===S||"MULTIPOINT"===S)if(v=y.coordinates,"iconColor"in l&&l.image&&!t.gmxUtil.isIE11&&(l.lastImage!==l.image&&(l.lastImage=l.image,l.lastImageData=s.getImageData(l.image)),T.imageData=l.lastImageData),"MULTIPOINT"===S)for(u=0,h=v.length;u<h;u++)T.coords=v[u],s.pointToCanvas(T);else T.coords=v,s.pointToCanvas(T);else if("POLYGON"===S||"MULTIPOLYGON"===S)if(l.image)T.coords=[(x.bounds.min.x+x.bounds.max.x)/2,(x.bounds.min.y+x.bounds.max.y)/2],T.pointAttr=s.getPixelPoint(T,T.coords),T.pointAttr&&s.pointToCanvas(T);else{v=y.coordinates,"POLYGON"===S&&(v=[v]);var P=x.hiddenLines||[],L=x.pixels,I=!0;L&&L.z===n.topLeft.tilePoint.z||(L=x.pixels=s.getCoordsPixels({gmx:f,coords:v,topLeft:n.topLeft,tpx:n.tpx,tpy:n.tpy,hiddenLines:P}));var M=function(e,t){for(v=L.coords,P=L.hidden||[],T.flagPixels=I,u=0,h=v.length;u<h;u++){var i=v[u],r=P[u]||[];for(g.beginPath(),
c=0,d=i.length;c<d;c++)T.coords=i[c],T.hiddenLines=r[c]||[],e(T);g.closePath(),t&&g.fill()}},k=r.currentStyle.strokeStyle||l.strokeStyle,C=r.currentStyle.lineWidth||l.lineWidth;k&&C&&M(s.polygonToCanvas),n.bgImage?T.bgImage=n.bgImage:_[p]&&(T.bgImage=_[p]),(T.styleExtend.skipRasters||r.skipRasters)&&delete T.bgImage,l.imagePattern?r.currentStyle.fillStyle=g.createPattern(l.imagePattern,"repeat"):T.bgImage&&b.intersectsWithDelta(x.bounds,-1,-1)&&(s.isPatternNode(T.bgImage)&&("rasterOpacity"in f&&(g.globalAlpha=f.rasterOpacity),g.fillStyle=g.createPattern(T.bgImage,"no-repeat"),l.bgImage=!0),M(s.polygonToCanvasFill,!0),g.globalAlpha=1),(r.currentStyle.fillStyle||r.currentStyle.canvasPattern)&&(g.fillStyle=r.currentStyle.canvasPattern||r.currentStyle.fillStyle,M(s.polygonToCanvasFill,!0))}else if("LINESTRING"===S||"MULTILINESTRING"===S){v=y.coordinates,"LINESTRING"===S&&(v=[v]);var O=r.currentStyle||r.parsedStyleKeys,w=O.iconPath||O.iconPath,D=(r.currentStyle.maxSize||r.currentStyle.lineWidth)/n.topLeft.mInPixel;for(u=0,h=v.length;u<h;u++)if(w){var F=b.clipPolyLine(v[u],!0,D);for(c=0,d=F.length;c<d;c++){T.coords=F[c];var R=s.lineToCanvas(T);R&&(g.save(),s.lineToCanvasAsIcon(R,T),g.restore())}}else T.coords=v[u],s.lineToCanvas(T)}return!0};var l={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var e=this;if(this._scriptSearched)return this._scriptAPIKey;for(var t=document.getElementsByTagName("script"),i=0;i<t.length;i++){for(var r=t[i].getAttribute("src"),n=this.SCRIPT_REGEXP,o=0,s=n.length;o<s;o++)if(n[o].exec(r)){var a=r.split("?")[1];if(a)for(var l=a.split("&"),u=0;u<l.length;u++){var h=l[u].split("=");if(h[0]===e.APIKEY_PARAM){e._scriptAPIKey=h[1];break}}break}if(e._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(e,i){var r=this._sessionKeys;return e in r||(i="undefined"==typeof i?this._searchScriptAPIKey():i,r[e]=new Promise(function(r,n){if(i){var o=t.gmxUtil.protocol+"//"+e+"/ApiKey.ashx?WrapStyle=None&Key="+i,s=function(t){if(t&&"ok"===t.Status){var i=l._sessionKeysRes[e]=t.Result.Key;r(i)}else n()};fetch(o,{mode:"cors"}).then(function(e){return e.json()}).then(s)}else r("")})),r[e]},getSessionKey:function(e){return this._sessionKeys[e]},getSessionKeyRes:function(e){return this._sessionKeysRes[e]},_sessionKeysRes:{},_sessionKeys:{}};t.gmx=t.gmx||{},t.gmx.gmxSessionManager=l;var u={getMap:function(e,t,i,r,n){return u.loadMapProperties({srs:n,hostName:e,apiKey:t,mapName:i,skipTiles:r})},_addMapProperties:function(e,i,r){t.gmx._maps[i]=t.gmx._maps[i]||{},t.gmx._maps[i][r]={_rawTree:e,_nodes:{}},u.iterateNode(e,function(e){if("layer"===e.type){var i=e.content.properties;i.styles&&!i.gmxStyles&&(e.content.properties.gmxStyles=t.gmx.StyleManager.decodeOldStyles(i))}}),t.gmx.mapPropertiesHook&&t.gmx.mapPropertiesHook(e)},getMapFolder:function(e){var r=e.hostName||e.serverHost||"maps.kosmosnimki.ru",n=e.mapId,o=e.folderId,s={folderId:o||"",mapId:n,skipTiles:e.skipTiles||"All",srs:e.srs||3857};return new Promise(function(a,h){t.gmx.sendCmd?console.log("TODO: L.gmx.sendCmd"):l.requestSessionKey(r,e.apiKey).then(function(e){s.key=e,i.requestJSONP(t.gmxUtil.protocol+"//"+r+"/Map/GetMapFolder",s).then(function(e){if(e&&"ok"===e.Status&&e.Result){var i=t.gmx._maps[r][n],s=i.loaded,l=e.Result.content,c={children:l.children,properties:s.properties};u.iterateNode(i._rawTree,function(i){o===i.content.properties.GroupID&&t.extend(i,e.Result)},!0),s.layersCreated.then(function(){s.layersCreatePromise(c).then(function(){a(e.Result)})})}else h(e)},h)},h)})},loadMapProperties:function(e){var r=this._maps,n=e.hostName||e.serverHost||"maps.kosmosnimki.ru",o=e.mapName;if(!r[n]||!r[n][o]){var s={WrapStyle:"func",skipTiles:e.skipTiles||"All",MapName:o,srs:e.srs||3857,ftc:e.ftc||"osm",ModeKey:"map"};e.visibleItemOnly&&(s.visibleItemOnly=!0);var a=new Promise(function(r,a){t.gmx.sendCmd?t.gmx.sendCmd("mapProperties",{serverHost:n,apiKey:e.apiKey,WrapStyle:"func",skipTiles:e.skipTiles||"All",MapName:o,visibleItemOnly:s.visibleItemOnly||!1,srs:e.srs||3857,ftc:e.ftc||"osm",ModeKey:"map"}).then(function(e){e&&e.load&&e.res?(u._addMapProperties(e.res,n,o),r(e.res)):a(e)})["catch"](a):l.requestSessionKey(n,e.apiKey).then(function(e){s.key=e,i.requestJSONP(t.gmxUtil.protocol+"//"+n+"/TileSender.ashx",s).then(function(t){t&&"ok"===t.Status&&t.Result?(t.Result.properties.hostName=n,t.Result.properties.sessionKey=e,u._addMapProperties(t.Result,n,o),r(t.Result)):a(t)},a)},a)});r[n]=r[n]||{},r[n][o]={promise:a}}return r[n][o].promise},syncParams:{},setSyncParams:function(e){this.syncParams=e},getSyncParams:function(e){var t=this.syncParams;if(e){var i=[];for(var r in t)i.push(r+"="+t[r]);t=i.join("&")}return t},findLayerInfo:function(e,i,r){var n=t.gmx._maps[e],o=null;if(n&&n[i]){var s=n[i];s._nodes[r]||u.iterateNode(s._rawTree,function(e){s._nodes[e.content.properties.name]=e}),o=s._nodes[r]}return o?o.content:null},iterateLayers:function(e,t){var i=function(e){for(var r=0,n=e.length;r<n;r++){var o=e[r];"layer"===o.type?t(o.content):"group"===o.type&&i(o.content.children||[])}};e&&i(e.children)},iterateNode:function(e,t,i){var r=function(e){for(var n=e.children||[],o=0,s=n.length;o<s;o++){var a=n[o];if(t(a)&&i)break;"group"===a.type&&r(a.content)}};e&&r(e)},_maps:{}};t.gmx=t.gmx||{},t.gmx._maps={},t.gmx._clientLayers={},/\bsw=1\b/.test(location.search)&&(t.gmx._sw=1,"serviceWorker"in navigator?navigator.serviceWorker.register("./gmx-sw1.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)})["catch"](function(e){console.log("ServiceWorker registration failed: ",e)}):console.error("Your browser does not support Service Workers.")),t.gmx.gmxMapManager=u;var h=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e,i){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={},this.options=i,this.properties=t.extend({},e.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=e,this.layersCreated=this.layersCreatePromise(e)},layersCreatePromise:function(e){return new Promise(function(i){var r=e.properties.name,n=this,o=this.options,s=this.options.skipTiles||"All",a=this.options.ftc||"osm",l=this.options.srs||3857,h={},c={};u.iterateLayers(e,function(i){var s=i.properties,a={mapID:r,sessionKey:e.properties.sessionKey,layerID:s.name};s.hostName=e.properties.hostName,e.srs&&(s.srs=e.srs);var l=s.ContentID||s.type,u=s.MetaProperties||{},d=t.extend(a,o);s.styles&&!s.gmxStyles&&(s.gmxStyles=t.gmx.StyleManager.decodeOldStyles(s)),s.dataSource||"parentLayer"in u?(d.parentLayer=s.dataSource||"","parentLayer"in u&&(d.parentLayer=u.parentLayer.Value||""),c[a.layerID]={info:i,options:d}):l in t.gmx._layerClasses?n.addLayer(t.gmx.createLayer(i,d)):(h[l]=h[l]||[],h[l].push({info:i,options:d}))});var d=[];for(var m in h)d.push(t.gmx._loadLayerClass(m).then(function(e){for(var i=h[e],r=0,o=i.length;r<o;r++)n.addLayer(t.gmx.createLayer(i[r].info,i[r].options))}.bind(null,m)));var p,f,y,v={};for(f in c){y=c[f];var x=y.options,_=x.parentLayer,b=this.layersByID[_];b?(y.options.parentOptions=b.getGmxProperties(),y.options.dataManager=this.dataManagers[_]||new g(y.options.parentOptions,(!0)),this.dataManagers[_]=y.options.dataManager,this.addLayer(t.gmx.createLayer(y.info,y.options))):(p=x.hostName,v[p]||(v[p]={}),v[p][_]||(v[p][_]=[]),v[p][_].push(f))}for(p in v){var S=[],T=t.gmxUtil.protocol+"//"+p;for(f in v[p])S.push({Layer:f});d.push(t.gmxUtil.requestJSONP(T+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",skipTiles:s,srs:l,ftc:a,Layers:JSON.stringify(S)},{ids:v[p]}).then(function(e,i){if(e&&"ok"===e.Status&&e.Result)e.Result.forEach(function(e){var r=e.properties,o=r.name;r.tiles=[],r.srs=l,r.ftc=a;var s=n.addDataManager(e);i&&i.ids&&i.ids[o]&&i.ids[o].forEach(function(i){var r=c[i];r.options.parentOptions=e.properties,r.options.dataManager=s,r.info.properties.tiles=[],r.info.properties.srs=l,r.info.properties.ftc=a,n.addLayer(t.gmx.createLayer(r.info,r.options))})});else if(console.info("Error: loading ",T+"/Layer/GetLayerJson.ashx",e.ErrorInfo),i&&i.ids)for(var r in i.ids)i.ids[r].forEach(function(e){n.addLayer(new t.gmx.DummyLayer(c[e].info.properties))})}))}Promise.all(d).then(i)}.bind(this))},addDataManager:function(e){var t=e.properties.name;return this.dataManagers[t]||(this.dataManagers[t]=new g(e.properties)),this.dataManagers[t]},getDataManager:function(e){return this.dataManagers[e]},addLayer:function(e){var t=e.getGmxProperties();return this.layers.push(e),this.layersByTitle[t.title]=e,this.layersByID[t.name]=e,this.fire("layeradd",{layer:e}),this},removeLayer:function(e){for(var t=e.getGmxProperties(),i=0;i<this.layers.length;i++)if(this.layers[i].getGmxProperties().name===t.name){this.layers.splice(i,1);break}return delete this.layersByTitle[t.title],delete this.layersByID[t.name],this.fire("layerremove",{layer:e}),this},addLayersToMap:function(e){for(var t=this.layers.length-1;t>=0;t--){var i=this.layers[t];i.getGmxProperties().visible&&e.addLayer(i)}return this}});t.gmx=t.gmx||{},t.gmx.gmxMap=h;var c=t.Handler.extend({options:{},initialize:function(e){this._map=e,this._layers={},this._lastLayer=null,this._lastId=null,this._drawstart=null,this._lastCursor="",e.on({zoomend:function(){e._gmxMouseLatLng&&this._onmousemove({type:"mousemove",latlng:e._gmxMouseLatLng})},click:this._eventCheck,dblclick:this._eventCheck,mousedown:this._eventCheck,mouseup:this._eventCheck,mousemove:this._onmousemove,contextmenu:this._onmousemove,layeradd:function(e){var t=e.layer;if("gmxEventCheck"in t&&t.options.clickable){var i=0;if(t._container){var r,n=t._container,o=n.parentNode.childNodes;for(i=0,r=o.length;i<r&&n!==o[i];i++);}this._layers[t._leaflet_id]=i}},layerremove:function(e){var t=e.layer._leaflet_id;delete this._layers[t],this._lastLayer&&this._lastLayer._leaflet_id===t&&(this._lastLayer=null,this._lastId=0)}},this)},_onmousemove:function(e){this._map._animatingZoom||(this._onmousemoveTimer&&clearTimeout(this._onmousemoveTimer),this._onmousemoveTimer=setTimeout(this._eventCheck.bind(this,e),50))},_isDrawing:function(){var e=this._map;if(this._drawstart)return!0;if(null===this._drawstart){if(e.gmxControlsManager){var t=e.gmxControlsManager.get("drawing");t&&t.on("activechange",function(t){this._drawstart=t.activeIcon,e._container.style.cursor=this._drawstart?"pointer":""}.bind(this))}this._drawstart=!1}return!1},_clearLastHover:function(){this._lastLayer&&(this._lastLayer.gmxEventCheck({type:"mousemove"},!0),this._lastLayer=null)},_eventCheck:function(e){var i=e.type,r=this._map;if(e.originalEvent){var n=e.originalEvent.target,o=n.tagName.toLowerCase();if("svg"!==o&&n!==r._container)return;if("path"===o)return;r.gmxMouseDown=t.Browser.webkit&&!t.gmxUtil.isIEOrEdge?e.originalEvent.which:e.originalEvent.buttons}if(r._animatingZoom||!e.latlng||this._isDrawing()||"click"===i&&r._skipClick||"mousemove"===i&&r.gmxMouseDown)return this._clearLastHover(),void(r._skipClick=!1);e.layerPoint&&(r._gmxMouseLatLng=e.latlng,r.gmxMousePos=r.getPixelOrigin().add(e.layerPoint));for(var s,a=Object.keys(this._layers).sort(function(e,t){var i=r._layers[e],n=r._layers[t];if(i&&n){var o=i.options,s=n.options,a=(o.zIndexOffset||0)+(o.zIndex||0),l=(s.zIndexOffset||0)+(s.zIndex||0),u=l-a;return u?u:this._layers[t]-this._layers[e]}return 0}.bind(this)),l=null,u="",h=0,c=a.length;h<c;h++){var d=a[h];if(s=r._layers[d],s&&s._map&&!s._animating&&s.options.clickable&&s.gmxEventCheck(e)){s.hasEventListeners("mouseover")&&(u="pointer"),l=s;break}}this._lastCursor===u||this._isDrawing()||(r._container.style.cursor=u),this._lastCursor=u,"zoomend"!==i&&(l?(this._lastLayer!==l&&this._clearLastHover(),this._lastLayer=l):this._clearLastHover())}});t.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new c(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart}.bind(this),this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()},this))}),function(){var e="rus",i=function(e,t,i,r){r[e]||(r[e]={}),r[e][t]=i};t.gmxLocale={setLanguage:function(e){this._language=e},getLanguage:function(){return window.language||this._language||e}},t.gmxLocaleMixin={addText:function(){var e=arguments[0],t=arguments[1];1===arguments.length&&(t=e,e=null);for(var r in t)if(null===e)for(var n in t[r])i(r,n,t[r][n],this);else i(e,r,t[r],this);return this},getText:function(e){for(var i=t.gmxLocale.getLanguage(),r=this[i]||{},n=e?e.split(/\./):[],o=0,s=n.length;o<s&&r;o++)r=r[n[o]];return r}},t.extend(t.gmxLocale,t.gmxLocaleMixin)}(),t.extend(t.gmxLocale,{rus:{Coordinates:"Координаты",Length:"Длина",nodeLength:"Длина от начала",edgeLength:"Длина сегмента",Area:"Площадь",Perimeter:"Периметр",units:{m:"м",nm:"м.мили",km:"км",m2:"кв. м",km2:"кв. км",ha:"га",m2html:"м<sup>2",km2html:"км<sup>2"}}}),t.extend(t.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}});var d={_loadedTiles:{},_getKey:function(e){return[e.layerID,e.x,e.y,e.z,"undefined"==typeof e.d?-1:e.d,"undefined"==typeof e.s?-1:e.s,e.v].join(":")},load:function(e,i){var r=d._getKey(i);if(!this._loadedTiles[r]){var n={ModeKey:"tile",ftc:"osm",r:"j",LayerName:i.layerID,z:i.z,x:i.x,y:i.y,v:i.v};i.srs&&(n.srs=i.srs),i.d!==-1&&(n.Level=i.d,n.Span=i.s),t.gmx._sw&&(n.sw=t.gmx._sw);var o=new Promise(function(t){var i=e+"&"+Object.keys(n).map(function(e){return e+"="+n[e]}).join("&");fetch(i,{mode:"cors",credentials:"include"}).then(function(e){return e.text()}).then(function(e){var i="gmxAPI._vectorTileReceiver(";e.substr(0,i.length)===i&&(e=e.replace(i,""),e=e.substr(0,e.length-1)),t(JSON.parse(e))})});this._loadedTiles[r]=o}return this._loadedTiles[r]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(e){var t=d._getKey({layerID:e.LayerName,x:e.x,y:e.y,z:e.z,d:e.level,s:e.span,v:e.v});d._loadedTiles[t]&&d._loadedTiles[t].resolve({bbox:e.bbox,srs:e.srs,isGeneralized:e.isGeneralized,values:e.values})};var m=function(e,t){this.dataProvider=e,this.x=t.x,this.y=t.y,this.z=t.z,this.v=t.v,this.s=t.s||-1,this.d=t.d||-1,this.attributes=t.attributes,this.isGeneralized=t.isGeneralized,this.isFlatten=t.isFlatten,this.bounds=i.getBoundsByTilePoint(this.z?t:{z:0,x:0,y:0}),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=m.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&t.dateZero&&(this.beginDate=new Date(t.dateZero.valueOf()+this.s*this.d*i.oneDay*1e3),this.endDate=new Date(t.dateZero.valueOf()+(this.s+1)*this.d*i.oneDay*1e3)),this.clear()};m.prototype={addData:function(e,t){t&&this.removeData(t,!0);for(var r=e.length,n=new Array(r),o=i.bounds(),s=0;s<r;s++){var a=this._parseItem(e[s]);n[s]=a,o.extendBounds(a.bounds)}return this.data?(this.data=this.data.concat(e),this.dataOptions=this.dataOptions.concat(n)):(this.data=e,this.dataOptions=n),this.loaded(e),o},removeData:function(e){for(var t=this.data||[],i=t.length-1;i>=0;i--)e[t[i][0]]&&(t.splice(i,1),this.dataOptions&&this.dataOptions.splice(i,1))},loaded:function(e){this.state="loaded",this._resolve(e)},load:function(){if("notLoaded"===this.state){this.state="loading";var e=this;this.dataProvider.load(e.x,e.y,e.z,e.v,e.s,e.d,function(t){e.bbox=t.bbox,e.srs=t.srs,e.isGeneralized=t.isGeneralized,e.addData(t.values)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this))},_parseItem:function(e){var t,r=e.length-1;for(t=1;t<r;t++)null===e[t]&&(e[t]="");var n=e[r],o=this.isFlatten,s=n.type,a=s.indexOf("POLYGON")!==-1||s.indexOf("Polygon")!==-1,l="POLYGON"===s||"Polygon"===s,u=n.coordinates,h=[],c=null,d=[];if(a){l&&(u=[u]),c=i.bounds();var m=i.bounds().extendBounds(this.bounds).addBuffer(-.05),p=!1;for(t=0,r=u.length;t<r;t++){for(var f=[],g=[],y=0,v=u[t].length;y<v;y++){o&&"number"!=typeof u[t][y][0]&&(u[t][y]=i.flattenRing(u[t][y]));var x=i.bounds(u[t][y]);f.push(x),0===y&&c.extendBounds(x);var _=i.getHidden(u[t][y],m);g.push(_),_.length&&(p=!0)}d.push(f),h.push(g)}p||(h=null),l&&(d=d[0])}else if("POINT"===s||"Point"===s)c=i.bounds([u]);else if("MULTIPOINT"===s||"MultiPoint"===s)for(c=i.bounds(),t=0,r=u.length;t<r;t++)c.extendBounds(i.bounds([u[t]]));else if("LINESTRING"===s||"LineString"===s)c=i.bounds(u);else if("MULTILINESTRING"===s||"MultiLineString"===s)for(c=i.bounds(),t=0,r=u.length;t<r;t++)c.extendBounds(i.bounds(u[t]));var b={bounds:c,boundsArr:d};return h&&(b.hiddenLines=h),b}},m.makeTileKey=function(e,t,i,r,n,o){return i+"_"+e+"_"+t+"_"+r+"_"+n+"_"+o},m.createTileKey=function(e){return[e.z,e.x,e.y,e.v,e.s,e.d].join("_")},m.parseTileKey=function(e){var t=e.split("_").map(function(e){return Number(e)});return{z:t[0],x:t[1],y:t[2],v:t[3],s:t[4],d:t[5]}},m.boundsFromTileKey=function(e){var t=m.parseTileKey(e);return i.getTileBounds(t.x,t.y,t.z)};var p=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this.type=e.type||"update",this._callback=e.callback,this.layerID=e.layerID,this.target=e.target,this.z=e.z,this.itemHook=e.itemHook,this._items=null,this.bbox=e.bbox,this.needBbox=e.needBbox,this.filters=e.filters||[],this.targetZoom=e.targetZoom||null,this.active=!("active"in e)||e.active,this.srs=e.srs||3857,e.bounds&&this.setBounds(e.bounds);var t,r=i.worldWidthMerc;this.bbox?this.bbox.max.x>r?(t=this.bbox.max.x-r,this.bbox1=i.bounds([[t-r,this.bbox.max.y],[-(t+r),this.bbox.min.y]])):this.bbox.min.x<-r&&(t=this.bbox.min.x+r,this.bbox1=i.bounds([[t+r,this.bbox.max.y],[r-t,this.bbox.min.y]])):(this.bbox=i.bounds([[-r,-r],[r,r]]),this.world=!0),e.dateInterval&&this._setDateInterval(e.dateInterval[0],e.dateInterval[1])},hasFilter:function(e){for(var t=0,i=this.filters.length;t<i;t++)if(this.filters[t]===e)return!0;return!1},activate:function(e){return this.active||(this.active=!0,e||this.fire("activate")),this},deactivate:function(e){return this.active&&(this.active=!1,e||this.fire("activate")),this},toggleActive:function(e){return e?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(e){var t=e.length,i={count:t};if("update"===this.type){this._items||(this._items={});for(var r,n=this._items,o={},s=[],a=[],l=0;l<t;l++){var u=e[l];r=u.id+"_"+u.tileKey,o[r]=u,n[r]||s.push(u)}for(r in n)o[r]||a.push(n[r]);s.length&&(i.added=s),a.length&&(i.removed=a),this._items=o}else i.added=e;return this.fire("data",{data:this._callback(i)}),i=null,e=null,this},removeData:function(e){if("update"!==this.type||!this._items)return this;var t=this._items,i=[];for(var r in e)t[r]&&(i.push(t[r]),delete t[r]);return i.length&&this._callback({removed:i}),this},setBounds:function(e,r){var n;if(!e)return this.world||(n=i.worldWidthMerc,this.bbox=i.bounds([[-n,-n],[n,n]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var o=e.min,s=e.max;if(!o||!s){var a=t.latLngBounds(e),l=a.getSouthWest(),u=a.getNorthEast();o={x:l.lng,y:l.lat},s={x:u.lng,y:u.lat}}var h=o.x,c=s.x,d=o.y,m=s.y,p=null,f=null;if(this.world=!1,n=(c-h)/2,n>=180)h=-180,c=180,this.world=!0;else if(c>180||h<-180){var g=(c+h)/2%360;g>180?g-=360:g<-180&&(g+=360),h=g-n,c=g+n,h<-180?(p=h+360,f=180,h=-180):c>180&&(p=-180,f=c-360,c=180)}var y=3857==this.srs?t.CRS.EPSG3857:t.Projection.Mercator,v=y.project(t.latLng(d,h)),x=y.project(t.latLng(m,c));return this.bbox=i.bounds([[v.x,v.y],[x.x,x.y]]),r&&this.bbox.addBuffer(r),this.bbox1=null,p&&(v=y.project(t.latLng(d,p)),x=y.project(t.latLng(m,f)),this.bbox1=i.bounds([[v.x,v.y],[x.x,x.y]]),r&&this.bbox1.addBuffer(r)),this.fire("update"),this},intersects:function(e){return this.world||this.bbox.intersects(e)||!(!this.bbox1||!this.bbox1.intersects(e))},intersectsWithTile:function(e){if(this.targetZoom&&!this.needBbox){var t=this.targetZoom+(this.targetZoom%2?1:0);if(e.isGeneralized&&e.z!==t||e.z>t)return!1}var i=this.dateInterval;return this.intersects(e.bounds)&&(!e.beginDate||i&&i.endDate>=e.beginDate&&i.beginDate<=e.endDate)},intersectsWithGeometry:function(e){var t=e.type.toUpperCase(),i=e.coordinates;if("POINT"===t)return this.world||this.bbox.contains(i)||!(!this.bbox1||!this.bbox1.contains(i));"POLYGON"===t?i=[i[0]]:"MULTIPOLYGON"===t?i=i.map(function(e){return e[0]}):"LINESTRING"===t&&(i=[i]);for(var r=0,n=i.length;r<n;r++)if(this.bbox.clipPolygon(i[r]).length||this.bbox1&&this.bbox1.clipPolygon(i[r]).length)return!0;return!1},_setDateInterval:function(e,t){e&&t?this.dateInterval={beginDate:e,endDate:t}:this.dateInterval=null},setDateInterval:function(e,t){var i=e&&t;return(!this.dateInterval!=!i||i&&(this.dateInterval.beginDate.valueOf()!==e.valueOf()||this.dateInterval.endDate.valueOf()!==t.valueOf()))&&(this._setDateInterval(e,t),this.fire("update",{temporalFilter:!0})),this}});t.gmx.observer=function(e){return new p(e)},function(){var e=function(e){var t=[],r=e.TemporalTiles||[],n=e.TemporalVers||[],o=e.TemporalPeriods||[],s=o[o.length-1],a=Number.MAX_VALUE,l=e.ZeroDate.split("."),u=new Date(l.length>2?l[2]:2008,l.length>1?l[1]-1:0,l.length>0?l[0]:1),h=new Date(u.getTime()-6e4*u.getTimezoneOffset()),c=h.getTime()/1e3;this.dateZero=h;var d,p,f=function(e,t,r){var n=e.d;if(t.d===o[n])return e.count++,void e.tiles.push(r);var s=o[n-1],a=o[n]/s;"children"in e||(e.children=new Array(a));var l=Math.floor(t.s*t.d/s),u=l-e.s*a;if(!e.children[u]){var h=s*i.oneDay,d=l*h+c;e.children[u]={d:n-1,s:l,t1:d,t2:d+h,count:0,children:[],tiles:[]}}f(e.children[u],t,r)},g=o.length-1,y=o[g]*i.oneDay;for(d=0,p=r.length;d<p;d++){l=r[d];var v=Number(l[1]),x=Number(l[0]);x===s&&(a=Math.min(a,v))}for(d=0,p=r.length;d<p;d++){l=r[d];var _={x:Number(l[2]),y:Number(l[3]),z:Number(l[4]),v:Number(n[d]),s:Number(l[1]),d:Number(l[0])};if(!(_.d<0)){var b=Math.floor(_.s*_.d/o[g])-a,S=b+a;t[b]=t[b]||{d:g,s:S,t1:S*y+c,t2:(S+1)*y+c,count:0,tiles:[]};var T=m.createTileKey(_);f(t[b],_,T)}}r=n=null,this.selectTiles=function(e,i,r){r=r||{};for(var n=e.valueOf()/1e3,s=i.valueOf()/1e3,a=0,l=(s-n)/3600/24,u=0;u<o.length;u++)if(o[u]>l){a=Math.max(0,u-1);break}o[o.length-1]<=l&&(a=o.length-1);for(var h=Math.min(o.length-1,a+Number(l>o[a])),c=function(e,t){for(var i=0,r=0;r<e.length;r++)e[r].intersects(t)&&i++;return i},d=function(e,t,i){if(t>=e.t2||i<=e.t1)return{count:0,tiles:[],nodes:[]};if(r.bounds&&!e.tileBounds&&(e.tileBounds=e.tiles.map(function(e){return m.boundsFromTileKey(e)})),e.d===a){var n=r.bounds?c(e.tileBounds,r.bounds):e.count;return{tiles:e.tiles,count:n,nodes:[e]}}var o,s=0,l=[],u=e.children?e.children.length:0;for(o=0;o<u;o++)e.children[o]?l[o]=d(e.children[o],Math.max(t,e.t1),Math.min(i,e.t2)):l[o]={count:0,tiles:[],nodes:[]},s+=l[o].count;var p=r.bounds?c(e.tileBounds,r.bounds):e.count;if(e.d>h||s<p){var f=[],g=[];for(o=0;o<l.length;o++)g.push(l[o].nodes),f.push(l[o].tiles);return{tiles:[].concat.apply([],f),count:s,nodes:[].concat.apply([],g)}}return{tiles:e.tiles,count:p,nodes:[e]}},p=[],f=0;f<t.length;f++)if(t[f]){var g=d(t[f],n,s);g.tiles.length&&(p=p.concat(g.tiles))}for(var y={},v=0;v<p.length;v++)y[p[v]]=!0;return{tiles:y}},this.getNode=function(e,i){if(e<0||i<0)return null;for(var r=function(e,t,i){if(!e)return null;if(o[e.d]===t)return e.s===i?e:null;var n=o[e.d]/o[e.d-1],s=Math.floor(i*t/o[e.d-1]),a=s-e.s*n;return e.children[a]?r(e.children[a],t,i):null},n=0;n<t.length;n++){var s=r(t[n],e,i);if(s)return s}return null}};t.gmx.tilesTree=function(t){return new e(t)}}();var f=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,initialize:function(e){this._dataManager=e,this._observerData={},this._tileData={}},addObserver:function(e){return this._observerData[e.id]={observer:e,tiles:{},leftToLoad:0,loadingState:!1},e.on("update",this._updateObserver.bind(this,e)),this._updateObserver(e),this},removeObserver:function(e){var t=this._observerData[e].tiles;for(var i in t)delete this._tileData[i].observers[e];return delete this._observerData[e],this},addTile:function(e){var t="loaded"===e.state?0:1,i={};for(var r in this._observerData){var n=this._observerData[r];n.observer.intersectsWithTile(e)&&(n.tiles[e.vectorTileKey]=!0,n.leftToLoad+=t,i[r]=!0)}return this._tileData[e.vectorTileKey]={observers:i,tile:e},e.loadDef.then(this._tileLoadedCallback.bind(this,e)),this},removeTile:function(e){var t=this._tileData[e],i="loaded"===t.tile.state?0:1;for(var r in t.observers){var n=this._observerData[r];n.leftToLoad-=i,delete n.tiles[e]}return delete this._tileData[e],this},_isLeftToLoad:function(e){var t=0,i=this._dataManager.processingTile;for(var r in e.tiles){var n=this._tileData[r].tile;n!==i&&"loaded"!==n.state&&t++}return t},startLoadTiles:function(e){this._dataManager._getActiveTileKeys();var t=this._observerData[e.id];if(t){if(t.leftToLoad=this._isLeftToLoad(t),t.leftToLoad<1)return this.fire("observertileload",{observer:e}),this;t.loadingState||(t.loadingState=!0,e.fire("startLoadingTiles"));for(var i in t.tiles)this._tileData[i].tile.load()}return this},getTileObservers:function(e){return this._tileData[e].observers},getObserverLoadingState:function(e){return this._observerData[e.id].loadingState},getObserverLeftToLoad:function(e){return this._observerData[e.id].leftToLoad},_updateObserver:function(e){if(this._observerData[e.id]){var t,i=this._observerData[e.id],r={},n=0;for(t in this._tileData){var o=this._tileData[t].tile;e.intersectsWithTile(o)&&(r[t]=!0,"loaded"!==o.state&&n++,this._tileData[t].observers[e.id]=!0)}for(t in i.tiles)t in r||delete this._tileData[t].observers[e.id];i.tiles=r,i.leftToLoad=n}},_tileLoadedCallback:function(e){this.fire("tileload",{tile:e});var t=e.vectorTileKey;if(t in this._tileData){var i=this._tileData[t].observers;for(var r in i){var n=this._observerData[r],o=n.leftToLoad;n.leftToLoad=this._isLeftToLoad(n),n.leftToLoad<1&&(n.loadingState&&(n.loadingState=!1),o&&this.fire("observertileload",{observer:n.observer}))}}}}),g=t.Class.extend({includes:t.Evented?t.Evented.prototype:t.Mixin.Events,options:{name:null,srs:"",identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:-1,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,needBbox:!1,isFlatten:!1},setOptions:function(e){if(e.GeoProcessing){if(this.options.LayerVersion===e.LayerVersion)return;this._chkProcessing(e.GeoProcessing)}else this._clearProcessing();t.setOptions(this,e),this.optionsLink=e,this._isTemporalLayer=this.options.Temporal;var i=t.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=i.tileAttributeIndexes,this.temporalColumnType=i.tileAttributeTypes[this.options.TemporalColumnName];var r=this.options.hostName,n=this.options.sessionKey||"";this.tileSenderPrefix=t.gmxUtil.protocol+"//"+r+"/TileSender.ashx?WrapStyle=None&key="+encodeURIComponent(n),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(e,t,i,r,n,o,s){var a=this;d.load(a.tileSenderPrefix,{x:e,y:t,z:i,v:r,s:n,d:o,srs:this.options.srs,layerID:a.options.name}).then(s,function(){console.log("Error loading vector tile"),s({values:[]}),a.fire("chkLayerUpdate",{dataProvider:a})})},initialize:function(e,t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._filtersView={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var i=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new f(this),this._observerTileLoader.on("tileload",function(e){var t=e.tile;if(i._updateItemsFromTile(t),i._tilesTree){var r=i._tilesTree.getNode(t.d,t.s);r&&r.count--}}),this._observerTileLoader.on("observertileload",function(e){var t=e.observer;t.isActive()&&(t.needRefresh=!1,t.updateData(i.getItems(t.id)))}),this.setOptions(e),t&&(this.options.LayerVersion=-1),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(e,t,i){var r=e.options.unixTimeStamp,n=i.dateInterval;return n&&r>=n.beginDate.valueOf()&&r<n.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),this.options.needBbox||!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var e={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),e=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(e)}else this.initTilesList();return this._activeTileKeys},getViewFilters:function(e,t){var i=[];e=e||"screen";for(var r in this._filtersView[t])0===r.indexOf(e)&&i.push(r);return i},_getObserversByFilterName:function(e,t){var i={};for(var r in this._observers){var n=this._observers[r];n.hasFilter(e)?i[r]=!0:t&&t===n.target&&(n.filters.push(e),i[r]=!0)}return i},addLayerFilter:function(e,t){if(t&&t.layerID){var i=t.layerID,r=t.target||"screen",n=r;this._filtersView[i]||(this._filtersView[i]={}),t.id&&(n+="_"+t.id),this._filtersView[i][n]=e,this._triggerObservers(this._getObserversByFilterName(n,r))}return this},removeLayerFilter:function(e){if(this._filtersView[e.layerID]){var t=e.layerID,i=e.target||"screen",r=i;if(e.id&&(r+="_"+e.id),this._filtersView[t][r]){var n=this._getObserversByFilterName(r,i);delete this._filtersView[t][r],this._triggerObservers(n)}}return this},addFilter:function(e,t){return this._filters[e]=t,this._triggerObservers(this._getObserversByFilterName(e)),this},removeFilter:function(e){if(this._filters[e]){var t=this._getObserversByFilterName(e);delete this._filters[e],this._triggerObservers(t)}return this},getItems:function(e){var t=[],i=this._observers[e];if(!i)return[];if(!i.isActive()&&"hover"!==i.id)return[];var r=i.layerID,n=this._filtersView[r]||{},o=i.filters.concat("processingFilter");this._isTemporalLayer&&o.push("TemporalFilter"),o=o.filter(function(e){return e in this._filters||e in n}.bind(this));var s=this,a=function(e){var r=e.data,a=t.length,l=r.length;t.length=a+l;for(var u=0;u<l;u++){var h=e.dataOptions[u];if(i.intersects(h.bounds)){var c=r[u],d=c[c.length-1];if(i.intersectsWithGeometry(d)){for(var m=c[0],p=s.getItem(m),f=!1,g=0;g<o.length;g++){var y=o[g],v=s._filters[y]||n[y];if(v&&!v(p,e,i,d,h)){f=!0;break}}if(!f){var x={id:m,properties:c,item:p,dataOption:h,v:e.v,tileKey:e.vectorTileKey};i.itemHook?i.itemHook(x):t[a++]=x}}}}t.length=a},l=this._getActiveTileKeys();for(var u in l){var h=s._tiles[u].tile;h.data&&h.data.length>0&&(0===h.z||i.intersectsWithTile(h))&&a(h)}return t},_updateItemsFromTile:function(e){for(var t=e.vectorTileKey,i=e.data||[],r=i.length,n=i[0]&&i[0].length-1,o=0;o<r;o++){var s=i[o],a=s[n],l=s[0],u=this._items[l];if(u?(u.processing?e.data[o]=u.properties:(u.properties=s,u.type.indexOf("MULTI")===-1&&(u.type="MULTI"+u.type)),delete u.bounds,u.currentFilter=null):(u={id:l,type:a.type,properties:s,options:{fromTiles:{}}},this._items[l]=u),u.options.fromTiles[t]=o,e.isGeneralized&&(u.options.isGeneralized=!0),this.options.TemporalColumnName){var h=s[this.tileAttributeIndexes[this.options.TemporalColumnName]];u.options.unixTimeStamp=1e3*h}}return r},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var e=this._observers,t=null,i=null;for(var r in e){var n=e[r],o=n.dateInterval;o&&((!t||o.beginDate<t)&&(t=o.beginDate),(!i||o.endDate>i)&&(i=o.endDate))}t&&i&&(this._beginDate!==t||this._endDate!==i)&&(this._beginDate=t,this._endDate=i,this._needCheckActiveTiles=!0)}},addObserver:function(e,i){
i=i||"s"+ ++this._freeSubscrID;var r=this,n=new p(e);return n.id=i,n.needRefresh=!0,this._observerTileLoader.addObserver(n),n.on("update",function(e){n.needRefresh=!0,e.temporalFilter&&(r._needCheckDateInterval=!0),t.gmx.layersVersion.now(),r._waitCheckObservers()}).on("activate",function(){r.fire("observeractivate"),r.checkObserver(n)}),r._needCheckDateInterval=!0,this._observers[i]=n,this._waitCheckObservers(),n.isActive()&&this.fire("observeractivate"),n},getActiveObserversCount:function(){var e=0;for(var t in this._observers)this._observers[t].isActive()&&e++;return e},getObserver:function(e){return this._observers[e]},removeObserver:function(e){if(this._observers[e]){this._observerTileLoader.removeObserver(e);var t=this._observers[e].isActive();delete this._observers[e],t&&this.fire("observeractivate")}},getObserverLoadingState:function(e){return this._observerTileLoader.getObserverLoadingState(e)},getObserverLeftToLoad:function(e){return this._observerTileLoader.getObserverLeftToLoad(e)},getTileKeysToLoad:function(e,t){var i=this._tilesTree.selectTiles(e,t).tiles;return i},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=i.bounds();for(var e in this._items){var t=this.getItem(e);this._itemsBounds.extendBounds(t.bounds)}}return this._itemsBounds},getItem:function(e){var t=this._items[e];if(t&&!t.bounds){var r=t.options.fromTiles,n=[];for(var o in r)if(this._tiles[o]){var s=r[o],a=this._tiles[o].tile;"loaded"===a.state&&a.dataOptions[s]?n.push(a.dataOptions[s].bounds):delete r[o]}if(1===n.length)t.bounds=n[0];else{t.bounds=i.bounds();for(var l=i.worldWidthMerc,u=0,h=n.length;u<h;u++){var c=n[u];t.bounds.max.x-c.min.x>l&&(c=i.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),t.bounds.extendBounds(c)}}}return t},getItemMembers:function(e){var t=this._items[e].options.fromTiles,i=[];for(var r in t)if(this._tiles[r]){var n=this._tiles[r].tile;if(n.data){var o=t[r],s=n.data[o],a=n.dataOptions[o],l=a.bounds;i.push({geo:s[s.length-1],width:l.max.x-l.min.x,dataOption:a})}}return i.sort(function(e,t){return t.width-e.width})},getItemGeometries:function(e){var t=this._items[e]?this._items[e].options.fromTiles:{},r=[];for(var n in t)if(this._tiles[n]&&this._tiles[n].tile.data){var o=this._tiles[n].tile.data,s=o[t[n]];r.push(i.getUnFlattenGeo(s[s.length-1]))}return r},addTile:function(e){this._tiles[e.vectorTileKey]={tile:e},this._getActiveTileKeys()[e.vectorTileKey]=!0,this._observerTileLoader.addTile(e),this.checkObservers()},checkObserver:function(e){e.needRefresh&&e.isActive()&&this._observerTileLoader.startLoadTiles(e)},checkObservers:function(){var e=this._observers;for(var t in this._observers)this.checkObserver(e[t])},_waitCheckObservers:function(){this._checkObserversTimer&&clearTimeout(this._checkObserversTimer),this._checkObserversTimer=setTimeout(t.bind(this.checkObservers,this),25)},_triggerObservers:function(e){var t=e||this._observers;for(var i in t)this._observers[i]&&(this._observers[i].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(e){var t=this._observers;for(var i in t)this._observers[i].removeData(e);this._waitCheckObservers()},_updateActiveTilesList:function(e){if(this._tileFilteringHook){var t={};for(var i in e)this._tileFilteringHook(this._getVectorTile(i,!0).tile)&&(t[i]=!0);e=t}var r,n=this._activeTileKeys||{},o={},s=this;this.processingTile&&(e[this.processingTile.vectorTileKey]=!0),this._rasterVectorTile&&(r=this._rasterVectorTile.vectorTileKey,e[r]=!0,this._tiles[r]={tile:this._rasterVectorTile});var a=function(e){var t=s._observerTileLoader.getTileObservers(e);for(var i in t)o[i]=!0};for(r in e)n[r]||(this._observerTileLoader.addTile(this._getVectorTile(r,!0).tile),a(r));for(r in n)e[r]||(a(r),this._observerTileLoader.removeTile(r));this._activeTileKeys=e,this._triggerObservers(o)},_propertiesToArray:function(e){var t=e.properties,i=this.tileAttributeIndexes,r=[];for(var n in i)r[i[n]]=t[n];return r[r.length]=e.geometry,r[0]=e.id,r},_clearProcessing:function(){if(this.processingTile){for(var e=this._items,t=this.processingTile,i=t.vectorTileKey,r=t.data||[],n=0,o=r.length;n<o;n++){var s=r[n][0];if(e[s]){var a=e[s];a.processing=null,a.currentFilter=null,delete a.options.fromTiles[i],delete a.fromServerProps,delete a.geometry}}t.clear()}},_chkProcessing:function(e){this.processingTile=this.processingTile||this.addData([]);var t,i,r,n,o,s,a=this._items,l=!1,u={},h=this.processingTile,c=h.vectorTileKey,d=h.data||[];if(e){if(e.Deleted){for(i=0,r=e.Deleted.length;i<r;i++)t=e.Deleted[i],u[t]=!0,a[t]&&(a[t].processing=!0,a[t].currentFilter=null);r>0&&(l=!0)}var m={};if(e.Inserted)for(i=0,r=e.Inserted.length;i<r;i++)n=e.Inserted[i],t=n[0],s=a[t],s&&s.processing&&this._isUpdateded(n,s.properties)!==n.length-1?d[s.options.fromTiles[c]]=n:u[t]||(m[t]=n);if(e.Updated)for(i=0,r=e.Updated.length;i<r;i++)n=e.Updated[i],t=n[0],s=a[t],s&&s.processing&&this._isUpdateded(n,s.properties)!==n.length-1?d[s.options.fromTiles[c]]=n:(u[t]||(m[t]=n),l||(l=!0));o=[];for(t in m)this._items[t]&&(this._items[t].properties=m[t],this._items[t].processing=!0,this._items[t].currentFilter=null),o.push(m[t]);o.length>0&&(this.processingTile=this.addData(o))}l?this.addFilter("processingFilter",function(e,t){return 0===t.z||!e.processing}):this._filters.processingFilter&&this.removeFilter("processingFilter")},_isUpdateded:function(e,t){if(e.length===t.length){for(var i=0,r=e.length;i<r;i++)if("object"==typeof e[i]&&JSON.stringify(e[i])!==JSON.stringify(t[i])&&e[i]!==t[i])return i;return!1}return!0},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())},_resetTilesTree:function(){this._tilesTree=null,this._reCheckActiveTileKeys()},updateVersion:function(e,i){if(!t.gmx.skipLoadTiles)if(e&&this.setOptions(e),i){this._needCheckActiveTiles=!1;for(var r,n={},o={},s=0,a=0,l=i.length;s<l;s+=6,a++)r=m.createTileKey({z:Number(i[s]),x:Number(i[s+1]),y:Number(i[s+2]),v:Number(i[s+3]),d:Number(i[s+4]),s:Number(i[s+5])}),n[r]=this._getVectorTile(r,!0),o[r]=!0;this._tiles=n,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile}),this._updateActiveTilesList(o)}else this._resetTilesTree()},getNotLoadedVectorTiles:function(e){var t=0;if(e.tiles)for(var i=e.tiles||[],r=0,n=0,o=i.length;r<o;r+=6,n++)this._tiles[m.createTileKey({z:Number(i[r]),x:Number(i[r+1]),y:Number(i[r+2]),v:Number(i[r+3]),d:Number(i[r+4]),s:Number(i[r+5])})]||t++;return t},_getDataKeys:function(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i][0]]=!0;return t},_getProcessingTile:function(){if(!this.processingTile){var e=-.5,t=-.5,i=0,r=0,n=-1,o=-1,s=this.options.isFlatten;this.processingTile=new m({load:function(e,t,i,r,n,o,s){s({values:[]})}},{x:e,y:t,z:i,v:r,s:n,d:o,isFlatten:s}),this.addTile(this.processingTile)}return this.processingTile},addData:function(e){e||(e=[]);var t=this._getProcessingTile(),i=this._getDataKeys(e),r=t.addData(e,i);return this._itemsBounds&&this._itemsBounds.extendBounds(r),this._updateItemsFromTile(t),this._triggerObservers(),t},removeData:function(e){this._itemsBounds=null;var t=this.processingTile;if(t){var i=(e||t.data).reduce(function(e,t){var i="string"==typeof t?t:t[0];return e[i]=!0,delete this._items[i],e}.bind(this),{});this._removeDataFromObservers(i),t.removeData(i,!0),this._updateItemsFromTile(t),this._triggerObservers()}return t},initTilesTree:function(){this._tilesTree=t.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(e,t){if(!this._tiles[e]&&t){var i=m.parseTileKey(e);i.dateZero=this.dateZero,this._addVectorTile(i)}return this._tiles[e]},_addVectorTile:function(e){e.isFlatten=this.options.isFlatten,e.needBbox=this.options.needBbox,e.attributes=this.options.attributes;var t=new m(this._vectorTileDataProvider,e),i=t.vectorTileKey;return this._tiles[i]={tile:t},i},_getGeneralizedTileKeys:function(e){for(var i=e.z%2?1:2,r=Math.pow(2,i),n=e.z-i,o=Math.floor(e.x/r),s=Math.floor(e.y/r),a={v:e.v,s:-1,d:-1,isGeneralized:!0},l={};n>1;){var u=[n,o,s].join("_");l[u]=t.extend({},a,{x:o,y:s,z:n}),n-=2,o=Math.floor(o/4),s=Math.floor(s/4)}return l},initTilesList:function(){var e={};if(this.options.tiles){for(var t,i,r,n,o=this.options.tiles||[],s=this.options.tilesVers,a=this.options.isGeneralized?{}:null,l={},u=0,h=0,c=o.length;u<c;u+=3,h++)if(r={x:Number(o[u]),y:Number(o[u+1]),z:Number(o[u+2]),v:Number(s[h]),s:-1,d:-1},n=this._getVectorTile(m.createTileKey(r),!0),i=n.tile.vectorTileKey,l[i]=n,e[i]=!0,a){var d=this._getGeneralizedTileKeys(r);for(t in d){var p=d[t];a[t]?a[t].v=Math.max(p.v,a[t].v):a[t]=p}}if(a)for(t in a)r=a[t],i=m.createTileKey(r),l[i]||(this._tiles[i]||this._addVectorTile(r),l[i]=this._tiles[i],e[i]=!0);this._tiles=l,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(e)},setTileFilteringHook:function(e){this._tileFilteringHook=e,this._reCheckActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._reCheckActiveTileKeys()},_reCheckActiveTileKeys:function(){this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});t.gmx=t.gmx||{},t.gmx.DataManager=g;var y=t.GridLayer.extend({_animateZoom:function(e){this.options.updateWhenZooming=!1,this._setView(e.center,e.zoom,!0,!0)},_setZoomTransform:function(e,i,r){var n=e.zoom+"_"+r+"_"+e.origin.x+"_"+e.origin.y,o=t.gmx._zoomLevelsCache[n]||{},s=o.translate,a=o.scale;s||(a=this._map.getZoomScale(r,e.zoom),s=e.origin.multiplyBy(a).subtract(this._map._getNewPixelOrigin(i,r))._round(),t.gmx._zoomLevelsCache[n]={translate:s,scale:a}),t.Browser.any3d?t.DomUtil.setTransform(e.el,s,a):t.DomUtil.setPosition(e.el,s)},_clearOldLevels:function(e){if(this._map){e=e||this._map.getZoom();for(var i in this._levels){var r=this._levels[i].el,n=Number(i);n!==e&&(t.DomUtil.remove(r),this._removeTilesAtZoom(n),this._onRemoveLevel(n),delete this._levels[i])}}},_noTilesToLoad:function(){var e=this._tileZoom||this._map.getZoom();for(var t in this._tiles)if(this._tiles[t].coords.z===e&&!this._tiles[t].loaded)return!1;return!0},_tileReady:function(e,i,r){if(this._map){i&&this.fire("tileerror",{error:i,tile:r,coords:e});var n=this._tileCoordsToKey(e);r=this._tiles[n],r&&(r.loaded=+new Date,i||(t.DomUtil.addClass(r.el,"leaflet-tile-loaded"),this.fire("tileload",{tile:r.el,coords:e})),this._noTilesToLoad()&&(this._loading=!1,this._clearOldLevels(this._tileZoom),this.fire("load")))}},_updateLevels:function(){var e=this._tileZoom,i=this._map;if(void 0!==e){for(var r in this._levels){var n=e-r;0===n&&(this._levels[r].origin=i.project(i.unproject(i.getPixelOrigin()),e).round(),this._onUpdateLevel(e))}var o=this._levels[e];return o||(o=this._levels[e]={},o.el=t.DomUtil.create("div","leaflet-tile-container leaflet-zoom-animated",this._container),o.origin=i.project(i.unproject(i.getPixelOrigin()),e).round(),o.zoom=e,this._setZoomTransform(o,i.getCenter(),i.getZoom()),this._onCreateLevel(o)),this._level=o,o}},_update:function(e){var i=this._map;if(i){var r=this._clampZoom(i.getZoom());if(void 0===e&&(e=i.getCenter()),void 0!==this._tileZoom){var n=this._getTiledPixelBounds(e),o=this._pxBoundsToTileRange(n),s=o.getCenter(),a=[],l=this.options.keepBuffer,u=new t.Bounds(o.getBottomLeft().subtract([l,-l]),o.getTopRight().add([l,-l]));if(!(isFinite(o.min.x)&&isFinite(o.min.y)&&isFinite(o.max.x)&&isFinite(o.max.y)))throw new Error("Attempted to load an infinite number of tiles");for(var h in this._tiles){var c=this._tiles[h].coords;c.z===this._tileZoom&&u.contains(new t.Point(c.x,c.y))||(this._tiles[h].current=!1)}if(Math.abs(r-this._tileZoom)>1)return void this._setView(e,r);for(var d=o.min.y;d<=o.max.y;d++)for(var m=o.min.x;m<=o.max.x;m++){var p=new t.Point(m,d);if(p.z=this._tileZoom,this._isValidTile(p)){var f=this._tiles[this._tileCoordsToKey(p)];f?f.current=!0:a.push(p)}}if(a.sort(function(e,t){return e.distanceTo(s)-t.distanceTo(s)}),0!==a.length){this._loading||(this._loading=!0,this.fire("loading"));var g=document.createDocumentFragment();for(m=0;m<a.length;m++)this._addTile(a[m],g)}this.fire("update")}}}});t.gmx.VectorLayer=y.extend({options:{tilesCRS:t.CRS.EPSG3395,openPopups:[],className:"vector-tiles",minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,skipTiles:"All",iconsUrlReplace:[],cacheRasters:!0,cacheQuicklooks:!0,clearCacheOnLoad:!0,showScreenTiles:!1,updateWhenZooming:!1,keepBuffer:0,clickable:!0},initialize:function(e){e=t.setOptions(this,e),this._initPromise=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this)),this.repaintObservers={},this._gmx={hostName:i.normalizeHostname(e.hostName||"maps.kosmosnimki.ru"),mapName:e.mapID,sessionKey:this.options.sessionKey,iconsUrlReplace:this.options.iconsUrlReplace,showScreenTiles:this.options.showScreenTiles,skipTiles:e.skipTiles,needBbox:"All"===e.skipTiles,useWebGL:e.useWebGL,srs:e.srs||"",layerID:e.layerID,beginDate:e.beginDate,endDate:e.endDate,sortItems:e.sortItems||null,styles:e.styles||[],shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},/\buseWebGL=1\b/.test(location.search)&&(this._gmx.useWebGL=!0),e.cacheQuicklooks&&(this._gmx.quicklooksCache={}),e.cacheRasters&&(this._gmx.rastersCache={}),e.crossOrigin&&(this._gmx.crossOrigin=e.crossOrigin)},_onCreateLevel:function(e){this._updateShiftY(e.zoom)},_initContainer:function(){if(!this._container){var e=["leaflet-layer"];this.options.className&&e.push(this.options.className),this._container=t.DomUtil.create("div",e.join(" ")),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),this._updateZIndex(),this.getPane(this.options.pane).appendChild(this._container)}},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},_waitCheckOldLevels:function(){this._oldLevelsTimer&&clearTimeout(this._oldLevelsTimer),this._oldLevelsTimer=setTimeout(this._chkOldLevels.bind(this),250)},_chkOldLevels:function(){if(this._map){var e,t,i=this._map._zoom;for(e in this._tiles)if(t=this._tiles[e],t.coords.z===i&&!t.loaded)return;this._loading=!1,this._clearOldLevels(i),this.fire("load")}},_waitOnMoveEnd:function(){this._onmoveendTimer&&clearTimeout(this._onmoveendTimer),this._onmoveendTimer=setTimeout(this._chkTiles.bind(this),250)},_chkCurrentTiles:function(){if(this._map){var e,i,r=this._tileZoom||this._map._zoom;for(e in this._tiles)i=this._tiles[e],i.coords.z===r&&(t.DomUtil.setPosition(i.el,this._getTilePos(i.coords)),i.promise||this.__drawTile(i))}},_chkTiles:function(){this._chkCurrentTiles(),this.repaint(),this._waitCheckOldLevels()},_getEvents:function(){var e=t.GridLayer.prototype.getEvents.call(this);t.extend(e,{});var i=this._gmx,r={dateIntervalChanged:function(){if(this._chkTiles(),t.gmx.sendCmd){var e=i.dataManager.getMaxDateInterval();t.gmx.sendCmd("dateIntervalChanged",{layerID:i.layerID,mapID:i.mapName,hostName:i.hostName,dInterval:[Math.floor(e.beginDate.getTime()/1e3),Math.floor(e.endDate.getTime()/1e3)]})}},tileloadstart:function(e){var t=e.key||this._tileCoordsToKey(e.coords),i=this._tiles[t];i.loaded=0},stylechange:function(){!i.balloonEnable&&this._popup?this.unbindPopup():i.balloonEnable&&!this._popup&&this.bindPopup(""),this._map&&(this.options.minZoom===i.styleManager.minZoom&&this.options.maxZoom===i.styleManager.maxZoom||(this.options.minZoom=i.styleManager.minZoom,this.options.maxZoom=i.styleManager.maxZoom,this._map._updateZoomLevels()),i.labelsLayer?this._map._labelsLayer.add(this):i.labelsLayer||this._map._labelsLayer.remove(this),this.repaint(),this._chkTiles())},versionchange:this._onVersionChange};return e.moveend=this._waitOnMoveEnd.bind(this),e.zoomend=this._waitOnMoveEnd.bind(this),{map:e,owner:r}},beforeAdd:function(e){this._updateShiftY(e.getZoom()),t.GridLayer.prototype.beforeAdd.call(this,e),this._map=e,this._drawnObjectsCount=0},onAdd:function(e){if(e=e||this._map,e.options.crs!==t.CRS.EPSG3857&&e.options.crs!==t.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";this.beforeAdd(e);var i=this._gmx;this.options.tilesCRS=3857==i.srs?t.CRS.EPSG3857:t.CRS.EPSG3395,i.shiftY=0,i.applyShift=e.options.crs===t.CRS.EPSG3857&&3857!=i.srs,i.currentZoom=e.getZoom(),this._levels={},this._tiles={},this._initContainer(),i.styleManager.initStyles().then(function(){if(i.balloonEnable&&!this._popup&&this.bindPopup(""),this._map){var r=this._getEvents();e.on(r.map,this),this.on(r.owner,this),this.once("remove",function(){e.off(r.map,this),this.off(r.owner,this)},this),t.gmx._zoomLevelsCache={},this._invalidateAll(),this._resetView(),i.dataManager.fire("moveend"),this._chkTiles(),t.gmx.layersVersion.add(this)}this.fire("add")}.bind(this))},onRemove:function(e){var i=this._gmx,r=i.dataManager;i.labelsLayer&&e._labelsLayer.remove(this),i.quicklooksCache={},i.rastersCache={},delete i.map,r&&!r.getActiveObserversCount()&&t.gmx.layersVersion.remove(this),this._map&&t.GridLayer.prototype.onRemove.call(this,e),this._map=null,this.fire("remove")},_removeTile:function(e){this._map&&!this._map._animatingZoom&&(this._gmx&&this._gmx.dataManager&&this._gmx.dataManager.removeObserver(e),t.GridLayer.prototype._removeTile.call(this,e))},_updateZIndex:function(){if(this._container){var e=this.options,t=e.zIndex||0,i=e.zIndexOffset||0;this._container.style.zIndex=i+t}this.fire("zindexupdated")},createTile:function(e,i){var r=t.DomUtil.create("canvas","leaflet-tile"),n=this.getTileSize();return r.width=r.height=0,r.style.width=n.x+"px",r.style.height=n.y+"px",r.onselectstart=t.Util.falseFn,r.onmousemove=t.Util.falseFn,t.Browser.android&&!t.Browser.android23&&(r.style.WebkitBackfaceVisibility="hidden"),r},initFromDescription:function(e){var r=this._gmx;if(r.properties=e.properties,r.geometry=e.geometry,r.properties._initDone&&delete r.properties[r.properties.Temporal?"TemporalTiles":"tiles"],r.properties._initDone=!0,!r.geometry){var n=i.tileSizes[1];r.geometry={type:"POLYGON",coordinates:[[[-n,-n],[-n,n],[n,n],[n,-n],[-n,-n]]]}}if(r.rawProperties=e.rawProperties||e.properties,this._updateProperties(e.properties),"Vector"===r.rawProperties.type&&(e.properties.srs=r.srs=3857,r.RasterSRS=Number(r.rawProperties.RasterSRS)||3857),e.properties.sessionKey=e.properties.sessionKey||r.sessionKey||"",e.properties.needBbox=r.needBbox,e.properties.isGeneralized=this.options.isGeneralized,e.properties.isFlatten=this.options.isFlatten,r.dataManager=this.options.dataManager||new g(e.properties),this.options.parentOptions&&(e.properties.styles||(e.properties.styles=this.options.parentOptions.styles),r.dataManager.on("versionchange",this._onVersionChange,this)),r.styleManager=new x(r),this.options.minZoom=r.styleManager.minZoom,this.options.maxZoom=r.styleManager.maxZoom,r.dataManager.on("observeractivate",this._chkNeedLayerVersion,this),"Vector"!==r.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==r.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),r.clusters&&this.bindClusters(JSON.parse(r.clusters)),r.filter){var o=t.gmx.Parsers.parseSQL(r.filter.replace(/[\[\]]/g,'"'));o&&r.dataManager.addFilter("userFilter_"+r.layerID,function(e){return r.layerID!==this._gmx.layerID||!o||o(e.properties,r.tileAttributeIndexes,r.tileAttributeTypes)?e.properties:null}.bind(this))}return r.dateBegin&&r.dateEnd&&this.setDateInterval(r.dateBegin,r.dateEnd),this._resolve(),this},getStyleIcon:function(e,t){return this._gmx.styleManager.getStyleIcon(e,t)},_chkNeedLayerVersion:function(){this._chkNeedLayerVersionTimer&&clearTimeout(this._chkNeedLayerVersionTimer),this._chkNeedLayerVersionTimer=setTimeout(function(){this._gmx.dataManager.getActiveObserversCount()?t.gmx.layersVersion.add(this):t.gmx.layersVersion.remove(this)}.bind(this),100)},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._gmx.dataManager.enableGeneralization(),this.redraw(),this._chkTiles()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._gmx.dataManager.disableGeneralization(),this.redraw(),this._chkTiles()))},setRasterOpacity:function(e){return this._gmx.rasterOpacity!==e&&(this._gmx.rasterOpacity=e,this._initPromise.then(this.repaint.bind(this))),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(e){return this._gmx.styleManager.getIcons(e),this},setStyles:function(e){return this._initPromise.then(function(){this._gmx.styleManager.clearStyles(),e?e.forEach(function(e,t){this.setStyle(e,t,!0)}.bind(this)):this.fire("stylechange")}.bind(this)),this},getStyle:function(e){return this.getStyles()[e]},setStyle:function(e,t,i){return this._initPromise.then(function(){this._gmx.styleManager.setStyle(e,t,i).then(function(){this.fire("stylechange",{num:t||0}),this.repaint()}.bind(this))}.bind(this)),this},setStyleHook:function(e){return this._gmx.styleHook=e,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(e){return this._gmx.rasterProcessingHook=e,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(e){var t=this._gmx;return t.dataManager.addFilter("userFilter",function(i){return t.layerID!==this._gmx.layerID||!e||e(i)?i.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},addLayerFilter:function(e,t){var i=this._gmx;return t=t||{},t.layerID=i.layerID,i.dataManager.addLayerFilter(function(t){return!e||e(t)?t.properties:null}.bind(this),t),this},removeLayerFilter:function(e){return e=e||{},e.layerID=this._gmx.layerID,this._gmx.dataManager.removeLayerFilter(e),this},setDateInterval:function(e,i){var r=this._gmx;if(r.dateBegin&&r.dateEnd&&(e=r.dateBegin,i=r.dateEnd),!r.beginDate!=!e||!r.endDate!=!i||e&&r.beginDate.valueOf()!==e.valueOf()||i&&r.endDate.valueOf()!==i.valueOf()){if(r.rawProperties.maxShownPeriod&&e){var n=24*r.rawProperties.maxShownPeriod*3600*1e3;e=new Date(Math.max(e.valueOf(),i.valueOf()-n))}r.beginDate=e,r.endDate=i;var o=null,s=r.dataManager;for(var a in this._tiles)this._tiles[a].loaded=0,o=this._tiles[a].observer,o&&o.setDateInterval(e,i);o=s.getObserver("_Labels"),o&&o.setDateInterval(e,i),("NotVisible"===r.skipTiles||r.needBbox||r.properties.UseTiles===!1)&&(r.needBbox||(r.properties.LayerVersion=-1,s.setOptions({LayerVersion:-1})),this._map&&t.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(e){return this._gmx.dataManager.addObserver(e)},removeObserver:function(e){return this._gmx.dataManager.removeObserver(e.id)},setPositionOffset:function(e,t){var i=this._gmx;return i.shiftXlayer=e,i.shiftYlayer=t,this._update(),this},getPositionOffset:function(){var e=this._gmx;return{shiftX:e.shiftXlayer,shiftY:e.shiftYlayer}},setZIndexOffset:function(e){return arguments.length&&(this.options.zIndexOffset=e),this._updateZIndex(),this},_clearLoaded:function(e){this._tiles[e]&&(this._tiles[e].loaded=0)},repaint:function(e){if(this._map){if(this._chkCurrentTiles(),e){if(t.Util.isArray(e)){var i=e;e={},i.forEach(function(t){e[t]=!0,this._clearLoaded(t)}.bind(this))}else if("string"==typeof e){var r=e;this._clearLoaded(r),e={},e[r]=!0}}else{var n,o,s=t.gmx._zoomStart||this._tileZoom||this._map._zoom;e={};for(n in this._tiles)o=this._tiles[n],o.coords.z===s?(e[n]=!0,this._clearLoaded(n),o.observer&&o.observer.activate(!0)):o.observer&&o.observer.deactivate(!0);t.extend(e,this.repaintObservers)}this._gmx.dataManager._triggerObservers(e)}},redrawItem:function(e){if(this._map){var t=this._gmx.dataManager.getItem(e),i=this._getTilesByBounds(t.bounds);this.repaint(i)}},appendTileToContainer:function(e){this._level&&this._level.zoom===e.coords.z&&this._level.el!==e.el.parentNode&&this._level.el.appendChild(e.el)},addData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.addData(e,t),this.repaint()),this},removeData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.removeData(e,t),this.repaint()),this},getStylesByProperties:function(e,t){return this._gmx.styleManager.getCurrentFilters(e,t)},getItemStyle:function(e){var t=this._gmx,i=t.dataManager.getItem(e);return t.styleManager.getObjStyle(i)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(e){var i=this._gmx,r=i.dataManager.getItem(e),n=this.getStyles(),o="";if(r&&n[r.currentFilter]){var s=r.properties;o=t.gmxUtil.parseBalloonTemplate(n[r.currentFilter].Balloon,{properties:this.getItemProperties(s),geometries:[s[s.length-1]],tileAttributeTypes:i.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return o},getItemProperties:function(e){var t={},i=this._gmx.tileAttributeIndexes;for(var r in i)t[r]=e[i[r]];return t},addPreRenderHook:function(e){this._gmx.preRenderHooks.push(e),this.repaint()},removePreRenderHook:function(e){for(var t=this._gmx.preRenderHooks,i=0,r=t.length;i<r;i++)if(t[i]===e){t.splice(i,1),this.repaint();break}},addRenderHook:function(e){this._gmx.renderHooks.push(e),this.repaint()},removeRenderHook:function(e){for(var t=this._gmx.renderHooks,i=0,r=t.length;i<r;i++)if(t[i]===e){t.splice(i,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var e=this._gmx.layerID?i.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return e?e.toLatLngBounds(3857==this._gmx.srs):new t.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=t.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0,3857==this._gmx.srs)),this._gmx.latLngGeometry},getPropItem:function(e,t){return i.getPropItem(e,t,this._gmx.tileAttributeIndexes)},_getTilesByBounds:function(e){var t=this._gmx,i=this._tileZoom||this._map._zoom,r=t.shiftX||0,n=t.shiftY||0,o=e.toLatLngBounds(3857==t.srs),s=o.getSouthWest(),a=o.getNorthEast(),l=this._map.getBounds(),u=l.getSouthWest(),h=l.getNorthEast(),c=0;h.lng-u.lng<360&&(a.lng<u.lng?c=360*(1+Math.floor((u.lng-a.lng)/360)):s.lng>h.lng&&(c=360*Math.floor((h.lng-s.lng)/360))),s.lng+=c,a.lng+=c;var d,m,p,f,g=this._map.getPixelBounds(),y=this._map.project(s),v=this._map.project(a),x=this.options.tileSize;g?(d=Math.floor((Math.max(v.y,g.min.y)+n)/x),m=Math.floor((Math.min(y.y,g.max.y)+n)/x),p=s.lng<=-180?g.min.x:Math.max(y.x,g.min.x),p=Math.floor((p+r)/x),f=a.lng>=180?g.max.x:Math.min(v.x,g.max.x),f=Math.floor((f+r)/x)):(d=Math.floor((v.y+n)/x),m=Math.floor((y.y+n)/x),p=Math.floor((y.x+r)/x),f=Math.floor((v.x+r)/x));for(var _={},b=p;b<=f;b++)for(var S=d;S<=m;S++){var T=this._tileCoordsToKey({x:b,y:S,z:i});_[T]=!0}return _},_updateProperties:function(e){var i=this._gmx;i.sessionKey||(i.sessionKey=e.sessionKey=this.options.sessionKey||""),this.options.parentOptions&&(e=this.options.parentOptions),i.identityField=e.identityField,i.GeometryType=(e.GeometryType||"").toLowerCase(),i.minZoomRasters=e.RCMinZoomForRasters||1,i.minZoomQuicklooks=i.minZoomRasters;var r=e.type||"Vector";if(e.Temporal&&(r+="Temporal"),i.layerType=r,i.items={},t.extend(i,t.gmxUtil.getTileAttributes(e)),i.dataManager&&i.dataManager.setOptions(e),"ZIndexField"in e&&e.ZIndexField in i.tileAttributeIndexes&&(i.zIndexField=i.tileAttributeIndexes[e.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),i.filter=e.filter,i.dateBegin=e.dateBegin,i.dateEnd=e.dateEnd,i.dataSource=e.dataSource,"MetaProperties"in i.rawProperties){var n=i.rawProperties.MetaProperties;"srs"in n&&(i.srs=n.srs.Value||""),"parentLayer"in n&&(i.dataSource=n.parentLayer.Value||""),"filter"in n&&(i.filter=n.filter.Value||""),"dateBegin"in n&&(i.dateBegin=t.gmxUtil.getDateFromStr(n.dateBegin.Value||"01.01.1980")),"dateEnd"in n&&(i.dateEnd=t.gmxUtil.getDateFromStr(n.dateEnd.Value||"01.01.1980")),("shiftX"in n||"shiftY"in n)&&(i.shiftXlayer=n.shiftX?Number(n.shiftX.Value):0,i.shiftYlayer=n.shiftY?Number(n.shiftY.Value):0),("shiftXfield"in n||"shiftYfield"in n)&&(n.shiftXfield&&(i.shiftXfield=n.shiftXfield.Value),n.shiftYfield&&(i.shiftYfield=n.shiftYfield.Value)),"quicklookPlatform"in n&&(i.quicklookPlatform=n.quicklookPlatform.Value,"image"===i.quicklookPlatform&&delete i.quicklookPlatform),"quicklookX1"in n&&(i.quicklookX1=n.quicklookX1.Value),"quicklookY1"in n&&(i.quicklookY1=n.quicklookY1.Value),"quicklookX2"in n&&(i.quicklookX2=n.quicklookX2.Value),"quicklookY2"in n&&(i.quicklookY2=n.quicklookY2.Value),"quicklookX3"in n&&(i.quicklookX3=n.quicklookX3.Value),"quicklookY3"in n&&(i.quicklookY3=n.quicklookY3.Value),"quicklookX4"in n&&(i.quicklookX4=n.quicklookX4.Value),"quicklookY4"in n&&(i.quicklookY4=n.quicklookY4.Value),"gmxProxy"in n&&(i.gmxProxy="true"===n.gmxProxy.Value.toLowerCase()?t.gmx.gmxProxy:n.gmxProxy.Value),"multiFilters"in n&&(i.multiFilters="1"===n.multiFilters.Value),"isGeneralized"in n&&(this.options.isGeneralized="false"!==n.isGeneralized.Value),"isFlatten"in n&&(this.options.isFlatten="false"!==n.isFlatten.Value)}if(e.Temporal&&(this.options.isGeneralized=!1),e.IsRasterCatalog){i.IsRasterCatalog=e.IsRasterCatalog;var o=i.tileAttributeIndexes.GMX_RasterCatalogID;o&&(i.rasterBGfunc=function(e,r,n,s,a){var l=s.properties,u=t.gmxUtil.protocol+"//"+i.hostName+"/TileSender.ashx?ModeKey=tile&ftc=osm&x="+e+"&y="+r+"&z="+n;return(a||i.srs)&&(u+="&srs="+(a||i.srs)),i.crossOrigin&&(u+="&cross="+i.crossOrigin),u+="&LayerName="+l[o],i.sessionKey&&(u+="&key="+encodeURIComponent(i.sessionKey)),t.gmx._sw&&s.v&&(u+="&sw="+t.gmx._sw+"&v="+s.v),u})}if(e.Quicklook){var s;s="{"===e.Quicklook[0]?JSON.parse(e.Quicklook):{minZoom:i.minZoomRasters,template:e.Quicklook},"X1"in s&&(i.quicklookX1=s.X1),"Y1"in s&&(i.quicklookY1=s.Y1),"X2"in s&&(i.quicklookX2=s.X2),"Y2"in s&&(i.quicklookY2=s.Y2),"X3"in s&&(i.quicklookX3=s.X3),"Y3"in s&&(i.quicklookY3=s.Y3),"X4"in s&&(i.quicklookX4=s.X4),"Y4"in s&&(i.quicklookY4=s.Y4);var a=i.Quicklook=s.template;"minZoom"in s&&(i.minZoomQuicklooks=s.minZoom),i.quicklookBGfunc=function(e){for(var t=a,r=/\[([^\]]+)\]/,n=r.exec(t);n&&n.length>1;)t=t.replace(n[0],e.properties[i.tileAttributeIndexes[n[1]]]),n=r.exec(t);return t},i.imageQuicklookProcessingHook=t.gmx.gmxImageTransform}this.options.attribution=e.Copyright||""},_updateShiftY:function(e){var t=this._gmx;t.currentZoom=e,t.tileSize=i.tileSizes[e],t.mInPixel=this.options.tileSize/t.tileSize},__drawTile:function(t){var i=t.coords,r=this._tileCoordsToKey(i),n=this._tiles[r];if(n){var o=this,s=this._tileZoom,a=this._gmx;n.promise?n.resolve():(n.loaded=0,n.key=r,n.screenTile=new e(o,n),n.promise=new Promise(function(e,t){n.resolve=e,n.reject=t;var l=a.dataManager.getViewFilters("screen",a.layerID),u=function(){n.count&&(o._drawnObjectsCount+=n.count,o.appendTileToContainer(n)),o._tileReady(i,null,n.el)};n.observer=a.dataManager.addObserver({type:"resend",layerID:a.layerID,needBbox:a.needBbox,srs:a.srs,target:"screen",z:s,targetZoom:o.options.isGeneralized?s:null,dateInterval:"VectorTemporal"===a.layerType?[a.beginDate,a.endDate]:null,active:!0,bbox:a.styleManager.getStyleBounds(i),filters:["clipFilter","userFilter_"+a.layerID,"styleFilter","userFilter"].concat(l),callback:function(e){o._tiles[r]?(o._tiles[r].loaded=0,n.screenTile.drawTile(e).then(function(e){e&&(n.count=e.count),u(e)},function(e){u(e)})):u()}},r)})["catch"](function(e){console.warn("catch:",e)}))}}}),t.Map.addInitHook(function(){t.Mixin.ContextMenu&&t.gmx.VectorLayer.include(t.Mixin.ContextMenu),
this.options.ftc=this.options.ftc||"osm",this.options.srs=this.options.srs||3857,this.options.skipTiles=this.options.skipTiles||"All",t.gmx.leafletMap=this,t.gmx._zoomLevelsCache={},this.on("zoomstart",function(e){t.gmx._zoomStart=e.zoom,t.gmx._zoomLevelsCache={},t.gmx._zoomLevelsCount=0;var i=0,r=this.options.maxZoomAnimGmxLayers||5;for(var n in this._layers){var o=this._layers[n];if(o._map&&o instanceof t.gmx.VectorLayer){var s=t.DomUtil.removeClass;e.zoom>this._zoom&&(0===o._drawnObjectsCount||i>r)?s=t.DomUtil.addClass:i++,s(o._container,"leaflet-zoom-hide"),o._drawnObjectsCount=0}}},this)});var v={credentials:"include"};e.prototype={_getUrlFunction:function(e,t){return this.gmx.rasterBGfunc(e.x,e.y,e.z,t)},_chkZoom:function(e){return e>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||e>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx},_loadTileRecursive:function(e,i){var r=this.gmx,n={z:e.z,x:this.ntp.x,y:this.ntp.y},o=this;return this.rasterRequests={},new Promise(function(e){var s=function(n,a){var l=o._getUrlFunction(n,i);if(r.rastersCache&&r.rastersCache[l])e({gtp:n,image:r.rastersCache[l]});else{var u=function(t){t&&(r.badTiles[t]=!0);var i=n.z-1;i&&o._chkZoom(i)?s({x:Math.floor(n.x/2),y:Math.floor(n.y/2),z:i},""):e({gtp:n})},h=function(e){o.layer.fire("bitmap",{id:i.id,loaded:!1,url:l,result:e}),u(l)};if(r.badTiles[l]||r.maxNativeZoom&&r.maxNativeZoom<n.z)return void u();if(t.gmx.getBitmap)t.gmx.getBitmap(l,v).then(function(t){if(t){var s=t.imageBitmap,a=document.createElement("canvas");a.width=s.width,a.height=s.height,a.getContext("2d").drawImage(s,0,0,a.width,a.width),r.rastersCache&&(r.rastersCache[l]=a),e({gtp:n,image:a}),o.layer.fire("bitmap",{id:i.id,loaded:!0,url:l,result:t})}else h()},h)["catch"](t.Util.falseFn);else{var c=o.rasterRequests[l];c?c.options.tileRastersId=o._uniqueID:(r.rasterProcessingHook&&(a="anonymous"),c=t.gmx.imageLoader.push(l,{tileRastersId:o._uniqueID,zoom:o.zoom,cache:!0,crossOrigin:r.crossOrigin||a||""}),o.rasterRequests[l]=c),c.def.then(function(t){t?(r.rastersCache&&(r.rastersCache[l]=t),e({gtp:n,image:t})):u(l)},function(){u(l)})}}};s(n)})},_rasterHook:function(e){var t=e.sourceTilePoint||e.destinationTilePoint,i={geoItem:e.geoItem,zKey:e.zKey,destination:{z:e.destinationTilePoint.z,x:e.destinationTilePoint.x,y:e.destinationTilePoint.y},source:{z:t.z,x:t.x,y:t.y}};return e.url&&(i.quicklook=e.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(e.res,e.image,e.sx||0,e.sy||0,e.sw||256,e.sh||256,e.dx||0,e.dy||0,e.dw||256,e.dh||256,i)},_defaultRasterHook:function(e,t,i,r,n,o,s,a,l,u){if(t){var h=e.getContext("2d");h.drawImage(t,i,r,n,o,s,a,l,u)}return e},_getShiftPixels:function(e){var t=e.dx+(e.dx<0?256:0),i=e.dy+(e.dy<0?256:0),r=0,n=256-t,o=t,s=n;if(e.tx>e.x&&(r=n,n=t,o=0,s=n),256===r||n<1)return null;var a=i,l=256-i,u=0,h=l;return e.ty>e.y&&(a=0,u=l,l=i,h=l),256===a||l<1?null:{sx:r,sy:a,sw:n,sh:l,dx:o,dy:u,dw:s,dh:h}},_getShiftTilesArray:function(e,t,i){var r=this.topLeft.mInPixel,n=this.gmxTilePoint,o=t*r,s=i*r,a=Math.floor(.5+o%this.ts),l=Math.floor(.5+s%this.ts),u=this.ts/r,h=n.x-t/u,c=n.y-i/u,d=Math.floor(h),m=d+(h===d?0:1),p=Math.floor(c),f=p+(c===p?0:1),g=Math.floor((e.min.x-t)/u),y=Math.floor((e.max.x-t)/u),v=Math.floor((e.min.y-i)/u),x=Math.floor((e.max.y-i)/u);d<g&&(d=g),m>y&&(m=y),p<v&&(p=v),f>x&&(f=x);for(var _=[],b=p;b<=f;b++)for(var S=d;S<=m;S++)_.push({z:n.z,x:S,y:b,dx:a,dy:l,tx:h,ty:c});return _},_chkRastersByItemIntersect:function(e,t){var r=t.properties[t.properties.length-1],n=[];return e.forEach(function(e){var t=i.getBoundsByTilePoint(e);i.isItemIntersectBounds(r,t)&&n.push(e)}),n},getTilePosZoomDelta:function(e,t,i){var r=Math.pow(2,t-i),n=this.ts/r,o=e.x%r,s=e.y%r;return{size:n,zDelta:r,x:n*o,y:n*s}},_getItemRasters:function(e){var r=e.properties,n=r[0],o=this,s=this.gmx,a=s.tileAttributeIndexes,l=this.rasters,u=Number(s.shiftXfield?i.getPropItem(s.shiftXfield,r,a):0)%this.worldWidthMerc,h=Number(s.shiftYfield?i.getPropItem(s.shiftYfield,r,a):0),c=u||h,d=i.getPropItem("urlBG",r,a),m="",p=null,f=!1,g=s.dataManager.getItem(n),y=this.gmxTilePoint,x=this.tilePoint,_=this.ntp,b=null;return g.v=e.v,s.IsRasterCatalog&&("Raster"===s.rawProperties.type||i.getPropItem("GMX_RasterCatalogID",r,a))?f=!0:s.quicklookBGfunc?(m=s.quicklookBGfunc(g),p=s.imageQuicklookProcessingHook):d&&(m=d,p=s.imageQuicklookProcessingHook),f?new Promise(function(i){var r=e.dataOption||{},a=this._chkRastersByItemIntersect(c?this._getShiftTilesArray(r.bounds,u,h):[_],e),d=a.length,m=function(){d<1&&i()},f=function(){d--,m()},y=function(i,r,a){g.skipRasters=!1;var u=!0;p&&(a=p(a,{gmx:s,geoItem:e,item:g,gmxTilePoint:i}),u=!1);var h={geoItem:e,image:a,zKey:o.zKey,destinationTilePoint:x,sourceTilePoint:i,sx:0,sy:0,sw:o.ts,sh:o.ts,dx:0,dy:0,dw:o.ts,dh:o.ts};if(c){var y=o._getShiftPixels(r);if(null===y)return void f();t.extend(h,y),u=!1}if(i.z!==_.z){var v=o.getTilePosZoomDelta(_,_.z,i.z);if(v.size<1/256)return void m();if(u=!1,h.sx=Math.floor(v.x),h.sy=Math.floor(v.y),h.sw=h.sh=v.size,c){var S=Math.floor(h.dw/v.zDelta);h.sx=(0===h.dx?h.sw:o.ts)-S,h.sw=S;var T=Math.floor(h.dh/v.zDelta);h.sy=(0===h.dy?h.sh:o.ts)-T,h.sh=T}}if(u&&!s.rasterProcessingHook)d--,b=a,l[n]=b,m();else{b||(b=document.createElement("canvas"),b.width=b.height=o.ts),h.res=b;var P=o._rasterHook(h),L=function(){d--,l[n]=b,m()};P?P.then?P.then(L):(b=P,L()):null===P?(g.skipRasters=!0,f()):(b=a,L())}};d?a.map(function(e){var t=o._loadTileRecursive(e,g);return t.then(function(t){y(t.gtp,e,t.image)},f),t}):(g.skipRasters=!0,f())}.bind(this)):(s.sessionKey&&(m+=(m.indexOf("?")===-1?"?":"&")+"key="+encodeURIComponent(s.sessionKey)),new Promise(function(i){var r=function(e){o.layer.fire("bitmap",{id:n,loaded:!1,url:m,result:e}),g.skipRasters=!0,i()};if(!m)return void r();var a=function(t){s.quicklooksCache[m]=t;var o=t;if(this.gmx.rasterProcessingHook,p){var a={gmx:s,topLeft:this.topLeft,geoItem:e,item:g,gmxTilePoint:y};o=p(t,a)}o?(i(o),g.skipRasters=!1,l[n]=o):r()}.bind(this);if(s.quicklooksCache&&s.quicklooksCache[m])a(s.quicklooksCache[m]);else if(t.gmx.getBitmap){var u=m;s.gmxProxy&&(u=s.gmxProxy+"?WrapStyle=none&get="+encodeURIComponent(m)),t.gmx.getBitmap(u,v).then(function(e){var t=e.imageBitmap,i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,i.width,i.height),a(i),o.layer.fire("bitmap",{id:n,loaded:!0,url:m,result:e})},r)["catch"](r)}else{var h=this.rasterRequests[m];h?h.options.tileRastersId=this._uniqueID:(h=t.gmx.imageLoader.push(m,{tileRastersId:o._uniqueID,crossOrigin:s.crossOrigin||"anonymous"}),this.rasterRequests[m]=h),h.def.then(a,r)}}.bind(this)))},_getVisibleItems:function(e){if(e.length<2)return this.itemsView=e,e;i._tileCanvas||(i._tileCanvas=document.createElement("canvas"),i._tileCanvas.width=i._tileCanvas.height=this.ts);var r,n,o=this.gmx,s=o.dataManager,a=i._tileCanvas,l=a.getContext("2d"),u={tbounds:this.tbounds,gmx:o,topLeft:this.topLeft,tpx:this.tpx,tpy:this.tpy,ctx:l};for(l.clearRect(0,0,this.ts,this.ts),l.imageSmoothingEnabled=!1,r=0,n=e.length;r<n;r++){l.fillStyle=i.dec2rgba(r+1,1);var h=e[r];t.gmxUtil.drawGeoItem(h,s.getItem(h.properties[0]),u,{fillStyle:l.fillStyle})}var c={},d=l.getImageData(0,0,this.ts,this.ts).data;for(r=0,n=d.length;r<n;r+=4)if(255===d[r+3]){var m=d[r+2];d[r+1]&&(m+=d[r+1]<<8),d[r]&&(m+=d[r]<<16),m&&(c[m]=!0)}var p=[];for(var f in c){var g=e[Number(f)-1];g&&p.push(g)}return this.itemsView=p,p},_getNeedRasterItems:function(e){for(var t=this.gmx,r=t.tileAttributeIndexes,n=this.tbounds,o=[],s=0,a=e.length;s<a;s++){var l=e[s],u=l.properties,h=u[0],c=l.dataOption||{},d=!1;if(t.quicklookBGfunc&&!i.getPropItem("GMX_RasterCatalogID",u,r)){if(t.minZoomQuicklooks&&this.zoom<t.minZoomQuicklooks)continue;var m=i.getPropItem(t.quicklookPlatform,u,r)||t.quicklookPlatform||"";if(!(m&&"imageMercator"!==m||i.getQuicklookPointsFromProperties(u,t)))continue}t.styleHook&&(l.styleExtend=t.styleHook(t.dataManager.getItem(h),t.lastHover&&h===t.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&n.intersectsWithDelta(c.bounds,-1,-1)&&o.push(l)}return this._getVisibleItems(o)},_getTileRasters:function(e){return new Promise(function(t){var i=this._getNeedRasterItems(e).map(this._getItemRasters.bind(this));Promise.all(i).then(t,function(){})}.bind(this))},_chkItems:function(e){var t=this.layer;if(!t._map)return null;var i=e&&e.added&&e.added.length?e.added:null;if(!i){var r=t._tiles[this.zKey];return r&&r.el&&r.el.getContext("2d").clearRect(0,0,this.ts,this.ts),null}return this.gmx.sortItems?t.getSortedItems(i):i},destructor:function(){this._preRenderPromise&&this._preRenderPromise.reject(),this._renderPromise&&this._renderPromise.reject(),this._cancelRastersPromise(),this._clearCache()},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.reject&&this.rastersPromise.reject(),this.rastersPromise=null)},_clearCache:function(){for(var e in this.rasterRequests)this.rasterRequests[e].remove();this.rasterRequests={}},drawTile:function(e){return this.destructor(),new Promise(function(i,r){if(t.gmx._zoomStart&&t.gmx._zoomStart!==this.zoom)return void i();var n=this._chkItems(e),o=function(){i({count:n.length})}.bind(this),s=this;if(this._uniqueID++,n){var a=s.tile,l=a.getContext("2d");if(this.layer._gridClusters&&this.layer._gridClusters.checkData({geoItems:n,tileElem:this.tileElem,layer:this.layer}))return void o();var u=this.layer.options.tileSize;this.tile.width=this.tile.height=u;var h=function(){var e=s.gmx,i={tbounds:s.tbounds,rasters:s.rasters,gmx:e,topLeft:s.topLeft,tpx:s.tpx,tpy:s.tpy,ctx:l},h="zKey:"+s.zKey+" count: "+n.length;t.DomUtil.addClass(a,h),s.layer._gridClusters||(l.clearRect(0,0,u,u),e.showScreenTiles&&(l.strokeRect(0,0,u-1,u-1),l.strokeText(s.zKey+" "+n.length,50,50)));var c,d={zKey:s.zKey,topLeft:s.topLeft,tpx:s.tpx,tpy:s.tpy,x:s.tilePoint.x,y:s.tilePoint.y,z:s.zoom},m=[];e.preRenderHooks.forEach(function(e){c||(c=document.createElement("canvas"),c.width=c.height=u||256);var t=e(c,d);t&&t.then&&m.push(t)}),Promise.all(m).then(function(){c&&(i.bgImage=c);for(var l=0,u=n.length;l<u;l++){var h=n[l],m=h.id,p=e.dataManager.getItem(m);if(p){var f=e.styleManager.getObjStyle(p,s.zoom),g=e.lastHover&&e.lastHover.id===h.id&&f;if(e.multiFilters)for(var y=0,v=p.multiFilters.length;y<v;y++){var x=p.multiFilters[y];t.gmxUtil.drawGeoItem(h,p,i,g?x.parsedStyleHover:x.parsedStyle,x.style)}else t.gmxUtil.drawGeoItem(h,p,i,g?p.parsedStyleHover:p.parsedStyleKeys,f);m in e._needPopups&&!e._needPopups[m]&&(e._needPopups[m]=!0)}}Promise.all(s._getHooksPromises(e.renderHooks,a,d)).then(o,r)},r)};this.showRaster?(this.rastersPromise=this._getTileRasters(n),this.rastersPromise.then(h,r)):h()}else i()}.bind(this))["catch"](function(){})},_getHooksPromises:function(e,t,i){var r=[];return e.forEach(function(e){var n=e(t,i);n&&n.then&&r.push(n)}),r}},function(){var e=1e6,i=function(e){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=e,e.on("add",this.onAdd,this),e.on("remove",this.onRemove,this)};i.prototype={addToReorder:function(e,t){++this.count,this.all[e]=t?-this.count:this.count},clickFunc:function(e){if(!this.disabled){var t=e.gmx.id;this.addToReorder(t,e.originalEvent.ctrlKey),this.layer.redrawItem(t)}},sortItems:function(t,i){var r=this._objectsReorder;if(r.count>0){var n=r.all[t.id],o=r.all[i.id];if(n||o)return n=n?n+(n>0?e:-e):0,o=o?o+(o>0?e:-e):0,n-o}return r.sortFunc?r.sortFunc.call(this,t,i):0},resetSortFunc:function(){var e=this.layer,t=e._gmx,i=t.zIndexField;t.sortItems=this.sortItems,this.sortFunc=i&&!this.userSetSortFunc?function(e,t){var r=Number(e.properties[i])-Number(t.properties[i]);return r?r:e.id-t.id}:function(e,t){return e.id-t.id}},initialize:function(){var e=this.layer._gmx;this.userSetSortFunc||"polygon"!==e.GeometryType&&"linestring"!==e.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},t.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new i(this))},getReorderArrays:function(){var e={top:[],bottom:[]};if(this._objectsReorder)for(var t=this._objectsReorder,i=Object.keys(t.all).sort(function(e,i){return t.all[e]-t.all[i]}),r=0,n=i.length;r<n;r++){var o=i[r];t.all[o]>0?e.top.push(o):e.bottom.push(o)}return e},bringToTopItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e),this.redrawItem(e),this},bringToBottomItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e,!0),this.redrawItem(e),this},clearReorderArrays:function(){if(this._objectsReorder){var e=this._objectsReorder;e.all={},e.count=0,this.repaint()}return this},setReorderArrays:function(e,t){this._objectsReorderInit();var i=this._objectsReorder;return i.all={},i.count=0,t&&t.forEach(function(e){i.addToReorder(e,!0)}),e&&e.forEach(function(e){i.addToReorder(e)}),this.repaint(),this},getSortedItems:function(e){return this._objectsReorderInit(),e.sort(t.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))},setSortFunc:function(e){this._objectsReorderInit();var t=this._objectsReorder;return t.sortFunc=e,t.userSetSortFunc=!!e,this._gmx.sortItems=t.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}();var x=function(e){this.gmx=e,this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this)),this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var t=1/0,i=-(1/0),r=e.properties.styles||[],n=0,o=r.length;n<o;n++){var s=r[n];t=Math.min(t,s.MinZoom),i=Math.max(i,s.MaxZoom)}this.minZoom=t===1/0?0:t,this.maxZoom=i===-(1/0)?18:i};x.prototype={getStyleIcon:function(e,i){var r=this._styles[e];if(!r)return null;i=i||"";var n=this.gmx.GeometryType||"polygon",o=r.RenderStyle,s='<div class="gmx-style-legend"><span class="prefixWrapper"><span class="prefix'+(o.iconUrl?"":" style")+'">'+i+"</span></span>";if(s+='<span class="legend-block">',o.iconUrl)s+='<span class="legendIconStyleImage"><img crossorigin="" src="'+o.iconUrl+'" /></span>';else{var a="";o.fillColor&&(a="background-color: "+t.gmxUtil.dec2rgba(o.fillColor,o.fillOpacity||1)),o.color&&(a+=" border-color: "+t.gmxUtil.dec2rgba(o.color,o.opacity||1)),s+='<span class="legendIconStyle '+n+'"'+(a?' style="'+a+'"':"")+'"></span>'}var l=r.Name||r.Filter||"легенда";return s+='<span class="legendIconCell"><span class="styleName"> '+l+"</span>",s+="</span></div>"},_getMaxStyleSize:function(e){for(var t=0,i=0,r=this._styles.length;i<r;i++){var n=this._styles[i];if(!(e>n.MaxZoom||e<n.MinZoom)){var o=n.RenderStyle;if(this._needLoadIcons||!o||!("maxSize"in o)){t=x.MAX_STYLE_SIZE;break}var s=0;"iconAnchor"in o&&!o.iconCenter&&(s=Math.max(Math.abs(o.iconAnchor[0]),Math.abs(o.iconAnchor[1]))),t=Math.max(o.maxSize+s,t)}}return t},getStyleBounds:function(e){if(!e)return i.bounds();this._maxStyleSize=this._getMaxStyleSize(e.z);var t=2*this._maxStyleSize*i.tileSizes[e.z]/256;return i.getBoundsByTilePoint(e).addBuffer(t)},isVisibleAtZoom:function(e){for(var t=0,i=this._styles.length;t<i;t++){var r=this._styles[t];if(e>=r.MinZoom&&e<=r.MaxZoom)return!0}return!1},getIcons:function(e){var t=this;this.promise.then(function(){for(var i=[],r=0,n=t._styles.length;r<n;r++){var o=t._styles[r],s={};o.RenderStyle&&(s.RenderStyle={image:o.RenderStyle.image}),o.HoverStyle&&(s.HoverStyle={image:o.HoverStyle.image}),i.push(s)}e&&e(i)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var e=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(t){return e._chkStyleFilter(t)}),this.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=0,t=this._deferredIcons.length;e<t;e++)this._getImageSize(this._deferredIcons[e]);return this._deferredIcons=[],this._chkReady(),this.promise},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=[],i=0,r=this._styles.length;i<r;i++){var n=t.extend({},this._styles[i]);n.RenderStyle=x.getStyleKeys(n.RenderStyle),n.HoverStyle&&(n.HoverStyle=x.getStyleKeys(n.HoverStyle)),delete n.filterFunction,delete n.version,delete n.common,delete n.type,e.push(n)}return e},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var e=this;this._styles.map(function(t){t.version=++e._maxVersion})},setStyle:function(e,i,r){if(i=i||0,i<this._styles.length||r){var n=this._styles[i];if(n||(n=this._prepareItem({}),this._styles[i]=n),n.version=++this._maxVersion,"Filter"in e){n.Filter=e.Filter;var o=typeof e.Filter;n.filterFunction="string"===o?t.gmx.Parsers.parseSQL(n.Filter.replace(/[\[\]]/g,'"')):"function"===o?n.Filter:null,this._changeStylesVersion()}for(var s=0,a=x.DEFAULT_KEYS.length;s<a;s++){var l=x.DEFAULT_KEYS[s];l in e&&(n[l]=e[l])}e.RenderStyle&&(n.RenderStyle=this._parseStyle(e.RenderStyle)),e.HoverStyle&&(n.HoverStyle=this._parseStyle(e.HoverStyle,n.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(e){var t=this.gmx.dataManager.getItem(e),i=t?t.currentFilter:0,r=this._styles[i];return r?{DisableBalloonOnMouseMove:r.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:r.DisableBalloonOnClick||!1,templateBalloon:r.Balloon||null,isSummary:/\[SUMMARY\]/.test(r.Balloon)}:null},getObjStyle:function(e,t){this._chkStyleFilter(e,t);var i,r=this._styles[e.currentFilter];return r?r.hoverDiff&&this.gmx.lastHover&&e.id===this.gmx.lastHover.id?r.HoverStyle?(i=r.HoverStyle.version||-1,i!==e.styleVersion&&(e.parsedStyleHover=this._itemStyleParser(e,r.HoverStyle)),r.HoverStyle):(delete e.parsedStyleHover,null):(i=r.version||-1,i!==e.styleVersion&&(e.parsedStyleKeys=this._itemStyleParser(e,r.RenderStyle)),r.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(e){var i=e.iconUrl||e.fillIconUrl||"",r={crossOrigin:"anonymous"},n=t.gmxUtil.isIE11&&/\.svg/.test(i),o=this;"file:"!==self.location.protocol&&(i=i.replace(/http(s*):/,"")),n&&(i+=(i.indexOf("?")===-1?"?":"&")+"crossOrigin="+r.crossOrigin),r.layerID=this.gmx.layerID,++this._needLoadIcons,t.gmx.imageLoader.unshift(i,r).def.then(function(t){if(e.version=++o._maxVersion,e.fillIconUrl)e.imagePattern=t;else{e.sx=t.width||t.offsetWidth,e.sy=t.height||t.offsetHeight,e.image=t;var i=e.iconAngle?Math.sqrt(e.sx*e.sx+e.sy*e.sy):Math.max(e.sx,e.sy);e.scaleFunction||e.rotateFunction||((e.iconScale||1===e.iconScale)&&(i*=e.iconScale),e.common=!0),e.maxSize=Number(i.toFixed())}o._needLoadIcons--,o._chkReady()},function(){e.version=++o._maxVersion,e.sx=1,e.sy=0,e.image=null,o._needLoadIcons--,o._chkReady(),console.log({url:i,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(e,t){var i=this.gmx,r=i.tileAttributeIndexes,n=i.tileAttributeTypes,o=t||1,s=[];this._serverStylesParsed||this._parseServerStyles();for(var a=0,l=this._styles.length;a<l;a++){var u=this._styles[a];if(!(u.disabled||o>u.MaxZoom||o<u.MinZoom||u.filterFunction&&!u.filterFunction(e,r,n)||(s.push(a),i.multiFilters)))break}return s},_chkStyleFilter:function(e,t){var i=this.gmx,r=i.multiFilters?-1:e.currentFilter,n=this._styles[r],o=!n||n.version!==e.styleVersion;if(t=t||i.currentZoom,o||e._lastZoom!==t){e.currentFilter=-1,e.multiFilters=[];for(var s=this.getCurrentFilters(e.properties,t),a=0,l=s.length;a<l;a++){var u=s[a],h=this._styles[u];if(e.hoverDiff=h.hoverDiff,e.currentFilter=u,o||r!==u){var c=h.common&&h.common.RenderStyle||this._itemStyleParser(e,h.RenderStyle),d=null;e.parsedStyleKeys=c,h.HoverStyle&&(d=h.common&&h.common.HoverStyle||this._itemStyleParser(e,h.HoverStyle),e.parsedStyleHover=d),i.multiFilters&&e.multiFilters.push({style:h.RenderStyle,styleHover:h.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(e.styleVersion=h.version,!i.multiFilters)break}e._lastZoom=t}return!!this._styles[e.currentFilter]||(e.currentFilter=-1,!1)},_parseServerStyles:function(){var e,t,i=this.gmx,r=i.properties,n=r.gmxStyles?r.gmxStyles.styles:null,o=n||r.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:x.DEFAULT_STYLE}],s=Math.max(o.length,i.styles.length);if(n)for(e=0;e<s;e++)this._styles[e]||(t=i.styles[e]||o[e],t.RenderStyle=this._parseStyle(t.RenderStyle),t.HoverStyle=this._parseStyle(t.HoverStyle),this._styles.push(t),this._isLabel(t.RenderStyle)&&(i.labelsLayer=!0));else for(e=0;e<s;e++)if(!this._styles[e]){if(t=i.styles[e]||o[e],t.RenderStyle||(t.RenderStyle=x.DEFAULT_STYLE),void 0===t.HoverStyle){var a=JSON.parse(JSON.stringify(t.RenderStyle));a.outline&&(a.outline.thickness+=1),t.HoverStyle=a}else null===t.HoverStyle&&delete t.HoverStyle;var l=this._prepareItem(t);this._styles.push(l),this._isLabel(l.RenderStyle)&&(i.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_iconsUrlReplace:function(e){var t=e||"";return e&&this.gmx.iconsUrlReplace&&this.gmx.iconsUrlReplace.forEach(function(e){t=t.replace(e.from,e.to)}),t},_checkStyles:function(){for(var e=1/0,t=-(1/0),i=!1,r=!1,n=0,o=this._styles.length;n<o;n++){var s=this._styles[n];s.DisableBalloonOnMouseMove=s.DisableBalloonOnMouseMove!==!1,s.DisableBalloonOnClick=s.DisableBalloonOnClick||!1,s.DisableBalloonOnMouseMove!==!1&&s.DisableBalloonOnClick!==!1||(i=!0,s.BalloonEnable=!0),s.hoverDiff=null,s.common={},s.RenderStyle&&(s.RenderStyle.iconUrl&&(s.RenderStyle.iconUrl=this._iconsUrlReplace(s.RenderStyle.iconUrl)),s.HoverStyle&&s.HoverStyle.iconUrl&&(s.HoverStyle.iconUrl=this._iconsUrlReplace(s.HoverStyle.iconUrl)),r||this._isLabel(s.RenderStyle)&&(r=!0),s.RenderStyle.common&&(s.common.RenderStyle=this._itemStyleParser({},s.RenderStyle)),s.HoverStyle&&(s.hoverDiff=x.checkDiff(s.RenderStyle,s.HoverStyle))),s.HoverStyle&&s.HoverStyle.common&&(s.common.HoverStyle=this._itemStyleParser({},s.HoverStyle)),e=Math.min(e,s.MinZoom),t=Math.max(t,s.MaxZoom)}this.minZoom!==1/0&&(this.minZoom=e),this.maxZoom!==-(1/0)&&(this.maxZoom=t),this.gmx.balloonEnable=i,this.gmx.labelsLayer=r},_parseStyle:function(e,r){if(e){e.common=!0;for(var n in e)if(i.styleFuncKeys[n]){var o=i.styleFuncKeys[n],s=e[n];"string"==typeof s?(e.common=!1,r&&r[n]===s?e[o]=r[o]:(this._parserFunctions[s]||(this._parserFunctions[s]=t.gmx.Parsers.parseExpression(s)),e[o]=this._parserFunctions[s])):"function"==typeof s&&(e.common=!1,e[o]=s)}var a="";if("iconUrl"in e)a="image",e.iconUrl&&(e.maxSize=256,this._deferredIcons.push(e));else if(e.fillIconUrl)a="square",this._deferredIcons.push(e);else if(e.fillPattern)a="square",e.common=x.parsePattern(e.fillPattern),e.canvasPattern=i.getPatternIcon(null,e);else if(e.iconCircle)a="circle","iconSize"in e||(e.iconSize=4);else if(e.iconPath){a="iconPath";var l=0,u=t.Util.isArray(e.iconPath)?e.iconPath:x.DEFAULT_ICONPATH;e.iconPath=x.DEFAULT_ICONPATH.map(function(e,t){var i=u[t]||e;return l=Math.max(l,i),i}),e.iconSize=2*l}else if(e.fillRadialGradient){a="circle","iconCenter"in e||(e.iconCenter=!0);var h=x.parseRadialGradient(e.fillRadialGradient);null===h?e.common=!1:e.iconSize=h}else e.fillLinearGradient?(a="square",e.common=x.parseLinearGradient(e.fillLinearGradient)):e.iconSize&&(a="square","iconCenter"in e||(e.iconCenter=!0));e.type=a,e.common&&!e.maxSize&&(e.maxSize=e.iconSize||0,e.maxSize+=e.weight?e.weight:0,"iconScale"in e&&(e.maxSize*=e.iconScale))}return e},_prepareItem:function(e){var i={MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18,Filter:e.Filter||null,Balloon:e.Balloon||"",RenderStyle:e.RenderStyle?this._parseStyle(t.gmxUtil.fromServerStyle(e.RenderStyle)):{},version:++this._maxVersion};if(i.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove!==!1,i.DisableBalloonOnClick=e.DisableBalloonOnClick||!1,e.HoverStyle&&(i.HoverStyle=this._parseStyle(t.gmxUtil.fromServerStyle(e.HoverStyle),i.RenderStyle)),"Filter"in e){var r=t.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));r&&(i.filterFunction=r)}return i},_isLabel:function(e){var t=this.gmx.tileAttributeIndexes;return e&&(e.labelTemplate||e.labelField&&e.labelField in t)},_itemStyleParser:function(e,t){t=t||{};var r,n,o,s={},a=this.gmx.tileAttributeIndexes,l=e.properties||{},u=e.type,h=t.type,c="color"in t?t.color:255,d="opacity"in t?t.opacity:1;if(s.sx=t.sx,s.sy=t.sy,t.maxSize&&(s.maxSize=t.maxSize),t.iconAngle){var m=t.iconAngle||0;m&&"string"==typeof m&&(m=t.rotateFunction?t.rotateFunction(l,a):0),s.rotate=m||0}if("iconColor"in t&&(s.iconColor=t.iconColorFunction?t.iconColorFunction(l,a):t.iconColor),"iconScale"in t&&(s.iconScale=t.scaleFunction?t.scaleFunction(l,a):t.iconScale||1),"image"===h)s.type=h,t.iconUrl&&(s.iconUrl=t.iconUrl),t.image&&(s.image=t.image);else if(t.fillRadialGradient){var p=t.fillRadialGradient,f=p.r1Function?p.r1Function(l,a):p.r1,g=p.r2Function?p.r2Function(l,a):p.r2,y=p.x1Function?p.x1Function(l,a):p.x1,v=p.y1Function?p.y1Function(l,a):p.y1,x=p.x2Function?p.x2Function(l,a):p.x2,_=p.y2Function?p.y2Function(l,a):p.y2;p.r2max&&(g=Math.min(g,p.r2max));var b=[];for(o=p.addColorStop.length,p.addColorStopFunctions||(p.addColorStopFunctions=new Array(o)),n=0;n<o;n++){r=p.addColorStop[n];var S=p.addColorStopFunctions[n]||[],T=S[0]?S[0](l,a):r[0],P=r[3];if(r.length<4){var L=r.length<3?1:S[2]?S[2](l,a):r[2];P=i.dec2color(S[1]?S[1](l,a):r[1],L)}b.push([T,P])}s.maxSize=s.sx=s.sy=s.iconSize=g,s.fillRadialGradient={x1:y,y1:v,r1:f,x2:x,y2:_,r2:g,addColorStop:b},s._radialGradientParsed={create:[y,v,f,x,_,g],colorStop:b}}else if(t.fillLinearGradient)s.fillLinearGradient=t.fillLinearGradient;else{if(t.fillPattern&&(s.canvasPattern=t.canvasPattern?t.canvasPattern:i.getPatternIcon(e,t,a)),"iconPath"===h&&(s.type=h,s.iconPath=t.iconPath),"POLYGON"!==u&&"MULTIPOLYGON"!==u&&"polygon"!==this.gmx.GeometryType||(h="polygon"),t.iconSize){var I=t.sizeFunction?t.sizeFunction(l,a):t.iconSize;s.sx=s.sy=I,s.iconSize=I,"iconScale"in t&&(s.iconSize*=t.iconScale),s.maxSize=I}s.stroke=!0,c=t.colorFunction?t.colorFunction(l,a):c,d=t.opacityFunction?t.opacityFunction(l,a):d,s.strokeStyle=i.dec2color(c,d),s.lineWidth="weight"in t?t.weight:1}if("iconScale"in t&&(s.iconScale=t.scaleFunction?t.scaleFunction(l,a)||1:t.iconScale),"iconAnchor"in t&&(s.iconAnchor=t.iconAnchor),"iconCenter"in t&&(s.iconCenter=t.iconCenter),"square"===h||"polygon"===h||"circle"===h||"iconPath"===h){s.type=h;var M=t.fillOpacity,k=t.fillColor,C="string"==typeof k?parseInt(k.replace(/#/,""),16):k;"fillColor"in t&&(s.fillStyle=i.dec2color(C,1)),"fillColorFunction"in t||"fillOpacityFunction"in t?(c=t.fillColorFunction?t.fillColorFunction(l,a):k||255,d=t.fillOpacityFunction?t.fillOpacityFunction(l,a):M||1,s.fillStyle=i.dec2color(c,d)):"fillOpacity"in t&&"fillColor"in t&&(s.fillStyle=i.dec2color(C,M))}if("dashArray"in t&&(s.dashArray=t.dashArray),"dashOffset"in t&&(s.dashOffset=t.dashOffset),this.gmx.labelsLayer){for(r=i.styleKeys.label.client,n=0,o=r.length;n<o;n++){var O=r[n];if(O in t){if("labelField"===O){if(!a[t[O]])continue}else if("labelTemplate"===O){var w=i.getPropertiesHash(l,a);s.labelText=i.parseTemplate(t[O],w)}s[O]=t[O]}}"labelAnchor"in t&&(s.labelAnchor=t.labelAnchor)}return s}},x.MAX_STYLE_SIZE=256,x.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8}},x.DEFAULT_KEYS=["Name","MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick","disabled"],x.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],x.DEFAULT_STYLE_KEYS=["iconUrl","iconAngle","iconSize","iconScale","iconMinScale","iconMaxScale","iconCircle","iconCenter","iconAnchor","iconColor","stroke","color","weight","opacity","dashArray","fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient","labelTemplate","labelField","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign","labelAnchor","labelText"],x.HASH_KEYS=x.DEFAULT_KEYS.reduce(function(e,t){return e[t]=!0,e},{}),x.HASH_KEYS.RenderStyle=x.DEFAULT_STYLE_KEYS.reduce(function(e,t){return e[t]=!0,e},{}),x.parsePattern=function(e){var i=!0,r=t.gmx.Parsers;if("step"in e&&"string"==typeof e.step&&(e.patternStepFunction=r.parseExpression(e.step),i=!1),"width"in e&&"string"==typeof e.width&&(e.patternWidthFunction=r.parseExpression(e.width),i=!1),"colors"in e){for(var n=[],o=0,s=e.colors.length;o<s;o++){var a=e.colors[o];"string"==typeof a?(n.push(r.parseExpression(a)),i=!1):n.push(null)}e.patternColorsFunction=n}return i},x.getStyleKeys=function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,s=n.client.length;o<s;o++){var a=n.client[o];a in e&&(void 0!==e[a]&&(t[a]=JSON.parse(JSON.stringify(e[a]))),"fillPattern"===a?delete t[a].patternColorsFunction:"fillLinearGradient"===a&&delete t[a].addColorStopFunctions)}return"iconAnchor"in e&&(t.iconAnchor=e.iconAnchor),"labelAnchor"in e&&(t.labelAnchor=e.labelAnchor),t},x.checkDiff=function(e,t){for(var i in e)if(e[i]!==t[i])return i;return null},x.parseRadialGradient=function(e){var r=!0,n=t.gmx.Parsers,o=0,s=["r1","x1","y1","r2","x2","y2"],a=s.length;for(o=0;o<a;o++){var l=s[o];e[l]||(e[l]=0),"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),r=!1)}for(e.addColorStop=e.addColorStop||[[0,16711680,.5],[1,16777215,.5]],e.addColorStopFunctions=[],o=0,a=e.addColorStop.length;o<a;o++){s=e.addColorStop[o];var u=["string"==typeof s[0]?n.parseExpression(s[0]):null,"string"==typeof s[1]?n.parseExpression(s[1]):null,"string"==typeof s[2]?n.parseExpression(s[2]):null];e.addColorStopFunctions.push(u),null===u[1]&&null===u[2]?s[3]=i.dec2color(s[1],s[2]>1?s[2]/100:s[2]):r=!1}return"r2Function"in e&&(r=!1),r?Math.max(e.r1,e.r2):null},x.parseLinearGradient=function(e){var i=!0,r=0,n=t.gmx.Parsers,o=["x1","y1","x2","y2"],s=[0,0,0,256],a=o.length;for(r=0;r<a;r++){var l=o[r];l in e?"string"==typeof e[l]&&(e[l+"Function"]=n.parseExpression(e[l]),i=!1):e[l]=s[r]}for(e.addColorStop=e.addColorStop||[[0,16711680],[1,16777215]],e.addColorStopFunctions=[],r=0,a=e.addColorStop.length;r<a;r++)o=e.addColorStop[r],e.addColorStopFunctions.push(["string"==typeof o[0]?n.parseExpression(o[0]):null,"string"==typeof o[1]?n.parseExpression(o[1]):null,"string"==typeof o[2]?n.parseExpression(o[2]):null]);return i},x.parReg=/\[([^\]]+)\]/g,x.getKeysHash=function(e,t){var i={},r=e.match(x.parReg);return r&&r.forEach(function(e){var r=e.replace(/[[\]""]/g,"");i[r]||(i[r]=t||!0)}),i},x.decodeOldStyle=function(e){var r,n,o,s,a,l={},u={},h="";for(s in i.styleKeys){var c=i.styleKeys[s];for(n=0,o=c.client.length;n<o;n++)a=c.client[n],a in e&&(l[a]=e[a]);if(r=e[s],r&&"object"==typeof r)for(n=0,o=c.server.length;n<o;n++)if(a=c.server[n],a in r){var d=c.client[n],m=r[a];if("string"==typeof m){var p=x.getKeysHash(m,d);if(Object.keys(p).length&&(l.common=!1,t.extend(u,p)),i.styleFuncKeys[d])if(null===m.match(/[^\d\.]/))m=Number(m);else{var f=t.gmx.Parsers.parseExpression(m);null===f?m=i.styleFuncError[d]():l[i.styleFuncKeys[d]]=f}}else"opacity"===a&&(m/=100);l[d]=m}}if(e.marker&&(r=e.marker,"dx"in r||"dy"in r)){var g=r.dx||0,y=r.dy||0;l.iconAnchor=[-g,-y]}for(s in e)i.styleKeys[s]||(l[s]=e[s]);return{style:l,attrKeys:u,type:h}},x.decodeOldStyles=function(e){var i=e.styles,r=i||[{MinZoom:1,MaxZoom:21,RenderStyle:x.DEFAULT_STYLE}],n=e.type.toLocaleLowerCase(),o={attrKeys:{},iconsUrl:{}};return o.styles=r.map(function(e){var i={Name:e.Name||"",type:n||"",MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18};if("Balloon"in e){i.Balloon=e.Balloon;var r=x.getKeysHash(e.Balloon,"Balloon");Object.keys(r).length&&t.extend(o.attrKeys,r)}if(e.RenderStyle){var s=x.decodeOldStyle(e.RenderStyle);if(t.extend(o.attrKeys,s.attrKeys),s.style.iconUrl&&(o.iconsUrl[s.style.iconUrl]=!0),i.RenderStyle=s.style,void 0===e.HoverStyle){var a=JSON.parse(JSON.stringify(i.RenderStyle));a.outline&&(a.outline.thickness+=1),i.HoverStyle=a}else if(null===e.HoverStyle)delete i.HoverStyle;else{var l=x.decodeOldStyle(e.HoverStyle);i.HoverStyle=l.style}}else"vector "===n&&(i.RenderStyle=x.DEFAULT_STYLE);
if("DisableBalloonOnMouseMove"in e&&(i.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove!==!1),"DisableBalloonOnClick"in e&&(i.DisableBalloonOnClick=e.DisableBalloonOnClick||!1),"Filter"in e){i.Filter=e.Filter;var u=t.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));u&&(i.filterFunction=u)}return i}),o},t.gmx=t.gmx||{},t.gmx.StyleManager=x,t.gmx.VectorLayer.include({bindPopup:function(e,i){var r=t.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},i);return this._popup&&this.unbindPopup(),e instanceof t.Popup?this._popup=e:(this._popup&&!i||(this._popup=new t.Popup(r)),this._popup.setContent(e)),this._popup._initContent=e,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),r&&r.popupopen&&(this._popupopen=r.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var e in this._gmx._needPopups)this._gmx._needPopups[e]&&(this.addPopup(e),delete this._gmx._needPopups[e])},disablePopup:function(e){return this._popupDisabled=!0,e&&(this._cacheClickable=this.options.clickable,this.options.clickable=!1),this},enablePopup:function(e){return this._popupDisabled=!1,e&&(this.options.clickable=this._cacheClickable),this},openPopup:function(e,t){return this._popup&&(e=e||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],t=t||{},t.latlng=e,this._openPopup(t)),this},closePopup:function(e){return this._popup&&(this._popup._close(),"mouseout"!==e&&this.getPopups().forEach(this._clearPopup.bind(this)),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(e){if("mouseover"===this._popup._state){var t=this._popup.options._gmxID||-1;t!==e.gmx.id&&this._setPopupContent(e),this._popup.setLatLng(e.latlng)}},_overPopup:function(e){var t=this._popup;t._map?this.fire("popupopen",{popup:t,gmx:this._setPopupContent(e,t)}):this._openPopup(e),"mouseover"===t._state&&t.setLatLng(e.latlng)},_outPopup:function(e){"mouseover"!==this._popup._state||e.gmx.prevId||this.closePopup(e.type)},_callBalloonHook:function(e,t){var i,r,n,o=t.getElementsByTagName("span"),s={};for(i in this._balloonHook){var a=this._balloonHook[i].hookID;for(s[i]=0,r=0,n=o.length;r<n;r++)o[r].id===a&&s[i]++}for(i in this._balloonHook){var l=this._balloonHook[i],u=l.hookID,h=!0;for(r=0,n=o.length;r<n;r++){var c=o[r];c.id===u&&(h=!1,c.id+="_"+r,l.callback(e,t,c,s))}h&&l.callback(e,t,null,s)}},_setPopupContent:function(e,r){r||(r=this._popup);var n=e.gmx||{},o=n.balloonData||{},s=t.extend({},n.properties),a=n.target||{},l=a.geometry||{},u=a.offset,h=r._initContent||o.templateBalloon||"",c=e.type,d=this.options.isGeneralized&&("mouseover"===c||"mousemove"===c),m={id:n.id,type:c,nodePoint:n.nodePoint,latlng:e.latlng,properties:s,templateBalloon:h};if("POINT"===l.type){var p=t.gmxUtil.geometryToGeoJSON(l,!0,3857==n.srs);m.latlng=t.latLng(p.coordinates.reverse())}if(u){var f=t.Popup.prototype.options.offset;r.options.offset=[-f[0]-u[0],f[1]-u[1]]}else r.options.offset[1]="mouseover"===c?-7:7;if(this._popupopen)this._popupopen({popup:r,latlng:m.latlng,layerPoint:e.layerPoint,contentNode:r._contentNode,containerPoint:e.containerPoint,originalEvent:e.originalEvent,gmx:m});else if(!(h instanceof t.Popup)){if(!(h instanceof HTMLElement)){var g,y="",v=this._map?this._map.options:{};if(d||(g=a.geometry?[a.geometry]:n.geometries||this._gmx.dataManager.getItemGeometries(n.id)||[],m.summary=y=t.gmxUtil.getGeometriesSummary(g,v)),this._balloonHook){h||(h=i.getDefaultBalloonTemplate(s));for(var x in this._balloonHook)s[x]=i.parseTemplate(this._balloonHook[x].resStr,s)}h=t.gmxUtil.parseBalloonTemplate(h,{properties:s,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:v,summary:y,geometries:g})}var _=t.DomUtil.create("div","");_.innerHTML=h,r.setContent(_),this._balloonHook&&this._callBalloonHook(n.properties,r.getContent())}return r.options._gmxID=n.id,m},_openClickPopup:function(e){var r=e.originalEvent||{},n=!e.gmx||this._popupDisabled||r.ctrlKey||r.altKey||r.shiftKey;if(!n){var o=e.type,s=e.gmx,a=s.balloonData,l="click"===o&&a.isSummary&&!a.DisableBalloonOnClick,u=s.target;if(l&&u.options.isGeneralized&&!u.geometry){var h=s.layer.getGmxProperties();i.getLayerItemFromServer({options:e,layerID:h.name,value:u.id,field:h.identityField}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result){var i=e.Result.values[0];t.options.gmx.target.fromServerProps=i,t.options.gmx.target.geometry=i[i.length-1],this._openPopup(t.options)}}.bind(this))}else u.type.indexOf("POINT")!==-1&&(e.latlng=t.latLng(t.gmxUtil.geometryToGeoJSON(u.properties[u.properties.length-1],!0,3857==this._gmx.srs).coordinates.reverse())),this._openPopup(e)}},_openPopup:function(e,i){var r=this._map,n=e.originalEvent||{},o=i?!i:this._popupDisabled||n.ctrlKey||n.altKey||n.shiftKey;if(!o){var s=e.type,a=this._popup,l=e.gmx||{},u=l.balloonData||{};if("click"===s){if(!i&&u.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in r||(r._gmxPopups=[]),"maxPopupCount"in r.options||(r.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,r.on({layerremove:function(e){if(e.layer instanceof t.Popup)this._clearPopup(e.layer);else if(e.layer===this){if(r._gmxPopups){var i=this._gmx.layerID;r._gmxPopups=r._gmxPopups.reduce(function(e,t){return t._map&&(t.options.layerId===i?t._map.removeLayer(t):e.push(t)),e},[])}this.closePopup()}}},this)),this._clearPopup(l.id);var h=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};a=new t.Popup(t.extend({},h,{closeOnClick:1===r.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==s)return;if(u.DisableBalloonOnMouseMove)return void(a._state="");a.options.autoPan=!1}a.options.objectId=l.id,a._state=s;var c=this._setPopupContent(e,a);if(a.setLatLng(c.latlng),this.fire("popupopen",{popup:a,gmx:c}),"click"===s&&(r._gmxPopups.length>=r.options.maxPopupCount&&r.removeLayer(r._gmxPopups.shift()),r._gmxPopups.push(a)),a.addTo(r),a._closeButton){var d=a._closeButton.style;"mouseover"===s&&"hidden"!==d?(d.visibility="hidden",a._container.style.marginBottom="7px",a._container.style.pointerEvents="none"):"click"===s&&"inherit"!==d&&(d.visibility="inherit",a._container.style.marginBottom="",a._container.style.pointerEvents="")}}},_clearPopup:function(e){var i=this._map;if(i&&i._gmxPopups){var r=this._gmx.layerID,n=e instanceof t.Popup;i._gmxPopups=i._gmxPopups.reduce(function(t,i){return i._map&&(n&&i===e?i._map.removeLayer(i):i.options.layerId===r&&i.options.objectId===e?i._map.removeLayer(i):t.push(i)),t},[])}},getPopups:function(e){var t=this._map,i=[];if(t&&t._gmxPopups){var r=this._gmx.layerID;t._gmxPopups.reduce(function(t,i){return i.options.layerId===r&&t.push(e?i:i.options.objectId),t},i)}return i},addPopup:function(e){var i=this._gmx,r=i.dataManager.getItem(e);if(r&&this._map){var n=r.bounds.getCenter(),o=t.latLng(t.gmxUtil.coordsFromMercator("Point",n,3857==i.srs).reverse());this._openPopup({type:"click",latlng:o,gmx:this.getHoverOption(r)},!0),delete i._needPopups[e]}else i._needPopups[e]=!1;return this},addPopupHook:function(e,i){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[e]){var r="_"+t.stamp({});this._balloonHook[e]={key:e,hookID:r,resStr:'<span id="'+r+'"></span>',callback:i}}return this},removePopupHook:function(e){return this._balloonHook&&delete this._balloonHook[e],this}}),t.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(e,t,r){for(var n,o,s=this._gmx,a=s.mInPixel,l=e.length-1;l>=0;l--){var u=e[l].properties,h=u[0],c=e[l].dataOption||{},d=s.dataManager.getItem(h),m=d.currentStyle||d.parsedStyleKeys||{},p=m.iconScale||1,f=m.iconCenter,g=!f&&m.iconAnchor?m.iconAnchor:null,y=s.styleManager.getObjStyle(d),v=m.lineWidth||y.lineWidth||0,x=v+(y.sx||m.sx||0),_=v+(y.sy||m.sy||0),b=[p*x/2,p*_/2],S=t,T=u[u.length-1],P=T.type;"POINT"===P&&"circle"===y.type&&(b[0]*=2,b[1]*=2);var L=b[0],I=i.bounds().extendBounds(c.bounds).addBuffer(b[0]/a,b[1]/a);if(g&&(b=[g[0]-b[0],g[1]-b[1]],S=[t[0]+b[0]/a,t[1]-b[1]/a]),I.contains(S)){var M=m.fillStyle||m.canvasPattern||y.bgImage||y.fillColor,k=y&&y.image?y.image:null,C=P,O=c.hiddenLines||[],w=c.boundsArr,D=T.coordinates,F=null,R={point:t,bounds:r,coords:D,boundsArr:w};if("MULTIPOLYGON"!==P&&"POLYGON"!==P||(k?C="POINT":M||("POLYGON"===P?(C="MULTILINESTRING",O=O[0]):C="LIKEMULTILINESTRING",R.hidden=O)),"LINESTRING"===C){if(!i.isPointInPolyLine(t,v/a,D)&&(F=i.bounds([S]).addBuffer(b[0]/a,b[1]/a).isNodeIntersect(D),null===F))continue}else if("LIKEMULTILINESTRING"===C){R.delta=v/a;var N=!1;for(n=0,o=D.length;n<o;n++)if(R.coords=D[n],R.hidden=O?O[n]:null,R.boundsArr=w[n],i.isPointInLines(R)){N=!0;break}if(!N)continue}else if("MULTILINESTRING"===C){if(R.delta=v/a,R.hidden=O,!i.isPointInLines(R)){var E=i.bounds([S]).addBuffer(b[0]/a,b[1]/a);for(n=0,o=D.length;n<o;n++)if(F=E.isNodeIntersect(D[n]),null!==F){F.ring=n;break}if(null===F)continue}}else if("MULTIPOLYGON"===C||"POLYGON"===C){var A=t;for(N=!1,"POLYGON"===C&&(D=[T.coordinates],w=[c.boundsArr]),n=0,o=D.length;n<o;n++)for(var z=D[n],U=w[n],G=0,B=z.length;G<B;G++){var H=U[G];if(H.intersects(r)&&i.isPointInPolygonWithHoles(A,z)){N=0===G;break}}if(!N)continue}else if("POINT"===C&&"circle"===y.type){var Z=(D[0]-S[0])*a,V=(D[1]-S[1])*a;if(Z*Z+V*V>L*L)continue}if(this.isPointInClipPolygons(t))return{id:h,properties:d.properties,geometry:T,bounds:d.bounds,nodePoint:F,offset:g?b:null,parsedStyle:y}}}return null},gmxEventCheck:function(e,r){if(!this._map)return 0;var n=this,o=n._gmx,s=e.type,a=o.lastHover,l=function(t){a&&"mousemove"===s&&(t&&n.hasEventListeners(t)&&(e.gmx=a,n.fire(t,e)),a.hoverDiff&&n.redrawItem(a.id))},u=this._map.getZoom();if((u>this.options.maxZoom||u<this.options.minZoom)&&(r=!0),r)a&&(a.prevId=null),l("mouseout"),o.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(s)||"mousemove"===s&&"Raster"!==o.properties.fromType){var h=e.latlng.lng%360,c=new t.LatLng(e.latlng.lat,h+(h<-180?360:h>180?-360:0)),d=3857==o.srs?t.CRS.EPSG3857:t.Projection.Mercator,m=d.project(c)._subtract({x:o.shiftXlayer||0,y:o.shiftYlayer||0}),p=Math.max(5,o.styleManager._getMaxStyleSize(u))/o.mInPixel,f=[m.x,m.y],g=o.dataManager.getViewFilters("screen",o.layerID),y={type:"resend",layerID:o.layerID,needBbox:o.needBbox,bbox:i.bounds([f]).addBuffer(p),dateInterval:"VectorTemporal"===o.layerType?[o.beginDate,o.endDate]:null,filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"].concat(g),active:!1};this.options.isGeneralized&&(y.targetZoom=u),o.dataManager.addObserver(y,"hover");var v=o.dataManager.getItems("hover");if(o.dataManager.removeObserver("hover"),v&&v.length){v.length>1&&o.sortItems&&(v=this.getSortedItems(v));var x=this._gmxFirstObjectsByPoint(v,f,y.bbox);if(x){var _=x.id,b=o.dataManager.getItem(_),S=a?a.id:null,T=!a||a.id!==_;if("mousemove"===s&&a){if(!T)return e.gmx=a,this.fire(s,e),_;e.gmx=a,this.fire("mouseout",e),l(b.currentFilter!==a.currentFilter?"mouseout":""),o.lastHover=null}return e.gmx=t.extend(this.getHoverOption(b),{targets:v,nodePoint:x.nodePoint,prevId:S,hoverDiff:b.hoverDiff}),this.hasEventListeners(s)&&this.fire(s,e),"mousemove"===s&&T&&(a=o.lastHover=e.gmx,l("mouseover"),o.lastMouseover=o.lastHover),this._map.doubleClickZoom.disable(),_}this._map&&this._map.doubleClickZoom.enable()}}return 0},getHoverOption:function(e){return{layer:this,target:e,balloonData:this._gmx.styleManager.getItemBalloon(e.id),properties:this.getItemProperties(e.properties),currentFilter:e.currentFilter||0,id:e.id}}}),function(){var e=2e4,r={},n={},o="/Layer/CheckVersion.ashx",s=null,a=null,l={},u={},h=function(e){var t=e.Temporal?"TemporalTiles":"tiles";return t in e||e.currentTiles},c=function(e,t,i){var r={Name:e.name,Version:h(e)?e.LayerVersion:-1};if(t&&(e.UseTiles===!1||"NotVisible"===i.skipTiles||i.needBbox||i.options.needBbox)){var n=t.getMaxDateInterval(),o=n.beginDate||i.beginDate,s=n.endDate||i.endDate;o&&(r.dateBegin=Math.floor(o.getTime()/1e3)),s&&(r.dateEnd=Math.floor(s.getTime()/1e3))}return r},d=function(e){var i,n,o,s,a={};if(e&&e._gmx)e.target instanceof t.gmx.DataManager&&(e=e.target),e instanceof t.gmx.DataManager?(o=e,i=o.options):(i=e._gmx.properties,o=e._gmx.dataManager,s=e._gmx),n=i.hostName||e._gmx.hostName,a[n]=[c(i,o,s)];else{var l={};for(var u in r){var h=r[u],d=h instanceof t.gmx.DataManager;if(h.options.chkUpdate||d){o=d?h:h._gmx.dataManager,i=d?h.options:h._gmx.properties,s=d?h:h._gmx,n=i.hostName||h._gmx.hostName;var m=c(i,o,s),p=m.Name+m.Version,f=!l[p]&&(!i.Temporal||m.dateBegin);f&&(a[n]?a[n].push(m):a[n]=[m]),l[p]=!0}}}return a},m=function(e,n){"string"==typeof e&&(e=r[e]);var s=p._map,a=function(i){if(i&&"ok"===i.Status&&i.Result){var o,a,l,u,h,c=i.Result,d=c.length,m=0;if(p.needBbox){for(o=0;o<d;o++){if(h=c[o],u=h.name||h.properties.name,l=null,e&&e._gmx.properties.name===u)l=e;else for(a in r)if(l=r[a],!(e&&e===l&&"updateVersion"in e)){if(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l)break;if(l instanceof t.gmx.DataManager&&l.options.name===u)break}l&&(m+=(l.getDataManager?l.getDataManager():l).getNotLoadedVectorTiles(h))}if(s.fire("needLoadTiles",{count:m}),t.gmx.skipLoadTiles)return void console.log("Skiped tiles: ",t.gmx.needLoadTiles)}for(o=0;o<d;o++){h=c[o],u=h.name||h.properties.name,e&&e._gmx.properties.name===u&&"updateVersion"in e&&e.updateVersion(h);for(a in r)l=r[a],e&&e===l||(l._gmx&&l._gmx.properties.name===u&&"updateVersion"in l?l.updateVersion(h):l instanceof t.gmx.DataManager&&l.options.name===u&&l.updateVersion(h.properties,h.tiles))}}n&&n(i)};if(document.body&&!t.gmxUtil.isPageHidden()){var h=d(e),c=i.worldWidthMerc,m=[-c,-c,c,c].join(","),f=function(e,i){var n=t.gmxUtil.protocol+"//"+e+o,c=JSON.stringify(h[e]),d="WrapStyle=None&ftc=osm";if(p.needBbox){var g=s.getZoom(),y=t.Projection.Mercator;if(d+="&zoom="+g,3857==s.options.srs&&(d+="&srs=3857",y=t.CRS.EPSG3857),s.options.generalized===!1&&(d+="&generalizedTiles=false"),!s.options.allWorld){var v=s.getBounds(),x=y.project(v.getSouthWest()),_=y.project(v.getNorthEast());m=[x.x,x.y,_.x,_.y].join(",")}d+="&bbox=["+m+"]"}if(d+="&layers="+encodeURIComponent(c),"FormData"in window){l[e]=!0,t.gmxUtil.request({url:n,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:d,withCredentials:!0,callback:function(t){delete l[e],u[e]&&!i?(delete u[e],f(e,!0)):a(JSON.parse(t))},onError:function(t){console.log("Error: LayerVersion ",t),delete l[e],u[e]&&!i&&(delete u[e],f(e,!0))}});var b=Date.now();for(var S in r){var T=r[S],P=T._gmx||T.options;P.hostName===e&&(P._stampVersionRequest=b)}}};for(var g in h)l[g]?u[g]=!0:f(g)}},p={needBbox:!1,addDataManager:function(e){var t=e.options,i=t.name;i in r||(t.needBbox&&!p.needBbox&&(p.needBbox=t.needBbox),e.on("chkLayerUpdate",m.bind(e)),r[i]=e)},removeDataManager:function(e){var t=e.options.name;t in r&&(e.off("chkLayerUpdate",m.bind(e)),delete r[t])},remove:function(e){t.gmx.sendCmd&&t.gmx.sendCmd("toggleDataSource",{active:!1,hostName:e.options.hostName,mapID:e.options.mapID,layerID:e.options.layerID}),delete r[e._gmx.layerID];var i=e._gmx,o=e.options.parentOptions;if(o){var s=o.name;n[s]&&(delete n[s][i.properties.name],Object.keys(n[s]).length||(p.removeDataManager(i.dataManager),delete n[s]))}else i.dataManager.off("chkLayerUpdate",i._chkVersion)},add:function(e){var i=e._gmx.layerID;if(t.gmx.sendCmd){var o={active:!0,hostName:e.options.hostName,mapID:e.options.mapID,layerID:e.options.layerID},s=e._gmx.dataManager.getMaxDateInterval();s.beginDate&&s.endDate&&(o.dInterval=[Math.floor(s.beginDate.getTime()/1e3),Math.floor(s.endDate.getTime()/1e3)]),t.gmx.sendCmd("toggleDataSource",o)}if(!(i in r)){var a=e._gmx,l=a.properties;if("LayerVersion"in l){r[i]=e,a._chkVersion=function(){m(e)},a.dataManager.on("chkLayerUpdate",a._chkVersion);var u=e.options.parentOptions;if(u){var h=u.name;p.addDataManager(a.dataManager),n[h]||(n[h]={}),n[h][l.name]=e}a.needBbox&&!p.needBbox&&(p.needBbox=a.needBbox),p.start(),p.now()}}},chkVersion:m,now:function(){a&&clearTimeout(a),a=setTimeout(m,0)},stop:function(){s&&clearInterval(s),s=null},start:function(t){t&&(e=t),p.stop(),s=setInterval(m,e)}};t.gmx||(t.gmx={}),t.gmx.layersVersion=p,t.gmx.VectorLayer.include({updateVersion:function(e){if(e){var i=this._gmx;if(e.geometry&&(i.geometry=e.geometry),e.properties){var r={versionChanged:e.properties.LayerVersion!==i.properties.LayerVersion};t.extend(i.properties,e.properties),i.properties.currentTiles=e.tiles,i.properties.GeoProcessing=e.properties.GeoProcessing,i.rawProperties=i.properties,this.fire("versionchange",r)}!i.dataSource&&i.dataManager&&i.dataManager.updateVersion(i.rawProperties,e.tiles)}}}),t.Map.addInitHook(function(){p._map=this;var e=this,i={};this.on("moveend",function(){var r=e.getZoom(),n=e.getPixelBounds().getCenter();if((r!==i.z||i.center.distanceTo(n)>128)&&(m(),i.z=r,i.center=n,t.gmx.sendCmd)){var o=e.getBounds(),s=t.CRS.EPSG3857,a=s.project(o.getSouthWest()),l=s.project(o.getNorthEast()),u=[a.x,a.y,l.x,l.y];t.gmx.sendCmd("onmoveend",{zoom:r,bbox:u})}})})}(),t.gmx.RasterLayer=t.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(e){this._gmx.srs=this._gmx.srs||3857;var r=e.properties,n=r.styles[0]||{MinZoom:r.MinZoom||0,MaxZoom:r.MaxZoom||21},o={type:"Vector",fromType:r.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,RasterSRS:Number(r.RasterSRS)||3857,Copyright:r.Copyright||"",RCMinZoomForRasters:n.MinZoom,visible:r.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:n.MinZoom,MaxZoom:n.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},s=this._gmx,a=i.tileSizes[1];return r.MaxZoom&&(s.maxNativeZoom=r.MaxZoom),r.sessionKey=r.sessionKey||t.gmx.gmxSessionManager.getSessionKeyRes(r.hostName),r.sessionKey&&(s.sessionKey=r.sessionKey),e.geometry?3857==s.srs&&s.srs!=o.RasterSRS&&(e.geometry=i.convertGeometry(i.convertGeometry(e.geometry,!0,!0),!1,!0)):e.geometry={type:"POLYGON",coordinates:[[[-a,-a],[-a,a],[a,a],[a,-a],[-a,-a]]]},t.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:e.geometry,properties:o,rawProperties:e.properties}),s.rasterBGfunc=function(e,i,r){var n=t.gmxUtil.protocol+"//"+s.hostName+"/TileSender.ashx?ModeKey=tile&ftc=osm&z="+r+"&x="+e+"&y="+i;return s.srs&&(n+="&srs="+s.srs),s.crossOrigin&&(n+="&cross="+s.crossOrigin),n+="&LayerName="+s.layerID,s.sessionKey&&(n+="&key="+encodeURIComponent(s.sessionKey)),n},s.dataManager._rasterVectorTile=new m({load:function(t,r,n,o,l,u,h){var c=[[777,e.geometry]],d=i.geoItemBounds(e.geometry),m=d.bounds;if(m.max.x>a){var p=2*a,f=777,g=e.geometry.coordinates,y=d.boundsArr;c=[],"POLYGON"===e.geometry.type&&(g=[g],y=[y]);for(var v=0,x=g.length;v<x;v++){var _=g[v],b=y[v][0],S=_;if(c.push([f++,{type:"POLYGON",coordinates:S}]),b.max.x>a){S=[];for(var T=0,P=_.length;T<P;T++){for(var L=_[T],I=0,M=[],k=L.length;I<k;I++){var C=L[I];M.push([C[0]-p,C[1]])}S.push(M)}c.push([f++,{type:"POLYGON",coordinates:S}])}}}h({bbox:[m.min.x,m.min.y,m.max.x,m.max.y],srs:s.srs,isGeneralized:!1,changeState:!0,values:c}),s.dataManager._updateItemsFromTile(s.dataManager._rasterVectorTile)}},{x:0,y:0,z:0,v:0,s:-2,d:-2}),s.dataManager.addTile(s.dataManager._rasterVectorTile),this},setZoomBounds:function(e,i){var r=this.getStyles().slice(0);r[0]=t.extend({},r[0]),r[0].MinZoom=e,r[0].MaxZoom=i,this.setStyles(r)}}),t.Map.addInitHook(function(){if(this.options.multiRasterLayers){var e=this,i={},r=0,n=t.gmx.createLayer({properties:{type:"Vector",GeometryType:"polygon",identityField:"gmx_id",ZIndexField:"_zIndex",attributes:["gmx_id","_zIndex","MinZoom","MaxZoom","GMX_RasterCatalogID"],attrTypes:["integer","integer","integer","integer","string"],IsRasterCatalog:!0,RCMinZoomForRasters:1}},{_vectorType:"multiRasterLayer"}).setFilter(function(t){var r=e.getZoom(),n=t.properties;return i[n[5]]&&r>=n[3]&&r<=n[4]}).setStyles([{MinZoom:1,MaxZoom:21,DisableBalloonOnClick:!0,DisableBalloonOnMouseMove:!0,RenderStyle:{weight:0},HoverStyle:{weight:0}}]).once("update",function(){requestIdleCallback(n.repaint.bind(n),{timeout:0})}),o=function(t,o){var s=t.getGmxProperties(),a=s.name,l=function(e){var t=e.target.options,r=i[t.layerID];r&&(r[2]=(t.zIndexOffset?t.zIndexOffset:0)+(t.zIndex?t.zIndex:0)),n.repaint()};if(o){r++;var u=t.options,h=(u.zIndexOffset?u.zIndexOffset:0)+(u.zIndex?u.zIndex:0),c=r,d=[c,c,h,s.styles[0].MinZoom||1,s.styles[0].MaxZoom||21,a,t._gmx.geometry];n.addData([d]),i[a]=d,t.onRemove(e),t.on("zindexupdated",l)}else t.off("zindexupdated",l),n.removeData([i[a]]),i[a]=null;n.repaint()};e.on("layeradd",function(e){var i=e.layer;i instanceof t.gmx.RasterLayer&&o(i,!0)}).on("layerremove",function(e){var i=e.layer;i instanceof t.gmx.RasterLayer&&o(i,!1)}).addLayer(n)}}),t.LabelsLayer=(t.Layer||t.Class).extend({options:{animate:!1,labels:"default",pane:"overlayPane"},initialize:function(e,r){t.setOptions(this,t.extend(this.options,r)),this._observers={},this._styleManagers={},this._labels={},this._labelsIndex={};var n=this;this.bbox=i.bounds();var o=function(r,o){if(r.added||r.removed){for(var s=o.options,a=e._zoom>=s.minZoom&&e._zoom<=s.maxZoom?r.added:[],l="_"+o._leaflet_id,u=o._gmx,h={},c=0,d=a.length;c<d;c++){var m=a[c].item,p="POINT"===m.type||"MULTIPOINT"===m.type,f=m.parsedStyleKeys||m.currentStyle||{};if(u.styleHook){var g=u.styleHook(m,u.lastHover&&m.id===u.lastHover.id);if(!g)continue;f=t.extend({},f,g)}if(m.multiFilters)for(var y=0,v=m.multiFilters.length;y<v;y++){var x=m.multiFilters[y].parsedStyle;if("labelField"in x||"labelText"in x){f=x;break}}var _=u.styleManager.getObjStyle(m)||{},b=f.labelText||_.labelText,S=f.labelField||_.labelField,T=u.tileAttributeTypes[S],P=String(b||t.gmxUtil.attrToString(T,o.getPropItem(S,m.properties)));if(_.labelTemplate){var L,I=/\[([^\]]*)\]/g;for(P=_.labelTemplate;L=I.exec(_.labelTemplate);)if(2===L.length){S=L[1],T=u.tileAttributeTypes[S];var M=t.gmxUtil.attrToString(T,o.getPropItem(S,m.properties));P=P.replace(L[0],M)}}if(P||0===P){var k,C=_.labelFontSize||f.labelFontSize||12,O="_"+m.id,w=!0,D=0,F=m.options,R={font:C+'px "Arial"',labelHaloColor:"labelHaloColor"in f?f.labelHaloColor:"labelHaloColor"in _?_.labelHaloColor:16777215,labelColor:f.labelColor||_.labelColor,labelAlign:f.labelAlign||_.labelAlign,labelAnchor:f.labelAnchor||_.labelAnchor,labelFontSize:C};if(F){if(!("center"in F)){var N=i.getItemCenter(m,u.dataManager.getItemMembers(m.id));if(!N)continue;F.center=N}if(F.label){D=F.label.width,k=F.label.arrTxtWidth;var E=F.label.style;w=F.label.txt!==P||E.labelHaloColor!==R.labelHaloColor||E.labelColor!==R.labelColor||E.labelAlign!==R.labelAlign||E.labelAnchor!==R.labelAnchor||E.labelFontSize!==R.labelFontSize}}if(w){if(D=0,k=i.getLabelWidth(P,R),k&&k.forEach(function(e){D=Math.max(D,e[1])}),!D){delete h[O];continue}D+=4,m.options.labelStyle=null}F.label={isPoint:p,width:D,sx:_.sx||0,txt:P,arrTxtWidth:k,style:R},h[O]=m}}n._labelsIndex[l]=o.options.zIndex,n._labels[l]=h}},s=function(e,t){var i=e._gmx,r=["clipFilter","clipPointsFilter","styleFilter","userFilter"],s={type:"resend",bbox:n.bbox,filters:r,callback:function(t){o(t,e),n.redraw()}};return i.beginDate&&i.endDate&&(s.dateInterval=[i.beginDate,i.endDate]),i.dataManager.addObserver(s,"_Labels_"+t)};this.add=function(e){var t=e._leaflet_id,i=e._gmx;!n._observers[t]&&i&&i.labelsLayer&&t&&i.styleManager.promise.then(function(){var r=s(e,t),o=n._map._zoom;e.options.isGeneralized&&(r.targetZoom=o),r.dateInterval&&e.on("dateIntervalChanged",function(e){var t=e.target.getDateInterval();this.setDateInterval(t.beginDate,t.endDate)},r),i.styleManager.isVisibleAtZoom(o)||r.deactivate(),n._observers[t]=r,n._styleManagers[t]=i.styleManager,n._labels["_"+t]={},n._labelsIndex["_"+t]={},n._updateBbox()})},this.remove=function(e){var t=e._leaflet_id;if(n._observers[t]){var i=e._gmx,r=i.dataManager;r.removeObserver(n._observers[t].id),delete n._observers[t],delete n._styleManagers[t],delete n._labels["_"+t],delete n._labelsIndex["_"+t],n.redraw()}},this._layeradd=function(e){n.add(e.layer)},this._layerremove=function(e){n.remove(e.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=t.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var e=this._map.getPanes()[this.options.pane];e&&e.insertBefore(this._canvas,e.firstChild)},onAdd:function(e){this._map=e,this._canvas||this._initCanvas();var t=window.location.search.match("labels=([^&]+)");t&&(this.options.labels=t[1]),e.on({moveend:this._reset,zoomstart:this._hideMe,layeradd:this._layeradd,layerremove:this._layerremove},this),this._reset()},_hideMe:function(){this._canvas.style.visibility="hidden"},onRemove:function(e){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),e.off({moveend:this._reset,zoomstart:this._hideMe,layeradd:this._layeradd,layerremove:this._layerremove},this)},addTo:function(e){return e.addLayer(this),this},_initCanvas:function(){var e=t.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer leaflet-zoom-hide"),i=this._map.getSize();e.width=i.x,e.height=i.y,e.style.pointerEvents="none",this._canvas=e},_updateBbox:function(){var e=this._map,r=e.getBounds(),n=r.getSouthWest(),o=r.getNorthEast(),s=3857==e.options.srs?t.CRS.EPSG3857:t.Projection.Mercator,a=s.project(n),l=s.project(o),u=e.getZoom();this.mInPixel=i.getPixelScale(u),this._ctxShift=[a.x*this.mInPixel,l.y*this.mInPixel];for(var h in this._observers){var c=this._observers[h];c.targetZoom&&(c.targetZoom=u),c.setBounds({min:{x:n.lng,y:n.lat},max:{x:o.lng,y:o.lat}})}},_reset:function(){this._updateBbox();for(var e in this._observers){var t=this._observers[e];!t.isActive()&&this._styleManagers[e].isVisibleAtZoom(this._map.getZoom())&&t.activate(),t.fire("update")}setTimeout(function(){this._canvas.style.visibility=""}.bind(this),200)},_redraw:function(){var e=[],r=this._map,n=r.getSize(),o=this._canvas,s=this.options.labels,a=r.latLngToContainerPoint(r.getBounds().getNorthWest()),l=r.containerPointToLayerPoint(a);o.width=n.x,o.height=n.y,t.DomUtil.setPosition(o,l);var u,h,c,d=2*this.mInPixel*i.worldWidthMerc,m=d*Math.floor(r.getPixelBounds().min.x/d),p=o.getContext("2d"),f=Object.keys(this._labels).sort(function(e,t){return this._labelsIndex[t]-this._labelsIndex[e]}.bind(this));if(f.forEach(function(t){var r=this._labels[t];for(var o in r){c=r[o];var a=c.options,l=a.label,p=l.style,f=p.labelAlign||"center",g=l.arrTxtWidth,y=g.length||1,v=l.width,x=v/2,_=p.labelFontFamily||"Arial",b=p.labelFontSize||12,S=b/2,T=a.center,P=[T[0]*this.mInPixel,T[1]*this.mInPixel],L=!1;if(l.isPoint){var I=l.sx;"left"===f?P[0]+=x+I:"right"===f&&(P[0]-=v+I)}P[0]-=x+this._ctxShift[0],P[1]=-S-P[1]+this._ctxShift[1],S*=y,p.labelAnchor&&(P[0]+=p.labelAnchor[0],P[1]+=p.labelAnchor[1]);for(var M=P[0]+m;M<n.x;M+=d){var k=[Math.floor(M),Math.floor(P[1])],C=i.bounds([[k[0],k[1]-S],[k[0]+v,k[1]+S]]);if("All"!==s){for(u=0,h=e.length;u<h;u++)if(C.intersects(e[u].bbox)){L=!0;break}if(L)continue}a.labelStyle||(a.labelStyle={font:b+'px "'+_+'"',fillStyle:i.dec2color(p.labelColor||0,1),shadowBlur:4},p.labelHaloColor!==-1&&(a.labelStyle.strokeStyle=a.labelStyle.shadowColor=i.dec2color(p.labelHaloColor,1))),e.push({arr:c.properties,bbox:C,arrTxtWidth:g,width2:"center"===f?x:0,txt:l.txt,style:a.labelStyle,size:b,coord:k})}}}.bind(this)),e.length){for(p.clearRect(0,0,o.width,o.height),u=0,h=e.length;u<h;u++)c=e[u],c.arrTxtWidth.forEach(function(e,t){var r=[c.coord[0],c.coord[1]+(t+1)*c.size];i.setLabel(p,e[0],r,c.style)});o.parentNode||this._addToPane()}else o.parentNode&&o.parentNode.removeChild(o);this._frame=null},_animateZoom:function(e){var i=this._map.getZoomScale(e.zoom),r=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),e.zoom,e.center).min;t.DomUtil.setTransform(this._canvas,r,i)}}),t.labelsLayer=function(e,i){return new t.LabelsLayer(e,i)},t.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new t.LabelsLayer(this,this.options),this._labelsLayer.addTo(this))}),function(){var e=function(e,t){for(var i in t)for(var r=t[i],n=0,o=r.length;n<o;n++)for(var s=r[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,m=c.length;d<m;d++)if(c[d].intersects(e))return!0}return!1},r=function(e,t){for(var i in t)for(var r=t[i],n=0,o=r.length;n<o;n++)for(var s=r[n],a=s.geometry.type,l=s.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===a&&(c=[c]);for(var d=0,m=c.length;d<m;d++)if(e.intersects(c[d]))return!0}return!1},n=function(e,t){if(!t||0===Object.keys(t).length)return!0;for(var r in t)for(var n=t[r],o=0,s=n.length;o<s;o++)for(var a=n[o],l=a.geometry.type,u=a.boundsArr,h=0,c=u.length;h<c;h++){var d=u[h];"Polygon"===l&&(d=[d]);for(var m=0,p=d.length;m<p;m++)if(d[m].contains(e)){var f=a.geometry.coordinates,g=!1;"Polygon"===l&&(f=[f]);for(var y=0,v=f.length;y<v;y++)if(i.isPointInPolygonWithHoles(e,f[y])){g=!0;break}if(g)return!0}}return!1},o=function(e){var t=i.convertGeometry(e,!1,!0),r=i.geoItemBounds(t);return r.geometry=t,r},s=function(e){var t=document.createElement("canvas");t.width=t.height=256;var r=t.getContext("2d"),n=e.clipPolygons;e.ctx=r,r.fillStyle=r.createPattern(e.tile,"no-repeat");for(var o in n)for(var s=n[o],a=0,l=s.length;a<l;a++){var u=s[a].geometry,h=u.coordinates;"Polygon"===u.type&&(h=[h]);for(var c=0,d=h.length;c<d;c++){var m=h[c];r.beginPath();for(var p=0,f=m.length;p<f;p++){e.coords=m[p];var g=i.getRingPixels(e);e.coords=g.coords,i.polygonToCanvasFill(e)}r.closePath(),r.fill()}}r=e.tile.getContext("2d"),r.clearRect(0,0,256,256),r.drawImage(t,0,0)};t.gmx.VectorLayer.include({isPointInClipPolygons:function(e){return n(e,this._gmx._clipPolygons)},addClipPolygon:function(i){var a,l,u=[];if("coordinates"in i&&"type"in i)u.push(o(i));else if(i instanceof t.Polygon)u.push(o(i.toGeoJSON().geometry));else if(i instanceof t.GeoJSON){var h=i.getLayers();for(a=0,l=h.length;a<l;a++){var c=h[a];c instanceof t.Polygon&&c.feature?u.push(o(c.feature.geometry)):c instanceof t.MultiPolygon&&c.feature&&u.push(o(c.feature.geometry))}}if(u.length){var d=this._gmx,m=d.dataManager,p=this,f=t.stamp(i);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[f]=u,m.setTileFilteringHook(function(t){return e(t.bounds,p._gmx._clipPolygons)}),m.addFilter("clipFilter",function(e,t,i){return r(i,p._gmx._clipPolygons)}),m.addFilter("clipPointsFilter",function(e){if("POINT"===e.type){var t=e.properties,i=t[t.length-1];return n(i.coordinates,p._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&d.renderHooks.unshift(function(e,t){e&&Object.keys(p._gmx._clipPolygons).length>0&&s({tile:e,topLeft:t.topLeft,tpx:t.tpx,tpy:t.tpy,gmx:{mInPixel:d.mInPixel},clipPolygons:p._gmx._clipPolygons})})}return this},removeClipPolygon:function(e){var i=t.stamp(e);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[i],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}(),t.gmx.gmxImageTransform=function(e,r){var n=r.gmx,o=r.topLeft,s=o.mInPixel,a=r.gmxTilePoint,l=r.geoItem,u=l.properties,h=l.dataOption||{},c=n.tileAttributeIndexes,d=u[c[n.quicklookPlatform]]||n.quicklookPlatform||"",m={};"LANDSAT8"===d?(m.x1=h.bounds.min.x,m.y1=h.bounds.max.y,m.x2=h.bounds.max.x,m.y2=h.bounds.max.y,m.x3=h.bounds.max.x,m.y3=h.bounds.min.y,m.x4=h.bounds.min.x,m.y4=h.bounds.min.y):m=i.getQuicklookPointsFromProperties(u,n);
var p=s*m.x1,f=s*m.y1,g=s*m.x2,y=s*m.y2,v=s*m.x3,x=s*m.y3,_=s*m.x4,b=s*m.y4,S=i.bounds([[p,f],[g,y],[v,x],[_,b]]),T=Math.round(S.max.x-S.min.x),P=Math.round(S.max.y-S.min.y),L=256-S.max.y+256*a.y,I=l.item.bounds,M=Number(i.worldWidthMerc.toFixed(2)),k=a.x;k<0&&I.max.x>=M&&I.min.x<=-M&&(k+=Math.round(M*s/128));var C=S.min.x-256*k;p-=S.min.x,f=S.max.y-f,g-=S.min.x,y=S.max.y-y,v-=S.min.x,x=S.max.y-x,_-=S.min.x,b=S.max.y-b;var O=[[p,f],[g,y],[v,x],[_,b]];n.ProjectiveImage||(n.ProjectiveImage=(n.useWebGL?t.gmx.projectiveImageWebGL():null)||t.gmx.projectiveImage());var w=n.ProjectiveImage.getCanvas({imageObj:e,points:O,wView:T,hView:P,deltaX:C,deltaY:L});return w.canvas},function(){function e(e){return[e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]]}function i(e,t){for(var i=Array(9),r=0;3!==r;++r)for(var n=0;3!==n;++n){for(var o=0,s=0;3!==s;++s)o+=e[3*r+s]*t[3*s+n];i[3*r+n]=o}return i}function r(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[3]*t[0]+e[4]*t[1]+e[5]*t[2],e[6]*t[0]+e[7]*t[1]+e[8]*t[2]]}function n(t){var n=[t[0],t[2],t[4],t[1],t[3],t[5],1,1,1],o=r(e(n),[t[6],t[7],1]);return i(n,[o[0],0,0,0,o[1],0,0,0,o[2]])}var o=t.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;            uniform mat4 uTransformMatrix;            varying vec2 vTextureCoord;            void main(void) {                vTextureCoord = aVertCoord;                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);            }        ",shaderFS:"precision mediump float;            varying vec2 vTextureCoord;            uniform sampler2D uSampler;            void main(void) {                gl_FragColor = texture2D(uSampler, vTextureCoord);            }        "},setOptions:function(e){t.setOptions(this,e)},initialize:function(e){this.setOptions(e);var t=document.createElement("canvas"),i={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},r=t.getContext("webgl",i)||t.getContext("experimental-webgl",i);if(r){var n=this._setupGlContext(r);n&&(t.width=t.height=256,n.canvas=t,this.glResources=n,this.canvas=t,this.gl=r)}},_getShader:function(e,t,i){var r=i.createShader(e);return i.shaderSource(r,t),i.compileShader(r),i.getShaderParameter(r,i.COMPILE_STATUS)?r:(i.deleteShader(r),null)},_setupGlContext:function(e){var t=this._getShader(e.VERTEX_SHADER,this.options.shaderVS,e),i=this._getShader(e.FRAGMENT_SHADER,this.options.shaderFS,e);if(t&&i){var r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,i),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)){e.useProgram(r),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var n=e.createBuffer(),o=e.getAttribLocation(r,"aVertCoord");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),{transMatUniform:e.getUniformLocation(r,"uTransformMatrix"),samplerUniform:e.getUniformLocation(r,"uSampler"),screenTexture:e.createTexture()}}}return null},_bindTexture:function(e,t,i){e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},getCanvas:function(e){var t=e.points,i=e.deltaX,r=e.deltaY,n=new Float32Array([(t[0][0]+i)/128-1,1-(t[0][1]+r)/128,(t[1][0]+i)/128-1,1-(t[1][1]+r)/128,(t[3][0]+i)/128-1,1-(t[3][1]+r)/128,(t[2][0]+i)/128-1,1-(t[2][1]+r)/128]),s=o.Utils.general2DProjection(this.vertices,n),a=this.gl,l=this.glResources;return this._bindTexture(a,e.imageObj,l.screenTexture),a.viewport(0,0,256,256),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.uniformMatrix4fv(l.transMatUniform,!1,[s[0],s[3],0,s[6],s[1],s[4],0,s[7],0,0,1,0,s[2],s[5],0,1]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,l.screenTexture),a.uniform1i(l.samplerUniform,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),this}});o.Utils={general2DProjection:function(t,r){var o=i(n(r),e(n(t)));if(o[8])for(var s=0;9!==s;++s)o[s]=o[s]/o[8];return o},getWebGlResources:function(e){var t=new o(e);return t.gl?t:null}},t.gmx.projectiveImageWebGL=function(e){var t=new o(e);return t.gl?t:null}}(),function(){var e=function(){var e=0,t=4,r=64,n=null,o=function(e,t){for(var i=[],r=0;r<t;++r){i[r]=[];for(var n=0;n<e;++n)i[r][n]=0}return i},s=function(e,t,i){this.w=e,this.h=t,this.values=i||o(t)},a=function(e){for(var t=[],i=0;i<e.length;++i)t[i]=[].concat(e[i]);return t};s.prototype={add:function(e){if(e.w!==this.w||e.h!==this.h)throw new Error("Matrix add size mismatch");for(var t=o(this.w,this.h),i=0;i<this.h;++i)for(var r=0;r<this.w;++r)t[i][r]=this.values[i][r]+e.values[i][r];return new s(this.w,this.h,t)},transformProjectiveVector:function(e){var t,i,r=[];for(i=0;i<this.h;++i)for(r[i]=0,t=0;t<this.w;++t)r[i]+=this.values[i][t]*e[t];var n=r[r.length-1];if(n){var o=1/r[r.length-1];for(i=0;i<this.h;++i)r[i]*=o}return r},multiply:function(e){var t,i,r;if(+e!==e){if(e.h!==this.w)throw new Error("Matrix mult size mismatch");for(t=o(this.w,this.h),r=0;r<this.h;++r)for(i=0;i<e.w;++i){for(var n=0,a=0;a<this.w;a++)n+=this.values[r][a]*e.values[a][i];t[r][i]=n}return new s(e.w,this.h,t)}for(t=o(this.w,this.h),r=0;r<this.h;++r)for(i=0;i<this.w;++i)t[r][i]=this.values[r][i]*e;return new s(this.w,this.h,t)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var e=a(this.values),t=0;t<this.h;++t){for(var i=e[t][t];0===i;){for(var r=t+1;r<this.h;++r)if(0!==e[r][t]){var n=e[r];e[r]=e[t],e[t]=n;break}if(r===this.h)return new s(this.w,this.h,e);i=e[t][t]}for(var o=1/i,l=t;l<this.w;++l)e[t][l]*=o;for(var u=0;u<this.h;++u)if(u!==t){var h=e[u][t];for(e[u][t]=0,l=t+1;l<this.w;++l)e[u][l]-=h*e[t][l]}}return new s(this.w,this.h,e)},invert:function(){var e,t;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var i=o(2*this.w,this.h);for(t=0;t<this.h;++t)for(e=0;e<this.w;++e)i[t][e]=this.values[t][e],i[t][e+this.w]=e===t?1:0;i=new s(2*this.w,this.h,i),i=i.rowEchelon();var r=o(this.w,this.h);for(t=0;t<this.w;++t)for(e=0;e<this.w;++e)r[t][e]=i.values[t][e+this.w];return new s(this.w,this.h,r)}};var l=function(e){var t=new s(9,8,[[1,1,1,0,0,0,-e[2][0],-e[2][0],-e[2][0]],[0,1,1,0,0,0,0,-e[3][0],-e[3][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[2][1],e[2][1],e[2][1]],[0,0,0,0,-1,-1,0,e[3][1],e[3][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]),i=t.rowEchelon().values,r=new s(3,3,[[-i[0][8],-i[1][8],-i[2][8]],[-i[3][8],-i[4][8],-i[5][8]],[-i[6][8],-i[7][8],1]]);return r},u=function(t,i,o,s,a,l,h,c,d,m){if(d){var p=[l[0]+h[0]-2*a[0],l[1]+h[1]-2*a[1]],f=[l[0]+h[0]-2*c[0],l[1]+h[1]-2*c[1]],g=[p[0]+f[0],p[1]+f[1]],y=Math.abs((g[0]*g[0]+g[1]*g[1])/(p[0]*f[0]+p[1]*f[1]));p=[l[0]-a[0]+c[0]-h[0],l[1]-a[1]+c[1]-h[1]],f=[h[0]-a[0]+c[0]-l[0],h[1]-a[1]+c[1]-l[1]];var v=Math.abs(p[0]*f[1]-p[1]*f[0]);if(0===t&&1===o||(.25+5*y)*v>r*r){var x=(t+o)/2,_=(i+s)/2,b=n.transformProjectiveVector([x,_,1]),S=n.transformProjectiveVector([x,i,1]),T=n.transformProjectiveVector([x,s,1]),P=n.transformProjectiveVector([t,_,1]),L=n.transformProjectiveVector([o,_,1]);return d--,u.call(this,t,i,x,_,a,S,P,b,d,m),u.call(this,x,i,o,_,S,l,b,L,d,m),u.call(this,t,_,x,s,P,b,h,T,d,m),void u.call(this,x,_,o,s,b,L,T,c,d,m)}}var I=m.ctx,M=[l[0]-a[0],l[1]-a[1]],k=[c[0]-l[0],c[1]-l[1]],C=[h[0]-c[0],h[1]-c[1]],O=[a[0]-h[0],a[1]-h[1]],w=Math.abs(M[0]*O[1]-M[1]*O[0]),D=Math.abs(k[0]*M[1]-k[1]*M[0]),F=Math.abs(C[0]*k[1]-C[1]*k[0]),R=Math.abs(O[0]*C[1]-O[1]*C[0]),N=Math.max(Math.max(w,D),Math.max(R,F)),E=0,A=0,z=0,U=0;N===w?(I.setTransform(M[0],M[1],-O[0],-O[1],a[0]+m.deltaX,a[1]+m.deltaY),1!==o&&(z=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1]))):N===D?(I.setTransform(M[0],M[1],k[0],k[1],l[0]+m.deltaX,l[1]+m.deltaY),1!==o&&(z=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),E=-1):N===F?(I.setTransform(-C[0],-C[1],k[0],k[1],c[0]+m.deltaX,c[1]+m.deltaY),1!==o&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),E=-1,A=-1):N===R&&(I.setTransform(-C[0],-C[1],-O[0],-O[1],h[0]+m.deltaX,h[1]+m.deltaY),1!==o&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(U=1.05/Math.sqrt(O[0]*O[0]+O[1]*O[1])),A=-1);var G=o-t,B=s-i;z++,U++;var H=m.imageObj.width,Z=m.imageObj.height,V=Math.floor(t*H),K=Math.floor(i*Z),j=Math.floor(Math.min(z*G,1)*H),q=Math.floor(Math.min(U*B,1)*Z);e++,I.drawImage(m.imageObj,V,K,j,q,E,A,z,U)};this.getCanvas=function(o){e=0,n=l(o.points);var s=n.transformProjectiveVector([0,0,1]),a=n.transformProjectiveVector([1,0,1]),h=n.transformProjectiveVector([0,1,1]),c=n.transformProjectiveVector([1,1,1]),d=document.createElement("canvas");d.width=d.height=256,o.canvas=d,o.ctx=d.getContext("2d");var m=i.bounds([s,a,c,h]),p=Math.max(m.max.x-m.min.x,m.max.y-m.min.y);t="limit"in o?o.limit:p<200?1:4,r="patchSize"in o?o.patchSize:p/8;try{u(0,0,1,1,s,a,h,c,t,o)}catch(f){console.log("Error: ProjectiveImage event:",f),d=null}return{canvas:d,ptl:s,ptr:a,pbl:h,pbr:c,cnt:e}}};t.gmx.projectiveImage=function(){return new e}}(),t.RotatedMarker=t.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:t.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){t.Marker.prototype._initIcon.call(this),this._icon.style[t.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var e=this.options.icon.options.iconAnchor;return e?e[0]+"px "+e[1]+"px":"50% 50%"},_setPos:function(e){if(t.Marker.prototype._setPos.call(this,e),t.DomUtil.TRANSFORM)this._icon.style[t.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(t.Browser.ie){var i=this.options.angle*(Math.PI/180),r=Math.cos(i),n=Math.sin(i);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+r+", M12="+-n+", M21="+n+", M22="+r+")"}},setAngle:function(e){this.options.angle=e}}),t.rotatedMarker=function(e,i){return new t.RotatedMarker(e,i)},t.gmx.ExternalLayer=t.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var e=this.parentLayer._gmx;this._observer.setDateInterval(e.beginDate,e.endDate)}},options:{useDataManager:!0,observerOptions:{delta:0,filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(e,i){t.setOptions(this,e),this.parentLayer=i,i.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),i._map&&(this._addEvent({target:{_map:i._map}}),this._updateBbox())},_addObserver:function(e){this._items={},this._observer=this.parentLayer.addObserver(t.extend({bbox:i.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:t.bind(this.updateData,this)},e)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var e=this._map||this.parentLayer._map;this._onRemove(!e),this._removeMapHandlers()},_addMapHandlers:function(e){e&&(this._map=e,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this))},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(e){this._addMapHandlers(e.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(e){var t=e.layer;return t._gmx&&t._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(e){this._isParentLayer(e)&&this._chkZoom()},_layerremove:function(e){this._isParentLayer(e)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(e){this._observer&&this._observer.deactivate();var t=this._map;t&&(t.hasLayer(this.externalLayer)&&(this._chkZoom(),t.removeLayer(this.externalLayer)),e||this.parentLayer.onAdd(t))},_chkZoom:function(){if(this._map){var e=this.parentLayer,t=this._observer,i=this._map,r=i.hasLayer(this.externalLayer);e.setCurrentZoom&&e.setCurrentZoom(i),this.isExternalVisible(i.getZoom())?e._map&&(e.onRemove(i),r||i.addLayer(this.externalLayer),this.setDateInterval(),t&&e.getIcons(function(){t.activate()}.bind(this)),e.disablePopup()):(t&&t.deactivate(),e._map||(r&&i.removeLayer(this.externalLayer),e.onAdd(i)),e.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var e=this._map,i=e.getBounds(),r=i.getNorthWest(),n=i.getSouthEast(),o=t.gmxUtil.bounds([[r.lng,r.lat],[n.lng,n.lat]]),s=this.options.observerOptions.delta,a=s?s*t.gmxUtil.tileSizes[e.getZoom()]/256:0;this._observer.setBounds(o,a)}}}),function(){var e=t.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var e=this.parentLayer.options,i={map:e.mapID,layers:e.layerID,format:this.options.format,transparent:this.options.transparent},r=this.parentLayer.getGmxProperties();return r&&r.Temporal&&this._extendOptionsByDateInterval(i),this.options.apikey&&(i.apikey=this.options.apikey),t.tileLayer.wms(t.gmxUtil.protocol+"//"+e.hostName+"/TileService.ashx",i)},_extendOptionsByDateInterval:function(e){var i=this.parentLayer.getDateInterval(),r=i.beginDate,n=i.endDate;t.extend(e,{StartDate:r&&r.toLocaleDateString(),EndDate:n&&n.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)}});t.gmx.VectorLayer.include({bindWMS:function(t){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new e(t,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}(),function(){var e=t.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return t.heatLayer([],t.extend({},this.options))},isExternalVisible:function(e){return!(e<this.options.minHeatMapZoom||e>this.options.maxHeatMapZoom)},updateData:function(e){if(e.added){var i=[],r=this.parentLayer.getTileAttributeIndexes(),n=null,o=this.options.intensityField||"",s=this.options.intensityScale||1;o&&o in r&&(n=r[o]);for(var a=0,l=e.added.length;a<l;a++){var u=e.added[a].properties,h=null!==n?u[n]:1,c=u[u.length-1],d=c.coordinates,m=t.Projection.Mercator.unproject({x:d[0],y:d[1]});i.push([m.lat,m.lng,"function"==typeof s?s(h):s*h])}this.externalLayer.setLatLngs(i)}}});t.gmx.VectorLayer.include({bindHeatMap:function(i){return t.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new e(i,this)),this},unbindHeatMap:function(){return t.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}(),function(){var e={radiusFunc:function(e){var t=Math.floor(e/15);return t>40?t=40:t<20&&(t=20),t},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},i=t.gmx.ExternalLayer.extend({options:{observerOptions:{delta:256,filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,animate:!1,minZoom:1,maxZoom:6},createExternalLayer:function(){var i=t.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var r=this.options.clusterIconOptions;if("radialGradient"in r){var n=r.radialGradient,o=r.text||e.text;i.iconCreateFunction=function(i){var r=i.getChildCount();return o.count=r,t.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(n.radiusFunc||e.radiusFunc)(r),text:o,fillRadialGradient:n})}}}this.options.clusterclick&&(i.clusterclick=this.options.clusterclick,i.clusterclick===!0&&(i.zoomToBoundsOnClick=!1)),this._popup=new t.Popup({maxWidth:1e4,className:"gmxPopup"});var s=new t.MarkerClusterGroup(i),a=null;return s.on("click",function(e){var i=e.layer.options.properties,r=this.parentLayer.getItemProperties(i),n=[i[i.length-1]],o=i[0];!a||a.getAllChildMarkers().indexOf(e.layer)+1?this._openPopup(i,e.latlng):(a.unspiderfy(),s.once("unspiderfied",function(){this._openPopup(i,e.latlng)},this)),this.parentLayer.fire("click",t.extend(e,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:o,layer:this.parentLayer,properties:r,target:{id:o,properties:i,geometry:n}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(e){this.parentLayer.fire("clusterclick",t.extend(e,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(e){a=e.cluster},this).on("unspiderfied",function(){a=null},this),i.clusterclick&&s.on("clusterclick",i.clusterclick instanceof Function?i.clusterclick:function(e){e.layer.spiderfy()}),s},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)},updateData:function(e){var i,r,n,o,s,a=[];if(e.removed){for(i=0,r=e.removed.length;i<r;i++)n=e.removed[i],o=n.id,s=this._items[o],s&&a.push(s),delete this._items[o];this.externalLayer.removeLayers(a),a=[]}if(e.added){var l=this.parentLayer.options.tilesCRS||t.Projection.Mercator;for(i=0,r=e.added.length;i<r;i++){n=e.added[i],o=n.id,s=this._items[o];var u=n.properties;if(s&&u.processing&&(this.externalLayer.removeLayer(s),s=null),!s){n.item.parsedStyleKeys||(n.item.parsedStyleKeys=this.parentLayer.getItemStyle(o));var h=u[u.length-1],c=n.item.parsedStyleKeys,d=h.coordinates,m=l.unproject({x:d[0],y:d[1]}),p={properties:n.properties,mPoint:d};if(this.options.notClusteredIcon){var f=this.options.notClusteredIcon;f instanceof t.Icon?p.icon=f:p.icon=t.icon(f)}else if(c)if(c.iconUrl){var g=c.iconAnchor;if(!g){var y=this.parentLayer.getItemStyle(o);g=y.image?[y.sx/2,y.sy/2]:[8,10]}p.icon=t.icon({iconAnchor:g,iconUrl:c.iconUrl})}else p.icon=t.gmxUtil.getSVGIcon(c);s=c.rotate?t.rotatedMarker(m,t.extend(p,{angle:c.rotate})):t.marker(m,t.extend(p,{angle:c.rotate})),this._items[o]=s}a.push(s)}this.externalLayer.addLayers(a)}},_openPopup:function(e,i){var r=this.parentLayer._gmx,n=e[0],o=r.styleManager.getItemBalloon(n),s=this.parentLayer.getItemProperties(e),a=[e[e.length-1]];if(o&&!o.DisableBalloonOnClick){var l=this.parentLayer.getItemStyle(n);if(l&&l.iconAnchor){var u=t.Popup.prototype.options.offset;this._popup.options.offset=[-u[0]-l.iconAnchor[0]+l.sx/2,u[1]-l.iconAnchor[1]+l.sy/2]}if(this.parentLayer._balloonHook)for(var h in this.parentLayer._balloonHook)s[h]=t.gmxUtil.parseTemplate(this.parentLayer._balloonHook[h].resStr,s);var c=t.gmxUtil.parseBalloonTemplate(o.templateBalloon,{properties:s,tileAttributeTypes:r.tileAttributeTypes,unitOptions:this._map.options||{},geometries:a}),d=t.DomUtil.create("div","");d.innerHTML=c,this._popup.setLatLng(i).setContent(d).openOn(this._map),this.parentLayer._balloonHook&&this.parentLayer._callBalloonHook(s,this._popup.getContent())}}});t.gmx.VectorLayer.include({bindClusters:function(e){return t.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new i(e,this)),this},unbindClusters:function(){return t.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}(),function(){var e=t.Evented.extend({options:{skipItems:!0,pixelDelta:0,styleHook:function(e,t,i){e.setLineDash([2,4])},minZoom:1,maxZoom:6},_layer:null,_markers:null,initialize:function(e,i){this._layer=i,e=t.Util.setOptions(this,e),this._markers=new t.FeatureGroup(e),this._layer.on("load",this.checkLoad,this)},checkLoad:function(){var e=this._layer._tiles,t=0,i=0;for(var r in e){var n=e[r];n.count&&(i+=n.count),n._gridData&&n._gridData.forEach(function(e){e.count&&(t=Math.max(t,e.count))})}i&&this._drawMe(t,i)},_drawMe:function(e,t){var i=this._layer._tiles,r=this._layer.options.tileSize;for(var n in i){var o=i[n];if(!o._drawDone&&o._gridData){o.el.height!=r&&(o.el.width=o.el.height=r);var s=o.el.getContext("2d");o._gridData.forEach(function(t){if(t.count){this.options.styleHook&&this.options.styleHook(s,t,e);var i=t.pixelBox;s.strokeRect(i[0],i[1],i[2],i[3])}}.bind(this))}}},_zoomClear:null,checkData:function(e){var t=this._layer._gmx.currentZoom;return t<this.options.minZoom||t>this.options.maxZoom?(this._layer.enablePopup(!0),!1):(this._layer.disablePopup(!0),this._parseData(e),this._layer._map&&t===e.tileElem.coords.z&&(this._layer._map.addLayer(this._markers),this._zoomClear||(this._layer._map.on("zoomstart",function(e){this._markers.clearLayers()},this),this._zoomClear=!0)),this.options.skipItems&&!0)},_parseData:function(e){var i=e.tileElem,r=i.screenTile.tbounds,n=r.getCenter(),o=this._layer._tileCoordsToNwSe(i.coords),s=t.latLngBounds(o[0],o[1]),a=s.getCenter(),l=[{bounds:t.gmxUtil.bounds([[r.min.x,n[1]],[n[0],r.max.y]]),center:t.latLngBounds(s.getNorthWest(),a).getCenter()},{bounds:t.gmxUtil.bounds([n,[r.max.x,r.max.y]]),center:t.latLngBounds(s.getNorthEast(),a).getCenter()},{bounds:t.gmxUtil.bounds([[r.min.x,r.min.y],n]),center:t.latLngBounds(s.getSouthWest(),a).getCenter()},{bounds:t.gmxUtil.bounds([[n[0],r.min.y],[r.max.x,n[1]]]),center:t.latLngBounds(s.getSouthEast(),a).getCenter()}],u=2,h=256/u-this.options.pixelDelta;e.geoItems.forEach(function(e){for(var t=e.item,i=t.bounds,r=0;r<4;r++){var n=l[r];if(n.bounds.intersects(i)){var o=t.currentFilter;n.counts||(n.counts={}),n.counts[o]?n.counts[o]++:n.counts[o]=1;break}}}),l.forEach(function(t,i){if(t.counts){var r=0;for(var n in t.counts)r+=t.counts[n];t.count=r,t.data=e,t.pixelBox=[128*(i%2)+this.options.pixelDelta,(i>1?128:0)+this.options.pixelDelta,h,h],t.marker=this.addMarker(t,r),t.marker.addTo(this._markers)}}.bind(this)),i._gridData=l},clearLayers:function(){this._markers&&(this._markers.clearLayers(),this._markers._map&&this._markers._map.removeLayer(this._markers))},addMarker:function(e,i){var r=e.bounds.toLatLngBounds().getCenter(),n=t.marker(t.latLng(r.lat,e.center.lng),t.extend({icon:t.divIcon({className:"gmx-style-legend-icon",html:i})},this.options)).bindPopup(Object.keys(e.counts).sort(function(t,i){return e.counts[i]-e.counts[t]}).map(function(t){return this._layer.getStyleIcon(t,e.counts[t])}.bind(this)).join(""),{minWidth:150});return n}});t.gmx.VectorLayer.include({bindGridClusters:function(t){return this._gridClusters&&this._gridClusters.clearLayers(),this._gridClusters=new e(t,this),this.redraw().repaint(),this},unbindGridClusters:function(){return this._gridClusters&&(this._gridClusters.clearLayers(),this._gridClusters=null,this.redraw().repaint()),this}})}(),function(){function e(e,t,r){r=r||2;var o=t&&t.length,s=o?t[0]*r:e.length,a=i(e,0,s,r,!0),l=[];if(!a)return l;var h,c,d,m,p,f,g;if(o&&(a=u(e,t,a,r)),e.length>80*r){h=d=e[0],c=m=e[1];for(var y=r;y<s;y+=r)p=e[y],f=e[y+1],p<h&&(h=p),f<c&&(c=f),p>d&&(d=p),f>m&&(m=f);g=Math.max(d-h,m-c),g=0!==g?1/g:0}return n(a,l,r,h,c,g),l}function i(e,t,i,r,n){var o,s;if(n===C(e,t,i,r)>0)for(o=t;o<i;o+=r)s=I(o,e[o],e[o+1],s);else for(o=i-r;o>=t;o-=r)s=I(o,e[o],e[o+1],s);return s&&_(s,s.next)&&(M(s),s=s.next),s}function r(e,t){if(!e)return e;t||(t=e);var i,r=e;do if(i=!1,r.steiner||!_(r,r.next)&&0!==x(r.prev,r,r.next))r=r.next;else{if(M(r),r=t=r.prev,r===r.next)break;i=!0}while(i||r!==t);return t}function n(e,t,i,u,h,c,d){if(e){!d&&c&&m(e,u,h,c);for(var p,f,g=e;e.prev!==e.next;)if(p=e.prev,f=e.next,c?s(e,u,h,c):o(e))t.push(p.i/i),t.push(e.i/i),t.push(f.i/i),M(e),e=f.next,g=f.next;else if(e=f,e===g){d?1===d?(e=a(e,t,i),n(e,t,i,u,h,c,2)):2===d&&l(e,t,i,u,h,c):n(r(e),t,i,u,h,c,1);break}}}function o(e){var t=e.prev,i=e,r=e.next;if(x(t,i,r)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(y(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&x(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function s(e,t,i,r){var n=e.prev,o=e,s=e.next;if(x(n,o,s)>=0)return!1;for(var a=n.x<o.x?n.x<s.x?n.x:s.x:o.x<s.x?o.x:s.x,l=n.y<o.y?n.y<s.y?n.y:s.y:o.y<s.y?o.y:s.y,u=n.x>o.x?n.x>s.x?n.x:s.x:o.x>s.x?o.x:s.x,h=n.y>o.y?n.y>s.y?n.y:s.y:o.y>s.y?o.y:s.y,c=f(a,l,t,i,r),d=f(u,h,t,i,r),m=e.prevZ,p=e.nextZ;m&&m.z>=c&&p&&p.z<=d;){if(m!==e.prev&&m!==e.next&&y(n.x,n.y,o.x,o.y,s.x,s.y,m.x,m.y)&&x(m.prev,m,m.next)>=0)return!1;if(m=m.prevZ,p!==e.prev&&p!==e.next&&y(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&x(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;m&&m.z>=c;){if(m!==e.prev&&m!==e.next&&y(n.x,n.y,o.x,o.y,s.x,s.y,m.x,m.y)&&x(m.prev,m,m.next)>=0)return!1;m=m.prevZ}for(;p&&p.z<=d;){if(p!==e.prev&&p!==e.next&&y(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&x(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function a(e,t,i){var r=e;do{var n=r.prev,o=r.next.next;!_(n,o)&&b(n,r,r.next,o)&&T(n,o)&&T(o,n)&&(t.push(n.i/i),t.push(r.i/i),t.push(o.i/i),M(r),M(r.next),r=e=o),r=r.next}while(r!==e);return r}function l(e,t,i,o,s,a){var l=e;do{for(var u=l.next.next;u!==l.prev;){if(l.i!==u.i&&v(l,u)){var h=L(l,u);return l=r(l,l.next),h=r(h,h.next),n(l,t,i,o,s,a),void n(h,t,i,o,s,a)}u=u.next}l=l.next}while(l!==e)}function u(e,t,n,o){var s,a,l,u,d,m=[];for(s=0,a=t.length;s<a;s++)l=t[s]*o,u=s<a-1?t[s+1]*o:e.length,d=i(e,l,u,o,!1),d===d.next&&(d.steiner=!0),m.push(g(d));for(m.sort(h),s=0;s<m.length;s++)c(m[s],n),n=r(n,n.next);return n}function h(e,t){return e.x-t.x}function c(e,t){if(t=d(e,t)){var i=L(t,e);r(i,i.next)}}function d(e,t){var i,r=t,n=e.x,o=e.y,s=-(1/0);do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var a=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=n&&a>s){if(s=a,a===n){if(o===r.y)return r;if(o===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(n===s)return i.prev;var l,u=i,h=i.x,c=i.y,d=1/0;for(r=i.next;r!==u;)n>=r.x&&r.x>=h&&n!==r.x&&y(o<c?n:s,o,h,c,o<c?s:n,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(n-r.x),(l<d||l===d&&r.x>i.x)&&T(r,e)&&(i=r,d=l)),r=r.next;return i}function m(e,t,i,r){var n=e;do null===n.z&&(n.z=f(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,p(n)}function p(e){var t,i,r,n,o,s,a,l,u=1;do{for(i=e,e=null,o=null,s=0;i;){for(s++,r=i,a=0,t=0;t<u&&(a++,r=r.nextZ,r);t++);for(l=u;a>0||l>0&&r;)0!==a&&(0===l||!r||i.z<=r.z)?(n=i,i=i.nextZ,a--):(n=r,r=r.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;i=r}o.nextZ=null,u*=2}while(s>1);return e}function f(e,t,i,r,n){return e=32767*(e-i)*n,t=32767*(t-r)*n,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e|t<<1}function g(e){var t=e,i=e;do t.x<i.x&&(i=t),t=t.next;while(t!==e);return i}function y(e,t,i,r,n,o,s,a){return(n-s)*(t-a)-(e-s)*(o-a)>=0&&(e-s)*(r-a)-(i-s)*(t-a)>=0&&(i-s)*(o-a)-(n-s)*(r-a)>=0}function v(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!S(e,t)&&T(e,t)&&T(t,e)&&P(e,t)}function x(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function _(e,t){return e.x===t.x&&e.y===t.y}function b(e,t,i,r){return!!(_(e,t)&&_(i,r)||_(e,r)&&_(i,t))||x(e,t,i)>0!=x(e,t,r)>0&&x(i,r,e)>0!=x(i,r,t)>0}function S(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&b(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function T(e,t){return x(e.prev,e,e.next)<0?x(e,t,e.next)>=0&&x(e,e.prev,t)>=0:x(e,t,e.prev)<0||x(e,e.next,t)<0}function P(e,t){var i=e,r=!1,n=(e.x+t.x)/2,o=(e.y+t.y)/2;do i.y>o!=i.next.y>o&&i.next.y!==i.y&&n<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next;while(i!==e);return r}function L(e,t){var i=new k(e.i,e.x,e.y),r=new k(t.i,t.x,t.y),n=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,o.next=r,r.prev=o,r}function I(e,t,i,r){var n=new k(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function M(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function k(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function C(e,t,i,r){for(var n=0,o=t,s=i-r;o<i;o+=r)n+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return n}e.deviation=function(e,t,i,r){var n=t&&t.length,o=n?t[0]*i:e.length,s=Math.abs(C(e,0,o,i));if(n)for(var a=0,l=t.length;a<l;a++){var u=t[a]*i,h=a<l-1?t[a+1]*i:e.length;s-=Math.abs(C(e,u,h,i))}var c=0;for(a=0;a<r.length;a+=3){var d=r[a]*i,m=r[a+1]*i,p=r[a+2]*i;c+=Math.abs((e[d]-e[p])*(e[m+1]-e[d+1])-(e[d]-e[m])*(e[p+1]-e[d+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,n=0;n<e.length;n++){for(var o=0;o<e[n].length;o++)for(var s=0;s<t;s++)i.vertices.push(e[n][o][s]);n>0&&(r+=e[n-1].length,i.holes.push(r))}return i},t.gmx=t.gmx||{},t.gmx.WebGL=t.gmx.WebGL||{},t.gmx.WebGL.earcut=e}(),t.gmx=t.gmx||{};var _="maps.kosmosnimki.ru",b=2e6;t.gmx._layerClasses={Raster:t.gmx.RasterLayer,Vector:t.gmx.VectorLayer,VectorView:t.gmx.DummyLayer},t.gmx._loadingLayerClasses={},t.gmx.addLayerClass=function(e,i){t.gmx._layerClasses[e]=i},t.gmx._layerClassLoaders=[],t.gmx.addLayerClassLoader=function(e){t.gmx._layerClassLoaders.push(e),t.gmx._loadingLayerClasses={}},t.gmx._loadLayerClass=function(e){if(!t.gmx._loadingLayerClasses[e]){var i=new t.gmx.Deferred;i.resolve(),t.gmx._layerClassLoaders.forEach(function(r){i=i.then(function(i){return i?(t.gmx._layerClasses[e]=i,i):r(e)},function(){})}),i=i.then(function(i){if(i)return t.gmx._layerClasses[e]=i,i},function(){}),t.gmx._loadingLayerClasses[e]=i}return t.gmx._loadingLayerClasses[e]},t.gmx.loadLayer=function(e,r,n){return new Promise(function(o,s){var a={mapID:e,layerID:r};n=n||{},n.skipTiles||(n.skipTiles="All");for(var l in n)a[l]=n[l];var h=i.normalizeHostname(n.hostName||_);a.hostName=h,u.loadMapProperties({srs:n.srs||"3857",hostName:h,apiKey:n.apiKey,mapName:e,skipTiles:n.skipTiles}).then(function(){var i=u.findLayerInfo(h,e,r);if(!i)return void s("There is no layer "+r+" in map "+e);i.properties.hostName=h;var n=i.properties.ContentID||i.properties.type,l=function(){var e=t.gmx.createLayer(i,a);e?o(e):s("Unknown type of layer "+r)};n in t.gmx._layerClasses?l():t.gmx._loadLayerClass(n).then(l)},function(t){s("Can't load layer "+r+" from map "+e+": "+t.error)})})},t.gmx.loadLayers=function(e,i){return new Promise(function(r){Promise.all(e.map(function(e){var r=t.extend({},i,e);return t.gmx.loadLayer(e.mapID,e.layerID,r)})).then(function(e){r(e)})})},t.gmx.loadMap=function(e,r){return t.gmxUtil.debug&&console.warn("L.gmx.loadMap:",e,r),r=t.extend({},r),r.hostName=i.normalizeHostname(r.hostName||_),r.mapName=e,r.skipTiles||(r.skipTiles="All"),r.srs||(r.srs=3857),r.ftc||(r.ftc="osm"),new Promise(function(i,n){u.loadMapProperties(r).then(function(n){var o=t.gmx._maps[r.hostName][e];if(o.loaded)i(o.loaded);else{var s=new t.gmx.gmxMap(n,r);o.loaded=s,s.layersCreated.then(function(){if(r.leafletMap||r.setZIndex)for(var e,t,o=0,a=r.visibility,l=s.layers.length-1;l>=0;l--)e=s.layers[l],t=e.getGmxProperties(),"VectorOnTop"===n.properties.LayerOrder&&e.setZIndexOffset&&"Raster"!==t.type&&e.setZIndexOffset(b),r.setZIndex&&e.setZIndex&&e.setZIndex(++o),r.leafletMap&&(a?a[t.name]:t.visible)&&e.addTo(r.leafletMap);i(s)})}},function(t){var i=t&&t.ErrorInfo&&t.ErrorInfo.ErrorMessage||"Server error";n("Can't load map "+e+" from "+r.hostName+": "+i)})["catch"](console.log)})},t.gmx.DummyLayer=function(e){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return e}},t.gmx.createLayer=function(e,i){
e||(e={}),e.properties||(e.properties={type:"Vector"});var r,n=e.properties,o=n.ContentID||n.type||"Vector";if(i||(i=n),o in t.gmx._layerClasses)try{r=new t.gmx._layerClasses[o](i||e.properties),r=r.initFromDescription(e)}catch(s){r=new t.gmx.DummyLayer(n)}else r=new t.gmx.DummyLayer(n);return r}}();